bwdefine("storagebusymarker",["jquery"],function(e){var n,t={};return t.init=function(){var t=e("#storage-busy-marker");0===t.length&&e('<div id="storage-busy-marker"></div>').appendTo(".closebutton-container"),n=0},t.start=function(){0==n&&e("#storage-busy-marker").addClass("busy"),++n},t.end=function(){0==--n&&e("#storage-busy-marker").removeClass("busy")},t}),bwdefine("SynchronousTaskQueue",["jquery"],function(e){function n(){return 0==r.length?void(o=null):(o=r.shift(),void o())}var t={},o=null,r=[];return t.pushAsyncFunc=function(t){var i=e.Deferred(),s=function(){t().always(function(){i.resolve(),n()})};return r.push(s),null===o&&n(),i},t.pushSyncFunc=function(n){this.pushAsyncFunc(function(){return n(),e.when()})},t}),bwdefine("BWCredentialStorage",["jquery","bw/platform","BWLocalStorage","BWSessionStorage","bw/storage/NativeSQLAsyncKeyStore","bw/storage/ProxiedAsyncKeyStore","bw/qs","bw/lti"],function(e,n,t,o,r,i,s,a){function u(n){this.setCredentials=function(t){return e.Deferred(function(e){try{n.SetItem("BwCredentials",JSON.stringify(t)),e.resolve()}catch(n){e.reject()}})},this.getCredentials=function(){return e.Deferred(function(e){try{var t=JSON.parse(n.GetItem("BwCredentials"));e.resolve(t)}catch(n){e.reject()}})}}function c(n){this._storage=n,this.setCredentials=function(n){var t=this;return e.Deferred(function(e){t._storage.setItemsAsync([{key:"BwCredentials",value:JSON.stringify(n),attribs:""}],function(){e.resolve()},function(){e.reject()})})},this.getCredentials=function(){var n=this;return e.Deferred(function(e){n._storage.getItemsAsync(["BwCredentials"],function(n){try{var t=JSON.parse(n.BwCredentials.value);e.resolve(t)}catch(n){e.reject()}},function(){e.reject()})})}}var l=a.isLTI()||s.getParameters().sso;return l&&console.log("Using session storage for credentials"),"ibw-platform-ipad-bookwidgets"===n.getPlatform()?new c(new r):n.usesCredentialProxy()?new c(new i("_secureStorage",!0,s.getQueryParams(window.location.search)["bwds-secure-proxy-token"],l)):new u(l?o:t)}),bwdefine("bwdsstorage",["BWDS","bw/storage/BWDSError","bw/platform","jquery","bw/dialog"],function(e,n,t,o,r){function i(t){var r=o.Deferred();return e.remove(t,function(e){return null===e||e.code==n.BWDS_ERROR_UNKNOWN?r.resolve():(console.log("Remove failed: "+JSON.stringify(e)),r.reject()),r}),r}function s(i,s,a){var u=o.Deferred();return e.write(i,s,function(e){if(null===e)u.resolve();else{if(a&&f===!1){if(e.code==n.BWDS_ERROR_SECURITY){var o=t.getPlatform();"ibw-platform-ipad-ibooks-epub"===o||"ibw-platform-ipad-ibooks"===o?r.showCriticalAlert("Unable to save your answer, please restart iBooks to solve this issue.<br>"+o.getIOSIBooksRestartInfo(),"Storage error"):r.showCriticalAlert("Storing answers not supported on this platform.","Storage error")}else r.showCriticalAlert("Could not save your answer.","Storage problem");f=!0}console.log("Save failed"),u.reject()}}),u}function a(i,s){var a=o.Deferred();return e.read(i,function(e,o){if(null===e)o?a.resolve(o):(console.log("How did this happen?  No saved data on read!"),a.reject({}));else{if(s&&f===!1)if(e.code==n.BWDS_ERROR_SECURITY){var i=t.getPlatform();"ibw-platform-ipad-ibooks-epub"===i||"ibw-platform-ipad-ibooks"===i?r.showCriticalAlert("Unable to save your answer, please restart iBooks to solve this issue.<br>"+i.getIOSIBooksRestartInfo(),"Storage error"):r.showCriticalAlert("Storing answers not supported on this platform.","Storage error"),f=!0}else e.code!=n.BWDS_ERROR_UNKNOWN&&(console.log("Error "+e.code+" occurred while loading data: "+e.message),r.showCriticalAlert("Storing answers not supported on this platform.","Storage error"),f=!0);a.reject({})}}),a}function u(n){var t=o.Deferred();return e.dir(n,function(e,n){null===e?t.resolve(n):t.reject(e)}),t}function c(e,n){var t=e||{};for(var o in n){var r=n[o];null===r?delete t[o]:t[o]=r}return t}function l(n,t,r,l,d,f,g){function h(){return m+"books/"+n+"/"+t+"/"+r}function p(e){return h()+"/img/"+e}var v={},m=""==d?"":d+"/",w={};return v.loadAll=function(n){l?a(h()+f,g).done(n).fail(function(){n(null)}):""!==d?a(h(),g).always(function(e){try{var t=JSON.parse(e);w=t,n(JSON.parse(e))}catch(e){console.log("Can't parse bwds user data"),console.log(e),n(w)}}):u(h()).done(function(t){function r(n,t,o){e.read(n+"/"+t,function(e,n){null===e?i[t]=n:console.log("Received error reading: "+t),o.resolve()})}for(var i={},s=[],a=0;a<t.length;++a){var u=o.Deferred();s.push(u),r(h(),t[a],u)}o.when.apply(null,s).done(function(){n(i)})}).fail(function(e){n({})})},v.write=function(e,n){if(l)null===e?i(h()+f).always(n):s(h()+f,e,g).always(n);else if(""!==d)w=c(w,e),s(h(),JSON.stringify(w),g).always(n);else{var t=[];for(var r in e){var a=e[r];null===a?t.push(i(h()+"/"+r)):t.push(s(h()+"/"+r,a,g))}o.when.apply(null,t).always(n)}},v.overwriteAndSetVersion=function(e,n){var t=o.Deferred();if(l)null===e?i(h()+f).always(function(){t.resolve()}):s(h()+f,e,g).always(function(){v.setVersion(n).always(function(){t.resolve()})});else if(""!==d){var r=JSON.stringify(e);w=JSON.parse(r),s(h(),r,g).always(function(){v.setVersion(n).always(function(){t.resolve()})})}else console.error("bwds_storage_if.overwriteAndSetVersion not implemented for this storage mode... only intended for local caching"),t.reject();return t},v.setVersion=function(n){var t=o.Deferred(),r=h();return l&&(r+=f),e.stat(r,function(o,i,s){null===o?e.setStat(r,{backup_date:i.modified,backup_version:n},function(e){null===e?t.resolve():(console.log("Problem writing stat: "+JSON.stringify(e)),t.reject())}):(console.log("Got error reading stat for "+r+": means offline mode won't work"),t.reject())}),t},v.getVersion=function(n){var t=h();l&&(t+=f),e.stat(t,function(e,t,o){null===e?n({version:t.backup_version,offlinedata:t.backup_date!=t.modified,hasdata:!0}):(console.log("Error reading stat... assume there is no data"),n({version:0,offlinedata:!1,hasdata:!1}))})},v.writeImage=function(e,n){return s(p(e),n,g)},v.isImageBackedUp=function(n){var t=o.Deferred();return e.stat(p(n),function(e,n,o){null===e?t.resolve(n.backup_date==n.modified):t.reject()}),t},v.listImagesAndBackupStatus=function(){var n=o.Deferred();return e.stat(h()+"/img",function(e,t,o){if(null!==e)return void n.resolve([]);for(var r=[],i=0;i<o.length;++i){var s=o[i].name;r.push({id:s.substring(s.lastIndexOf("/")+1),backed_up:o[i].backup_date===o[i].modified})}n.resolve(r)}),n},v.setImageBackedUp=function(n){var t=o.Deferred();return e.stat(p(n),function(o,r,i){null===o?e.setStat(p(n),{backup_date:r.modified},function(e){null===e?t.resolve():t.reject()}):t.reject()}),t},v.readImage=function(e){return a(p(e),g)},v.sync=function(n){e.executeSync(n)},v}function d(e,n,t){function o(e){var t=""==n?"":n+"/";return t+"info/"+e}var r={},i={},u={};return a(o("BWCommon"),t).always(function(e){try{i=JSON.parse(e)}catch(e){i={}}}),a(o(e),t).always(function(e){try{u=JSON.parse(e)}catch(e){u={}}}),r.getCommonProperties=function(e){e(i)},r.getGroupProperties=function(e){e(u)},r.setCommonProperties=function(e){i=c(i,e),s(o("BWCommon"),JSON.stringify(i),t)},r.setGroupProperties=function(n){u=c(u,n),s(o(e),JSON.stringify(u),t)},r}var f=!1;return{createWidgetStorage:l,createInfoStorage:d}}),bwdefine("studentaccountui",["config","jquery","bw/dialog","bw/tr","bw/addWeblinkIFrame","bw/platform","bw/widget"],function(e,n,t,o,r,i,s){function a(){var e=i.getPlatform();return!!("ibw-platform-ipad-ibooks"===e||"ibw-platform-ipad-ibooks-epub"===e||"ibw-platform-osx-ibooks"===e||"ibw-platform-osx-ibooks-epub"===e||"ibw-platform-android-chrome"===e||i.isPreview()||"ibw-platform-ipad-bookwidgets"!==e&&i.isTopLevelPlay()===!1)}function u(e){for(var n=0;n<e.bw_links.length;++n){var t=e.bw_links[n];if("bw-student"===t.name)return t}return null}function c(){return e.hasOwnProperty("student_account_school")&&e.student_account_school.hasOwnProperty("code")&&null!==e.student_account_school.code&&""!==e.student_account_school.code&&"null"!==e.student_account_school.code}var l={};return l.createDialog=function(e,t){function o(e){e.find(".weblink").each(function(){r(n(this).parent()[0],n(this).attr("href"),!0,n(this).attr("message")),n(this).attr("href","")}),e.find(".external-link").each(function(){r(this,n(this).attr("href"),!1,n(this).attr("message")),n(this).attr("href","")})}var i=n('<div class="bw-login-dialog-wrapper"></div>'),s=n(document.createElement("div")).css({position:"absolute",width:"100%",height:"100%",left:"0px",top:"0px"}).appendTo(i),a=n('<div id="bw-login-dialog" class="bw-row-container"></div>').appendTo(i);return t&&(i.addClass("bw-centering-container"),a.addClass("bw-centered")),i.appendTo("body"),e&&s.click(function(){i.remove(),e.reject()}),{close:i.remove.bind(i),show:function(e,t){a.empty(),t&&n('<div class="login-dialog-title bw-row-fixed"></div>').html(t).appendTo(a),e.appendTo(a),o(a)}}},l.queryLoginMethod=function(e){var t=this,r=n.Deferred(function(r){function i(t,r){for(var t=e.oauth_links,i=0;i<t.length;++i){var s=t[i],u=a()&&s.toplevel,c=u?'target="_blank" class="weblink login-type-button" ':'target="_top" class="login-type-button" ',l=u?"":"onclick=\"setTimeout(function() { window.postMessage({ msg:'linkclicked'}, '*');}, 1000);\" ";n('<div class="web-link-wrapper"> <a message="linkclicked" href="'+s.url+'" '+c+l+">"+o("Sign in using")+" "+s.name+"</a></div>").appendTo(r)}}function s(e,t){n('<div class="login-type-button"></div>').html(o("Sign in using email and password")).tapOrClick(function(){r.resolve("bw"),d()}).appendTo(t)}function l(e,t){n('<div class="login-type-button"></div>').html(o("Sign in using school account")).tapOrClick(function(){r.resolve("school"),d()}).appendTo(t)}function d(){removeEventListener("message",f),g.close()}function f(e){var n=e.data;n.hasOwnProperty("msg")&&"linkclicked"===n.msg&&(d(),r.resolve("oauth"))}var g=t.createDialog(r,!0),h=n('<div class="login-type-selection login-dialog-body"></div>'),p=u(e),v=e.oauth_links.length>0,m=null!==p;v&&i(e.oauth_links,h),m&&(c()||s(p,h),l(p,h)),g.show(h,o("Sign in")),window.postMessage({msg:"requestlogin"},"*"),addEventListener("message",f)}).promise();return r},l.queryBWCredentials=function(e){var t=this;return n.Deferred(function(r){function i(e,t){function i(){r.resolve({action:"login",school:"",username:u.val(),password:c.val()}),s()}var u=n('<input id="bw-email" placeholder="'+o("Email")+'" class="login-dialog-field"  tabindex="1">').appendTo(t),c=n('<input id="bw-password" type="password" placeholder="'+o("Password")+'" class="login-dialog-field" tabindex="2">').appendTo(t);n('<button class="login-dialog-button"  tabindex="3"></button>').html(o("Sign in")).tapOrClick(i).appendTo(t);var l=a(),d=l?'target="_blank" class="external-link" ':'target="_top" ',f=l?"":"onclick=\"setTimeout(function() { window.postMessage({ msg:'linkclicked'}, '*');}, 1000);\" ";e.hasOwnProperty("resetPasswordURL")&&n('<a href="'+e.resetPasswordURL+'" '+d+">"+o("Forgot password?")+"</a>").addClass("bw-reset-password").appendTo(t),e.hasOwnProperty("registerURL")&&n('<hr><p style="position: relative">Don\'t have an account?<br><a message="linkclicked" href="'+e.registerURL+'" '+d+f+">"+o("Sign up here")+"</a></p>").appendTo(t).find("a").addClass("bw-signup")}function s(){removeEventListener("message",c),l.close()}function c(e){var n=e.data;n.hasOwnProperty("msg")&&"linkclicked"===n.msg&&(s(),r.resolve({action:"signup"}))}var l=t.createDialog(r,!0),d=u(e),f=n('<div class="login-form login-dialog-body"></div>');i(d,f),l.show(f,o("Sign in")),window.postMessage({msg:"requestlogin"},"*"),addEventListener("message",c)}).promise()},l.querySchoolCredentials=function(t){var r=this;return n.Deferred(function(t){function i(){var n=c()?e.student_account_school.code:a.val();t.resolve({action:"login",school:n,username:d.val(),password:f.val()}),s()}function s(){u.close()}var a,u=r.createDialog(t,!0),l=n('<div class="login-form login-dialog-body"></div>');c()||(a=n('<input id="school-school" placeholder="'+o("School code")+'" class="login-dialog-field" tabindex="1">').appendTo(l));var d=n('<input id="school-username" placeholder="'+o("Username")+'" class="login-dialog-field" tabindex="2">').appendTo(l),f=n('<input id="school-password"  type="password" placeholder="'+o("Password")+'" class="login-dialog-field" tabindex="3">').appendTo(l);n('<button class="login-dialog-button"  tabindex="4"></button>').html(o("Sign in")).tapOrClick(i).appendTo(l),u.show(l,c()?e.student_account_school.name:o("Sign in")),window.postMessage({msg:"requestlogin"},"*")}).promise()},l.queryLogout=function(e,t,r,i){var s=this;return n.Deferred(function(a){function u(){c.close(),a.resolve()}var c=s.createDialog(a),l=n('<div id="offline-dialog" class="login-dialog-body"></div>');n("<p>"+t+"</p>").appendTo(l),n('<div id="login-current-user"></div>').html(r).appendTo(l),i||n('<div class="login-dialog-button"></div>').html(o("Sign out")).tapOrClick(u).appendTo(l),c.show(l,e)}).promise()},l.showMessage=function(e,r){return n.Deferred(function(n){t.showAlert(e,r,o("OK"),function(){n.resolve()})})},l.createPollingUI=function(e){var t=this.createDialog(null,!0),r=n('<div class="login-pollingdialog"></div>');return n("<p></p>").html(o("Waiting for account sign in to complete...")).appendTo(r),n('<div class="login-dialog-button"></div>').html(o("Cancel")).tapOrClick(e).appendTo(r),t.show(r,o("Waiting")),t},l}),bwdefine("studentaccount",["config","studentaccountui","bw/throbber","BWCredentialStorage","SynchronousTaskQueue","jquery","bw/dialog","bw/tr","bw/addWeblinkIFrame","bw/platform","bw/widget","bw/qs","bw/activeCredentials","bw/lti","bw/widgetsI18N"],function(e,n,t,o,r,i,s,a,u,c,l,d,f,g,h){function p(){return e.student_account_authrestrict&&"yes"===e.student_account_authrestrict}function v(){return"no"!==e.support_student_account||g.isLTI()||O}function m(e){var n=c.getPlatform();return"ibw-platform-ipad-ibooks"===n||"ibw-platform-ipad-ibooks-epub"===n?"ibooks-ios":"ibw-platform-ipad-bookwidgets"===n?c.isPreview()?"bwapp-preview":"bwapp":"ibw-platform-osx-ibooks"===n||"ibw-platform-osx-ibooks-epub"===n?"ibooks-osx":"ibw-platform-osx-preview"===n||"ibw-platform-win32-preview"===n?"bw-preview":"ibw-platform-android-chrome"!==n||e?c.isPreview()?"create-preview":c.isTopLevelPlay()?"play":"embed":"embed"}function w(e){return e.firstName&&""!=e.firstName&&e.lastName&&""!=e.lastName?e.firstName+" "+e.lastName:e.firstName&&""!=e.firstName?e.firstName:e.lastName&&""!=e.lastName?e.lastName:e.providerHumanID&&""!=e.providerHumanID&&e.providerHumanID!==e.providerID?e.providerHumanID:e.email&&""!=e.email?e.email.substring(0,e.email.indexOf("@")):e.providerID}var b={};b.INIT=-1,b.ANONYMOUS=0,b.OFFLINE=1,b.ONLINE=2;var S=d.getParameters(),y=g.isLTI(),O=S.sso,I=S.login_hint,k=d.getQueryParams(window.location.search).toplevel,N=y&&!k||S.no_logout,C=b.INIT;b.stateChangeCallbacks=[],b.registerStateChangeCallback=function(e){this.stateChangeCallbacks.push(e)},b.triggerStateChangeCallbacks=function(){for(var e=[],n=0;n<this.stateChangeCallbacks.length;++n)e.push(this.stateChangeCallbacks[n](C));return i.when.apply(null,e)},b.onlinecheck_enabled=!1;var T=null,_=2,A=_,L=20,P=null;return b.isStudentAccountsSupported=v,b.setCredentials=function(e,n){var t={username:w(e),userid:e.id,email:e.email,providerid:e.providerID,providerhumanid:e.providerHumanID,provider:e.provider,school:n,className:e.className,token:e.token,sid:null,coaccount:e.isCoAccount};f.setCredentials(t),o.setCredentials(f.credentials())},b.clearCredentials=function(){f.clear(),o.setCredentials(f.credentials())},b.loadCredentials=function(){return i.Deferred(function(e){o.getCredentials().done(function(n){null!==n?f.setCredentials(n):f.clear(),e.resolve(f.credentials())}).fail(function(){console.log("credentials load failure"),f.clear(),e.resolve(f.credentials())})}).promise()},b.getStudentInfo=function(n,t){var o=null,r=null,s=void 0!==n&&null!==n&&""!==n,a=void 0!==t&&null!==t&&""!==t;return s?r={Authorization:"BWWAAuthToken "+n}:a&&(o={sid:t}),i.ajax({type:"GET",dataType:"json",data:o,url:e.student_account_server+"/student/GetInfo",headers:r,timeout:1e4})},b.checkIfOnline=function(){if(!this.onlinecheck_enabled)return i.when();var e=i.Deferred(),n=f.getUserToken();return this.getStudentInfo(n,null).done(function(n){console.log("Got back online !"),b.goOnline(),e.resolve()}).fail(function(){e.reject()}),e},b.goOffline=function(e){console.log("goOffline");var n=this;r.pushAsyncFunc(function(){return console.log("Executing goOffline"),n.setState(b.OFFLINE)})},b.goOnline=function(e){console.log("goOnline");var n=this;r.pushAsyncFunc(function(){return console.log("Executing goOnline"),n.setState(b.ONLINE)})},b.scheduleOnlineCheck=function(){var e=this;A=Math.min(2*A,L),this.onlinecheck_enabled&&(T=setTimeout(function(){e.checkIfOnline().always(function(){e.scheduleOnlineCheck()})},1e3*A))},b.startOnlineCheck=function(){this.onlinecheck_enabled=!0,A=_,this.scheduleOnlineCheck()},b.stopOnlineCheck=function(){this.onlinecheck_enabled=!1,null!==T&&clearTimeout(T)},b.setState=function(e){return e===C?(console.log("Warning: setting identical storage state, ignoring"),i.when()):(C===b.OFFLINE&&this.stopOnlineCheck(),e===b.OFFLINE&&this.startOnlineCheck(),C=e,this.triggerStateChangeCallbacks())},b.setUserInfo=function(e,n){console.log("Log in successfull"),this.setCredentials(e,n),this.setState(this.ONLINE)},b.waitForExternalLogin=function(t,o){return o=o||2e3,i.Deferred(function(r){function s(){l=null;var n={sid:t.sid};console.log("Poll",t.sid),d=i.ajax({type:"GET",dataType:"json",data:n,url:e.student_account_server+"/student/GetInfo",timeout:1e4,success:function(e){d=null,c(),r.resolve(e)},error:function(e,n,t){if(d=null,"abort"!==n)if(401===e.status||0===e.status)try{0===e.status||"authenticating"===JSON.parse(e.responseText).auth.status?l=setTimeout(s,o):(c(),r.reject({msg:a("Authentication error.")}))}catch(e){c(),r.reject({msg:a("Server error when signing in.")})}else c(),r.reject({msg:a("Received error trying to sign in")+" ("+e.status+")"})}})}function u(){l&&clearTimeout(l),d&&d.abort(),c(),r.reject()}function c(){f.close()}var l=null,d=null,f=n.createPollingUI(u);s()}).promise()},b.serverLogin=function(n,t,o){return i.Deferred(function(r){var s={schoolCode:n,username:t,password:o};return i.ajax({type:"POST",data:s,url:e.student_account_server+"/student/Login",timeout:1e4}).done(function(e){r.resolve(e)}).fail(function(e){401==e.status?r.reject({msg:a("Wrong username or password, please try again.")}):r.reject({msg:a("Received error trying to sign in")+" ("+e.status+")"})})}).promise()},b.login=function(e,n,t){var o=this;return i.Deferred(function(r){"oauth"===n||"signup"===t.action?o.waitForExternalLogin(e).done(function(e){r.resolve(e)}).fail(function(e){r.reject(e)}):"login"===t.action?o.serverLogin(t.school,t.username,t.password).done(function(e){r.resolve(e,t.school)}).fail(function(e){r.reject(e)}):r.reject({msg:"Unsupported login action"})}).promise()},b.getLoginCredentials=function(e,t){return i.Deferred(function(o){"oauth"===t?o.resolve(e,t):"bw"===t?n.queryBWCredentials(e).done(function(n){o.resolve(e,t,n)}).fail(function(e){o.reject(e)}):"school"===t?n.querySchoolCredentials(e).done(function(n){o.resolve(e,t,n)}).fail(function(e){o.reject(e)}):o.reject({msg:"Unsupported login type: "+t})}).promise()},b.hasSchool=function(){return e.hasOwnProperty("student_account_school")&&e.student_account_school.hasOwnProperty("code")&&null!==e.student_account_school.code&&""!==e.student_account_school.code&&"null"!==e.student_account_school.code},b.selectLoginType=function(e){var t=this;return i.Deferred(function(o){var r=e.oauth_links.length>0;if(!r&&t.hasSchool())return void o.resolve(e,"school");if(O)for(var i=0;i<e.oauth_links.length;++i){var u=e.oauth_links[i];if(u.provider===O)return void s.navigateAlert(a("You need to be signed in to use this widget."),a("Please sign in"),a("OK"),u.url)}n.queryLoginMethod(e).done(function(n){o.resolve(e,n)}).fail(function(e){o.reject(e)})}).promise()},b.getLoginInfo=function(){var n=S.lfq?d.split(S.lfq):{};n.schoolCode=this.hasSchool()?e.student_account_school.code:"",O?n.providers=O:p()&&(n.providers=(e.student_account_authproviders||[]).join(",")),n.source=m(!!O),e.kmuserid&&""!=e.kmuserid&&(n.creator=e.kmuserid),"undefined"!=typeof bwshortcode&&(n.widget=bwshortcode),c.isIOS()&&(n.ios="1"),n.q=S.q;var o=t("body");return i.Deferred(function(t){i.ajax({type:"GET",dataType:"json",data:n,url:e.student_account_server+"/student/GetLoginForm",timeout:1e4}).done(function(e){o.close(),t.resolve(e)}).fail(function(e){o.close(),400==e.status?t.reject({msg:a("Widget configuration error: school doesn't exist.")}):t.reject({msg:a("Could not connect to server, check your internet connection.")})})}).promise()},b.reportFailure=function(e){return e&&e.hasOwnProperty("msg")?n.showMessage(e.msg,a("Sign in failed")):i.when(!0)},b.requestSignin=function(){var e=this;return i.Deferred(function(n){e.getLoginInfo().then(e.selectLoginType.bind(e)).then(e.getLoginCredentials.bind(e)).then(e.login.bind(e)).then(e.setUserInfo.bind(e)).then(function(){n.resolve(!1)}).fail(function(t){e.reportFailure(t).done(function(e){n.resolve(!e)})})}).promise()},b.showLoginStateInfo=function(){return C===b.OFFLINE?n.queryLogout(a("Offline"),a("You're currently offline and logged in as user:"),this.getUserName(),N):C===b.ONLINE?n.queryLogout(a("Online"),a("You're currently online and logged in as user:"),this.getUserName(),N):i.when()},b.loopLoginUntilOnline=function(e){var t=this;this.requestSignin().done(function(o){C===t.ONLINE?e.resolve():o?t.loopLoginUntilOnline(e):n.showMessage(a("You need to be signed in to use this widget."),a("Please sign in")).done(function(){t.loopLoginUntilOnline(e)})})},b.forceLogin=function(){var e=i.Deferred();return this.loopLoginUntilOnline(e),e},b.setAnonymousOrForceLogin=function(){g.isEmbeddedLTI()?this.loginLTI():"optional"===e.support_student_account?(this.setState(this.ANONYMOUS),P.resolve()):this.forceLogin().done(function(){P.resolve()})},b.initializeWithStoredCredentials=function(n){var o=this,r=n.token,i=n.sid,s=void 0!==r&&null!==r&&""!==r,a=void 0!==i&&null!==i&&""!==i;if(s===!1&&a===!1||v()&&this.hasSchool()&&e.student_account_school.code!==n.school)return void this.setAnonymousOrForceLogin();var u=t("body");o.getStudentInfo(r,i).done(function(e){return u.close(),!O||i||e.provider===O&&I&&0!=I.length&&(e.providerID===I||e.providerHumanID===I)?(o.setCredentials(e,n.school),o.setState(b.ONLINE),void P.resolve()):(console.log("Logged in with incompatible credentials. Re-login."),void o.setAnonymousOrForceLogin())}).fail(function(e){u.close(),console.log("Error getting student info -> either invalid token or wrong connection"),s&&401!==e.status?(o.setState(b.OFFLINE),P.resolve()):o.setAnonymousOrForceLogin()})},b.loginLTI=function(){var n=t("body"),o=this;i.ajax({type:"POST",data:{lti:d.urlencode(d.getParameters()),url:window.location.protocol+"//"+window.location.host+window.location.pathname,wa:e.WA,id:e.uuid2},headers:h.getAJAXHeaders(),url:e.student_account_server+"/student/Login",timeout:1e4}).then(function(e){n.close(),g.setEmbeddedLTIAuthenticated(),o.setCredentials(e,null),o.setState(b.ONLINE),P.resolve()},function(e){n.close();try{var t=JSON.parse(e.responseText);if("noLTILicense"==t.code)return o.setState(o.ANONYMOUS),void P.reject();if(null!=t.message&&t.message.length>0)return void s.showFatalAlert(t.message,a("Error"))}catch(e){}0===e.readyState?s.showFatalAlert(a("You need an internet connection to access this widget."),a("Error")):s.showFatalAlert(a("Error signing in."),a("Error"))})},b.initialize=function(){var e=this;i(function(){if(!v())return e.setState(e.ANONYMOUS),void P.resolve();var n=S.sid;return n?(console.log("Got SID from params"),history.replaceState("",document.title,window.location.pathname+window.location.search+d.removeQueryStringParameter(d.getHash(),"sid")),void e.initializeWithStoredCredentials({sid:n})):g.isEmbeddedLTI()&&!g.isEmbeddedLTIAuthenticated()?void e.loginLTI():!y&&c.isPreview()?(e.setState(e.ANONYMOUS),void P.resolve()):void e.loadCredentials().done(e.initializeWithStoredCredentials.bind(e))})},b.initialized=function(){return null===P&&(P=i.Deferred(),this.initialize()),P},b.logout=function(){return this.clearCredentials(),"optional"===e.support_student_account?this.setState(b.ANONYMOUS):(t("body"),window.location.reload(!1)),i.when().promise()},b.requestSignout=function(){return this.showLoginStateInfo().done(this.logout.bind(this))},b.getUserToken=function(){return f.getUserToken()},b.getUserSid=function(){return f.getUserSid()},b.getUserName=function(){return f.getUserName()},b.getUserClassName=function(){return f.getUserClassName()},b.getUserId=function(){return f.getUserId()},b.getEmail=function(){return f.getEmail()},b.getProviderId=function(){return f.getProviderId()},b.getProviderHumanId=function(){return f.getProviderHumanId()},b.isCoAccount=function(){return f.isCoAccount()},b.getState=function(){return C},b.hasProperty=function(e){return"user_id"===e},b.getProperty=function(e){if("user_id"==e)return this.getUserId()},b}),bwdefine("studentaccountbutton",["config","studentaccount","SynchronousTaskQueue","jquery","bw/tr","bw/widget","bw/platform","bw/dialog"],function(e,n,t,o,r,i,s,a){return{init:function(){function u(){return n.getState()===n.ANONYMOUS?n.requestSignin():n.requestSignout()}function c(){if(s.isPreview()){var o=n.hasSchool()?r("Students need school accounts associated with %(school)s (%(schoolCode)s) in order to sign in.").replace("%(school)s",e.student_account_school.name).replace("%(schoolCode)s",e.student_account_school.code)+"<br><br>":r("Any BookWidgets student account can be used to sign in.")+"<br><br>";a.showAlert(r("Your widget will require students to sign in.")+"<br><br>"+o+r("In widget preview mode sign in is not required / not supported."),r("Sign in not available"))}else t.pushAsyncFunc(u)}function l(e){var t="anonymous",s=r("Not signed in");switch(e){case n.OFFLINE:t="offline",s=r("You're offline");break;case n.ONLINE:t="online";var a=n.getUserName();a.indexOf("@")!=-1&&(a=a.substring(0,a.indexOf("@"))),s=a}var u=o("#loginbutton");if((u.html()!==s||u.attr("state")!==t)&&(u.html(s).attr({state:t}),e==n.OFFLINE||e==n.ONLINE)){var c=o(document.createElement("div")).addClass("login-change-wrapper").appendTo("#top-container"),l=u.clone();l.attr("id","login-change-alert").appendTo(c).fadeIn(400,"swing",function(){setTimeout(function(){l.fadeOut(400,"swing",function(){c.remove()})},1e3)}),u.effect&&u.effect("pulsate",{times:4},500)}i.centerTitle()}function d(){var e=o('<div id="loginbutton" class="loginbutton bw-tooltext"></div>');i.prependToTitleToolbar(e),l(n.ANONYMOUS),e.tapOrClick(c)}d(),n.initialized().then(function(){l(n.getState()),n.registerStateChangeCallback(l)},function(){l(n.ANONYMOUS),o("#loginbutton").hide()})}}}),bwdefine("onlinestorage",["config","studentaccount","jquery","blob"],function(e,n,t,o){function r(e,n){var t=e||{};for(var o in n){var r=n[o];null===r?delete t[o]:t[o]=r}return t}function i(o,r,i){t.ajax({type:"GET",dataType:"json",data:o,timeout:3e4,headers:{Authorization:"BWWAAuthToken "+n.getUserToken()},url:e.student_account_server+"/widget-storage/",connectTimeout:2e3,beforeSend:function(e,n){var t=this,o=n.xhr;n.xhr=function(){var e=o();return t.connectTimeoutCB=setTimeout(function(){console.log("Connection timeout occurred !"),e.abort()},t.connectTimeout),e.onreadystatechange=function(){1==this.readyState&&clearTimeout(t.connectTimeoutCB)},e}},success:r,error:i})}function s(o,r,i,s,a){var u={version:r,data:JSON.stringify(i)},c=n.getUserToken();t.ajax({type:"PUT",contentType:"text/plain",data:JSON.stringify(u),url:e.student_account_server+"/widget-storage/"+o,headers:{Authorization:"BWWAAuthToken "+c},timeout:3e4,connectTimeout:2e3,beforeSend:function(e,n){var t=this,o=n.xhr;n.xhr=function(){var e=o();return t.connectTimeoutCB=setTimeout(function(){console.log("Connection timeout occurred !"),e.abort()},t.connectTimeout),e.onreadystatechange=function(){1==this.readyState&&clearTimeout(t.connectTimeoutCB)},e}},success:s,error:a})}function a(a,u,c,l){function d(o,r){var i=n.getUserToken(),s={name:r};return t.ajax({type:"POST",data:s,url:e.student_account_server+"/widget-storage/"+o+"/resources",headers:{Authorization:"BWWAAuthToken "+i},timeout:3e4,connectTimeout:2e3,beforeSend:function(e,n){var t=this,o=n.xhr;n.xhr=function(){var e=o();return t.connectTimeoutCB=setTimeout(function(){console.log("Connection timeout occurred !"),e.abort()},t.connectTimeout),e.onreadystatechange=function(){1==this.readyState&&clearTimeout(t.connectTimeoutCB)},e}}})}function f(e,n,r){var i=new FormData,s=new o([r],{type:"image/jpeg"});return i.append("file",s),t.ajax({url:e,data:i,processData:!1,contentType:!1,type:"POST"})}var g={},h=null,p=-1,v=null;return g.loadAll=function(e){var t={"widget-id":c,"widget-type":a,"widget-name":u};"undefined"!=typeof bwshortcode&&(t["widget-shortcode"]=bwshortcode),i(t,function(n){h=n.id,p=n.version,v=JSON.parse(n.data);try{l?e(v.hasOwnProperty("DATA")?v.DATA:"",p):e(v,p)}catch(e){console.error("Error in widget load callback"),console.error(e)}},function(t){console.error("Got error reading widget data"),n.goOffline(),l?e(null,-1):e({},-1)})},g.overwrite=function(e,t){s(h,p,l?{DATA:e}:e,function(e){p=e.version,v=JSON.parse(e.data),t({status:"OK",data:l?v.hasOwnProperty("DATA")?v.DATA:null:v,version:p})},function(e,o,r){if(console.log("Got error putting widget data"),409==e.status){console.log("Conflict, someone wrote newer data");var i=JSON.parse(e.responseText);p=i.version,v=JSON.parse(i.data),t({status:"CONFLICT",data:l?v.hasOwnProperty("DATA")?v.DATA:null:v,version:p})}else n.goOffline(),t({status:"OFFLINE"})})},g.write=function(e,n){this.overwrite(l?e:r(v,e),n)},g.writeImage=function(e,n){var o=t.Deferred();return d(h,e).done(function(t){f(t.upload_url,e,n).done(function(){o.resolve()}).fail(function(){console.log("upload resource failed"),o.reject()})}).fail(function(){console.log("getting image url failed"),o.reject()}),o},g.readImage=function(o){var r=e.student_account_server+"/widget-storage/"+h+"/resources/"+o,i=n.getUserToken(),s=t.Deferred();return t.ajax({url:r,headers:{Authorization:"BWWAAuthToken "+i},type:"GET"}).done(function(e){t.ajax({url:e.url,type:"GET"}).done(function(e){s.resolve(e)}).fail(function(){s.reject()})}).fail(function(){s.reject()}),s},g.sync=function(e){e()},g}function u(e){function n(e,n){var t={"book-id":e};i(t,n,function(e){console.error("Got error reading widget data"),n({id:null,version:-1,data:"{}"})})}function t(){n("BWCommon",function(e){c=e.id,l=e.version,d=JSON.parse(e.data)})}function o(){n(e,function(e){f=e.id,g=e.version,h=JSON.parse(e.data)})}function a(e,n,t,o){s(e,n,t,function(e){o(e.version)},function(){})}var u={},c=null,l=-1,d=null,f=null,g=-1,h=null;return t(),o(),u.getCommonProperties=function(e){e(d)},u.getGroupProperties=function(e){e(h)},u.setCommonProperties=function(e){d=r(d,e),a(c,l,d,function(e){l=e})},u.setGroupProperties=function(e){h=r(h,e),a(f,g,h,function(e){g=e})},u}return{createWidgetStorage:a,createInfoStorage:u}}),bwdefine("writecachingonlinestorage",["studentaccount","onlinestorage","bwdsstorage","jquery"],function(e,n,t,o){function r(r,i,s,a,u,c,l){var d={};return d.os=n.createWidgetStorage(i,s,a,u),d.bs=t.createWidgetStorage(r,i,a,u,e.getUserId(),l,!1),d.loadAll=function(e){var n=o.Deferred(),t=o.Deferred();this.os.loadAll(function(e,t){n.resolve(e,t)}),this.bs.getVersion(function(e){t.resolve(e)});var r=this;o.when(n,t).done(function(n,t){var o=n[0],i=n[1];i==-1?(console.log("error accessing online data, return local data or null"),t.hasdata?r.bs.loadAll(e):e(u?null:{})):t.offlinedata===!1||t.version<i?r.bs.overwriteAndSetVersion(o,i).always(function(){e(o)}):r.bs.loadAll(function(n){r.os.overwrite(n,function(t){r.bs.setVersion(t.version).always(function(){e(n)})})})})},d.goneOnlineSync=function(e){var n=o.Deferred(),t=o.Deferred();
this.os.loadAll(function(e,t){n.resolve(e,t)}),this.bs.getVersion(function(e){t.resolve(e)});var r=this;o.when(n,t).done(function(n,t){var o=n[0],i=n[1];i==-1?console.log("goneOnlineSync: Can't find online version"):t.version<i?(console.log("goneOnlineSync: local version out of date, need to use online version"),r.bs.overwriteAndSetVersion(o,i).always(function(){e({status:"CONFLICT",data:o})})):t.offlinedata===!0?(console.log("goneOnlineSync: latest version is local, pushing state online"),r.bs.loadAll(function(n){r.os.overwrite(n,function(n){r.bs.setVersion(n.version).always(function(){e({status:"OK"})})})})):e({status:"OK"})})},d.write=function(e,n){var t=this;t.bs.write(e,function(){t.os.write(e,function(e){"undefined"!=typeof e&&e.hasOwnProperty("data")?t.bs.overwriteAndSetVersion(e.data,e.version).always(function(){n(e)}):n(e)})})},d.writeImage=function(e,n){var t=o.Deferred(),r=this;return r.bs.writeImage(e,n).done(function(){t.resolve(),r.os.writeImage(e,n).done(function(){r.bs.setImageBackedUp(e)}).fail(function(){})}).fail(function(){r.os.writeImage(e,n).done(function(){t.resolve()}).fail(function(){t.reject()})}),t},d.readImage=function(e){var n=o.Deferred(),t=this;return t.bs.readImage(e).done(function(e){n.resolve(e)}).fail(function(){t.os.readImage(e).done(function(e){n.resolve(e)}).fail(function(){n.reject()})}),n},d.moveImageOnline=function(e){var n=o.Deferred(),t=this;return t.bs.readImage(e).done(function(o){t.os.writeImage(e,o).done(function(){t.bs.setImageBackedUp(e),n.resolve()}).fail(function(){n.reject()})}).fail(function(){n.reject()}),n},d.moveImageOnlineIfRequired=function(){var e=o.Deferred(),n=this;return n.bs.listImagesAndBackupStatus().done(function(t){for(var o=0;o<t.length;++o)if(t[o].backed_up===!1)return void n.moveImageOnline(t[o].id).done(function(){e.resolve(!0)}).fail(function(){e.reject()});e.resolve(!1)}),e},d}function i(o){var r={};return r.os=n.createInfoStorage(o),r.bs=t.createInfoStorage(o,e.getUserId(),!1),r.getCommonProperties=function(e){var n=this;this.os.getCommonProperties(function(t){n.bs.setCommonProperties(t),e(t)})},r.getGroupProperties=function(e){var n=this;this.os.getGroupProperties(function(t){n.bs.setGroupProperties(t),e(t)})},r.setCommonProperties=function(e){this.os.setCommonProperties(e),this.bs.setCommonProperties(e)},r.setGroupProperties=function(e){this.os.setGroupProperties(e),this.bs.setGroupProperties(e)},r}return{createWidgetStorage:r,createInfoStorage:i}}),bwdefine("widgetstorage",["config","studentaccount","studentaccountbutton","bwdsstorage","writecachingonlinestorage","storagebusymarker","SynchronousTaskQueue","bw/throbber","jquery","bw/qs"],function(e,n,t,o,r,i,s,a,u,c){function l(e,n){return e!=-1&&e+n<3}function d(){L===C.STORAGE_ONLINE&&N.moveImageOnlineIfRequired().done(function(e){e&&d()})}function f(){var e=a("body"),n=u.Deferred();return i.start(),N.loadAll(function(t){i.end(),e.close(),b(t),d(),n.resolve()}),n}function g(){var e=u.Deferred();return i.start(),N.goneOnlineSync(function(n){i.end(),"CONFLICT"==n.status&&b(n.data),d(),e.resolve()}),e}function h(){var e=u.Deferred();N.loadAll(function(n){e.resolve()})}function p(e,n){var t=e||{};for(var o in n)t[o]=n[o];return t}function v(e){E?P=_?e:p(P,e):(P=e,E=!0)}function m(e){var n=u.Deferred();return D=!0,i.start(),N.write(e,function(e){i.end(),e&&"CONFLICT"==e.status&&b(e.data),D=!1,E?(E=!1,m(P).done(function(){n.resolve()})):n.resolve()}),n}function w(e){for(var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<e;o++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}var b,S,y,O,I,k,N,C={},T="",_=!1,A="no"!==e.save_answers;C.STORAGE_ANONYMOUS=0,C.STORAGE_OFFLINE=1,C.STORAGE_ONLINE=2;var N=null,L=-1;C.stateChanged=function(e){if(e==L)return console.log("Warning: setting identical storage state, ignoring"),u.when();switch(e){case C.STORAGE_ANONYMOUS:N=o.createWidgetStorage(O,y,k,_,"",T,A);break;case C.STORAGE_OFFLINE:N=o.createWidgetStorage(O,y,k,_,n.getUserId(),T,A);break;case C.STORAGE_ONLINE:N=r.createWidgetStorage(O,y,I,k,_,n.getUserId(),T)}var t=L;return L=e,l(t,e)?f():t==C.STORAGE_OFFLINE&&e==C.STORAGE_ONLINE?g():t==C.STORAGE_ONLINE&&e==C.STORAGE_OFFLINE?h():u.when()},C.init=function(o){var r=this;b=o.updateCallback,S=o.clearCallback,y=o.type,O=o.group,I=o.name,k=o.id,_=o.singleKey,T=o.extension,i.init(),n.initialized().then(function(){r.stateChanged(n.getState()),f(),n.registerStateChangeCallback(r.stateChanged.bind(r))},function(){r.stateChanged(n.ANONYMOUS),f()}),void 0===e.support_student_account&&alert("Incorrect schema.xml, must include studentaccountconfig.xml if widget depends on widgetstorage.js");var s=!!c.getParameters().hide_account;n.isStudentAccountsSupported()&&!s&&t.init()};var P,D=!1,E=!1;return C.write=function(e){null!==N&&(D?v(e):s.pushAsyncFunc(function(){return m(e)}))},C.registerImage=function(e){var n=u.Deferred(),t=new Date,o=t.getTime()+w(5);return N.writeImage(o,e).done(function(){n.resolve("bwimg:"+o)}).fail(function(){n.reject()}),n},C.getImageUrl=function(e){var n=u.Deferred();return 0==e.indexOf("bwimg:")?N.readImage(e.substring(6)).done(function(e){n.resolve(e)}).fail(function(){n.reject("")}):n.resolve(e),n},C.sync=function(e){s.pushSyncFunc(e)},C.clear=function(){},C}),bwdefine("studentinfo",["config","studentaccount","bwdsstorage","writecachingonlinestorage","jquery"],function(e,n,t,o,r){function i(e){return"student_name"==e||"student_email"==e||"student_id"==e}function s(i){if(c.resolve(),i==d)return console.log("Warning: setting identical storage state, ignoring"),r.when();var s=e.book_title&&""!==e.book_title?e.book_title:"_no_name_";switch(i){case n.ANONYMOUS:l=t.createInfoStorage(s,"",u);break;case n.OFFLINE:l=t.createInfoStorage(s,n.getUserId(),u);break;case n.ONLINE:l=o.createInfoStorage(s)}return d=i,r.when()}var a={},u="no"!==e.save_answers,c=r.Deferred();a.initialized=function(){return c};var l=null,d=-1;return a.get=function(e,t){function o(n){t(n[e])}d!=n.ANONYMOUS&&n.hasProperty(e)?t(n.getProperty(e)):u?i(e)?l.getCommonProperties(o):l.getGroupProperties(o):t(null)},a.set=function(e,t){if(d!=n.ANONYMOUS&&n.hasProperty(e))return void console.log("Request setting read-only property... skipping");if(u){var o={};o[e]=t,i(e)?l.setCommonProperties(o):l.setGroupProperties(o)}},a.hasStudentAccount=function(){return d==n.OFFLINE||d==n.ONLINE},a.getStudentAccountUserId=function(){return n.getUserId()},a.getStudentAccountUserName=function(){return n.getUserName()},a.getStudentAccountEmail=function(){return n.getEmail()},a.getStudentAccountProviderId=function(){return n.getProviderId()},a.getStudentAccountProviderHumanId=function(){return n.getProviderHumanId()},a.getStudentAccountToken=function(){return n.getUserToken()},a.getStudentAccountClassName=function(){return n.getUserClassName()},a.isCoAccount=function(){return n.isCoAccount()},n.initialized().then(function(){s(n.getState()),n.registerStateChangeCallback(s)},function(){s(n.ANONYMOUS)}),a});