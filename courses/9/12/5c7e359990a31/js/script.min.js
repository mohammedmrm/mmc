function getElementsByAttribute(e,t,n,o){for(var r,i,a="*"==t&&e.all?e.all:e.getElementsByTagName(t),s=new Array,c=void 0!==o?new RegExp("(^|\\s)"+o+"(\\s|$)","i"):null,l=0;l<a.length;l++)"string"==typeof(i=(r=a[l]).getAttribute&&r.getAttribute(n))&&i.length>0&&(void 0===o||c&&c.test(i))&&s.push(r);return s}function toggleClass(e,t){strHasClass(e.className,t)?removeClass(e,t):addClass(e,t)}function addRemoveClass(e,t,n){var o=e.className,r=!0;if(t)for(i=0;i<t.length;i++)strHasClass(o,t[i])||(r=!1,o+=(""==o?"":" ")+t[i]);if(n)for(var i=0;i<n.length;i++)strHasClass(o,n[i])&&(r=!1,o=strRemoveClass(o,n[i]));r||(e.className=o.trim())}function addClass(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])||(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(strHasClass(n,t))return;n+=(""==n?"":" ")+t}e.className=n}function removeClass(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])&&(o=!1,n=strRemoveClass(n,t[r]));if(o)return}else{if(!strHasClass(n,t))return;n=strRemoveClass(n,t)}""==(n=n.trim())?e.removeAttribute("class"):e.className=n}function getClassThatStartsWith(e,t){for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o].indexOf(t)>-1)return n[o]}function hasClass(e,t){return strHasClass(e.className,t)}function strHasClass(e,t){e||(e="");for(var n=e.trim().split(" "),o=0;o<n.length;o++)if(n[o]==t)return!0;return!1}function strRemoveClass(e,t){e||(e="");for(var n=e.trim().split(" "),o=0;o<n.length;o++)n[o]==t&&(n[o]=null);return n.join(" ")}function removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function randStr(e,t){return t||(t="s"),t+Math.random().toString(36).substring(5).substr(0,e)}function getDateTime(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),i=e.getMinutes(),a=e.getSeconds();if(1==n.toString().length)n="0"+n;if(1==o.toString().length)o="0"+o;if(1==r.toString().length)r="0"+r;if(1==i.toString().length)i="0"+i;if(1==a.toString().length)a="0"+a;return t+"/"+n+"/"+o+" "+r+":"+i+":"+a}function getFormData(e){e||(e={});var t=new FormData;for(var n in e)e[n]&&t.append(n,e[n]);return t}function newBlob(e,t){try{var n=new Blob([e],{type:t});return n}catch(r){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==r.name&&window.BlobBuilder){var o=new BlobBuilder;return o.append(e.buffer),n=o.getBlob(t)}if("InvalidStateError"==r.name)return n=new Blob([e.buffer],{type:t})}}function clone(e){if(null==e||"object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=clone(e[n]));return t}function rgb2hex(e){function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return/^#[0-9A-F]{6}$/i.test(e)?e:(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+t(e[1])+t(e[2])+t(e[3]):void 0}function timeOut(e,t){var n=setInterval(function(){clearInterval(n),e()},t);return n}function wrapNode(e,t){var n=document.createRange();n.selectNode(e),n.surroundContents(document.createElement(t))}function wrapNodeFromTo(e,t,n,o){var r=document.createRange();r.setStart(e,n),r.setEnd(e,o),r.surroundContents(document.createElement(t))}function XMLEscape(e,t){for(var n="",o=0;o<e.length;o++){var r=e.charAt(o);n+="&"==r?"&amp;":"'"==r?t?"&apos;":"&#39;":r}return n}function replaceHTML(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o}function kTemplate(e){return mobile?(config.overflowScroll?"templates/mobileOverflow/":"templates/mobile/")+e:"templates/web/"+e}function arrayContainsProperty(e,t,n){for(var o=0;o<e.length;o++)if(e[o][t]==n)return!0;return!1}function cacheBust(e){return!desktop||0!=e.indexOf("/")&&0!=e.indexOf("file://")&&0!=e.indexOf("chrome-extension://")?e+"?"+Math.floor(9999*Math.random()):e}function addPrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.addEventListener(o[r]+t,n,!1)}function removePrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.removeEventListener(o[r]+t,n,!1)}function redrawForChrome(e){-1!=navigator.userAgent.toLowerCase().indexOf("chrome")&&(e.style.display="inline-block",e.offsetHeight,e.style.display="")}function pauseVideoAndAudio(e){for(var t=e.getElementsByTagName("audio"),n=t.length;n--;)try{t[n].pause()}catch(e){}for(var o=e.getElementsByTagName("video"),n=o.length;n--;)try{o[n].pause()}catch(e){}}function isEmpty(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return JSON.stringify(e)===JSON.stringify({})}function asyncCheck(e,t,n,o){return e?o():(n.push(o),t.apply(this,n))}function autoprefixTransform(e,t){t||(t=""),e.style.transform=e.style.msTransform=e.style.webkitTransform=e.style.mozTransform=t}function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}var o=e.indexOf("Edge/");return o>0&&parseInt(e.substring(o+5,e.indexOf(".",o)),10)}function getImgDataSrc(e,t){var n=new XMLHttpRequest;n.open("GET",e),n.responseType="blob",n.onload=function(){var e=new FileReader;e.onloadend=function(){t&&t(e.result)},e.readAsDataURL(n.response)},n.send()}function isAbsoluteURLPath(e){return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||(0==e.trim().indexOf("data:")||void 0)))}function isAbsoluteURLAndNotDataPath(e){return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||void 0))}function isKotobeeHosted(){var e=window.location.href.split("://");if(!(e.length<=1))for(var t=e[1],n=["www.kotobee.com","kotobee.com","qa.kotobee.com","dev.kotobee.com","dev.kotobee.net","k.localhost"],o=0;o<n.length;o++){if(0==t.indexOf(n[o]+"/ebook"))return!0;if(0==t.indexOf(n[o]+"/library"))return!0;if(0==t.indexOf(n[o]+"/lti"))return!0}}function decodeHTMLEntities(e){for(var t=[["amp","&"],["apos","'"],["#x27","'"],["#x2F","/"],["#39","'"],["#47","/"],["lt","<"],["gt",">"],["nbsp"," "],["quot",'"']],n=0,o=t.length;n<o;++n)e=e.replace(new RegExp("&"+t[n][0]+";","g"),t[n][1]);return e}function addFormHiddenInput(e,t,n){var o=document.createElement("input");o.setAttribute("name",e),o.setAttribute("type","hidden"),o.setAttribute("value",t),n.appendChild(o)}function stopAllAudio(){for(var e=document.getElementsByTagName("audio"),t=0;t<e.length;t++)e[t].pause(),e[t].src="";try{document.bgAudio&&(document.bgAudio.pause(),document.bgAudio.src="")}catch(e){}}function applyPreview(e){var t=angular.element(document.body).scope();t.config=config=e,t.$apply(),angular.element(document.getElementById("home")).scope().injectUserCSS(e)}function previewPage(e,t){var n=angular.element(document.body).scope();n.previewPage&&n.previewPage(e,t)}function getCookie(e){var t=("; "+document.cookie).split("; "+e+"=");if(2==t.length)return t.pop().split(";").shift()}function getVar(e){return Modernizr.localstorage?localStorage[e]:getCookie("continueWithoutHTML5")}function setVar(e,t){Modernizr.localstorage?localStorage[e]=t:document.cookie=e+"="+t}function getGlobal(){return angular.element(document.body).scope()}function putTest(e){return}function continueLocally(){setVar("continueLocally","true"),location.reload()}function continueWithoutHTML5(){setVar("continueWithoutHTML5","true"),location.reload()}function kInteractionStart(){this.log=function(e){},kInteractive.setDOMParser(),kInteractive.preRender(),kInteractive.postRender()}function kInteractionStartSingleElem(e){kInteractive.setDOMParser(),kInteractive.preRender(e,!0),kInteractive.postRender(e,!0)}!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser),ph={},ph.removeHash=function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},ph.getHash=function(e){if(e.indexOf("#")>=0)return e.substr(e.lastIndexOf("#")+1)},ph.normalize=function(e){var t=ph.normalizedArray(e).join("/");return arguments.length&&"/"==arguments[0].substr(0,1)&&(t="file:///"+t),t},ph.normalizedArray=function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t},ph.basename=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1]},ph.removeFilename=function(e){var t=ph.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},ph.removeExtension=function(e){if(-1==e.indexOf("."))return e;var t=e.split(".");return t.splice(t.length-1,1),t.join(".")},ph.getExtension=function(e){if(-1==e.indexOf("."))return"";var t=e.split(".");return t[t.length-1]},ph.dirname=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1].indexOf(".")>=0&&t.splice(t.length-1,1),1==t.length?t[0]:t[t.length-1]},ph.relative=function(e,t){var n,o,r=ph.normalizedArray(e),i=ph.normalizedArray(t),a=new Array;for(r[r.length-1].indexOf(".")>=0&&r.splice(r.length-1,1),n=0;n<r.length&&r[n]==i[n];n++);for(o=n;o<r.length;o++)a.push("..");for(o=n;o<i.length;o++)a.push(i[o]);return a.join("/")},ph.join=function(){for(var e=new Array,t=0;t<arguments.length;t++){var n=ph.normalizedArray(arguments[t]);t<arguments.length-1&&!isAbsoluteURLPath(n[n.length-1])&&n[n.length-1].indexOf(".")>=0&&n.splice(n.length-1,1),e=e.concat(n)}var o=ph.normalize(e.join("/"));return"/"==arguments[0].substr(0,1)&&(o=desktop?"file:////"+o:"/"+o),o},ph.parent=function(e){e=ph.removeFilename(e);var t=ph.normalizedArray(e);t.splice(t.length-1,1);var n=t.join("/");return arguments.length&&"/"==arguments[0].substr(0,1)&&(n="/"+n),n};var startDate=Date.now(),log=function(e){debug&&(null==e&&(e="null"),debugDuration&&(e=Date.now()-startDate+" "+e))},Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(e){var t=e.length/4*3,n=new ArrayBuffer(t);return this.decode(e,n),n},decode:function(e,t){var n=this._keyStr.indexOf(e.charAt(e.length-1)),o=this._keyStr.indexOf(e.charAt(e.length-2)),r=e.length/4*3;64==n&&r--,64==o&&r--;var i,a,s,c,l,d,u,p=0,f=0;for(i=t?new Uint8Array(t):new Uint8Array(r),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),p=0;p<r;p+=3)a=this._keyStr.indexOf(e.charAt(f++))<<2|(l=this._keyStr.indexOf(e.charAt(f++)))>>4,s=(15&l)<<4|(d=this._keyStr.indexOf(e.charAt(f++)))>>2,c=(3&d)<<6|(u=this._keyStr.indexOf(e.charAt(f++))),i[p]=a,64!=d&&(i[p+1]=s),64!=u&&(i[p+2]=c);return i}},currentIndex,parser=new DOMParser,preview,previewParams,app,mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),mobileDebug=!1,ios=/iPhone|iPad|iPod/i.test(navigator.userAgent),debug=!1,native,bookPath,noFlash,desktop,chromeApp,os,uuid,partitionEnabled="Android"==mobile&&config.kotobee.segregate,isKotobee=!0,debugDuration=!1,swipeMode="chapter",parseSecsSeparate=!0,overflowScroll=!mobile|config.overflowScroll,rootDir="",postOptions={transformRequest:angular.identity,headers:{"Content-Type":void 0}};null==config.mediaTab&&(config.mediaTab=!0),null==config.settingsTab&&(config.settingsTab=!0),null==config.notebookTab&&(config.notebookTab=!0),null==config.textSizeControls&&(config.textSizeControls=!0),null==config.chaptersTab&&(config.chaptersTab=!0),null==config.showCategories&&(config.showCategories=!0),null==config.styleControls&&(config.styleControls=!1),function(){function e(){for(var e=document.getElementsByTagName("head")[0],t=e.innerHTML,n=[],o=[],r=document.getElementsByTagName("script"),i=0;i<r.length;i++)if(r[i].getAttribute("src")&&r[i].getAttribute("src").indexOf("lib/ionic/release/js")>=0){var a=r[i].getAttribute("src").split("lib/ionic/release/js");rootDir=a[0];break}n=[rootDir+"lib/ionic/release/css/ionic.min.css"];for(i=0;i<o.length;i++)t+='<script src="'+o[i]+'"><\/script>';for(i=0;i<n.length;i++)t='<link rel="stylesheet" href="'+n[i]+'">'+t;e.innerHTML=t}function t(){var e=document.getElementsByTagName("body");e.length?addClass(e[0],"ie"):timeOut(t,100)}if(detectIE()&&t(),window.location.href.indexOf("?preview")>0){preview=!0,mobileDebug=!0;var n=window.location.href.split("?");n=n[1].split("&"),previewParams={};for(var o=0;o<n.length;o++){var r=n[o].split("=");previewParams[r[0]]=r[1]}mobile=previewParams.mobile}else{if(config.gAnalyticsID){var i="";isKotobeeHosted()&&(i="/bundles/vijualib/templates/reader/public/");var a="";(native||desktop)&&(a="ga('set','checkProtocolTask',null);ga('set','anonymizeIp',true);ga('set','forceSSL',true)");var s="'auto'";native?s="{'storage':'none','clientId':device.uuid}":desktop&&(s="{'storage':'none'}");var c=document.createElement("script");c.innerHTML="(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','"+i+"lib/gAnalytics/analytics.js','ga');ga('create', '"+config.gAnalyticsID+"', "+s+");"+a;var l=document.getElementsByTagName("head");l.length&&l[0].appendChild(c)}if("file:"==window.location.protocol||"undefined"!=typeof require){if(mobile)native=!0;else if("undefined"!=typeof require)desktop=!0,os="mac",process.env.OS&&process.env.OS.toLowerCase().indexOf("windows")>=0&&(os=process.env.PROCESSOR_ARCHITECTURE.indexOf("64")>=0?"win64":"win32");else if(window.chrome&&chrome.app&&chrome.app.runtime&&chrome.storage){try{if(!chromeEnabled)return}catch(e){return}chromeApp=!0}else if("true"!=getVar("continueLocally"))return timeOut(function(){document.getElementById("localFallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e()}else"chrome-extension:"==window.location.protocol&&(chromeApp=!0)}if(!chromeApp){if("true"!=getVar("continueWithoutHTML5")&&!(Modernizr.audio&&Modernizr.video&&Modernizr.backgroundsize&&Modernizr.borderradius&&Modernizr.canvas&&Modernizr.opacity&&Modernizr.localstorage&&Modernizr.rgba))return timeOut(function(){document.getElementById("html5Fallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e();setVar("continueLocally","false"),setVar("continueWithoutHTML5","false")}e(),angular.module("ngIOS9UIWebViewPatch",["ng"]).config(["$provide",function(e){"use strict";e.decorator("$browser",["$delegate","$window",function(e,t){return function(e){return/(iPhone|iPad|iPod).* OS 9_\d/.test(e)&&!/Version\/9\./.test(e)}(t.navigator.userAgent)?function(e){function t(){n=null}var n=null,o=e.url;return e.url=function(){return arguments.length?(n=arguments[0],o.apply(e,arguments)):n||o.apply(e,arguments)},window.addEventListener("popstate",t,!1),window.addEventListener("hashchange",t,!1),e}(e):e}])}]),app=angular.module("reader.Kotobee",["templates","ionic","angular.css.injector","scormwrapper","ngIOS9UIWebViewPatch"]),ionic.Platform.isFullScreen=!1,app.config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider","$compileProvider",function(e,t,n,o){(chromeApp||desktop)&&(o.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),o.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|chrome-extension):/)),n.views.swipeBackEnabled(!1),t.otherwise("/loading"),e.state("home",{url:"/loading",templateUrl:kTemplate("views/home.html")}).state("login",{url:"/login",templateUrl:kTemplate("views/login.html")}).state("register",{url:"/register",templateUrl:kTemplate("views/register.html")}).state("forgotPwd",{url:"/forgotpwd",templateUrl:kTemplate("views/forgotPwd.html")}).state("redeemCode",{url:"/redeemcode",templateUrl:kTemplate("views/redeemCode.html")}).state("library",{url:"/library",templateUrl:kTemplate("views/library.html")}).state("library_tab",{url:"/library/tab/:tab",templateUrl:kTemplate("views/library.html")}).state("reader",{url:"/reader",templateUrl:kTemplate("views/reader.html")}).state("reader.chapter",{url:"/chapter/:ch",templateUrl:kTemplate("views/reader.html")}).state("reader.chapterhash",{url:"/chapter/:ch/:hash",templateUrl:kTemplate("views/reader.html")}).state("libraryreader",{url:"/book/:book/reader",templateUrl:kTemplate("views/reader.html")}).state("libraryreader.chapter",{url:"/chapter/:ch",templateUrl:kTemplate("views/reader.html")}).state("libraryreader.chapterhash",{url:"/chapter/:ch/:hash",templateUrl:kTemplate("views/reader.html")}).state("app",{url:"/app",templateUrl:kTemplate("views/app.html")})}]),putTest("prerun timeout start"),window.setTimeout(function(){putTest("prerun timeout found!!")},300),app.run(["$ionicPlatform","$location","chapters","library",function(e,t,n,o){var r=t.path();if(0==r.indexOf("/book/")&&(a=(i=r.split("/book/")[1]).split("/")).length>0&&(o.startBook=Number(a[0])),r.indexOf("/reader/chapter/")>=0){var i=r.split("/reader/chapter/")[1],a=i.split("/");a.length>0&&(n.startChapter=Number(a[0])),a.length>1&&(n.startHash=a[1])}t.path("/loading"),e.ready(function(){try{try{ios||StatusBar&&(StatusBar.overlaysWebView(!1),StatusBar.backgroundColorByHexString("#2c1c3c"))}catch(e){}try{document.addEventListener("deviceready",function(){},!1)}catch(e){}try{navigator.splashscreen&&setTimeout(function(){navigator.splashscreen.hide()},1e3)}catch(e){}putTest("app 1"),putTest(setTimeout),putTest(window.setTimeout),putTest(window.setTimeout==setTimeout),window.setTimeout(function(){putTest("timeout A")},100),putTest("app 1b"),window.setTimeout(function(){putTest("timeout B")},300),putTest("app 1c"),setTimeout(function(){putTest("timeout C")},600),putTest("app 1d"),window.setTimeout(function(){putTest("timeout D")},600),putTest("app 1e"),setTimeout(function(){putTest("app 1a");try{cordova,window.cordova,cordova.plugins,window.cordova.plugins;putTest("app 2")}catch(e){putTest("app 3")}putTest("app 4"),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),putTest("app 5"),window.StatusBar&&StatusBar.styleDefault(),putTest("app 6"),putTest(angular.element(document.body).scope().start),angular.element(document.body).scope().start(),putTest("app 7")},native?1e3:0),putTest("setTimeout called")}catch(e){putTest("in catch"),putTest(e)}})}])}();var kInteractive={scormWrapper:null,preRender:function(e,t){new DOMParser;var n,o=e||document;t?(n=[e],o=document):n=o.getElementsByClassName("kInteractive");for(var r=n.length;r--;){var i=n[r];if(this.hasClass(i,"gallery")){var a=o.createDocumentFragment(),s=kInteractive.readData(i);if(!s)continue;i.innerHTML="";var c=document.createElement("div");c.className="imgMask";var l=document.createElement("div");l.className="images "+s.scale,c.appendChild(l);for(I=0;I<s.imgs.length;I++){var d=document.createElement("div");d.className="imgContainer"+(I?"":" selected");X=void 0===isKotobee?s.imgs[I].path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,s.imgs[I].path);d.setAttribute("style","background-color:"+s.bgColor+";background-image:url('"+X+"')"+(I?"":";display:block")),s.imgs[I].caption&&d.setAttribute("data-caption",s.imgs[I].caption),l.appendChild(d)}a.appendChild(c);var u=document.createElement("div");u.className="imgCaption";var p=document.createElement("div");p.className="inner",s.imgs[0]&&s.imgs[0].caption&&(p.innerHTML=s.imgs[0].caption),u.appendChild(p),a.appendChild(u);var f=document.createElement("a");f.className="next btn ki-btn",1==s.imgs.length&&(f.className+=" disable"),a.appendChild(f);var m=document.createElement("a");m.className="prev btn ki-btn disable",a.appendChild(m),void 0===isKotobee&&(f.addEventListener("click",this.actionEvent),m.addEventListener("click",this.actionEvent));K=document.createElement("div");s.style&&kInteractive.c.addClass(K,s.style),K.appendChild(a),i.appendChild(K)}if(this.hasClass(i,"questions")){var a=o.createDocumentFragment(),g=kInteractive.readData(i);if(!g)continue;var h=g.dict,v=g.userDict;h||(h={}),v||(v=h),g.options||(g.options={}),i.id||(i.id="ki-qs-"+r+"-"+Math.ceil(1e3*Math.random()));if(i.innerHTML="",g.layout&&g.layout.popup&&!this.hasClass(i,"inpopup")){var b=document.createElement("img"),k=g.layout.popupImg;b.src=k,a.appendChild(b),void 0===isKotobee&&b.addEventListener("click",this.actionEvent),i.appendChild(a);continue}if(g.options.randomize){for(I=0;I<g.q.length;I++)g.q[I].origin=I;for(var y,w,C=g.q.length;0!==C;)w=Math.floor(Math.random()*C),C-=1,y=g.q[C],g.q[C]=g.q[w],g.q[w]=y}if(g.options.questionsDisplayed){var E=Number(g.options.questionsDisplayed);g.q=g.q.slice(0,E)}if(g.title){var x=document.createElement("span");x.innerHTML="<h4>"+kInteractive.escapeHtml(g.title)+"</h4>",a.appendChild(x)}for(var I=0;I<g.q.length;I++){var T=g.q[I],S=document.createElement("div");if(S.className="ques",null!=T.origin&&S.setAttribute("data-o",T.origin),S.innerHTML="<p><strong><span class='no'>"+(I+1)+"</span> "+kInteractive.escapeHtml(T.q)+"</strong></p>",T.path){var A=document.createElement("img");A.src=T.path,S.appendChild(A)}if("sa"==T.type){var N=T.lines?T.lines:1,B=document.createElement(N>1?"textarea":"input");B.name="sa-"+I,1==N?B.type="text":B.rows=T.lines?T.lines:1,B.className="ans txtfield";$="ki-sa-"+r+"-"+I;B.id=$,document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[I]&&(B.value=document[i.id].q[I]),S.appendChild(B)}else if("mcq"==T.type||"mmcq"==T.type)for(var L=T.c,O=0;O<L.length;O++){var $="ki-mcq-"+r+"-"+I+"-"+O,M=document.createElement("input");"mmcq"==T.type?(M.name="name",M.type="checkbox"):(M.name="mcq-"+I,M.type="radio"),M.className="ans",M.id=$,(_=document.createElement("label")).htmlFor=$,_.innerHTML=" "+kInteractive.escapeHtml(L[O].t)+"<br/>",_.className="ki-noHighlight",(P=document.createElement("div")).className="answer",document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[I]&&(M.checked=document[i.id].q[I][O],g.options&&g.options.highlightCorrect&&g.q[I].c[O].a&&kInteractive.c.addClass(P,"correct")),P.appendChild(M),P.appendChild(_),S.appendChild(P)}else if("tf"==T.type)for(O=0;O<2;O++){var $="ki-tf-"+r+"-"+I+"-"+O,H=document.createElement("input");H.type="radio",H.name="tf-"+I,H.className="ans",H.id=$,(_=document.createElement("label")).htmlFor=$,T.choice1&&T.choice2?_.innerHTML=kInteractive.escapeHtml(" "+(0==O?T.choice1:T.choice2)):_.innerHTML=" "+(0==O?"True":"False"),_.className="ki-noHighlight";var P=document.createElement("div");document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[I]&&(H.checked=document[i.id].q[I][O],g.options&&g.options.highlightCorrect&&(0==O&&g.q[I].a||1==O&&!g.q[I].a)&&kInteractive.c.addClass(P,"correct")),P.appendChild(H),P.appendChild(_),S.appendChild(P)}if((W=document.createElement("p")).className="separator",S.appendChild(W),document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[I]){if(g.q[I].exp&&!S.getElementsByClassName("explanation").length){var D=document.createElement("p");D.className="explanation",D.innerHTML=kInteractive.escapeHtml(g.q[I].exp),kInteractive.appendAfterDelay(S,D)}if(g.q[I].ref&&!S.getElementsByClassName("reference").length){var R=document.createElement("a");R.className="reference",R.innerHTML=v.learnMode?v.learnMode:"Learn more",R.setAttribute("href",kInteractive.escapeHtml(g.q[I].ref)),R.setAttribute("target","_blank"),kInteractive.appendAfterDelay(S,R)}}a.appendChild(S)}if(g.options.emailForm){var F=document.createElement("div");F.setAttribute("class","emailForm"),function(e,t,n){var o=document.createElement("div");o.className="address",o.innerHTML="<p><strong>"+e+"</strong><em>"+t+"</em></p>";var r=document.createElement("input");r.name=n,r.type="text",r.className="txtfield",o.appendChild(r);var i=document.createElement("p");i.className="separator",o.appendChild(i),F.appendChild(o)}(v.recipientEmail?v.recipientEmail:"Recipient email",v.separateEmails?v.separateEmails:"Separate multiple emails with commas","recipientEmail"),a.appendChild(F)}var z=null;if("none"!=g.action){var j="ki-"+r+"-btn";(z=document.createElement("input")).type="submit",z.value=v.submit?v.submit:"Submit Answers",z.id=j,z.className="btn ki-btn ki-mcq"}var q=null,U=null;if(g.options&&(g.options.clearAnswers&&((q=document.createElement("input")).type="submit",q.value=v.clear?v.clear:"Clear Answers",q.className="btn ki-btn ki-questions questions-clear",void 0===isKotobee&&q.addEventListener("click",this.actionEvent)),g.options.addToNotebook&&((q=document.createElement("input")).type="submit",q.value=v.notebook?v.notebook:"Save to Notebook",q.className="btn ki-btn ki-questions questions-notebook",void 0===isKotobee&&q.addEventListener("click",this.actionEvent)),g.options.preserveAnswers)){(U=document.createElement("div")).style.marginTop="5px";var V=document.createElement("input");V.type="checkbox",V.name="preserveAnswers",V.className="ki-btn ki-questions questions-preserve",V.id="ki-"+r+"-preserveAnswersBtn",document[i.id]&&(V.checked=document[i.id].preserve),U.appendChild(V);var _=document.createElement("label");_.htmlFor=V.id,_.innerHTML=" "+(v.preserve?v.preserve:"Preserve submitted answers"),_.className="ki-noHighlight",U.appendChild(_),void 0===isKotobee&&V.addEventListener("change",this.actionEvent)}void 0===isKotobee&&z&&z.addEventListener("click",this.actionEvent),z&&a.appendChild(z),a.appendChild(document.createTextNode(" ")),q&&a.appendChild(q),U&&a.appendChild(U);var W=document.createElement("p");W.className="separator",a.appendChild(W),g.options.rtl?(i.style.direction="rtl",kInteractive.c.addClass(i,"rtl")):i.style.direction="ltr";var K=document.createElement("div");g.style&&kInteractive.c.addClass(K,g.style),K.appendChild(a),i.appendChild(K)}if(this.hasClass(i,"image")){if(i.parentNode&&this.hasClass(i.parentNode,"link"))continue;void 0===isKotobee&&i.addEventListener("click",this.actionEvent)}if(this.hasClass(i,"link")){var Y=kInteractive.readData(i);if(!Y)continue;if("undefined"!=typeof editorMode&&editorMode)continue;if("div"==i.nodeName.toLowerCase()){var J=document.createElement("a");J.setAttribute("href","popup"==Y.type?"":i.getAttribute("href")),J.setAttribute("target",Y.target),J.setAttribute("style",i.getAttribute("style")),J.setAttribute("data-kotobee",i.getAttribute("data-kotobee")),J.className="kInteractive link btn",J.style.opacity=Number(Y.transparency)/100,i.parentNode.replaceChild(J,i),i=J}void 0===isKotobee&&("popup"!=Y.type&&"audio"!=Y.type||i.setAttribute("onclick","return false;"),i.addEventListener("click",this.actionEvent))}if(this.hasClass(i,"container")){var G=kInteractive.readData(i);if(!G)continue;if(G.path){var X=G.path;void 0!==isKotobee&&(X=ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,G.path));var Z=i.getAttribute("style");i.setAttribute("style",Z+' background-image:url("'+X+'");')}kInteractive.isMobile()&&(i.style.minHeight=i.style.height,i.style.height="auto",i.style.overflowY=null)}}},clearAudioVideo:function(e){var t=e||document;kInteractive.stopCurrentMedia();for(var n=t.getElementsByTagName("audio"),o=n.length;o--;)try{if(n[o].hasAttribute("data-dontclose"))continue;n[o].pause(),n[o].children.length||(n[o].src="")}catch(e){}for(var r=t.getElementsByTagName("video"),o=r.length;o--;)r[o].pause(),r[o].children.length||(r[o].src="")},postRender:function(e,t){kInteractive.videoIsFullscreen=!1,kInteractive.timestamp=new Date,kInteractive.currentVideo=kInteractive.currentAudio=null,kInteractive.clearAudioVideo(e);var n,o=e||document;t?(n=[e],o=document):n=o.getElementsByClassName("kInteractive");for(var r=n.length;r--;){var i=n[r];if(this.hasClass(i,"questions")){var a=kInteractive.readData(i);if(!a)continue;var s=a.dict,c=a.userDict;s||(s={}),c||(c=s);for(var l=i.getElementsByClassName("ques"),d=i.getElementsByClassName("explanation"),u=d.length;u--;)d[u].parentNode.removeChild(d[u]);for(var p=i.getElementsByClassName("reference"),u=p.length;u--;)p[u].parentNode.removeChild(p[u]);for(var f=0;f<l.length;f++){var m=l[f].getElementsByClassName("ans"),g=(m.length,f);if(a.options.randomize&&(g=Number(l[f].getAttribute("data-o"))),document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[g]){if(a.q[g].exp&&!l[f].getElementsByClassName("explanation").length){var h=document.createElement("p");h.className="explanation",h.innerHTML=kInteractive.escapeHtml(a.q[g].exp),kInteractive.appendAfterDelay(l[f],h)}if(a.q[g].ref&&!l[f].getElementsByClassName("reference").length){var v=document.createElement("a");v.className="reference",v.innerHTML=c.learnMode?c.learnMode:"Learn more",v.setAttribute("href",kInteractive.escapeHtml(a.q[g].ref)),v.setAttribute("target","_blank"),kInteractive.appendAfterDelay(l[f],v)}}for(u=0;u<m.length;u++)kInteractive.c.removeClass(m[u].parentNode,"correct"),m[u].getAttribute("id").indexOf("ki-tf-")>=0?document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[g]&&(m[u].checked=document[i.id].q[g][u],a.options&&a.options.highlightCorrect&&(0==u&&a.q[g].a||1==u&&!a.q[g].a)&&kInteractive.c.addClass(m[u].parentNode,"correct")):m[u].getAttribute("id").indexOf("ki-sa-")>=0?document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[g]&&(m[u].value=document[i.id].q[g]):document[i.id]&&document[i.id].preserve&&document[i.id].q&&document[i.id].q[g]&&(m[u].checked=document[i.id].q[g][u],a.options&&a.options.highlightCorrect&&a.q[g].c[u].a&&kInteractive.c.addClass(m[u].parentNode,"correct"));if(document[i.id]){var b=i.getElementsByClassName("questions-preserve");b.length&&(b[0].checked=document[i.id].preserve)}}}else if(this.hasClass(i,"widget")){var k=o.createDocumentFragment(),y=kInteractive.readData(i);if(!y)continue;var w=y.name,C=y.src,E=y.width,x=y.height;if("page"==y.mode){if(i.children.length)continue;var I=document.createElement("div");I.className="cover",k.appendChild(I),y.interaction&&(I.style.pointerEvents="none");var T=document.createElement("div");T.className="iframeContainer";var S=document.createElement("iframe");S.setAttribute("nwdisable","true"),S.setAttribute("nwfaketop","true"),S.setAttribute("width",i.style.width?i.style.width:E+y.widthUnit),S.setAttribute("height",i.style.height?i.style.height:x+"px"),S.src=kInteractive.getWidgetUrl(y),T.appendChild(S),k.appendChild(T);var A=i.style.width,N=i.style.height;A.indexOf("px")>=0&&(y.widthUnit="px"),A.indexOf("%")>=0&&(y.widthUnit="%");try{y.widthUnit?y.width=Number(A.split(y.widthUnit)[0]):y.width=Number(A)}catch(e){y.width=Number(A)}try{y.height=Number(N.split("px")[0])}catch(e){y.height=Number(N)}kInteractive.writeData(i,y)}else{if(i.setAttribute("wdgt-src",C),i.setAttribute("wdgt-name",w),!i.children.length&&!i.innerHTML.trim()){var B=document.createElement("img");B.src=kInteractive.getWidgetHome(y)+"/"+w+"/Icon.png",k.appendChild(B)}void 0===isKotobee&&i.addEventListener("click",this.actionEvent)}i.appendChild(k)}else if(this.hasClass(i,"video")){var k=o.createDocumentFragment(),L=kInteractive.readData(i);if(!L)continue;var O="";if(L.splash&&(O=void 0===isKotobee?L.splash:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,L.splash)),O){i.style.backgroundImage=null;var $=i.style.cssText;i.setAttribute("style","background-image:url('"+O+"');"+$)}i.setAttribute("id","ki-video-"+r),i.innerHTML="",(H=document.createElement("div")).setAttribute("id","ki-video-"+r+"-container"),H.className="container";D=document.createElement("div");L.style&&kInteractive.c.addClass(D,L.style),(P=document.createElement("a")).className="playBtn ki-btn",P.appendChild(document.createElement("span")),void 0===isKotobee&&P.addEventListener("click",this.actionEvent),k.appendChild(P),k.appendChild(H),D.appendChild(k),i.appendChild(D),L.autoplay&&kInteractive.action(i)}else if(this.hasClass(i,"audio")){var k=o.createDocumentFragment(),M=kInteractive.readData(i);i.setAttribute("id","ki-audio-"+r),i.innerHTML="";var H=document.createElement("div");H.setAttribute("id","ki-audio-"+r+"-container"),H.className="container";var P=document.createElement("a");P.className="playBtn ki-btn",P.appendChild(document.createElement("span")),void 0===isKotobee&&P.addEventListener("click",this.actionEvent);var D=document.createElement("div");M.style&&kInteractive.c.addClass(D,M.style),k.appendChild(P),k.appendChild(H),D.appendChild(k),i.appendChild(D)}else if(this.hasClass(i,"threed")){var k=o.createDocumentFragment(),R=kInteractive.readData(i);if(!R)continue;i.innerHTML="";var F=i.getAttribute("style");R.inter.placeholderPath&&(F+="background-image:url('"+(void 0===isKotobee?R.inter.placeholderPath:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,R.inter.placeholderPath))+"');"),i.setAttribute("style",F);var z=document.createElement("a");R.inter.includeMsg?(z.innerHTML=kInteractive.escapeHtml(R.inter.msg),z.className="msgBtn ki-btn"):z.className="invisibleBtn ki-btn",k.appendChild(z),void 0===isKotobee&&z&&z.addEventListener("click",this.actionEvent),i.appendChild(k)}else if(this.hasClass(i,"gallery"));else if(this.hasClass(i,"image")){var j=kInteractive.readData(i);if(!j)continue;j&&(j.behavior&&"none"!=j.behavior||(i.style.transition=i.style.webkitTransition=i.style.mozTransition="none"))}}this.firstRun&&(window.addEventListener("resize",function(n){kInteractive.resizeEvent(e,t)}),this.firstRun=!1),kInteractive.resizeEvent(e,t)},actionEvent:function(e){kInteractive.action(e.target)},action:function(e,t){function n(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t}function o(){var e="Questions: "+g+". Score: "+v+" questions out of "+k;e+=". Action: "+q,"selfAnswerReport"==q&&(e+=". Details: "+y),kInteractive.tinCan({verb:"solved",activity:e})}function r(){de||(kInteractive.c.addClass(pe,"hide"),de=!0)}function i(e,t){e.style.webkitAnimation=e.style.mozAnimation=e.style.animation=t}function a(e,t){e.style.webkitAnimationDuration=e.style.mozAnimationDuration=e.style.animationDuration=t}function s(e,t){e.style.webkitAnimationIterationCount=e.style.mozAnimationIterationCount=e.style.animationIterationCount=t}function c(e){var t=document.createElement("video");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("src",e),t.setAttribute("autoplay","true"),t.setAttribute("data-tap-disabled","false");var n;0!=e.indexOf("http://")&&0!=e.indexOf("https://")||(n=!0),n&&t.setAttribute("crossorigin","anonymous");var o=!1;try{o=navigator.userAgent.toLowerCase().indexOf("android")>-1}catch(e){}o||t.setAttribute("type","video/mp4"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.className="ki-noHighlight",Te.hideDownloadBtn&&(t.className+=" hideDownloadBtn"),t.innerHTML="Your browser doesn't support HTML5 video.",n&&(t.crossOrigin="anonymous"),t.oncanplay=function(){kInteractive.currentVideo==d&&(Ae.className="playBtn ki-btn hide",kInteractive.tinCan({verb:"played",activity:"Video: "+e}))},t.addEventListener("error",function(e){kInteractive.stopCurrentMedia()}),t.addEventListener("webkitfullscreenchange",function(e){var t=null!==document.webkitFullscreenElement;kInteractive.videoIsFullscreen=t});var r=d.getElementsByClassName("container")[0];r.setAttribute("data-tap-disabled","true"),r.appendChild(t)}function l(){function e(e){function n(t){if(!(t>=Me.objects.length)){var o=Me.objects[t],i=void 0===isKotobee?o.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,o.path);new THREE.OBJLoader(l).load(i,function(i){He&&He.parentNode&&He.parentNode.removeChild(He),r.domElement.parentNode||e.appendChild(r.domElement),i.position.set(o.x,o.y,o.z),i.traverse(function(e){if(e instanceof THREE.Mesh){var r=e==i.children[i.children.length-1];if(o.textPath){var a=new THREE.ImageLoader(l),s=void 0===isKotobee?o.textPath:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,o.textPath);a.load(s,function(o){var a=new THREE.Texture;a.image=o,a.needsUpdate=!0,e.material.map=a,r&&c.add(i),n(++t)},function(){},function(e){})}else r&&c.add(i),n(++t)}})},function(e){e.lengthComputable&&(e.loaded,e.total)},function(e){})}}function o(){r.render(c,s);v.getDelta();t=requestAnimFrame(o)}kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("_3D",Me.name?Me.name:"Model"),e.description="Opened 3D model: "+(Me.name?Me.name:"No name"),e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800),t&&cancelAnimationFrame(t);var r;r=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}()?new THREE.WebGLRenderer({precision:"highp"}):new THREE.CanvasRenderer;var i=e.offsetWidth,a=e.offsetHeight,s=new THREE.PerspectiveCamera(Me.camera.viewAngle,i/a,Me.camera.near,Me.camera.far),c=new THREE.Scene;null!=Me.scene.bgColor&&r.setClearColor(Me.scene.bgColor,1),c.add(s),s.position.x=Me.camera.x,s.position.y=Me.camera.y,s.position.z=Me.camera.z,r.setSize(i,a),Me.scene.floor&&(floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500,1,1),new THREE.MeshPhongMaterial({color:Me.scene.floorColor?Me.scene.floorColor:10066329})),floor.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),floor.position.y=-80,floor.receiveShadow=!0,c.add(floor));var l=new THREE.LoadingManager;l.onProgress=function(e,t,n){},n(0),new THREE.OrbitControls(s,r.domElement).target=new THREE.Vector3(0,0,0);for(var d=0;d<Me.lights.length;d++)if("pointLight"==Me.lights[d].type){var u=new THREE.PointLight(Me.lights[d].color);u.position.set(Me.lights[d].x,Me.lights[d].y,Me.lights[d].z),c.add(u)}else if("directionalLight"==Me.lights[d].type){var p=new THREE.DirectionalLight(Me.lights[d].color,Me.lights[d].intensity);p.position.set(Me.lights[d].x,Me.lights[d].y,Me.lights[d].z),c.add(p)}else if("hemisphereLight"==Me.lights[d].type){var f=new THREE.HemisphereLight(Me.lights[d].sky,Me.lights[d].ground,Me.lights[d].intensity);f.position.set(Me.lights[d].x,Me.lights[d].y,Me.lights[d].z),c.add(f)}else if("spotLight"==Me.lights[d].type){var m=new THREE.SpotLight(Me.lights[d].color,Me.lights[d].intensity,Me.lights[d].distance,Me.lights[d].angle,Me.lights[d].exponent,Me.lights[d].decay);m.position.set(Me.lights[d].x,Me.lights[d].y,Me.lights[d].z),c.add(m)}else if("ambientLight"==Me.lights[d].type){var g=new THREE.AmbientLight(Me.lights[d].color);c.add(g)}else if("areaLight"==Me.lights[d].type){var h=new THREE.AreaLight(Me.lights[d].color,Me.lights[d].intensity);c.add(h)}var v=new THREE.Clock;o()}var t,n=d;if("inPanel"==Me.inter.target){var o={};o.class="threed",o.cb=function(t){var n=document.createElement("div");n.className="container",t.appendChild(n),e(n)},o.closed=function(){kInteractive.c.removeClass(d,"running")},kInteractive.openFrame(o)}else e(n)}if("undefined"==typeof editorMode||!editorMode){for(var d=e;!this.hasClass(d,"kInteractive");){if(!d.parentNode)return;if((d=d.parentNode)==document.body)return}if(this.hasClass(d,"questions")){var u=kInteractive.readData(d);if(!u)return;var p=u.dict,f=u.userDict;if(p||(p={}),f||(f=p),u.layout&&u.layout.popup&&!this.hasClass(d,"inpopup")&&"img"==e.nodeName.toLowerCase()){var m=document.getElementById("epubContent");return m&&d.setAttribute("data-loc",function(e,t){for(var o="";e!=t;)o=n(e)+"."+o,e=e.parentNode;return""==o?"":o.substr(0,o.length-1)}(d,m)),(ae=document.createElement("iframe")).setAttribute("nwdisable","true"),ae.setAttribute("nwfaketop","true"),u.cb=function(e){function t(){if(void 0!==isKotobee){var e={};e.root=ae.contentDocument.documentElement.ownerDocument.body,e.rootIndex=d.getAttribute("data-loc"),angular.element(document.body).scope().getNotebookShortcut(e,function(){})}}var n,o=document.createElement("head");if(void 0===isKotobee){for(var r=document.getElementsByTagName("link"),i=0;i<r.length;i++){var a=r[i];if(a.getAttribute("href").indexOf("base.css")>=0){var s=a.getAttribute("href").split("/");delete s[s.length-1],n=s.join("/");break}}if(!n)return}var c=void 0===isKotobee?n+"../xhtml/":bookPath+"EPUB/xhtml/",o="<head>";if(o+='<base href="'+kInteractive.c.removeFilename(kInteractive.c.removeHash(window.location.href))+"/"+c+'"/>',o+='<link rel="stylesheet" type="text/css" href="../css/base.css" />',o+='<link rel="stylesheet" type="text/css" href="../css/global.css" />',o+='<link rel="stylesheet" type="text/css" href="../css/kotobeeInteractive.css" />',o+='<script type="text/javascript" src="../js/kotobeeInteractive.js"><\/script>',o+='<script type="text/javascript" src="../js/global.js"><\/script>',void 0!==isKotobee){var l=clone(config);l.kotobee.email=angular.element(document.body).scope().data.user.email,o+='<script type="text/javascript">var config='+JSON.stringify(l)+";<\/script>"}o+='<meta charset="utf-8" />',o+="</head>";var u=d.outerHTML;u=(u=(u=(u=(u=(u=u.replace("<img",'<img style="display:none"')).replace(/([;\s]*?height:)(.*)?;/i,"$1auto")).replace(/([;\s]*?width:)(.*)?;/i,"$1auto")).replace(/([;\s]*?top:)(.*)?;/i,"$1auto")).replace(/([;\s]*?left:)(.*)?;/i,"$1auto")).replace('class="','class="inpopup ');var p="<html>"+o+"<body>"+(u+='<div class="vSpace20"></div>')+"</body></html>";ae.setAttribute("srcdoc",p);var f="javascript: window.frameElement.getAttribute('srcdoc');";ae.setAttribute("src",f),ae.contentWindow&&(ae.contentWindow.location=f),e.appendChild(ae),ae.addEventListener?ae.addEventListener("load",t,!0):ae.attachEvent&&ae.attachEvent("onload",t)},u.closed=function(){},u.pos=u.layout.pos,kInteractive.openFrame(u),kInteractive.tinCan({verb:"opened",activity:"Questions: "+u.title}),void(kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("question",u.title),e.description="Opened question popup: "+u.title,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800))}var g="Untitled questions",h=d.getElementsByTagName("h4");h.length&&(g=h[0].textContent||h[0].data);var v=0,b=d.getElementsByClassName("ques"),k=b.length,y="";if(this.hasClass(e,"kInteractive"))return;if(this.hasClass(e,"questions-clear")){for(var w=d.getElementsByClassName("ans"),C=0;C<w.length;C++)w[C].checked=!1,w[C].value=null,kInteractive.c.removeClass(w[C].parentNode,"correct");for(C=(R=d.getElementsByClassName("explanation")).length;C--;)R[C].parentNode.removeChild(R[C]);for(C=(F=d.getElementsByClassName("reference")).length;C--;)F[C].parentNode.removeChild(F[C]);return void(document[d.id]=null)}if(this.hasClass(e,"questions-notebook")){var E=u.layout&&u.layout.popup&&this.hasClass(d,"inpopup");if(void 0===isKotobee&&!E)return void kInteractive.alert({content:p.kotobeeOnly,title:f.sorry?f.sorry:"Sorry"});var x,I={elem:d};if(void 0!==isKotobee)x=angular.element(document.body).scope();else{try{x=window.parent.getGlobal()}catch(e){return void kInteractive.alert({content:p.kotobeeOnly,title:f.sorry?f.sorry:"Sorry"})}I.rootIndex=d.getAttribute("data-loc"),I.root=d}return kInteractive.c.addClass(e,"busy"),void x.questionsAddToNotebookShortcut(I,function(){kInteractive.c.removeClass(e,"busy"),kInteractive.alert({content:f.savedToNotebook?f.savedToNotebook:"Saved to notebook!"})})}if(this.hasClass(e,"questions-preserve"))return document[d.id]||(document[d.id]={}),void(document[d.id].preserve=e.checked);for(var T=0,S=0,A=[],C=0;C<b.length;C++){var N=(w=b[C].getElementsByClassName("ans")).length>0,B=u.q[C];if(u.options.randomize&&(B=u.q[Number(b[C].getAttribute("data-o"))]),kInteractive.scorm&&u.options&&u.options.answerOnce&&kInteractive.scorm.interactionExists(kInteractive.getScormId(d.id+"-"+(C+1),B.q))){V="<p style='text-align:center'>"+(f.alreadySubmitted?f.alreadySubmitted:"This test has already been submitted!")+"</p>";return void kInteractive.alert({content:V})}var L={};A.push(L),L.id=kInteractive.getScormId(d.id+"-"+(C+1),B.q),L.qid=d.id,L.type=w[0].getAttribute("id").indexOf("ki-tf-")>=0?"true-false":"choice",L.objective=u.options?u.options.objective:null,L.timestamp=kInteractive.timestamp,L.latency=Math.round(((new Date).getTime()-kInteractive.timestamp.getTime())/1e3),L.description=B.q;for(te=0;te<w.length;te++)if(w[te].getAttribute("id").indexOf("ki-tf-")>=0)0==te&&B.a?L.correctResponses=B.choice1:1!=te||B.a||(L.correctResponses=B.choice2),w[te].checked?(L.learnerResponses=te?B.choice2:B.choice1,0!=te||B.a?1==te&&B.a&&(N=!1):N=!1):0==te&&B.a?N=!1:1!=te||B.a||(N=!1),u.options&&u.options.highlightCorrect&&(0==te&&B.a||1==te&&!B.a)&&kInteractive.c.addClass(w[te].parentNode,"correct");else if(w[te].getAttribute("id").indexOf("ki-sa-")>=0){(Q=w[te].value.toLowerCase())&&(Q=Q.trim()),N=!0;for(var O="",$=0;$<B.k.length;$++){var M=B.k[$].t;if(!M){N=!1;break}M=M.toLowerCase(),O&&(O+="+"),O+=M;for(var H=M.split(","),P=!1,D=0;D<H.length;D++)if(Q.indexOf(H[D].trim())>=0){P=!0;break}if(!P){N=!1;break}}L.correctResponses=O,L.learnerResponses=Q}else B.c[te].a&&(L.correctResponses=B.c[te].t),w[te].checked&&(L.learnerResponses=B.c[te].t),w[te].checked&&!B.c[te].a?N=!1:!w[te].checked&&B.c[te].a&&(N=!1),u.options&&u.options.highlightCorrect&&B.c[te].a&&kInteractive.c.addClass(w[te].parentNode,"correct");if(L.result=0,null!=B.weight&&(T+=B.weight,N&&(S+=B.weight,L.result=B.weight)),L.scoreMax=u.options?Number(u.options.totalScore):null,B.exp&&!b[C].getElementsByClassName("explanation").length){var R=document.createElement("p");R.className="explanation",R.innerHTML=kInteractive.escapeHtml(B.exp),kInteractive.appendAfterDelay(b[C],R)}if(B.ref&&!b[C].getElementsByClassName("reference").length){var F=document.createElement("a");F.className="reference",F.innerHTML=f.learnMode?f.learnMode:"Learn more",F.setAttribute("href",kInteractive.escapeHtml(B.ref)),F.setAttribute("target","_blank"),kInteractive.appendAfterDelay(b[C],F)}var z=f.question?f.question.replace("[no]",C+1):"Question "+(C+1);N?(y+="<span style='border-bottom: dotted 1px #aaa;' title='"+B.q.replace(/'/g,"&#39;")+"'>"+z+".</span>  <span style='color:#366c20'>"+f.correct+"</span><br/>",v++):y+="<span style='border-bottom: dotted 1px #aaa;' title='"+B.q.replace(/'/g,"&#39;")+"'>"+z+".</span>  <span style='color:#7a1818'>"+f.incorrect+"</span><br/>"}for(C=0;C<A.length;C++)A[C].weighting=Math.round(1e3*u.options.totalScore/T)/1e3;var j,q=u.action;if(u.options.totalScore&&T&&(j=Math.round(10*u.options.totalScore*S/T)/10),"selfAnswer"==q||"selfAnswerReport"==q){var U="";"ar"==u.options.language&&(U=' direction="rtl"');var V="";if(f.scoreWeight){if(null!=j){var _="";u.options.passScore&&(j>=u.options.passScore||j==u.options.totalScore?_+=f.pass:_+=f.fail),_&&(_+=". "),V+="<h3"+U+">"+(_||"")+f.scoreWeight.replace("[score]",j).replace("[total]",u.options.totalScore)+"</h3>"}V+="<p"+U+">"+f.score.replace("[correct]",v).replace("[total]",k)+"</p>"}else V="You scored "+v+" question(s) out of "+k;"selfAnswerReport"==q&&(V="<p"+U+"><strong>"+V+"</strong></p><p><strong>"+(f.details?f.details:"Details")+"</strong></p><p class='kbAlertScroll'>"+y+"</p>"),kInteractive.alert({content:V}),o()}if("email"==q||u.options.reportEmail||u.options.emailForm){var W="selfAnswer"!=q&&"selfAnswerReport"!=q&&"email"!=q;try{if(!config.kotobee.cloudid)return void(W&&kInteractive.alert({content:p.cloudOnly,title:f.sorry?f.sorry:"Sorry"}))}catch(e){return void(W&&kInteractive.alert({content:p.cloudOnly,title:f.sorry?f.sorry:"Sorry"}))}var K={};K.ans=new Array;for(te=0;te<b.length;te++)for(var w=b[te].getElementsByClassName("ans"),C=0;C<w.length;C++)w[C].checked&&K.ans.push({q:te,index:C,label:w[C].nextSibling.textContent||w[C].nextSibling.data});if(K.title=g,(fe={}).recipient=u.address,u.options.reportEmail&&(fe.recipient=u.options.reportEmail),fe.content=JSON.stringify(K),fe.mode=config.kotobee.mode,fe.cloudid=config.kotobee.cloudid,fe.email=config.kotobee.email?config.kotobee.email:angular.element(document.body).scope().data.user.email,u.options.emailForm){var Y=document.getElementsByName("recipientEmail");Y.length&&(fe.recipient=fe.recipient?fe.recipient+","+Y[0].value:Y[0].value)}var J=e.value;e.value=f.submitting?f.submitting:"Submitting ..",e.setAttribute("disabled","true");var G=new XMLHttpRequest;G.onreadystatechange=function(){try{if(4===G.readyState&&200===G.status){if(e.value=J,e.removeAttribute("disabled"),!W)return;JSON.parse(G.responseText).success?kInteractive.alert({content:f.submitted?f.submitted:"Answers submitted!"}):kInteractive.alert({content:f.errorSubmitting?f.errorSubmitting:"An error has occurred while sending answers to the server"})}}catch(t){if(e.value=J,e.setAttribute("value",e.value),e.removeAttribute("disabled"),!W)return;kInteractive.alert({content:f.errorSubmitting?f.errorSubmitting:"An error has occurred while sending answers to the server"})}};ie=config.kotobee.liburl?config.kotobee.liburl:"http://www.kotobee.com/";ie+="library/report/questions",G.open("POST",ie),G.setRequestHeader("Content-type","application/x-www-form-urlencoded");var X="a=a";for(var Z in fe){var Q=fe[Z];void 0!=Q&&("object"!=typeof Q&&("string"==typeof Q&&(Q=encodeURIComponent(Q)),"boolean"==typeof Q&&(Q=Q?1:0),X+="&"+Z+"="+Q))}G.send(X),o()}document[d.id]||(document[d.id]={}),document[d.id].q=[];for(var ee=d.getElementsByClassName("ques"),te=0;te<ee.length;te++){var ne=te;u.options.randomize&&(ne=Number(ee[te].getAttribute("data-o"))),document[d.id].q[ne]=[];for(var oe=ee[te].getElementsByClassName("ans"),C=0;C<oe.length;C++)kInteractive.hasClass(oe[C],"txtfield")?document[d.id].q[ne][C]=oe[C].value:document[d.id].q[ne][C]=oe[C].checked}kInteractive.scorm&&setTimeout(function(){kInteractive.scorm.setInteractions(A)},500)}else if(this.hasClass(d,"widget")){var re=kInteractive.readData(d);if(!re)return;var ie=kInteractive.getWidgetUrl(re),ae=document.createElement("iframe");ae.setAttribute("nwdisable","true"),ae.setAttribute("nwfaketop","true"),re.cb=function(e){ae.src=ie,e.appendChild(ae)},re.cb1="yes",re.closed=function(){},kInteractive.openFrame(re),kInteractive.tinCan({verb:"opened",activity:"Widget: "+re.name}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("widget",re.name),e.description="Opened popup widget: "+re.name,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else{if(this.hasClass(e,"link")){if(!(fe=kInteractive.readData(e)))return;if("popup"==fe.type){if(V=(V="<div class='kbAlertScroll'>"+fe.msg+"</div>").replace(/src="(.*?)"/g,function(){var e=arguments[1];return void 0!==isKotobee&&(e=ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,e)),'src="'+e+'"'}),"image"==fe.popupMode){var se=fe.popupImg;void 0!==isKotobee&&(se=ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,se)),V="<img src='"+se+"'/>"}kInteractive.alert({content:V}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("popup",fe.msg),e.description="Shown popup message: "+fe.msg,e.type="other",e.learnerResponses="Shown",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else if("audio"==fe.type){kInteractive.stopCurrentMedia();var ce=document.createElement("audio"),le=fe.src;"file"==fe.audioType&&(le=void 0===isKotobee?fe.audio:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,fe.audio)),ce.setAttribute("src",le);var de,ue=document.createElement("div");ue.className="kiAudioLoader",ue.style.transform=ue.style.webkitTransform=ue.style.mozTransform="scale(1)";var pe=document.createElement("div");pe.className="kiAudioSpinner",ue.appendChild(pe),e.parentNode.insertBefore(ue,e),ce.onplaying=r,setTimeout(r,5e3),ce.play(),kInteractive.currentAudio=ce,kInteractive.tinCan({verb:"played",activity:"Audio: "+le}),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(e.textContent,le),L.description="Played audio link: "+le,L.type="other",L.learnerResponses="Played",L.objective=fe.options?fe.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L]))}return!1}if(this.hasClass(e,"image")){if(e.parentNode&&this.hasClass(e.parentNode,"kInteractive")&&this.hasClass(e.parentNode,"link"))return void this.action(e.parentNode,t);var fe=kInteractive.readData(e);if(!fe)return;var me=fe.behavior;if("none"==me)return;i(e,"none"),a(e,"none"),s(e,"none"),setTimeout(function(){function t(o){i(e,"none"),a(e,"none"),s(e,"none"),e.removeEventListener(n,t)}"wiggle"==me?(i(e,"wiggle"),a(e,"0.5s"),s(e,"1")):"jump"==me?(i(e,"jump"),a(e,"0.7s"),s(e,"1")):"scale"==me&&(i(e,"scale"),a(e,"0.5s"),s(e,"1"));var n=function(){var e,t=document.createElement("fakeelement"),n={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}();n&&e.addEventListener(n,t)}),kInteractive.tinCan({verb:"clicked",activity:me+"image: "+e.getAttribute("src")})}else if(this.hasClass(d,"gallery")){var ge=d.getElementsByClassName("images")[0],v=ge.children.length,he=d.getElementsByClassName("selected")[0],ve=Number(he.style.left.slice(0,-2)),be=Number(ge.style.left.slice(0,-2));if(this.hasClass(e,"next")){var ke=he.nextSibling;if(!ke)return;kInteractive.c.removeClass(he,"selected"),kInteractive.c.addClass(ke,"selected"),ke.style.left=ve+ge.offsetWidth+"px",ke.style.display="block",ge.style.left=be-ge.offsetWidth+"px",ke.nextSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(d.getElementsByClassName("prev")[0],"disable"),he=ke}else if(this.hasClass(e,"prev")){var ye=he.previousSibling;if(!ye)return;kInteractive.c.removeClass(he,"selected"),kInteractive.c.addClass(ye,"selected"),ye.style.left=ve-ge.offsetWidth+"px",ye.style.display="block",ge.style.left=be+ge.offsetWidth+"px",ye.previousSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(d.getElementsByClassName("next")[0],"disable"),he=ye}var we=d.getElementsByClassName("imgCaption");if(!we.length)return;var Ce=(we=we[0]).getElementsByClassName("inner");if(!Ce.length)return;(Ce=Ce[0]).style.display="none",he.hasAttribute("data-caption")&&(Ce.innerHTML=he.getAttribute("data-caption"),Ce.style.display=null)}else if(this.hasClass(d,"audio")){kInteractive.stopCurrentMedia();var Ee=kInteractive.readData(d);if(!Ee)return;Ee.audioType||(Ee.audioType=Ee.type);Se=d.getAttribute("id")+"-container";(Ae=d.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn hide";le=Ee.src;"file"==Ee.audioType&&(le=void 0===isKotobee?Ee.audio:Ee.relToRoot?ph.join(bookPath,Ee.audio):ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,Ee.audio)),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(d.getAttribute("id"),le),L.description="Played audio: "+le,L.type="other",L.learnerResponses="Played",L.objective=Ee.options?Ee.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L]));var xe=document.createElement("audio");xe.setAttribute("controls","true"),xe.setAttribute("autoplay","true"),xe.setAttribute("data-tap-disabled","false");var Ie=document.createElement("source");Ie.src=le,xe.appendChild(Ie),xe.appendChild(document.createTextNode("Your browser does not support the audio element")),xe.className="ki-noHighlight",xe.oncanplay=function(){kInteractive.currentAudio==d&&kInteractive.tinCan({verb:"played",activity:"Audio: "+le})},d.getElementsByClassName("container")[0].appendChild(xe),xe.play(),kInteractive.currentAudio=d,kInteractive.c.addClass(kInteractive.currentAudio,"playing")}else if(this.hasClass(d,"video")){var Te=kInteractive.readData(d);if(!Te)return;var Se=d.getAttribute("id")+"-container",Ae=d.getElementsByClassName("playBtn")[0];if(Ae.className.indexOf("loading")>=0)return;if(kInteractive.stopCurrentMedia(),Ae.className="playBtn ki-btn loading",Te.autoplay&&(Ae.className="playBtn ki-btn hide"),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(d.getAttribute("id"),Te.src),L.description="Played video: "+Te.src,L.type="other",L.learnerResponses="Played",L.objective=Te.options?Te.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L])),"file"==Te.type)c(le=void 0===isKotobee?Te.video:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,Te.video));else if(Te.src.indexOf("youtube.com")>=0||Te.src.indexOf("youtu.be/")>=0){var Ne;if(Te.src.indexOf("youtube.com")>=0)Ne=(Be=Te.src.split("watch?v="))[1];else{if(!(Te.src.indexOf("youtu.be/")>=0))return;var Be=Te.src.split("youtu.be/");Ne=Be[Be.length-1]}if(window&&window.iBooks)return setTimeout(function(){Ae.className="playBtn ki-btn"},1500),void(window.location.href=Te.src);var Le={videoId:Ne,playerVars:{autoplay:1,rel:"0"},events:{onReady:function(){},onStateChange:function(e){e.data==YT.PlayerState.PLAYING&&kInteractive.tinCan({verb:"played",activity:"Video: "+Te.src})}}};if(kInteractive.youTubeStatus)if("loading"==kInteractive.youTubeStatus){if(kInteractive.vQueue)return;kInteractive.vQueue=function(){Ae.className="playBtn ki-btn hide",new YT.Player(Se,Le)}}else"ready"==kInteractive.youTubeStatus&&(Ae.className="playBtn ki-btn hide",new YT.Player(Se,Le));else{window.onYouTubePlayerAPIReady=function(){kInteractive.youTubeStatus="ready",kInteractive.vQueue(),kInteractive.vQueue=null};var Oe=document.createElement("script");Oe.src="https://www.youtube.com/player_api";var $e=document.getElementsByTagName("script")[0];$e.parentNode.insertBefore(Oe,$e),kInteractive.youTubeStatus="loading",kInteractive.vQueue=function(){Ae.className="playBtn ki-btn hide",new YT.Player(Se,Le)}}}else c(Te.src);kInteractive.currentVideo=d,kInteractive.c.addClass(kInteractive.currentVideo,"playing")}else if(this.hasClass(d,"threed")){var Me=kInteractive.readData(d);if(!Me)return;"inPanel"==Me.inter.target?kInteractive.c.addClass(d,"running"):d.innerHTML="";var He=document.createElement("div");if(He.className="loading",d.appendChild(He),"undefined"==typeof THREE){var Pe,De=document.getElementsByTagName("head")[0],Re=De.getElementsByTagName("script");if(void 0!==isKotobee)Pe=bookPath+"EPUB/js/kotobeeInteractive3D.js";else for(te=0;te<Re.length;te++)if(Re[te].src.indexOf("kotobeeinteractive.js")>=0){Pe=Re[te].src.replace("kotobeeinteractive.js","kotobeeinteractive3D.js");break}if(!Pe)return;var Fe=document.createElement("script");Fe.type="text/javascript",Fe.src=Pe,Fe.onload=l,Fe.onreadystatechange=function(){"complete"==this.readyState&&l()},De.appendChild(Fe)}else l()}}}},openFrame:function(e){function t(){o.style.display="block",o.className="show";var t=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,i=window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth;t-=20,i-=20;var a=1;if(e.width&&e.height){var s=i/e.width,l=t/e.height;(a=s<l?s:l)>1&&(a=1)}var d="display:block;";d+=r;var u=e.width||e.height?"-50%,-50%":"0%,0%";d+="-webkit-transform:translate("+u+") scale("+a+");-moz-transform:translate("+u+") scale("+a+");transform:translate("+u+") scale("+a+");",d+="position:fixed;",void 0===isKotobee&&(d+="top:"+Math.round(window.innerHeight/2)+"px;",d+="left:"+Math.round(window.innerWidth/2)+"px;"),n.style.cssText=d,n.className=c+" ready";var p=n.getElementsByClassName("closeBtn");if(p.length){var f=p[0],m=1/a,g="-50%";kInteractive.hasClass(f,"side")&&(g="0%"),f.style.cssText="-webkit-transform: translate("+g+",0%) scale("+m+");-webkit-transform-origin: 50% 50%;-moz-transform: translate("+g+",0%) scale("+m+");-moz-transform-origin: 50% 50%;transform: translate("+g+",0%) scale("+m+");transform-origin: 50% 50%;"}}var n=document.getElementById("kInteractiveFrame"),o=document.getElementById("kiDarkOverlay"),r="";if(e.dict||(e.dict={}),e.width&&(r+="width:"+e.width+"px;max-width:"+e.width+"px;"),e.height&&(r+="height:"+e.height+"px;max-height:"+e.height+"px;"),n||((o=document.createElement("div")).id="kiDarkOverlay",document.body.appendChild(o),o.style.display="none",o.style.position="fixed",o.addEventListener("click",kInteractive.closeFrame),(n=document.createElement("div")).id="kInteractiveFrame"),e.pos||(e.pos="top"),"none"!=e.pos){var i=document.createElement("a"),a="closeBtn";e.pos&&(a+=" "+e.pos),i.className=a;var s=e.dict.close?e.dict.close:"Close";try{s=angular.element(document.body).scope().translit("close")}catch(e){}"side"!=e.pos&&(i.innerHTML=s),i.addEventListener("click",kInteractive.closeFrame),n.appendChild(i)}var c=e.class?e.class:"";(e.width||e.height)&&(c+=" fixed"),n.style.display="block",n.className=c,document.body.appendChild(n),kInteractive.frameIsOpen=!0,kInteractive.frameOb=e,kInteractive.openFrame.resized=t,window.addEventListener("resize",t),setTimeout(function(){t(),e.cb&&e.cb(n)},100)},closeAlert:function(e){e&&e.stopPropagation();var t=document.getElementById("kiSystemAlertBox"),n=document.getElementById("kiSystemAlertBackdrop");t.parentNode.removeChild(t),n.parentNode.removeChild(n),kInteractive.alertIsOpen=!1,window.removeEventListener("resize",kInteractive.alert.resized),kInteractive.alert.resized=null},closeFrame:function(){var e=document.getElementById("kInteractiveFrame"),t=document.getElementById("kiDarkOverlay");kInteractive.frameIsOpen=!1,window.removeEventListener("resize",kInteractive.openFrame.resized),kInteractive.openFrame.resized=null,kInteractive.c.removeClass(e,"ready");var n=kInteractive.frameOb,o="";n.width&&(o+="width:"+n.width+"px;max-width:"+n.width+"px;"),n.height&&(o+="height:"+n.height+"px;max-height:"+n.height+"px;"),e.style.cssText=o,t.className="",setTimeout(function(){e.innerHTML="",e.style.display=t.style.display="none",n.closed&&n.closed(),kInteractive.frameOb=null},300)},stopCurrentMedia:function(){if(kInteractive.currentVideo){var e=kInteractive.currentVideo.getAttribute("id")+"-container";(t=document.getElementById(e))&&(t.parentNode.removeChild(t),(n=document.createElement("div")).setAttribute("id",e),n.className="container",(o=kInteractive.currentVideo.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentVideo,"playing"),kInteractive.currentVideo.appendChild(n))}if(kInteractive.currentAudio)if(e=kInteractive.currentAudio.getAttribute("id")){e+="-container";var t=document.getElementById(e);if(t){t.parentNode.removeChild(t);var n=document.createElement("div");n.setAttribute("id",e),n.className="container";var o=kInteractive.currentAudio.getElementsByClassName("playBtn")[0];o.className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentAudio,"playing"),kInteractive.currentAudio.appendChild(n)}}else try{var r=kInteractive.currentAudio.getElementsByTagName("audio");r.length&&(r[0].pause(),r[0].src=""),kInteractive.currentAudio.pause&&(kInteractive.currentAudio.pause(),kInteractive.currentAudio.src="");for(var i=document.getElementsByClassName("kiAudioLoader"),a=i.length;a--;)i[a].parentNode.removeChild(i[a])}catch(e){}},hasClass:function(e,t){if(e&&e.className)for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o]&&n[o].trim()==t)return!0},appendAfterDelay:function(e,t){setTimeout(function(){e.appendChild(t)},30)},replaceHTML:function(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o},tinCan:function(e){if(void 0!==isKotobee)try{angular.element(document.body).scope().tinCanShortcut(e)}catch(e){}},setDOMParser:function(){!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser)},readData:function(e){try{var t=e.getAttribute("data-kotobee");return t||(t=e.getAttribute("data")),JSON.parse(decodeURI(kInteractive.XORCipher().decode("kotobee%%author",t)))}catch(e){try{return JSON.parse(kInteractive.XORCipher().decode("kotobee%%author",t))}catch(e){}}},writeData:function(e,t){var n=encodeURI(JSON.stringify(t)),o=e.hasAttribute("data-kotobee")?"data-kotobee":"data";e.setAttribute(o,kInteractive.XORCipher().encode("kotobee%%author",n))},XORCipher:function(){function e(e){var t,n,o,r,i,s,c=0,l="";if(!e)return e;do{t=(i=e[c++]<<16|e[c++]<<8|e[c++])>>18&63,n=i>>12&63,o=i>>6&63,r=63&i,l+=a.charAt(t)+a.charAt(n)+a.charAt(o)+a.charAt(r)}while(c<e.length);return((s=e.length%3)?l.slice(0,s-3):l)+"===".slice(s||3)}function t(e){var t,n,o,r,i,s,c=0,l=[];if(!e)return e;e+="";do{t=(s=a.indexOf(e.charAt(c++))<<18|a.indexOf(e.charAt(c++))<<12|(r=a.indexOf(e.charAt(c++)))<<6|(i=a.indexOf(e.charAt(c++))))>>16&255,n=s>>8&255,o=255&s,l.push(t),64!==r&&(l.push(n),64!==i&&l.push(o))}while(c<e.length);return l}function n(e,t){return e.charCodeAt(Math.floor(t%e.length))}function o(e,t){return i(t,function(t,o){return t.charCodeAt(0)^n(e,o)})}function r(e,t){return i(t,function(t,o){return String.fromCharCode(t^n(e,o))}).join("")}function i(e,t){for(var n=[],o=0;o<e.length;o++)n[o]=t(e[o],o);return n}var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t,n){return n=o(t,n),e(n)},decode:function(e,n){return n=t(n),r(e,n)}}},getScormId:function(e,t){return t&&(t=t.replace(/[^a-zA-Z0-9]/g,"-").substr(0,80)),e+"-"+t},alert:function(e){function t(){void 0===isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px")}var n=document.createElement("div");n.setAttribute("id","kiSystemAlertBox"),n.style.position="fixed",void 0===isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px");var o=document.createElement("div");o.innerHTML=e.content.replace("&nbsp;","&#160;"),o.className="content",n.appendChild(o);var r=document.createElement("div");if(r.className="footer",e.title){var i=document.createElement("div");i.innerHTML=e.title.replace("&nbsp;","&#160;"),i.className="header",n.insertBefore(i,n.firstChild)}var a=document.createElement("a"),s="OK";try{s=angular.element(document.body).scope().translit("ok")}catch(e){}a.innerHTML=s.replace("&nbsp;","&#160;"),a.className="okBtn",kInteractive.alertIsOpen=!0,a.addEventListener("click",kInteractive.closeAlert),r.appendChild(a),n.appendChild(r);var c=document.createElement("div");c.setAttribute("id","kiSystemAlertBackdrop"),c.addEventListener("click",kInteractive.closeAlert),c.style.position="fixed",document.body.appendChild(c),document.body.appendChild(n),a.focus(),kInteractive.alert.resized=t,window.addEventListener("resize",t),setTimeout(function(){n.className="show",c.className="show"},50)},c:{addClass:function(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)-1==n.indexOf(t[r])&&(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(n.indexOf(t)>=0)return;n+=(""==n?"":" ")+t}e.className=n},removeClass:function(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)n.indexOf(t[r])>=0&&(o=!1,n=n.replace(t[r],""));if(o)return}else{if(-1==n.indexOf(t))return;n=n.replace(t,"")}""==(n=n.trim())?e.removeAttribute("class"):e.className=n},removeHash:function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},removeFilename:function(e){var t=kInteractive.c.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},normalizedArray:function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t}},escapeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},resizeEvent:function(e,t){function n(e,t){if(e&&e.disableWrapForMobile&&"none"!=e.float){var n=t.parentNode;t.offsetWidth>.6*n.offsetWidth&&.4*(n.offsetWidth-t.offsetWidth)<100?kInteractive.c.addClass(t,"fullRow"):kInteractive.c.removeClass(t,"fullRow")}}var o,r=e||document;t&&(r=document);for(var i=(o=r.getElementsByClassName("kInteractive")).length;i--;){var a=o[i];if(this.hasClass(a,"image")){var s=kInteractive.readData(a);if(!s)return;n(s,a)}else if(this.hasClass(a,"gallery")){var c=kInteractive.readData(a);if(!c)return;n(c,a)}else if(this.hasClass(a,"container")){var l=kInteractive.readData(a);if(!l)return;n(l,a)}else if(this.hasClass(a,"video")){var d=kInteractive.readData(a);if(!d)return;if(n(d,a),!d.maintainRatio)continue;if("px"!=d.widthUnit)continue;if(!d.height||!d.width)continue;a.style.height=a.offsetWidth*(d.height/d.width)+"px"}else if(this.hasClass(a,"widget")){var u=kInteractive.readData(a);if(!u)return;if("page"!=u.mode)continue;if("px"!=u.widthUnit)continue;var p=u.width,f=u.height,m=a.parentNode;if(!m)continue;if(p>m.offsetWidth){var g=m.offsetWidth/p,h=a.children.length-1;a.children[h].style.transform=a.children[h].style.webkitTransform=a.children[h].style.mozTransform="scale("+g+")",a.children[h].style.transformOrigin=a.children[h].style.webkitTransformOrigin=a.children[h].style.mozTransformOrigin="0 0",a.style.maxWidth=a.style.width,a.style.height=Math.round(f*g)+"px"}else{for(h=0;h<a.children.length;h++)a.children[h].style.transform=a.children[h].style.webkitTransform=a.children[h].style.mozTransform=a.children[h].style.transformOrigin=a.children[h].style.webkitTransformOrigin=a.children[h].style.mozTransformOrigin=null;a.style.maxWidth=null,a.style.height=f+"px"}}}},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},closeFullscreenVideo:function(){kInteractive.currentVideo&&(kInteractive.currentVideo.webkitExitFullscreen?kInteractive.currentVideo.webkitExitFullscreen():kInteractive.currentVideo.mozCancelFullScreen?kInteractive.currentVideo.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen(),kInteractive.videoIsFullscreen=!1)},getWidgetHome:function(e){return e.path?void 0===isKotobee?e.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,e.path):void 0===isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/"},getWidgetUrl:function(e){var t=kInteractive.getWidgetHome(e)+"/"+e.name+"/"+e.src;if(void 0!==isKotobee){var n=angular.element(document.body).scope().data.user;n&&n.email&&n.signatures&&n.signatures.bookwidgets&&e.id&&0==e.id.indexOf("com.kidimedia")&&(t+="?oauth_signature="+n.signatures.bookwidgets.signature,t+="&oauth_nonce="+n.signatures.bookwidgets.nonce,t+="&oauth_timestamp="+n.signatures.bookwidgets.timestamp,t+="&oauth_consumer_key="+n.signatures.bookwidgets.key,t+="&lti_version=LTI-1p0",t+="&oauth_signature_method=HMAC-SHA1",t+="&oauth_version=1.0",t+="&tool_consumer_info_product_family_code=kotobee",t+="&lis_person_contact_email_primary="+n.email,t+="&lis_person_name_full="+(n.name?n.name:""),t+="&user_id="+n.id,t+="&lti_message_type=basic-lti-launch-request",angular.element(document.body).scope().refreshSignatures&&angular.element(document.body).scope().refreshSignatures())}return t},vQueue:[],youTubeReady:!1,firstRun:!0};if(void 0===isKotobee)try{document.addEventListener("DOMContentLoaded",kInteractionStart,!1)}catch(e){window.addEventListener("load",kInteractionStart,!1)}app.controller("BookInfoCtrl",["$scope","np","$timeout","bookinfo","$element","$rootScope","translit","crdv","sync","status","stg","book","modals","chapters","$location","backend",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g){var h;e.init=function(){},e.open=function(e){h=e,u.open(e)},e.download=function(e){o.download(e)},e.actionBtnClicked=function(e){e.redirect?desktop?t.openLink(e.redirect):native&&s.openInNativeBrowser(e.redirect):o.action(e)},e.delete=function(e){o.delete(e)},e.addToFav=function(e){o.addToFav(e)},e.toggleFav=function(e){o.toggleFav(e)},e.removeFav=function(e){o.removeFav(e)},e.categoryClicked=function(t){p.hide(),e.modal.bookInfoOptions.categoryClicked(t)},e.redeemCodeClicked=function(){o.redeemCode()}}]),app.controller("BookSettingsCtrl",["$scope","stg","crdv","$element","nav","backend","$location","$ionicSideMenuDelegate","cssParser","modals","sync","markers","settings","$timeout",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f){e.init=function(){e.navAnims=[{label:"flip",val:"navBookBlock"},{label:"card",val:"navFlip"},{label:"slide",val:"navSlide"},{label:"fade",val:"navFade"}],e.navModes=[{label:"vertical",val:"vertical"},{label:"horizontal",val:"horizontal"}]},e.stylingChanged=function(){f(p.stylingChanged,300)},e.navAnimChanged=function(){p.saveSettings()},e.navModeChanged=function(){p.saveSettings()},e.lineAdjustChanged=function(){f(p.lineAdjustChanged,300)},e.editFontSize=function(){e.header.mode="textSize",s.toggleRight(!1),s.toggleLeft(!1)},e.langChanged=function(){s.toggleLeft(!1),s.toggleRight(!1),f(p.langChanged,500)},e.sync=function(){s.toggleRight(!1),s.toggleLeft(!1),p.sync()},e.fullscreen=function(){s.toggleRight(!1),s.toggleLeft(!1),r.fullscreen()},e.logout=function(){s.toggleRight(!1),s.toggleLeft(!1),i.logout()},e.about=function(){e.openAuthorWebsite()},e.exit=function(){l.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}]),app.controller("CatMenuCtrl",["$scope","backend","translit","$ionicScrollDelegate","$ionicModal","$timeout","stg",function(e,t,n,o,r,i,a){}]),app.controller("ChaptersCtrl",["$scope","initializer","$stateParams","status","stg","nav","modals","$ionicHistory","crdv","virt","chapters","$ionicGesture","cache","$q","book","$timeout","$ionicPopup","$ionicSideMenuDelegate","$location","$ionicScrollDelegate","selection","$filter",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w){e.init=function(){e.putTest("ChaptersCtrl init"),e.$on("$stateChangeStart",function(e,t,n){if(0==t.name.indexOf("reader")||0==t.name.indexOf("libraryreader")){var o=n.ch?n.ch:0,r=n.hash?n.hash:null;d.loadChapterByIndex(Number(o),{hash:r})}}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||!config.kotobee.public&&!r.data.user.loggedIn){var e="loading";s.forwardView()?e=s.forwardView().stateId:s.backView()&&(e=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),b.path("/"+e)}})},e.nextChapter=function(){return d.nextChapter()},e.prevChapter=function(){return d.prevChapter()},e.isFirstChapter=function(){return d.isFirstVisibleChapter()},e.isLastChapter=function(){return d.isLastVisibleChapter()},e.pinched=function(e){},e.applySelectedChapter=function(e,t){if(null==t&&(t=!0),addClass(e,"selected"),addClass(e,"currentChapter"),t){for(var n=e,o=p.getOb("chaptersContent");;){if(!(e=e.parentNode))break;if(e==o)break;"li"==e.nodeName.toLowerCase()&&addClass(e,"expanded")}overflowScroll?o.scrollTop=Math.round(n.offsetTop):k.$getByHandle("chapters").scrollTo(0,Math.round(n.offsetTop-o.parentNode.offsetHeight/2),!1)}},e.deApplySelectedChapter=function(){for(var e=p.getOb("chaptersContent"),t=e.getElementsByClassName("selected"),n=t.length;n--;)removeClass(t[n],"selected");for(n=(t=e.getElementsByClassName("currentChapter")).length;n--;)t[n].removeAttribute("name")},e.showBookInfo=function(){native&&c.vibrate();var e=r.data.book;e.coverImg=r.data.epub.bookThumb,e.coverStyle={"background-image":"url('"+e.coverImg+"')"},e.name=e.meta.dc.title;var t={};t.book=e,config.kotobee.cloudid&&"book"==config.kotobee.mode&&(t.book.stats=config.kotobee.stats),t.noAction=!0,a.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up",bookInfoOptions:t})}}]),app.controller("ContentCtrl",["$location","nav","virt","$sce","$filter","stg","crdv","$rootScope","$element","cache","$scope","settings","$ionicSideMenuDelegate","$http","chapters","$timeout","selection","book","$ionicScrollDelegate",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b){d.init=function(){},d.mouseDown=function(){mobile&&t.resize(),n.enable()},d.mouseUp=function(){n.disableAfter(2e3)};var k;d.scroll=function(){i.data.book&&(config.preserveLoc&&"app"!=config.kotobee.mode&&(k&&clearTimeout(k),k=setTimeout(function(){if("app"!=config.kotobee.mode){var e=b.$getByHandle("content");if(e){var t=e.getScrollPosition();t&&i.writeSlot("lastLocY"+i.getBookId(),t.top)}}},2e3)),mobile||(n.enable(),n.disableAfter(2e3)))}}]),app.controller("ForgotPwdCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,n,o,r,i,a,s,c,l,d,u,p,f,m,g){e.init=function(){t=m,mobile||i.stylize("forgotPwd",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){f.setOb("title",replaceHTML(f.getOb("title"),m.get("forgotPwd")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!n.initialized||u.cloudParam("public")||a.data.user&&a.data.user.loggedIn){var e="loading";l.forwardView()?e=l.forwardView().stateId:l.backView()&&(e=l.backView().stateId),l.nextViewOptions({disableAnimate:!0}),s.path("/"+e)}})},e.showMenu=function(){var e=[{name:m.get("exit"),func:function(){o.hide(),c.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){r.exit()}}})}}];o.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){e.user&&e.user.email&&u.forgotPwd(e.user,function(e){e.error?d.update({error:"s_authError"==e.error?"accessDenied":e.error}):(c.show({mode:"success",successOptions:{msg:m.get("pwdEmailSent")}}),g.history.back())})},e.backClicked=function(){g.history.back()}}]),app.controller("GlobalCtrl",["cache","modals","popovers","crdv","np","book","$http","$rootScope","initializer","translit","error","notes","$sce","design","settings","status","tinCan","$scope","backend","stg","$location",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y){v.putTest=function(e){return},v.init=function(){v.putTest("Global init"),v.mobile=mobile,v.native=native,v.desktop=desktop,v.ios=ios,v.preview=preview,v.config=config,v.putTest("Global init good"),r.init(function(){})},v.start=function(){v.putTest("Global Start"),v.putTest("TO HOME!"),v.cloudParam=b.cloudParam,t.setScope(v),n.setScope(v),v.started=!0,v.putTest("A!"),setTimeout(function(){v.putTest("timeout postInitialize"),c.postInitialize(v)},700),v.$$phase||v.$apply()},v.tinCanShortcut=function(e){h.send(e)},v.questionsAddToNotebookShortcut=function(e,t){u.addNotesFromQuestions(e,t||angular.noop)},v.getNotebookShortcut=function(e,t){k.getNotes(function(n){for(var o=0;o<n.length;o++)n[o].chapter==currentIndex&&0==n[o].location.indexOf(e.rootIndex)&&(n[o].location=n[o].location.split(e.rootIndex)[1],u.addIcon(n[o],e.root));t&&t()})},v.location=function(e){y.path(e)},v.kTemplate=function(e){return kTemplate(e)},v.translit=function(e){return l.get(e)},v.htmlSafe=function(e){return p.trustAsHtml(e)},v.openAuthorWebsite=function(){var e=k.data.settings.language;"en"!=e&&"es"!=e&&"ar"!=e&&"fr"!=e&&(e="en"),window.open("https://www.kotobee.com/"+e+"/products/author","_system")},v.refreshSignatures=function(){b.refreshSignatures()},v.testModals=function(){t.show({mode:"loading",loadingMsg:l.get("pleaseWait")});t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"update",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"generalError"}),t.show({mode:"loading",loadingMsg:l.get("pleaseWait"),backdropClickToClose:!0}),t.show({mode:"note",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"hlight"}),t.show({mode:"externalSite",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"flashUnsupported",flashOb:{text:"Text for flash unsupported site"}}),t.show({mode:"success",successOptions:{msg:"SUCCESS MSG"}}),t.show({mode:"localOnlyError"}),t.show({mode:"xFrameError"}),t.show({mode:"networkError"}),t.show({mode:"exit"}),t.show({mode:"waitTimeout"}),t.show({mode:"backToLib"}),t.show({mode:"notebook",dynamic:!0,animation:"slide-in-up",scope:{notebookClose:t.hide}}),t.show({mode:"search",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"image",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"encryptionKey",backdropClickToClose:!0});t.show({mode:"loading",loadingMsg:l.get("pleaseWait"),timeLimit:3e3});return}}]),app.controller("HomeCtrl",["$scope","design","initializer","$timeout","$ionicHistory","$location",function(e,t,n,o,r,i){e.init=function(){e.putTest("HomeCtrl!");var t=n.getLogo();e.$parent.logo=t.logo,e.$parent.slogan=t.slogan;var o=document.getElementById("home").getElementsByClassName("logo")[0],a=o.getElementsByTagName("img")[0],s=o.style.backgroundImage;if(!s){var c="";config.hideLogo?c+="display:none":c+="background-image:url('"+t.logo+"');",o.style.cssText=c,e.putTest("HomeCtrl1")}a.onload=function(){if(!s){var e=window,t=document,n=t.documentElement,r=t.getElementsByTagName("body")[0],i=e.innerWidth||n.clientWidth||r.clientWidth,l=e.innerHeight||n.clientHeight||r.clientHeight;i||(i=e.screen.width),l||(l=e.screen.height);var d={};d.width=i-80,d.height=.5*l-40,c+="opacity:1;",d.height<a.height||d.width<a.width?c+="background-size:contain;":c+="background-size:auto;",o.style.cssText=c}},e.putTest("HomeCtrl2"),n.initialized||n.preInitialize(e),e.putTest("k"),e.native||e.desktop||(e.putTest("k2"),e.$on("$ionicView.beforeEnter",function(){e.putTest("be4 enter"),n.initialized&&(e.putTest("obbaa"),r.forwardView()&&(e.putTest("yup"),r.nextViewOptions({disableAnimate:!0}),i.path("/"+r.forwardView().stateId)))}))},e.injectUserCSS=function(e){t.injectUserCSS(e)}}]),app.controller("LibraryCtrl",["$scope","error","bookinfo","$sce","$location","$ionicPlatform","$rootScope","$element","$ionicHistory","auth","modals","popovers","translit","library","chapters","status","book","$timeout","$ionicPopup","$ionicModal","$ionicScrollDelegate","backend","crdv","$filter","stg","settings",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C,E,x,I){function T(t){for(var n=0;n<e.sortOb.options.length;n++)if(e.sortOb.options[n].val==t)return e.sortOb.options[n]}function S(){if(f.initialize(),f.addListener(A),e.initialized=!0,e.catList=x.data.currentLibrary.categories,x.data.user.loggedIn&&("account"!=x.data.currentLibrary.authbookview||w.cloudParam("public")||(e.supportsAccountView=!0)),"categories"==x.data.currentLibrary.startingpage)$(),L("categories");else if(0==r.path().indexOf("/library/tab/downloads"))e.downloadedClicked();else if(e.supportsAccountView)L("account"),v(function(){O({account:!0})});else if(!native&&!desktop||x.data.user.loggedIn||config.kotobee.public||!config.kotobee.offline){if(L("all"),!w.cloudParam("public")&&"hide"==x.data.currentLibrary.authbookview&&!x.data.user.loggedIn)return e.paneMsg="noEbooksAvailable",void $();v(O)}else L("downloaded"),e.paneMsg=null,0==x.data.downloaded.length&&(e.paneMsg="noEbooksDownloaded"),$();f.startBook&&(N(f.startBook),f.startBook=null)}function A(){var t,n=arguments[0];if("preload"==n&&(arguments[1].accumulated||(t=!0),mobile||(t=!0),e.paneMsg=null,t&&M()),"postload"==n){arguments[1];var o=arguments[2];t=!1,e.stopInfiniteScroll(),D=!1,e.stopRefresher();var r=B(o);e.moreData=r>=f.maxResults,e.moreData&&f.setMax(r)}}function N(e){if(x.data.user.loggedIn){if(x.data.currentLibrary&&x.data.currentLibrary.books)for(var t=0;t<x.data.currentLibrary.books.length;t++)if(x.data.currentLibrary.books[t].id==e)return void h.open(x.data.currentLibrary.books[t]);w.getEbook({bid:e},function(e){h.open(e)})}}function B(e){if(j){for(var t=0,n=0;n<e.length;n++)if(e[n].searchresults)for(var o=0;o<e[n].searchresults.length;o++)e[n].searchresults[o].results&&(t+=e[n].searchresults[o].results.length);return t}return e.length}function L(t){e.tab=t,mobile?y.$getByHandle("thumbs").scrollTop(!1):document.getElementById("libraryThumbs").scrollTop=0}function O(t){t||(t={}),e.paneMsg=null,F&&(t.catid=F.id,t.listmode=F.listmode),R&&(t.key=R),j&&(t.contentkey=j),f.getEbooks(t,function(t){"all"!=e.tab&&"account"!=e.tab||(t.empty&&(e.paneMsg="noEbooksAvailable"),$(),e.$$phase||e.$apply())})}function $(){for(var e=document.getElementsByClassName("libLoaderAnim"),t=0;t<e.length;t++)addClass(e[t],"hide")}function M(){for(var e=document.getElementsByClassName("libLoaderAnim"),t=0;t<e.length;t++)removeClass(e[t],"hide")}function H(e,t){t||(t=x.data.currentLibrary.categories);for(var n=0;n<t.length;n++){if(t[n].id==e)return t[n];if(t[n].children){var o=H(e,t[n].children);if(o)return o}}}function P(){z&&z(),z=i.registerBackButtonAction(function(t){e.searchOb.enabled?e.disableSearch():"categories"==e.tab&&e.catList!=x.data.currentLibrary.categories?e.categoryBackClicked():F?e.back():R?e.back():j&&e.back(),e.$apply()},102)}var D,R,F,z,j;e.initialized=!1,e.init=function(){document.getElementsByClassName("libraryView");w.setLibraryLoginCallback(function(){S()}),w.setLibraryLogoutCallback(function(){e.supportsAccountView&&"all"!=e.tab&&(L("all"),v(O)),e.supportsAccountView=!1,$()}),e.sortOb={},e.sortOb.options=[{name:"dateAddedNewestFirst",data:"date",dir:"desc",val:"dateDesc"},{name:"dateAddedOldestFirst",data:"date",dir:"asc",val:"dateAsc"},{name:"titleA-Z",data:"name",dir:"asc",val:"titleAsc"},{name:"titleZ-A",data:"name",dir:"desc",val:"titleDesc"},{name:"categoryA-Z",data:"cat",dir:"asc",val:"catAsc"},{name:"categoryZ-A",data:"cat",dir:"desc",val:"catDesc"}],e.sortOb.method=T("dateDesc"),x.data.currentLibrary&&x.data.currentLibrary.defaultsort&&(e.sortOb.method=T(x.data.currentLibrary.defaultsort)),f.sortMethod=e.sortOb.method;var t;e.$on("$ionicView.beforeEnter",function(n,o){if(t=null,!(e.native||e.desktop||l.authenticated&&"library"==config.kotobee.mode)){var i="loading";c.forwardView()?i=c.forwardView().stateId:c.backView()&&(i=c.backView().stateId),c.nextViewOptions({disableAnimate:!0}),r.path("/"+i)}c.forwardView()&&(t=c.forwardView().stateId),c.backView()&&(t=c.backView().stateId),"forward"==o.direction&&(x.data.currentLibrary.books=[],x.data.favorites=[])}),e.$on("$ionicView.afterEnter",function(e,t){if("back"==t.direction)return $(),void f.setBrowserTitle();w.cloudParam("entry")?w.login().then(function(e){e.error&&S()}):(w.cloudParam("public"),S())})},e.userLogin=function(){e.data.user.loggedIn?w.logout():t.update({error:"s_authError"})},e.langSelected=function(t){e.langDropdownExpanded=!1,x.data.settings.language=t,I.langChanged()},e.showLibraryMenu=function(){u.show({mode:"libraryMenu",menuItem:e.menuItemClicked,backdropClickToClose:!1})},e.scroll=function(t){var n=j?.95:.8;if(t.scrollTop/(document.getElementById("libraryThumbsContent").offsetHeight-t.offsetHeight)>n){if(D)return;if(!e.moreDataExists())return;D=!0,e.loadMore()}},e.bookClicked=function(t){n.show({book:t,categoryClicked:e.categoryClicked})},e.refresherExists=function(){try{if(!x.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;if("favorites"==e.tab)return!0;if("account"==e.tab)return!0;if("all"==e.tab)return!0}catch(e){return!1}return!0},e.doRefresh=function(){var t={accumulated:!0};"all"==e.tab?O(t):"account"==e.tab?(t.account=!0,O(t)):"favorites"==e.tab?e.loadFavorites(t):e.stopRefresher()},e.sort=function(){f.sortMethod=e.sortOb.method,"downloaded"==e.tab?E("orderBy")(e.data.downloaded,e.sortOb.method.data):"account"==e.tab?O({account:!0}):O()},e.menuItemClicked=function(n){"language"==n&&I.langChanged(),"redeemCode"==n&&(u.hide(),e.redeemCodeClicked()),"info"==n&&(u.hide(),d.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up",libraryInfo:x.data.currentLibrary.libraryinfo})),"logout"==n&&(u.hide(),e.data.user.pwd||e.data.user.code?w.logout():t.update({error:"s_authError"})),"exit"==n&&(u.hide(),d.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){C.exit()}}}))},e.loadFavorites=function(t){t||(t={}),e.paneMsg=null,F&&(t.catid=F.id),R&&(t.key=R),j&&(t.contentkey=j),t.favs=!0,f.getEbooks(t,function(t){"favorites"==e.tab&&(t.error&&(e.paneMsg="failedToGetFavs"),0==t.length&&(e.paneMsg="noFavsAvailable"),$())})},e.searchEbooksOld=function(t){e.subMode="search",e.title="searchResults",R=f.currentKey=t,F=f.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),v(function(){O({account:!0})})):(L("all"),v(O)),P()},e.searchEbooks=function(n){if(n&&n.length&&0!=n.length){if(n.length<3)return t.update({error:"lessThan3Characters"}),void d.hide();e.subMode="search",e.title="searchResults",config.searchLibContent?j=f.currentContentKey=n:R=f.currentKey=n,F=f.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),v(function(){O({account:!0})})):(L("all"),v(O)),P()}},e.enableSearch=function(){e.searchOb.enabled=!0,P()},e.disableSearch=function(){e.searchOb.enabled=!1,z&&z()},e.loadMore=function(){var t={more:!0,accumulated:!0};"all"==e.tab?O(t):"account"==e.tab?(t.account=!0,O(t)):"favorites"==e.tab?e.loadFavorites(t):(e.stopInfiniteScroll(),D=!0)},e.stopInfiniteScroll=function(){a.$broadcast("scroll.infiniteScrollComplete")},e.stopRefresher=function(){a.$broadcast("scroll.refreshComplete")},e.moreDataExists=function(){try{if(!x.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;var t;if("favorites"==e.tab&&(t=e.data.favorites),"all"==e.tab&&(t=x.data.currentLibrary.books),"account"==e.tab&&(t=x.data.currentLibrary.books),0==t.length)return!1}catch(e){return!1}return e.moreData},e.back=function(){e.subMode=!1,e.title=null,R=f.currentKey=null,j=f.currentContentKey=null,F=f.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),v(function(){O({account:!0})})):(L("all"),v(O)),z&&z()},e.categoryBackClicked=function(){if(e.catList&&e.catList.length){var t=e.catList[0].parent;for(t=H(t.id);;){if(!(t=t.parent))return void(e.catList=x.data.currentLibrary.categories);if("separate"==(t=H(t.id)).submode)return void(e.catList=t.children)}}},e.categoryClicked=function(t){if(native&&C.vibrate(),"expand"!=t.submode)if("separate"!=t.submode){var n={};F=f.currentCat=t,R=f.currentKey=null,j=f.currentContentKey=null,n.catid=F.id,e.subMode="category",e.title=F.name,e.supportsAccountView?(L("account"),v(function(){O({account:!0})})):(L("all"),v(O)),P()}else e.catList=t.children;else t.expand=!t.expand},e.categoriesClicked=function(){native&&C.vibrate(),L("categories"),e.paneMsg=null,$()},e.accountClicked=function(){native&&C.vibrate(),L("account"),$(),v(function(){O({account:!0})})},e.allClicked=function(){native&&C.vibrate(),L("all"),v(O)},e.downloadedClicked=function(){native&&C.vibrate(),L("downloaded"),e.paneMsg=null,0==x.data.downloaded.length&&(e.paneMsg="noEbooksDownloaded"),$()},e.favoritesClicked=function(){native&&C.vibrate(),L("favorites"),e.loadFavorites()},e.redeemCodeClicked=function(){l.redeemCode({source:"topmenu"},function(){e.allClicked()})}}]),app.controller("LoginCtrl",["$scope","initializer","crdv","$ionicHistory","popovers","design","modals","error","backend","auth","stg","cache","translit","$location",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f){e.model={},e.init=function(){mobile||i.stylize("login",i.getBgStyle()),"email"==config.kotobee.loginmode?e.canLoginByEmail=!0:"code"==config.kotobee.loginmode?e.canLoginByCode=!0:e.canLoginByEmail=e.canLoginByCode=!0,e.mode=e.canLoginByEmail?"email":"code",e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),p.get("login")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||config.kotobee.public||d.data.user.loggedIn){var e="loading";o.forwardView()?e=o.forwardView().stateId:o.backView()&&(e=o.backView().stateId),o.nextViewOptions({disableAnimate:!0}),f.path("/"+e)}})},e.showMenu=function(){var e=[{name:p.get("exit"),func:function(){r.hide(),a.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}];r.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.login=function(){function t(){c.login({dontShowErrorDialog:!0,userInput:!0}).then(function(t){t.error?s.update({error:"s_authError"==t.error?"accessDenied":t.error}):(e.model.pwd=null,e.model.code=null,l.startup())})}if(e.model){if("code"==e.mode){if(!e.model.code)return void s.update({error:"enterYourCode"});d.data.user.code=e.model.code,d.data.user.email=d.data.user.pwd=null}else{if(!d.data.user.email)return void s.update({error:"enterYourEmail"});if(!e.model.pwd)return void s.update({error:"enterYourPwd"});d.data.user.pwd=e.model.pwd,d.data.user.code=null}config.kotobee.permsLoaded?t():l.getPermissions(t)}},e.register=function(){a.hide(),f.path("/register")},e.forgotPassword=function(){f.path("/forgotpwd")},e.signInByEmail=function(){e.mode="email"},e.redeemCode=function(){e.mode="code"}}]),app.controller("MediaCtrl",["$ionicScrollDelegate","media","$ionicModal","$location","$rootScope","$scope","selection","crdv","stg","$ionicLoading",function(e,t,n,o,r,i,a,s,c,l){i.init=function(){},i.mediaClicked=function(e){t.show(e)},i.hide=function(){t.hide()}}]),app.controller("PreviewCtrl",["cache","modals","popovers","bookinfo","crdv","np","book","$http","$rootScope","initializer","translit","error","notes","$sce","design","settings","status","tinCan","$scope","backend","stg","$location",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w){b.putTest=function(e){},b.init=function(){b.putTest("Preview init"),b.mobile=mobile,b.native=native,b.desktop=desktop,b.ios=ios,b.preview=preview,b.config=config,b.putTest("Global init good"),i.init(function(){})},b.start=function(){c.data=y.data,c.view=y.view,b.cloudParam=k.cloudParam,t.setScope(b),n.setScope(b),b.started=!0},b.previewPage=function(e,t){b.started?(e||(e="bookInfo"),t||(t={lang:"en",book:{name:"Alice",description:"A great book indeed"}}),"bookInfo"==e&&(config=t.config?t.config:{kotobee:{entry:1,mode:"library"}},y.data.user=t.user?t.user:{loggedIn:!0},y.data.currentLibrary=t.library?t.library:{},d.setLang(t.lang?t.lang:"en"),o.show({book:t.book},{animation:"none"}))):setTimeout(function(){b.previewPage(e,t)},100)},b.kTemplate=function(e){return kTemplate(e)},b.translit=function(e){return d.get(e)},b.htmlSafe=function(e){return f.trustAsHtml(e)}}]),app.controller("ReaderCtrl",["$ionicScrollDelegate","modals","library","$sce","$location","$rootScope","$scope","selection","$ionicSideMenuDelegate","$state","$ionicPopover","chapters","book","$timeout","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m){a.init=function(){a.mode="reading"},a.chapterClicked=function(e){m.data.settings.rtl?c.toggleRight():c.toggleLeft()},a.backClicked=function(e){c.isOpenLeft()||t.show({mode:"backToLib",backdropClickToClose:!1,backToLibOptions:{back:function(){t.hide(),p.removeBookConfigElem(),u.clearContent(),setTimeout(n.setBrowserTitle,600),setTimeout(m.resetBook,600),r.path("/library")}}})},a.searchClicked=function(e){a.applyHeader("search")},a.menuClicked=function(e){},a.setting1Clicked=function(e){},a.setting2Clicked=function(e){},a.setting3Clicked=function(e){},a.linkClicked=function(){}}]),app.controller("RedeemCodeCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m){e.init=function(){mobile||r.stylize("redeemCode",r.getBgStyle()),e.$on("$ionicView.afterEnter",function(){p.setOb("title",replaceHTML(p.getOb("title"),f.get("redeemCode")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||d.cloudParam("public")||i.data.user&&i.data.user.loggedIn){var e="loading";c.forwardView()?e=c.forwardView().stateId:c.backView()&&(e=c.backView().stateId),c.nextViewOptions({disableAnimate:!0}),a.path("/"+e)}})},e.showMenu=function(){var e=[{name:f.get("exit"),func:function(){n.hide(),s.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){function t(){d.cloudParam("entry")?(m.history.back(),d.login()):d.login().then(function(e){e.error?l.update({error:"s_authError"==e.error?"accessDenied":e.error}):u.startup()})}e.user&&e.user.code&&(i.data.user.code=e.user.code,i.data.user.email=i.data.user.pwd=null,config.kotobee.permsLoaded?t():u.getPermissions(t))},e.backClicked=function(){m.history.back()}}]),app.controller("RegisterCtrl",["$scope","initializer","popovers","crdv","modals","design","stg","$ionicHistory","$location","translit","backend","backend","translit","cache","error","$window",function(e,t,n,o,r,i,a,s,c,l,d,d,l,u,p,f){function m(){var t=e.user;return-1==t.email1.indexOf("@")?(p.update({error:"emailFormatError"}),!1):/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i.test(t.email1)?t.email1==t.email2||(p.update({error:"emailsDontMatch"}),!1):(p.update({error:"emailFormatError"}),!1)}e.init=function(){e.user={email1:"",email2:""},mobile||i.stylize("register",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),l.get("register")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||config.kotobee.public||a.data.user.loggedIn){var e="loading";s.forwardView()?e=s.forwardView().stateId:s.backView()&&(e=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),c.path("/"+e)}})},e.showMenu=function(){var e=[{name:l.get("exit"),func:function(){n.hide(),r.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.create=function(){m()&&d.register(e.user,function(e){if(e.error)p.update(e);else{var t="d_accountCreated";e.success&&e.success.approvalRequired&&(t="d_accountCreatedApprovalRequired"),r.show({mode:"success",successOptions:{msg:l.get(t)}}),f.history.back()}})},e.backClicked=function(){f.history.back()}}]),app.controller("RendererCtrl",["$rootScope","$ionicHistory","modals","nav","backend","library","settings","book","auth","status","popovers","$sce","error","translit","cache","$ionicPlatform","bookmarks","hlights","notes","$ionicSideMenuDelegate","$scope","$ionicScrollDelegate","$filter","chapters","$ionicPopup","$location","$timeout","selection","crdv","$ionicLoading","stg","search","$ionicModal",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C,E,x,I,T,S,A,N,B,L,O){y.init=function(){e.renderScope=y,S.listener=y.selection,y.searchContent={},y.sideMenuMode="bookSettings";var r=g.registerBackButtonAction(function(t){kInteractive.frameIsOpen?kInteractive.closeFrame():kInteractive.alertIsOpen?kInteractive.closeAlert():kInteractive.videoIsFullscreen?kInteractive.closeFullscreenVideo():"default"!=y.header.mode?"selection"==y.header.mode?S.reset():y.applyHeader("default"):B.data.book.chapter.viewport&&o.getFxlScale()!=o.getFxlBestFit()?o.fxlZoomFit():"library"==config.kotobee.mode?I.path("/library"):e.readerApp?I.path("/app"):n.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){A.exit()}}}),y.$apply()},103);if(y.$on("$destroy",r),!desktop&&!chromeApp&&!preview&&ZeroClipboard){ZeroClipboard.config({trustedDomains:["*"],trustedOrigins:["*"]});var i=new ZeroClipboard(document.getElementById("copyBtn"));i.on("ready",function(e){i.on("aftercopy",function(e){e.target.style.display="none",l.showAndHide(f.get("copiedToClipboard"),500)})}),i.on("error",function(e){noFlash=!0})}y.native||y.desktop||y.$on("$ionicView.beforeEnter",function(){if(!c.authenticated){var e="loading";t.forwardView()?e=t.forwardView().stateId:t.backView()&&(e=t.backView().stateId),t.nextViewOptions({disableAnimate:!0}),I.path("/"+e)}})},y.setSideMenuMode=function(e){y.sideMenuMode=e},y.applyHeader=function(e){try{y.header.mode=e}catch(e){}},y.header={mode:"default"},y.selection=function(e){mobile?"activated"==e||"selectionFixed"==e?y.applyHeader("selection"):"deactivated"==e&&y.applyHeader("default"):"selectionFixed"==e?(addClass(document.getElementById("selectionOptions"),"showBar"),document.getElementById("copyBtn").setAttribute("data-clipboard-text",S.getSelectedText())):"deactivated"==e&&removeClass(document.getElementById("selectionOptions"),"showBar")},y.contentLink=function(e){E.applyChapterStateFromURL(e.getAttribute("href"))},y.chapterLink=function(e){if(e.parentElement.getElementsByTagName("ol").length>0){var t=e.offsetHeight+20;if(overflowScroll||w.$getByHandle("chapters").scrollBy(0,t,!0),!e.getAttribute("href")||e.getAttribute("data-dontshow"))return void(hasClass(e.parentElement,"expanded")?removeClass(e.parentElement,"expanded"):addClass(e.parentElement,"expanded"));addClass(e.parentElement,"expanded")}k.toggleLeft(!1),k.toggleRight(!1),timeOut(function(){y.deApplySelectedChapter(),y.applySelectedChapter(e.parentNode,!1),E.applyChapterStateFromURL(e.getAttribute("href")),y.$$phase||y.$apply()},250)},y.targetCurrentChapter=function(e){mobile&&o.resize();var t=S.getIdArray(),n=B.data.book.chapter.url;y.deApplySelectedChapter();for(var r=document.getElementById("chaptersContent").getElementsByTagName("a"),i=[],a=0;a<r.length;a++)-1!=r[a].getAttribute("href").indexOf(n)&&i.push({elem:r[a],id:ph.getHash(r[a].getAttribute("href"))});t.push(void 0);i.length&&y.applySelectedChapter(i[0].elem.parentNode)},y.externalLink=function(e){var t=e.getAttribute("href"),n=e.getAttribute("target");return void r.externalLink(t,{target:n})},y.bookmarkClicked=function(e){h.addBookmark()},y.noteClicked=function(e,t){b.noteClicked(e,t)},y.search=function(e,t,o,r){if(e&&e.length&&0!=e.length){if(e.length<3)return p.update({error:"lessThan3Characters"}),void n.hide();y.applyHeader("default"),void 0==o&&(y.searchStack=[0]),l.update(f.get("searching"),null,{dots:!0,timeoutDuration:6e4}),t||(t="all",o||(o=0));var i={key:e,mode:t,limit:40,start:o,array:r};T(function(){L.start(i,function(e){l.update(null),y.searchContent=e;for(var n=0;n<y.searchContent.results.length;n++)if(y.searchContent.results[n]&&y.searchContent.results[n].matches.length){y.searchContent.notEmpty=!0;break}"all"==t?(y.$broadcast("scroll.infiniteScrollComplete"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop()):"chapter"==t&&T(function(){y.applyHeader("searchItems")},500)})},500)}},y.searchMore=function(){for(var e,t=y.searchContent.results.length;t--;)if(y.searchContent.results[t]&&y.searchContent.results[t].matches[0]){e=y.searchContent.results[t].matches[0];break}e?(y.searchStack.push(e.chapter+1),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop(),y.search(y.searchContent.key,"all",e.chapter+1)):y.searchContent.more=!1},y.searchBack=function(){if(!(y.searchStack.length<=1)){y.searchStack.pop();var e=y.searchStack.pop();overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop(),y.search(y.searchContent.key,"all",e)}},y.locateInChapter=function(e){n.hide(),y.search(e,"chapter")},y.clearResults=function(){y.searchContent={},y.applyHeader("default"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop()},y.searchItemClickedOld=function(e){var t=e.item;e.index,e.matches;n.hide(),timeOut(function(){function e(){E.removeListener(e);var n=S.getElemsByLocation(t.location)[0];timeOut(function(){addClass(n,"searchItemHighlightFade"),timeOut(function(){removeClass(n,"searchItemHighlightFade")},2200)},1200)}E.addListener(e),I.path(s.root+"/reader/chapter/"+t.chapter+"/"+t.location)},300)},y.searchItemClicked=function(e){var t=e.item,o=e.index,r=e.matches;n.hide(),timeOut(function(){function e(){E.removeListener(e),r.index=o,y.applyHeader("searchItems")}E.addListener(e),I.path(s.root+"/reader/chapter/"+t.chapter+"/"+t.location)},300)},y.fxlZoomIn=function(e){o.fxlZoomIn(e)},y.fxlZoomOut=function(e){o.fxlZoomOut(e)},y.fxlZoomFit=function(e){o.fxlZoomFit(e)}}]),app.controller("SearchItemsCtrl",["$ionicScrollDelegate","cache","$ionicModal","$location","virt","$rootScope","$scope","selection",function(e,t,n,o,r,i,a,s){a.index=0,a.init=function(){a.index=0,a.titleMode=3,a.results=[];var e=a.searchContent.results[currentIndex];e&&(a.results=e.matches),a.results.index&&(a.index=a.results.index),0==a.results.length?a.titleMode="empty":a.highlightCurrentItem(),a.$on("$destroy",function(){a.removeHighlights()})},a.backClicked=function(){a.applyHeader("default")},a.up=function(){0==a.index&&(a.index=a.results.length),a.index--,a.highlightCurrentItem()},a.down=function(){a.index==a.results.length-1&&(a.index=-1),a.index++,a.highlightCurrentItem()},a.removeHighlights=function(){for(var e=document.getElementsByClassName("searchItemHighlight"),t=e.length;t--;)removeClass(e[t],"searchItemHighlight")},a.highlightCurrentItem=function(){if(a.results){a.removeHighlights();var e=a.results[a.index].location,t=s.getElemsByLocation(e);t[0].offsetParent?(a.titleMode="title",addClass(t[0],"searchItemHighlight"),r.safeScrollToElem("content",t[0],!0)):a.titleMode="hidden"}}}]),app.controller("SelectionCtrl",["$ionicScrollDelegate","translit","error","status","modals","notes","$window","$location","$sce","$rootScope","backend","hlights","$scope","selection","crdv","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g){p.tts=function(){if(config.tts){var e=f.getSelectedText();if(e)if(desktop)n.update({error:"speechUnsupportedInDesktop"});else if(preview)n.update({error:"speechUnsupportedInPreview"});else if(native&&"undefined"!=typeof TTS)m.tts(e,function(e){});else try{if("speechSynthesis"in window&&SpeechSynthesisUtterance){o.showAndHide(t.get("preparingVoice"),600,{dots:!0}),window.speechSynthesis.cancel();var r=new SpeechSynthesisUtterance,i=window.speechSynthesis.getVoices();if(r.lang=config.defaultTtsLanguage?config.defaultTtsLanguage:"en-US",r.voice=i.filter(function(e){return e.lang==r.lang})[0],!r.voice)return;r.text=e,window.speechSynthesis.speak(r)}else n.update({error:"speechUnsupported"})}catch(e){n.update({error:"speechUnsupported"})}}},p.copy=function(){if(config.clipboardCopy){var e=f.getSelectedText();if(e)if(native)m.copyToClipboard(e);else if(desktop)require("nw.gui").Clipboard.get().set(e,"text"),o.showAndHide(t.get("copiedToClipboard"),500);else if(chromeApp){var n=document.createElement("textarea");document.body.appendChild(n),n.value=e,n.focus(),n.select(),document.execCommand("Copy"),n.remove(),o.showAndHide(t.get("copiedToClipboard"),500)}else noFlash&&(r.show({mode:"flashUnsupported",flashOb:{text:e}}),setTimeout(function(){document.getElementById("clipboardText").focus(),document.getElementById("clipboardText").select()},200))}},p.share=function(){if(config.share){var e=f.getSelectedText();e&&m.share(e)}},p.note=function(e){if(config.annotations){var t={};t.type="content",t.location=f.getLocation(),t.src=f.getSelectedText(),t.event=e,i.noteClicked(t,function(e){f.reset()})}},p.highlight=function(){function e(){u.showPopup(t,function(e){f.reset()})}if(config.annotations){var t={};t.location=f.getLocation();for(var n=f.getSelectedNodes(),o=0;o<n.length;o++)if(hasClass(n[o],"contentHlightBG")){var r=getClassThatStartsWith(n[o],"hlight");return t.hid=r.substr(6),void g.getHlightById(t.hid,function(n){t.color=n.color,e()})}e()}},p.google=function(){if(config.googleLookup){var e=f.getSelectedText();if(e)try{var t="http://www.google.com/custom?q="+e;return void d.externalLink(t,{secure:!0})}catch(e){}}},p.wikipedia=function(){if(config.wikipediaLookup){var e=f.getSelectedText();if(e)try{var t="https://"+(config.wikipediaLang?config.wikipediaLang:"en")+".wikipedia.org/wiki/"+e;d.externalLink(t,{secure:!0})}catch(e){}}},p.backClicked=function(){f.reset()}}]),app.controller("SelectionOptionsCtrl",["$scope","$http","stg","$ionicScrollDelegate","$ionicPopup","$timeout","selection",function(e,t,n,o,r,i,a){e.init=function(){},e.expand=function(){a.expand()},e.extendRight=function(){a.extendRight()},e.extendLeft=function(){a.extendLeft()}}]),app.controller("TabMenuCtrl",["$scope","cache","modals","nav","settings","book","$rootScope","$ionicSideMenuDelegate","library","$stateParams","$location","$sce","$ionicScrollDelegate","chapters","virt","translit","$ionicModal","hlights","$timeout","$filter","stg","crdv","selection",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C){e.init=function(){e.$watch(function(){return s.isOpenRight()},function(t){t||b(function(){e.setSideMenuMode("bookSettings")},100)})},e.chaptersClicked=function(){mobile&&o.resize(),y.data.settings.rtl?s.toggleRight():s.toggleLeft(),native&&w.vibrate()},e.mediaClicked=function(){if(y.data.settings.rtl){if(s.isOpenLeft()&&"media"!=e.sideMenuMode)return s.toggleLeft(),void b(e.mediaClicked,300)}else if(s.isOpenRight()&&"media"!=e.sideMenuMode)return s.toggleRight(),void b(e.mediaClicked,300);native&&w.vibrate(),e.setSideMenuMode("media"),mobile&&o.resize(),y.data.settings.rtl?s.toggleLeft():s.toggleRight()},e.notebookClicked=function(){native&&w.vibrate(),e.createNotebookArray(function(){overflowScroll||o.resize(),n.show({mode:"notebook",dynamic:!0,scope:e,animation:"slide-in-up",cb:function(){overflowScroll?document.getElementById("notebookContent").scrollTop=0:p.$getByHandle("notebookScroll").scrollTop()}})})},e.pdfClicked=function(){f.pdfPrint()},e.printClicked=function(){f.print()},e.settingsClicked=function(){if(y.data.settings.rtl){if(s.isOpenLeft()&&"bookSettings"!=e.sideMenuMode)return s.toggleLeft(),void b(e.settingsClicked,300)}else if(s.isOpenRight()&&"bookSettings"!=e.sideMenuMode)return s.toggleRight(),void b(e.settingsClicked,300);native&&w.vibrate(),e.setSideMenuMode("bookSettings"),mobile&&o.resize(),y.data.settings.rtl?s.toggleLeft():s.toggleRight()},e.searchClicked=function(){native&&w.vibrate(),mobile&&o.resize(),n.show({mode:"search",dynamic:!0,animation:"slide-in-up",scope:e,cb:function(){e.searchContent.notEmpty||b(function(){w.showKeyboard()},200)}})},e.createNotebookArray=function(t){var n=new Array;y.getBookmarks(function(o){for(var r=0;r<o.length;r++){var a=o[r];n[a.chapter]||(n[a.chapter]=new Array),n[a.chapter].push(a)}y.getNotes(function(o){for(var r=0;r<o.length;r++){var a=o[r];n[a.chapter]||(n[a.chapter]=new Array),a.noteTrusted=u.trustAsHtml(a.note.replace(new RegExp("\r?\n","g"),"<br />")),n[a.chapter].push(a)}y.getHlights(function(o){for(a=0;a<o.length;a++){r=o[a];n[r.chapter]||(n[r.chapter]=new Array),n[r.chapter].push(r)}for(var r in n)n[r].title=i.getTitleByIndex(r);for(var a=0;a<n.length;a++)if(n[a])for(var s=0;s<n[a].length;s++){var c=n[a][s].location.split(",");n[a][s].locationDec=Number("0."+c[0].split(".").join(""))}e.notebookContent={results:n},t&&t()})})})},e.serializeNotebookTxt=function(){for(var t="\n",n=g.get("notebookFor")+' "'+e.data.book.meta.dc.title+'"'+t,o=n.length;o--;)n+="#";n+=t+t;for(var r=e.notebookContent.results,i=0;i<r.length;i++)if(r[i]){var a=g.get("chapter")+" "+(i+1);n+=a+t;for(o=a.length;o--;)n+="_";n+=t+t;for(var s=0;s<r[i].length;s++){var c=r[i][s];null!=c.nid?"page"==c.type?n+=g.get("pageNote")+": "+c.note+t:"content"==c.type&&(c.src?n+=g.get("noteFor")+' "'+c.src+'"'+t:n+=g.get("note")+t,n+=g.get("note")+": "+c.note+t):null!=c.hid?(n+=g.get("highlightFor")+' "'+c.src+'"'+t,n+=g.get("highlightColor")+" "+c.color+t):null!=c.bmid&&(n+=g.get("contentBookmark")+t),n+="........................\n\n"}}return n},e.serializeNotebookHtml=function(){function t(e,t,n){for(var o="",r=0;r<e.length;r++){var i=e[r],a=/^[\u0000-\u007f]*$/.test(i);if(a)o+=a?i:"<em>Non-unicode text</em>";else for(var s=0;s<i.length;s++)o+=(a=/^[\u0000-\u007f]*$/.test(i[s]))?i[s]:"?"}return"<"+t+(n?" "+n:"")+">"+o+"</"+t+">"}var n="<br/>",o='<html><head><meta charset="UTF-8" /><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body>';o+=t([g.get("notebookFor"),' "'+e.data.book.meta.dc.title+'"'],"h1"),o+=n+n;for(var r=e.notebookContent.results,a=0;a<r.length;a++)if(r[a]){var s="";s+=t(i.getTitleByIndex(a),"h2")+n;var c="..................................................................................";s+=t([c+c],"p");for(var l=0;l<r[a].length;l++){var d=r[a][l],u="";null!=d.nid?"page"==d.type?u+=t([g.get("pageNote")+": ",d.note],"p")+n:"content"==d.type&&(u+=t([g.get("noteFor"),' "'+d.src+'"'],"p")+n,u+=t([g.get("note")+": ",d.note],"p")+n):null!=d.hid?(u+=t([g.get("highlightFor"),' "'+d.src+'"'],"p")+n,u+=t([g.get("highlightColor")+": "+d.color+n],"p",'style="background-color:'+d.color+'"')):null!=d.bmid&&(u+=t([g.get("contentBookmark")],"p")+n),s+=t([u],"p")}o+=t([s],"p",'style="border:solid 3px #000;background-color:#ddd"')}return o+="</body></html>"},e.shareNotebook=function(){var t=e.serializeNotebookTxt();w.share(t)},e.pdfExport=function(){var t=e.serializeNotebookHtml(),n=(e.data.book.meta.dc.title?e.data.book.meta.dc.title:g.get("book"))+".pdf";b(function(){w.createPDF(t,n,function(e){})},500)},e.deleteFromNotebookContent=function(t,n){for(var o=e.notebookContent.results,r=0;r<o.length;r++)if(o[r])for(var i=0;i<o[r].length;i++)if(o[r][i][t]==n)return void o[r].splice(i,1)},e.notebookClose=function(){n.hide(),e.bookmarkContent=null,e.noteContent=null,e.hlightContent=null,e.notebook={}},e.settingsClose=function(){n.hide(),y.writeSlot("settings"+y.getBookId(!0),e.data.settings)},e.noteBtnClicked=function(e,t){"all"==e?t.notes=t.bookmarks=t.hlights=!(t.notes&&t.bookmarks&&t.hlights):(t.notes=t.bookmarks=t.hlights=!1,t[e]=!0),overflowScroll?document.getElementById("notebookContent").scrollTop=0:p.$getByHandle("notebookScroll").scrollTop()},e.noteItemClicked=function(e){var t=e.chapter,o=e.location;n.hide(),b(function(){t==l.ch&&o==l.hash?f.loadChapterByIndex(t,{hash:o}):d.path(i.root+"/reader/chapter/"+t+"/"+o)},100)},e.deleteBookmark=function(t,n){y.deleteBookmark(t,null,function(n){e.bookmarkContent=n,C.deleteBookMarker(t),e.deleteFromNotebookContent("bmid",t)}),n.stopPropagation()},e.deleteNote=function(t,n){y.deleteNote(t,null,function(n){e.noteContent=n,C.deleteNoteMarker(t),e.deleteFromNotebookContent("nid",t);for(var o=document.getElementsByClassName("note"+t),r=o.length;r--;)r==o.length-1&&(removeClass(o[r],"last"),o[r].removeAttribute("nloc"),o[r].removeAttribute("ncontent")),removeClass(o[r],"contentNoteBG"),removeClass(o[r],"note"+t)}),n.stopPropagation()},e.deleteHlight=function(t,n){v.delete(t,null,function(o){e.hlightContent=o,e.deleteFromNotebookContent("hid",t),n.stopPropagation()})};var E=[];e.customTabClicked=function(e,t){var n=document.createElement("div");if(e.relToRoot=!0,"audio"==e.type){var o=ph.join(bookPath,e.audio);e.id||(e.id=Math.round(1e4*Math.random()));for(var r,i=0;i<E.length;i++)if(E[i].getAttribute("id")=="audio-"+e.id&&!(r=E[i]).paused)return r.pause(),void(r.src="");if(!r){(r=document.createElement("audio")).setAttribute("data-dontclose",!0),r.setAttribute("id","audio-"+e.id),r.setAttribute("controls","true"),r.setAttribute("autoplay","true"),r.setAttribute("data-tap-disabled","false");var s=document.createElement("source");s.src=o,r.appendChild(s),r.appendChild(document.createTextNode("Your browser does not support the audio element")),r.className="ki-noHighlight",r.oncanplay=function(){kInteractive.tinCan({verb:"played",activity:"Audio: "+o})}}if(r.setAttribute("src",o),r.play(),E.push(r),kInteractive.scorm){var c={};c.id=kInteractive.getScormId(e.title,o),c.description="Played audio link: "+o,c.type="other",c.learnerResponses="Played",c.objective=e.options?e.options.objective:null,c.timestamp=new Date,kInteractive.scorm.setInteractions([c])}}else{kInteractive.writeData(n,e);var l=e.url;if(e.hash&&(l+=e.hash),n.className="kInteractive link",!l)return kInteractive.action(n,t),void t.stopPropagation();n.setAttribute("href",l),e.target&&"_blank"==e.target.toLowerCase()&&n.setAttribute("target","_BLANK"),l.match(/http[s]?:/g)?a.renderScope.externalLink(n):0==l.indexOf("/")?window.open(l):0==l.indexOf("mailto:")?window.location.href=l:(0!=l.indexOf("#")&&(l=ph.join(y.data.book.chapter.url,l)),f.applyChapterStateFromURL(l))}}}]),app.controller("TextSizeCtrl",["$scope","$location","cssParser","stg","settings","markers",function(e,t,n,o,r,i){e.backClicked=function(){e.applyHeader("default")},e.plus=function(){var t=r.getTextSize();t>30||(t=Math.round(10*(t+.1))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize())},e.minus=function(){var t=r.getTextSize();t<=.2||(t=Math.round(10*(t-.1))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize())}}]),app.controller("ThumbCtrl",["$scope","$filter","$rootScope","np","$element","stg","$ionicModal","modals","chapters","backend","book","$location","$timeout","$ionicLoading","$ionicPopup","crdv",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g){e.init=function(){if(e.book.coverImg=d.getCoverImgPath(e.book),chromeApp)if(i.data.chromeAssets[e.book.coverImg])e.book.coverImg=i.data.chromeAssets[e.book.coverImg];else{var t=e.book.coverImg;delete e.book.coverImg,getImgDataSrc(t,function(n){e.book.coverImg=n,i.data.chromeAssets[t]=n,e.$apply()})}}}]),app.directive("iframeOnload",[function(){return{scope:!1,link:function(e,t,n){t.on("load",function(){return e.modal.siteOptions.loaded()})}}}]),app.directive("enterWithoutShift",function(){return function(e,t,n){var o;t.bind("keydown keypress",function(t){(o=t.shiftKey)||13===t.which&&(e.$apply(function(){e.$eval(n.enterWithoutShift)}),t.preventDefault())})}}),app.directive("enterWithCtrl",function(){return function(e,t,n){var o;t.bind("keydown keypress",function(t){(o=t.ctrlKey)&&13===t.which&&(e.$apply(function(){e.$eval(n.enterWithCtrl)}),t.preventDefault())})}}),app.directive("searchheader",["$timeout","$parse",function(e,t){return{restrict:"E",replace:!1,scope:{obj:"=obj",prop:"=prop",kotobeeGradient:"=kotobeeGradient",onValue:"=onValue",offValue:"=offValue",noCancel:"=noCancel",searchKeyOb:"=searchKeyOb",onsearch:"&"},templateUrl:kTemplate("headers/headerSearch.html"),link:function(n,o,r){n.$watch("obj[prop]",function(i,a){i===t(r.onValue)(n)&&e(function(){o[0].getElementsByTagName("input")[0].focus()})}),n.hide=function(){n.obj[n.prop]=n.offValue}}}}]),app.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),app.directive("nextchapterscroll",function(){return{restrict:"E",templateUrl:kTemplate("components/nextChapterScroll.html")}}),app.directive("autofocusme",["$timeout",function(e){return{link:function(t,n,o){e(function(){n[0].focus()},350)}}}]),app.directive("readerheader",function(){return{restrict:"E",templateUrl:kTemplate("headers/readerHeader.html"),scope:!1}}),app.directive("headerdefault",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerDefault.html"),scope:!1}}),app.directive("headerselection",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSelection.html"),scope:!1}}),app.directive("headersearchitems",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSearchItems.html"),scope:!1}}),app.directive("headertextsize",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerTextSize.html"),scope:!1}}),app.directive("mouseEvents",["$ionicGesture","settings","nav","stg","$ionicScrollDelegate",function(e,t,n,o,r){return{restrict:"A",link:function(e,t,o){n.init(t)}}}]),app.directive("vanillaScroll",function(){return{restrict:"A",link:function(e,t,n){t[0].addEventListener("scroll",function(){e.scroll(this)})}}}),app.directive("selectOptions",function(){return{restrict:"E",templateUrl:kTemplate("headers/selectOptions.html")}}),app.directive("media",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/media.html"),scope:!1}}),app.directive("noteitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/noteItem.html")}}),app.directive("bookmarkitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/bookmarkItem.html")}}),app.directive("hlightitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/hlightItem.html")}}),app.directive("bookThumb",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/bookThumb.html")}}),app.directive("thumbnail",function(){return{restrict:"A",link:function(e,t,n){t.attr("style","background-size:cover,width:50px,height:50px")}}}),app.directive("showafterimageload",function(){return{restrict:"A",link:function(e,t,n){t.bind("load",function(e){e.currentTarget.style.opacity=1,autoprefixTransform(e.currentTarget,"translate(-50%, -50%) scale(1)")})}}}),app.directive("headerShrink",["autohide",function(e){return{restrict:"A",link:function(t,n,o){e.setup(t,n,o)}}}]),app.directive("categoryList",["autohide",function(e){return{restrict:"E",templateUrl:kTemplate("components/categoryList.html"),scope:{rtl:"=rtl",list:"=list",parent:"=parent",backlist:"=backlist",odd:"=odd",categoryClicked:"=clicked",categoryBackClicked:"=backClicked"}}}]),app.filter("bookSetup",["$rootScope","stg","selection","media","chapters","cache","$ionicScrollDelegate",function(e,t,n,o,r,i,a){return function(){function a(e){n.active()&&n.reset();var t=e.target;if("sections"!=t.nodeName.toLowerCase()&&!hasClass(t,"k-section")&&"video"!=t.nodeName.toLowerCase()&&"audio"!=t.nodeName.toLowerCase())for(var o=t.childNodes.length;o--;)if("#text"==t.childNodes[o].nodeName&&""!=t.childNodes[o].nodeValue.replace(/\s+/g," ").trim())return void n.elementDown(t,e)}var s=document.getElementById("chaptersContent"),c=document.getElementById("epubContainer");i.setOb("epubContainer",c),i.setOb("chaptersContent",s),document.getElementById("chapters").addEventListener("click",function(t){function n(e){for(var t=e.parentNode;t&&t!=document.body;){if(hasClass(t,"menu")&&(hasClass(t,"menu-left")||hasClass(t,"menu-right")))return!0;t=t.parentNode}}var o=t.target;if("a"==o.nodeName.toLowerCase()){if(!n(o))return;var r=o.getAttribute("href");if(r.match(/http[s]?:/g))return;if(0==r.indexOf("/"))return;e.renderScope.chapterLink(o)}else if("i"==o.nodeName.toLowerCase()){if(!n(o))return;if(o.parentElement.getElementsByTagName("ol").length>0)o.offsetHeight,o.parentElement.classList.toggle("expanded")}}),c.addEventListener("touchstart",a),c.addEventListener("mousedown",a),c.addEventListener("click",function(n){var i=n.target;if(i){for(var a=i;a&&a!=c;){if("a"==a.nodeName.toLowerCase()){if(hasClass(a,"ki-btn"))kInteractive.action(a,n);else{var s=a.getAttribute("href");if(!s)return kInteractive.action(a,n),void n.stopPropagation();s.match(/http[s]?:/g)?e.renderScope.externalLink(a):0==s.indexOf("/")?window.open(s):0==s.indexOf("mailto:")?window.location.href=s:(0!=s.indexOf("#")&&(s=ph.join(t.data.book.chapter.url,s)),r.applyChapterStateFromURL(s))}return void n.stopPropagation()}a=a.parentNode}if("video"!=i.nodeName.toLowerCase()&&"audio"!=i.nodeName.toLowerCase()){if("img"==i.nodeName.toLowerCase()){if(hasClass(i,"kInteractive")&&"none"!=kInteractive.readData(i).behavior)return kInteractive.action(i,n),void n.stopPropagation();var l=i.parentNode;if(hasClass(l,"kInteractive")){if(hasClass(l,"widget"))return kInteractive.action(i,n),void n.stopPropagation();if(hasClass(l,"questions"))return kInteractive.action(i,n),void n.stopPropagation()}var d=!0,u=kInteractive.readData(i);if(u?u.popup||(d=!1):d=!1,i.hasAttribute("static")&&(d=!1),i.hasAttribute("data-static")&&(d=!1),d){var p={thumbnail:i.getAttribute("src"),title:i.getAttribute("alt")};return o.show(p),void n.stopPropagation()}}return hasClass(i,"ki-btn")?(kInteractive.action(i,n),void n.stopPropagation()):hasClass(i,"kInteractive")?(kInteractive.action(i,n),void n.stopPropagation()):void("input"!=i.nodeName.toLowerCase()||n.stopPropagation())}}})}}]),app.filter("chapterHtml",function(){return function(e){if(e){for(var t=e.getElementsByTagName("li"),n=t.length;n--;){addClass(t[n],"item");var o=t[n].getElementsByTagName("ol").length?" parent":"";t[n].innerHTML='<i class="icon'+o+'"> </i> '+t[n].innerHTML}e.innerHTML=e.innerHTML.replace(/(<a .*?)(>)/g,'$1 onclick="return false;" $2')}}}),app.filter("contentHtml",["$rootScope","$filter","selection","stg",function(e,t,n,o){return function(e,t){function n(e){if(!e.match(/^http[s]?:/g)&&0!=e.indexOf("/")&&0!=e.indexOf("#dontparse"))return!0}var r=document.createElement("div");r.setAttribute("id","epubContent"),t||(t=o.data.book.chapter.absoluteURL);for(var i=e.getElementsByTagName("body")[0],a=[],s=0;s<i.childNodes.length;s++)3==i.childNodes[s].nodeType&&a.push(i.childNodes[s]);for(s=0;s<a.length;s++){var c=a[s],l=document.createElement("span");l.textContent=c.textContent,c.nextSibling?i.insertBefore(l,c.nextSibling):i.appendChild(l),i.removeChild(c)}kInteractive&&kInteractive.preRender(e);for(var d=getElementsByAttribute(e,"*","src"),s=0;s<d.length;s++)if(n(g=d[s].getAttribute("src"))&&d[s].setAttribute("src",ph.join(t,g)),"img"==d[s].nodeName.toLowerCase()&&(hasClass(d[s],"kInteractive")||hasClass(d[s].parentNode,"kInteractive")||d[s].style.height||d[s].getAttribute("height")||(d[s].style.maxWidth="100%"),chromeApp&&d[s].getAttribute("src"))){var u=d[s],p=u.getAttribute("src");if(isAbsoluteURLAndNotDataPath(p)){var f=u.getAttribute("chrome");o.data.chromeAssets[p]?u.setAttribute("src",o.data.chromeAssets[p]):f&&o.data.chromeAssets[f]?u.setAttribute("src",o.data.chromeAssets[f]):(f=Math.round(1e5*Math.random()),u.setAttribute("src",""),u.setAttribute("chrome",f),getImgDataSrc(p,function(e){setTimeout(function(){o.data.chromeAssets[f]=e;var t=getElementsByAttribute(document,"img","chrome",f);t.length&&t[0].setAttribute("src",e)},300)}))}}for(var m=getElementsByAttribute(e,"*","poster"),s=0;s<m.length;s++){var g=m[s].getAttribute("poster");n(g)&&m[s].setAttribute("poster",ph.join(t,g))}var h=document.createElement("sections"),v=e.getElementsByTagName("body")[0];if(partitionEnabled){for(var b=new Array,k=0;;){var y=!0,w=!1,C=0;b[k]=document.createElement("section"),b[k].setAttribute("sec",k),addClass(b[k],"k-section");for(s=v.childNodes.length;s--;)if(!v.childNodes[s].style||"absolute"!=v.childNodes[s].style.position){if(!((C+=(null!=v.childNodes[s].textContent?v.childNodes[s].textContent:v.childNodes[s].data).length)<4e3||y)){w=!0;break}y=!1,b[k].insertBefore(v.childNodes[s],b[k].firstChild)}if(!w)break;k++}for(s=0;s<b.length;s++)h.insertBefore(b[s],h.firstChild)}else{var E=document.createElement("section");E.setAttribute("sec","0"),addClass(E,"k-section");for(s=v.childNodes.length;s--;)E.insertBefore(v.childNodes[s],E.firstChild);h.appendChild(E)}if(v.appendChild(h),parseSecsSeparate)r.innerHTML=e.getElementsByTagName("body")[0].innerHTML;else{var x,I=[],T=-1!=(x=e.getElementsByTagName("body")[0].innerHTML).indexOf("<pre"),S=-1!=x.indexOf("<code"),A=-1!=x.indexOf("<script");T||S||A?(I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])):(I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])),I.push([/<([^\/][^\s>]*)([^<]*?>)(\s*[^<\s]+\s*)(<(?!\/\1))/g,"<$1$2<span>$3</span>$4"]),I.push([/(<[\/]+?[^\s>]*[^<]*?>)(\s*[^<\s]+\s*)(<)/g,"$1<span>$2</span>$3"]);for(s=0;s<I.length;s++)for(var N=I[s][0],B=I[s][1];N.test(x);)x=x.replace(N,B);r.innerHTML=x}return pauseVideoAndAudio(r),r}}]),app.filter("contentJs",["$rootScope","cache","cssParser","$filter","selection","stg","$q","settings","chapters","bookmarks","hlights","notes",function(e,t,n,o,r,i,a,s,c,l,d,u){return function(e){function n(){function e(){if(r++,"#e7e3d9"==rgb2hex(window.getComputedStyle(t.getOb("epubContent")).getPropertyValue("background-color"))){clearInterval(n),removeClass(o,"hide");for(var e=document.getElementsByTagName("style"),r=0;r<e.length;r++)e[r].hasAttribute("kotobee")&&(e[r].innerHTML=e[r].innerHTML.replace("background-color:#e7e3d9 !important;",""));s.initialize(),c.resolve({})}}removeClass(t.getOb("epubContent"),"bgInherit");var n=setInterval(e,30);e()}var o,c=a.defer(),p=t.getOb("epubContent");return document.getElementById("epubMeta")?(document.getElementById("epubMeta").innerHTML="",o=document.getElementById("epubMeta")):((o=document.createElement("div")).setAttribute("id","epubMeta"),o.className="hide",p.parentNode.insertBefore(o,p.nextSibling)),t.setOb("epubMeta",o),r.newChapter(),!parseSecsSeparate||e?i.getBookmarks(function(e){i.getNotes(function(t){i.getHlights(function(o){for(r=0;r<e.length;r++)e[r].chapter==currentIndex&&l.addIcon(e[r]);for(r=0;r<t.length;r++)t[r].chapter==currentIndex&&u.addIcon(t[r]);for(var r=0;r<o.length;r++)o[r].chapter==currentIndex&&d.addHlight(o[r]);n()})})}):n(),c.promise}}]),app.filter("contentVirt",["stg","bookmarks","notes","hlights","$timeout","$filter","cache","$ionicScrollDelegate",function(e,t,n,o,r,i,a,s){var c,l,d,u,p=[];return function(i,s){function f(e){for(var t=p.length;t--;)if(p[t]==e)return;var n=a.getOb("epubContent").className;addClass(a.getOb("epubContent"),"reveal");var o=e.offsetTop-a.getOb("epubContent").offsetTop;0!=o&&(e.style.marginTop=o+"px",p.push(e),a.getOb("epubContent").className=n)}function m(e,t){if(null==t&&(t=!0),!parseSecsSeparate)return e;if(hasClass(e,"parsed"))return e;addClass(e,"parsed");var n,o=e.innerHTML,r=[];o.indexOf("<pre"),o.indexOf("<code"),o.indexOf("<script");r.push(/([< \/][^>]*?>)((\s*[^<\s]+\s+?)+)([^<\s]+\s*)(<)/g),n=/(>)([^<\n][^<]+?)(<[^\/])/g;for(var i=0;i<r.length;i++){var a=r[i];o=o.replace(a,function(e,t){if(arguments[1].indexOf('class="parsed"')>=0)return e;if(0==arguments[1].indexOf("<pre"))return e;if(0==arguments[1].indexOf("<code"))return e;if(0==arguments[1].indexOf("<script"))return e;var n="",o=arguments[2].split(" ");o[o.length-1]=arguments[4];for(r=0;r<o.length;r++)r&&""==o[r-1].trim()&&(o[r-1]+=" "+o[r],o.splice(r,1),r--);for(var r=0;r<o.length;r++){var i=r==o.length-1?"":" ";n+="<span>"+o[r]+i+"</span>"}return arguments[1]+n+"<"})}n&&(o=o.replace(n,function(e,t){if(!arguments[2].trim())return e;var n="<span>"+arguments[2]+"</span>";return arguments[1]+n+arguments[3]}));var s=replaceHTML(e,o=o.replace(/(<a .*?)(>)/g,'$1 onclick="return false;" $2'));return t&&g(s),s}function g(i){for(var a=0,s=i;null!=(s=s.previousSibling);)a++;r(function(){e.getBookmarks(function(r){e.getNotes(function(i){e.getHlights(function(e){for(s=0;s<r.length;s++)r[s].chapter==currentIndex&&r[s].location.split(".")[1]==a&&t.addIcon(r[s]);for(s=0;s<i.length;s++)i[s].chapter==currentIndex&&i[s].location.split(".")[1]==a&&n.addIcon(i[s]);for(var s=0;s<e.length;s++)e[s].chapter==currentIndex&&e[s].location.split(".")[1]==a&&o.addHlight(e[s])})})})},1e3)}try{if("reset"==i)return c=l=null,d=!0,void(p=[]);var h=a.getOb("epubContent");if("reveal"==i)return void addClass(h,"reveal");if("undoReveal"==i)return void removeClass(h,"reveal");if("parse"==i)return void m(s,!1);if("parseAndAnnotations"==i)return void m(s);var v,b=h.parentNode.parentNode,k=b.style.webkitTransform||b.style.mozTransform||b.style.transform;v=null==i&&null!=s?s:!overflowScroll||!config.overflowScroll&&preview&&mobile?-Number(k.split(",")[1].slice(0,-2)):a.getOb("epubContainer").scrollTop;var y=u>v?"up":"down";u=v;var w,C,E=v+b.parentNode.offsetHeight,x=h.children[0];if(d){for(var I=[],T=0,S=0;S<x.childNodes.length;S++)I[S]={},x.childNodes[S].offsetTop+x.childNodes[S].offsetHeight<v-200?I[S].add=["cNone","noMargin"]:x.childNodes[S].offsetTop>E+200?I[S].add=["cNone","noMargin"]:(0==T&&(I[S].setMargin=!0,T=1,w=S),I[S].remove=["cNone","noMargin"],I[S].setParse=!0,C=S);for(S=0;S<I.length;S++)I[S].setMargin&&f(x.childNodes[S]),I[S].setParse&&m(x.childNodes[S]),addRemoveClass(x.childNodes[S],I[S].add,I[S].remove);for(S=0;S<I.length;S++);return null!=w&&(c=x.childNodes[w]),null!=C&&(l=x.childNodes[C]),void(d=!1)}if("up"==y){if(!(c.offsetTop+c.offsetHeight)<v-0&&!(c.offsetTop>v-200))return;if(l==x.childNodes[0])return}else if("down"==y){if(!(l.offsetTop>E+0||l.offsetTop+l.offsetHeight<E+200))return;if(c==x.childNodes[x.childNodes.length-1])return}c&&(c.offsetTop+c.offsetHeight<v-0?(addClass(c,"cNone"),addClass(c,"noMargin"),c.nextSibling&&(removeClass(c=c.nextSibling,"noMargin"),f(c),c=m(c))):c.offsetTop>v-200&&c.previousSibling&&(addClass(c,"noMargin"),removeClass(c=c.previousSibling,"cNone"),removeClass(c,"noMargin"),f(c),c=m(c))),l&&(l.offsetTop>E+0?(addClass(l,"cNone"),l.previousSibling&&(removeClass(l=l.previousSibling,"cNone"),l=m(l))):l.offsetTop+l.offsetHeight<E+200&&l.nextSibling&&(removeClass(l=l.nextSibling,"cNone"),l=m(l)))}catch(e){}}}]),app.filter("js",["$rootScope","$q","jsParser",function(e,t,n){return function(e,o){var r=t.defer();o||(o={});for(var i=[],a=e.getElementsByTagName("script"),s=0;s<a.length;s++)if(a[s].getAttribute("src")){var c=a[s].getAttribute("src");if(c.indexOf("/kotobeeInteractive.js")>=0)continue;c.indexOf(":/"),i.push({mode:"url",val:c})}else i.push({mode:"code",val:a[s].innerHTML});var l=e.getElementsByTagName("body")[0];return l.getAttribute("onload")&&i.push({mode:"code",val:l.getAttribute("onload")}),o.noJsParse?r.resolve():n.inject(i,function(e){r.resolve(e)}),r.promise}}]),app.filter("coverPath",["stg",function(e){return function(t,n){var o=(config.kotobee.liburl?config.kotobee.liburl:"")+"img/ui/defaultCover.png";return t?isAbsoluteURLPath(t)?t:n?(config.kotobee.liburl?config.kotobee.liburl:"../../")+"books/"+n+"/EPUB/"+t:ph.join(bookPath,e.data.packageURL,t):o}}]),app.filter("categoryStyle",["stg",function(e){return function(e){var t="";return"image"!=e.display&&"imagetext"!=e.display||e.img&&(t+="background-image:url("+("imgUser/"+e.img)+");"),"image"==e.display&&(t+="color:transparent;"),e.css&&(t+=e.css),t}}]),app.filter("catImgPath",["stg",function(e){return function(e){var t=(config.kotobee.liburl?config.kotobee.liburl:"")+"imgUser/"+e;return config.kotobee.liburl+"/"+ph.join(bookPath,t)}}]),app.filter("decodeHtmlEntities",function(){return function(e){return decodeHTMLEntities(e)}}),app.filter("nativeLinks",function(){return function(e){var t=document.createElement("div");t.innerHTML=e;for(var n=t.getElementsByTagName("a"),o=0;o<n.length;o++){var r=n[o].getAttribute("href");n[o].setAttribute("onclick","window.open('"+r+"', '_system');"),n[o].setAttribute("href","#")}return t.innerHTML}}),app.filter("moreDataExists",["stg",function(e){return function(t,n){try{if(!e.currentLibrary)return!1;if("categories"==n)return!1;if("downloaded"==n)return!1;var o;if("favorites"==n&&(o=e.favorites),"all"==n&&(o=e.currentLibrary.books),0==o.length)return!1}catch(e){return!1}return t}}]),app.filter("round",function(){return function(e){return Math.round(e)}}),app.filter("arrayEmpty",["$filter",function(e){return function(t){if(!t)return!0;for(var n=0;n<t.length;n++){if(!Array.isArray(t[n]))return!1;if(!e("arrayEmpty")(t[n]))return!1}return!0}}]),app.filter("langFromId",["stg",function(e){return function(t){for(var n=0;n<e.data.languages.length;n++)if(e.data.languages[n].val==t)return e.data.languages[n].label;return t}}]),app.filter("unsafe",["$sce",function(e){return e.trustAsHtml}]),app.filter("nl2br",function(){return function(e){return e?e.indexOf("</")>=0?e:e.replace(/\n/g,"<br>"):""}}),app.filter("releasePlatform",function(){return function(e){switch(e){case"win32":return"Windows 32-bit";case"win64":return"Windows 64-bit";case"win":return"Windows";case"mac":return"Macintosh"}}}),app.filter("styles",["$rootScope","$q","cssParser","$filter","selection","stg",function(e,t,n,o,r,i){return function(e,o){var r=t.defer();o||(o={});for(var i=[],a=e.getElementsByTagName("link"),s=0;s<a.length;s++)if("text/css"==a[s].getAttribute("type")&&a[s].getAttribute("href").length){var c=ph.join(o.path,a[s].getAttribute("href")),l=!1;isAbsoluteURLPath(a[s].getAttribute("href"))&&(c=a[s].getAttribute("href"),l=!0),i.push({type:"path",val:c,dontCache:l})}for(var d=e.getElementsByTagName("style"),s=0;s<d.length;s++)i.push({type:"local",val:d[s].innerHTML,root:o.path});return o.noCssParse?r.resolve():n.inject(i,function(e){r.resolve(e)}),r.promise}}]),app.filter("t",["translit",function(e){return function(t,n){return e.getLang()?e.get(t,Array.prototype.slice.call(arguments,2)):""}}]),app.factory("app",["$q","backend","modals","$location","sync","$ionicHistory","book","chapters","$compile","translit",function(e,t,n,o,r,i,a,s,c,l){return{}}]),app.factory("auth",["$q","backend","modals","$location","sync","$ionicHistory","status","stg","book","view","chapters","app","$compile","translit",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f){function m(){if({}.watermarkPlaceholder){var e='<div id="watermark"><span>'+f.get("createdUsing")+'</span><a href="#" class="inlineBlock" style="vertical-align: sub" onclick="window.open(\'https://www.kotobee.com\', \'_system\');return false;"><img width="163" src="'+rootDir+'img/ui/authorLogo.png"></a></div>',t=document.createElement("div");t.innerHTML=e,document.body.insertBefore(t,document.getElementById("html5Fallback")),setTimeout(function(){addClass(document.getElementById("watermark"),"show")},4e3)}}var g={};return g.authenticate=function(r){r||(r={putTest:function(){},$$phase:!0});var i=e.defer();return r.putTest("inside"),g.getPermissions(function(e){l.generate();try{if((native||desktop)&&e&&t.cloudParam("offline")&&"offline"==e.error)return void g.startup({tab:"downloads"})}catch(e){}t.cloudParam("public")||t.cloudParam("entry")?g.startup():t.login().then(function(e){e.error?(n.hide(),o.path("/login")):g.startup()})}),i.promise},g.getPermissions=function(e){"library"==config.kotobee.mode?t.getUnauthLibrary(function(t){if(t||(t={}),"offline"!=t.error){if(t.cloud)for(var n in t.cloud)config.kotobee[n]=t.cloud[n];config.kotobee.permsLoaded=!0,e()}else e(t)}):"book"==config.kotobee.mode?(config.kotobee.public=!0,e()):u.getPermissions(e)},g.startup=function(e){if(e||(e={}),native&&m(),"library"==config.kotobee.mode){g.authenticated=!0;var t="";e.tab&&(t="/tab/"+e.tab);try{o.path("/library"+t)}catch(e){}i.clearHistory()}else"book"==config.kotobee.mode?c.loadBook().then(function(){g.authenticated=!0,o.path("/reader"),i.clearHistory(),r.initialize(),setTimeout(function(){d.initialize()},1e3)}):"app"==config.kotobee.mode&&(g.authenticated=!0,o.path("/app"),i.clearHistory())},g.redeemCode=function(e,o){var r=clone(e),i={model:{}};i.submit=function(){n.hide(),r.code=i.model.code,r.code&&(a.update(f.get("pleaseWait"),null,{dots:!0}),t.redeemCode(r,function(e){e&&!e.error?(a.update(),o()):a.showAndHide(f.get(e?e.error:"unexpectedError"),3e3)}))},n.show({mode:"redeemCode",redeemCodeInfo:i})},g}]),app.factory("autohide",["$document","$injector","chapters","stg",function(e,t,n,o){var r={};return r.setup=function(r,i,a){function s(){h||(h=e[0].getElementById("libraryTabs")),h&&(v=h.offsetHeight)}function c(){p=u=0,l(addClass),w=!0}function l(e){e(b,"ease"),d(b,u,k,"up",!!ios),"reader"==a.headerShrink?(e(f,"ease"),e(m,"ease"),d(f,u*g/k,g,o.data.settings.rtl?"left":"right"),d(m,u*g/k,g,o.data.settings.rtl?"right":"left")):"library"==a.headerShrink&&(s(),h&&(e(h,"ease"),d(h,u,v,"up")))}function d(e,t,n,o,r){var i=1-(t=Math.min(n,t))/44;ionic.requestAnimationFrame(function(){if(e){var n;if("up"==o?n="translate3d(0, -"+t+"px, 0)":"right"==o?n="translate3d("+t+"px, 0, 0)":"left"==o&&(n="translate3d(-"+t+"px, 0, 0)"),e.style[ionic.CSS.TRANSFORM]=n,r)for(var a=0,s=e.children.length;a<s;a++)e.children[a].style.opacity=i}})}var u,p,f,m,g,h,v,b,k,y,w,C=!0;if(y=40,"reader"==a.headerShrink){if(!config.autohideHeader)return;b=e[0].getElementById("readerHeader");var E=e[0].body.getElementsByClassName("navControls");if(E.length){var x=(E=E[E.length-1]).getElementsByClassName("next");x.length&&(f=x[0]);var I=E.getElementsByClassName("prev");I.length&&(m=I[0]),g=f.offsetWidth}}else if("library"==a.headerShrink){if(!config.autohideLibHeader)return;b=e[0].getElementById("libraryHeader"),s()}k=b.offsetHeight,ios&&(k-=20),t.get("nav").addListener(function(e){"tap"==e&&c()}),"reader"==a.headerShrink?(r.$watch("data.settings.textSize",function(e,t){c()}),r.$watch("header.mode",function(e,t){c()}),n.addListener(function(){setTimeout(function(){C=!1},1500)})):"library"==a.headerShrink&&(r.$watch("subMode",function(e,t){c()}),r.$watch("searchOb.enabled",function(e,t){c()})),i.bind("scroll",function(e){if(w)return w=!1,void(y=Math.max(40,e.detail.scrollTop));if("reader"==a.headerShrink){if(C)return;if("default"!=r.header.mode)return;if(t.get("nav").transforming)return}else if("library"==a.headerShrink){if(r.subMode)return;if(r.searchOb.enabled)return}(u=k-(k-(e.detail.scrollTop-y)))>=k?(y=e.detail.scrollTop-k,u=k):u<0&&(y=Math.max(40,e.detail.scrollTop),u=0),null==p&&(p=0);var n=removeClass;if(p==k){if(u==k)return;if(u>14)return;y=Math.max(40,e.detail.scrollTop),u=0,n=addClass}u+p==0&&(n=addClass),p=u,n==addClass&&hasClass(b,"ease")||l(n)})},r}]),app.factory("backend",["$http","error","translit","cache","$location","$injector","$ionicHistory","$rootScope","modals","$window","status","crdv","$sce","$timeout","stg","$q","sync",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h){function v(){try{if("undefined"!=typeof lti&&lti&&email&&hash){m.data.user.email=email,m.data.user.pwd=hash,m.data.user.rememberMe=!0;var e=document.getElementsByTagName("head")[0];if(e.length){e[0];for(var t=document.getElementsByTagName("script"),n=0;n<t.length;n++)if(t[n].hasAttribute("lti")){t[n].parentNode.removeChild(t[n]);break}}}}catch(e){}}function b(e){if(m.data.currentLibrary=e,e&&e.categories){for(var t=[],n=0;n<e.categories.length;n++)t.push(e.categories[n]);for(n=0;n<e.categories.length;n++)for(var o=e.categories[n],r=0;r<t.length;r++)t[r].parent&&t[r].parent.id==o.id&&(o.children||(o.children=[]),o.children.push(t[r]),t[r].nested=!0);for(n=0;n<e.categories.length;n++)e.categories[n].nested&&(e.categories.splice(n,1),n--)}}var k={};k.getAuthVarsOld=function(){return{libid:config.kotobee.libid,email:m.data.user.email,pwd:m.data.user.pwd}},k.getAuthVars=function(){var e={email:m.data.user.email,pwd:m.data.user.pwd,code:m.data.user.code,env:config.kotobee.mode};return v(),e.cloudid=config.kotobee.cloudid,"library"==e.env&&m.data.book&&(e.bid=m.data.book.id),uuid&&(e.fingerprint=uuid),e},k.initialize=function(e){e||(e={putTest:function(){},$$phase:!0});arguments.callee;e.putTest("X");var n=g.defer();return e.putTest("Y"),e.putTest("Z"),e.putTest("J"),t.detect("s_authError",k.loginErrorDetection),e.putTest("K"),m.readSlot("user"+config.kotobee.cloudid,function(t){if(config.kotobee.cloudid){var o=t;o&&(m.data.user=o)}m.data.user||(m.data.user={}),0==m.data.user.length&&(m.data.user={}),m.data.user.loggedIn=!1,e.putTest("L"),u.initialize(e,function(){preview?n.resolve():k.getFingerprint(function(e){uuid=e,n.resolve()})})}),n.promise},k.getFingerprint=function(e){function t(){var t={excludeUserAgent:!0,excludeScreenResolution:!0,excludeDoNotTrack:!0,excludeAvailableScreenResolution:!0,excludeOpenDatabase:!0,excludePlugins:!0,excludeCanvas:!0,excludeWebGL:!0,excludeJsFonts:!0};t.excludeCanvas=!1,t.excludeWebGL=!1,new Fingerprint2(t).get(function(t,n){try{t||(t=process.env.USERNAME),m.writeSlot("fingerprint",t,function(){e(t)})}catch(e){}})}native&&window.plugins.uniqueDeviceID?window.plugins.uniqueDeviceID.get(function(n){n&&(n.length?e(n):t())},t):desktop?"mac"==os?t():require("child_process").exec("wmic CPU get ProcessorId",{cwd:"."},function(n,o,r){if(o){var i=o.toUpperCase().split("PROCESSORID");if(i.length){var a=i[1].trim();a.length?e(a):t()}else t()}else t()}):t()};var y=null,w=null;k.setLibraryLoginCallback=function(e){y=e},k.setLibraryLogoutCallback=function(e){w=e},k.loginErrorDetection=function(e){m.data.user.loggedIn=!1,e&&("email"==config.kotobee.loginmode?e.loginOptions.canLoginByEmail=!0:"code"==config.kotobee.loginmode?e.loginOptions.canLoginByCode=!0:e.loginOptions.canLoginByEmail=e.loginOptions.canLoginByCode=!0,e.loginOptions.mode=e.loginOptions.canLoginByEmail?"email":"code",e.loginOptions.signIn=function(){c.hide(),setTimeout(function(){function n(){k.login({userInput:!0}).then(function(t){t.error||e.model&&(e.model.pwd=e.model.code=null)})}if("code"==e.loginOptions.mode){if(!e.model||!e.model.code)return void t.update({error:"enterYourCode"});m.data.user.code=e.model.code,m.data.user.email=m.data.user.pwd=null}else{if(!m.data.user.email)return void t.update({error:"enterYourEmail"});if(!e.model||!e.model.pwd)return void t.update({error:"enterYourPwd"});m.data.user.pwd=e.model.pwd,m.data.user.code=null}config.kotobee.permsLoaded?n():i.get("auth").getPermissions(n)},800)},e.loginOptions.register=function(){c.hide(),r.path("/register")},e.loginOptions.forgotPassword=function(){c.hide(),r.path("/forgotpwd")},e.loginOptions.redeemCode=function(){e.loginOptions.mode="code"},e.loginOptions.signInByEmail=function(){e.loginOptions.mode="email"})};var C=null;return k.refreshSignatures=function(t){var n=config.kotobee.liburl+"user/signatures";e.post(n,getFormData(k.getAuthVars()),postOptions).success(function(e){e.error||(m.data.user.signatures=e.signatures,t&&t())})},k.login=function(o,r){o||(o={});var i={func:arguments.callee,args:arguments};document.body.focus=null;var a=c.show({mode:"loading",loadingMsg:n.get("pleaseWait"),timeLimit:1e4}),s=g.defer();m.data.user.loggedIn=!1,r&&(C=r);var l;"book"==config.kotobee.mode&&(l=config.kotobee.liburl+"library/auth"),"library"==config.kotobee.mode&&(l=config.kotobee.liburl+"library/get"),v(),preview||(k.fingerprint=uuid);var d=k.getAuthVars();return o.userInput&&(d.input=!0),d.platformdesc=navigator.userAgent,native?(d.platform="mobile",device&&(d.platformdesc=device.platform+" "+device.model+" "+device.version+" "+(device.manufacturer?device.manufacturer:""))):d.platform=desktop?"desktop":"web",e.post(l,getFormData(d),postOptions).success(function(e){function n(){if(!e.cloudid&&!e.success)return o.dontShowErrorDialog||t.update({error:"s_authError"}),void s.resolve({error:"s_authError"});m.data.user.loggedIn=!0,"library"==config.kotobee.mode&&(b(e),y&&y()),s.resolve(e),C&&(C(e),C=null)}if(clearTimeout(void 0),c.hide(a),e.error)return o.dontShowErrorDialog||t.update(e),m.data.user.pwd=null,m.data.user.code=null,void s.resolve(e);if(m.data.user.pwd=e.pwd,m.data.user.id=e.userid,m.data.user.name=e.username,m.data.user.lastchap=e.lastchap,m.data.user.signatures=e.signatures,m.data.user.rememberMe){var r={rememberMe:!0};m.data.user.email&&m.data.user.pwd?(r.email=m.data.user.email,r.pwd=m.data.user.pwd):m.data.user.code&&(r.code=m.data.user.code),m.writeSlot("user"+config.kotobee.cloudid,r,n)}else m.clearSlot("user"+config.kotobee.cloudid,n)}).error(function(e){clearTimeout(void 0),c.hide(),t.update({error:"networkError",ref:i})}),s.promise},k.logout=function(){m.data.user.pwd=null,m.data.user.loggedIn=!1,m.data.user.email=null,m.data.user.code=null,m.writeSlot("user"+config.kotobee.cloudid,m.data.user,function(){"library"==config.kotobee.mode?f(function(){if(t.update({error:"s_authError"}),k.cloudParam("entry")){for(var e=0;e<m.data.currentLibrary.books.length;e++)m.data.currentLibrary.books[e].favorite=!1;u.applyExistingBooks()}else m.data.currentLibrary={};w&&w()},200):(r.path("/login"),a.clearHistory())})},k.getPermissions=function(n){var o={func:arguments.callee,args:arguments},r={};return r.env=config.kotobee.mode,r.cloudid=config.kotobee.cloudid,e.post(config.kotobee.liburl+"library/permissions",getFormData(r),postOptions).success(function(e){if(e.error)return t.update({error:"errorAndCallback",msg:e.error,cb:u.exit}),angular.element(document.getElementById("home")).scope().hideLoading=!0,void(s.$$phase||s.$apply());n&&n(e)}).error(function(e,r){(native||desktop)&&k.cloudParam("offline")?n&&n({error:"offline"}):t.update({error:"networkError",ref:o})})},k.register=function(o,r){var i={func:arguments.callee,args:arguments},a=c.show({mode:"loading",loadingMsg:n.get("registeringAccount")}),s=k.getAuthVars();s.email=o.email1,s.promocode=o.promocode,s.root=config.kotobee.liburl;var l=getFormData(s);return l.append("platform",navigator.userAgent),e.post(config.kotobee.liburl+"user/register",l,postOptions).success(function(e){c.hide(a),e.error?t.update(e):r&&r(e)}).error(function(e){t.update({error:"networkError",ref:i})})},k.forgotPwd=function(o,r){var i={func:arguments.callee,args:arguments},a=c.show({mode:"loading",loadingMsg:n.get("retrieving")}),s=k.getAuthVars();s.email=o.email,s.root=config.kotobee.liburl;var l=getFormData(s);return e.post(config.kotobee.liburl+"user/forgotpwd",l,postOptions).success(function(e){c.hide(a),e.error?t.update(e):r&&r(e)}).error(function(e){t.update({error:"networkError",ref:i})})},k.redeemCode=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(k.getAuthVars());i.append("redeemcode",n.code),i.append("platform",navigator.userAgent),e.post(config.kotobee.liburl+"user/redeemcode",i,postOptions).success(function(e){o(e)}).error(function(){t.update({error:"networkError",ref:r})})},k.downloadEbookTest=function(e,n){var o={responseType:"blob",onProgress:function(e){}},r={id:e.id,mode:e.binary};return k.sendRawPost("http://192.168.1.5/files/test.zip",r,o,function(e){if(e.error)return t.update(e),void n();n(e)})},k.downloadEbook=function(e,n,o){try{var r={responseType:"blob",onProgress:n},i={id:e.id,mode:"binary",requester:"reader"};return k.sendRawPost(config.kotobee.liburl+"library/ebook/download",i,r,function(e){if(e.error)return t.update(e),void o();o(e)})}catch(e){}return},k.tincan=function(t,n){var o=getFormData(k.getAuthVars());for(var r in t)o.append(r,t[r]);e.post(config.kotobee.liburl+"tincan",o,postOptions).success(function(e){n&&n()}).error(function(e,t){})},k.getUnauthLibrary=function(n){if("library"==config.kotobee.mode){var o={func:arguments.callee,args:arguments},r=getFormData(k.getAuthVars());e.post(config.kotobee.liburl+"library/getbasic",r,postOptions).success(function(e){b(e),n&&n(e)}).error(function(e,r){(native||desktop)&&k.cloudParam("offline")?n&&n({error:"offline"}):t.update({error:"networkError",ref:o})})}},k.addtoFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(k.getAuthVars());i.append("bid",n.id),i.append("cloudid",k.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/add",i,postOptions).success(function(e){if(e.error)return t.update(e),void o();o(e)}).error(function(){t.update({error:"networkError",ref:r})})},k.removeFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(k.getAuthVars());i.append("bid",n.id),i.append("cloudid",k.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/remove",i,postOptions).success(function(e){if(e.error)return t.update(e),void o();o(e)}).error(function(e){t.update({error:"networkError",ref:r})})},k.getServerLang=function(t,n){if(isKotobeeHosted()){var o=getFormData();o.append("lang",t.lang),o.append("root",rootDir);var r=document.getElementsByTagName("base");return r.length&&o.append("base",r[0].getAttribute("href")),e.post(config.kotobee.liburl+"library/getlang",o,postOptions)}return e.get(cacheBust(rootDir+"locales/"+t.lang+".js"))},k.addBookStat=function(t,n){if(t||(t={}),!preview&&config.kotobee.cloudid){window.location.href;var o=getFormData(k.getAuthVars());o.append("type",t.type),e.post(config.kotobee.liburl+"library/ebook/stat",o,postOptions).success(function(e){}).error(function(){})}},k.addStat=function(t,n){if(t||(t={}),!preview){var o=window.location.href;if(!(o.indexOf("localhost/")>=0||o.indexOf("localhost:")>=0)){var r=getFormData(k.getAuthVars());r.append("software",s.readerApp?"readerapp":"reader"),r.append("platform",navigator.userAgent),r.append("assetType",config.kotobee.mode);try{r.append("assetName","book"==config.kotobee.mode?m.data.book.meta.dc.title:m.data.currentLibrary.name)}catch(e){}r.append("assetPath",o.split("#")[0]),config.kotobee.cloudid&&r.append("assetId",config.kotobee.cloudid),m.data.user.email&&r.append("email",m.data.user.email),m.data.user.code&&r.append("code",m.data.user.code),t.action&&r.append("action",t.action),t.param&&r.append("param",t.param),e.post(config.kotobee.liburl+"stat/add",r,postOptions).success(function(e){}).error(function(){})}}},k.externalLink=function(e,t){try{if(t||(t={}),t.secure&&!native&&!desktop&&!preview)return void l.open(e);var o=function(e,t){native?u.openInNativeBrowser(e,t):desktop?require("nw.gui").Shell.openExternal(e):window.open(e,"_blank")};if(t.target&&"_blank"==t.target.toLowerCase())return void o(e,!0);if(native)return void o(e);var r={title:n.get("externalLink"),src:p.trustAsResourceUrl(e),openInNativeBrowser:o};r.status="loading";var i=setTimeout(function(){r.status="",r.error=n.get("errorLoadingPage"),s.$$phase||s.$apply()},1e4);r.loaded=function(e,t,n){r.status="loaded",clearTimeout(i),s.$$phase||s.$apply()};var a=c.show({mode:"externalSite",animation:"slide-in-up",dynamic:!0,backdropClickToClose:!1,siteOptions:r});desktop||preview||k.getXframeOptions({url:e},function(t){if(r.status="loaded",s.$$phase||s.$apply(),t&&t.success){var n=t.success.toLowerCase();"sameorigin"!=n&&"deny"!=n||(c.hide(a),setTimeout(function(){c.show({mode:"xFrameError",errorOptions:{url:e,openInNativeBrowser:o}})},500))}})}catch(e){}},k.createRequest=function(t,n,o){n||(n={});var r=getFormData(k.getAuthVars());for(var i in n)r.append(i,n[i]);e.post(t,r,postOptions).success(function(e){o(e)}).error(function(){o(!1)})},k.convertPDF=function(t,n){if(t||(t={}),!preview){var o=getFormData(k.getAuthVars());o.append("url",t.url),e.post(config.kotobee.liburl+"library/pdf",o,postOptions).success(function(e){n(e)}).error(function(){})}},k.getXframeOptions=function(t,n){arguments.callee;var o=getFormData(k.getAuthVars());o.append("url",t.url),e.post(config.kotobee.liburl+"getxframe",o,postOptions).success(function(e){e.error?n():n(e)}).error(function(e){})},k.hasAccessTo=function(t,n){if("library"==config.kotobee.mode){var o=getFormData(k.getAuthVars());t||(t={});for(var r in t)o.append(r,t[r]);e.post(config.kotobee.liburl+"user/access",o,postOptions).success(function(e){n&&n(e)}).error(function(e,t){n&&n({error:""})})}else n&&n({success:!0})},k.setLastChapter=function(t){var n=getFormData(k.getAuthVars());n.append("chapter",currentIndex),e.post(config.kotobee.liburl+"user/lastchap",n,postOptions).success(function(e){t&&t(e)}).error(function(e,n){t&&t({error:""})})},k.cloudParam=function(e){return config.kotobee[e]},k.getEbook=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(k.getAuthVars());for(var a in n)i.append(a,n[a]);e.post(config.kotobee.liburl+"library/ebook/get",i,postOptions).success(function(e){e.error&&t.update(e),o&&o(e)}).error(function(e){t.update({error:"networkError",ref:r}),o&&o({error:"networkError"})})},k.getEbooks=function(n,o,r){var i={func:arguments.callee,args:arguments},a=getFormData(k.getAuthVars());for(var s in n)a.append(s,n[s]);e.post(config.kotobee.liburl+"library/ebook/all",a,postOptions).success(function(e){e.error&&t.update(e),r&&r(e,o)}).error(function(e){t.update({error:"networkError",ref:i}),r&&r({error:"networkError"},o)})},k.sendRawPost=function(e,t,n,o,r){r||(r=0);for(var i="",a=[k.getAuthVars(),t],s=0;s<a.length;s++)for(var c in a[s]){var l=a[s][c];void 0!=l&&("object"!=typeof l&&("string"==typeof l&&(l=encodeURIComponent(l=("."+l).substr(1))),"boolean"==typeof l&&(l=l?1:0),i+="&"+c+"="+l))}var d=new XMLHttpRequest;d.open(n.method?n.method:"POST",e,!0),"GET"!=n.method&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onProgress&&(d.onprogress=function(e){e.lengthComputable&&n.onProgress(e.loaded/e.total)}),n.responseType&&(d.responseType=n.responseType);var u;return d.addEventListener("error",function(e){o({error:"networkError"}),u=!0},!1),d.onreadystatechange=function(e){d.aborted||4==d.readyState&&(200==d.status?f(function(){o(d.response)}):d.onerror())},d.onerror=function(i){if(!u){if(!(r>=3))return k.sendRawPost(e,t,n,o,++r);f(function(){o({error:"d_connectionTimedOut"})})}},"GET"!=n.method?d.send(i):d.send(),d},k.abort=function(e){e&&4!=e.readyState&&(e.aborted=!0,e.abort())},k}]),app.factory("book",["$http","error","$timeout","$rootScope","crdv","translit","modals","design","$location","library","np","sync","cssInjector","jsParser","chapters","cssParser","$q","status","backend","tinCan","stg","$sce","$filter",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C){function E(t,n){!t.dver||t.dver<2?n():e.get(cacheBust(ph.join(bookPath,"_kmeta/config.js"))).success(function(e){if(-1!=e.indexOf("var config")){e=e.replace("var config","var bookConfig");var t=document.createElement("script");t.setAttribute("bookconfig",!0);var o=document.getElementsByTagName("head");o.length&&o[0].appendChild(t),t.innerHTML=e,T||(T=clone(config));for(var r in bookConfig)"kotobee"!=r&&(config[r]=bookConfig[r]);s.injectUserCSS(config),s.convertTabs(),n&&n()}else n()}).error(function(){n&&n()})}function x(e){for(var t=document.createElement("ol"),n=0;n<e.childNodes.length;n++)if(e.childNodes[n]){var o=e.childNodes[n];if(8!=o.nodeType&&"#text"!=o.nodeName&&"navpoint"==o.nodeName.toLowerCase()){for(var r,i,a,s=0;s<o.childNodes.length;s++)if(o.childNodes[s]){var c=o.childNodes[s].nodeName.toLowerCase();"content"==c?i=o.childNodes[s].getAttribute("src"):"navlabel"==c?r=o.childNodes[s].textContent.trim():"navpoint"==c&&(a||(a=x(o)))}var l=document.createElement("li"),d=document.createElement("a");d.innerHTML=r||"",d.setAttribute("href",i?ph.join(y.data.tocPath,i):""),l.appendChild(d),a&&l.appendChild(a),t.appendChild(l)}}return t}var I={};I.root="",I.initialize=function(){},I.getCoverImgPath=function(e,t){if(t||(t=e.path),!e.cover)return"";var n=C("coverPath")(e.cover,t);return e.exists&&(native?n=r.libEbooksDirectory.nativeURL+t+"/EPUB/"+e.cover.replace("_thumb",""):desktop&&(n=ph.normalize(d.getBooksPath()+t+"/"+e.cover.replace("_thumb","")))),n},I.getBgImgPath=function(e,t){if(t||(t=e.path),!e.cover)return"";var n=(config.kotobee.liburl?config.kotobee.liburl:"../../")+"books/"+e.path+"/"+e.bgimg;return e.exists&&(native?n=r.libEbooksDirectory.nativeURL+t+"/"+e.bgimg:desktop&&(n=ph.normalize(d.getBooksPath()+t+"/"+e.bgimg))),n},I.open=function(e){if(preview)return a.hide(),void setTimeout(function(){a.show({mode:"generalError",errorOptions:{msg:i.get("cantPreviewLibBook")}})},500);native?(r.vibrate(),bookPath=r.libEbooksDirectory.nativeURL+e.path+"/EPUB/"):desktop?(bookPath=d.getBooksPath()+e.path+"/","mac"==os&&(bookPath="file://"+bookPath)):bookPath=config.kotobee.liburl+"books/"+e.path+"/EPUB/",a.hide(),setTimeout(function(){v.update(i.get("pleaseWait"),null,{dots:!0}),function(t){(native||desktop)&&e.exists?t({success:!0}):b.hasAccessTo({testagainst:e.id},t)}(function(t){t.success?I.loadBook().then(function(){E(e,function(){if(y.data.book.id=e.id,y.data.epub.bookThumb=I.getCoverImgPath(e,y.data.book.path),chromeApp)if(y.data.chromeAssets[y.data.book.bookThumb])y.data.epub.bookThumb=y.data.chromeAssets[y.data.book.bookThumb];else{var t=y.data.epub.bookThumb;delete y.data.epub.bookThumb,getImgDataSrc(t,function(e){y.data.epub.bookThumb=e,y.data.chromeAssets[t]=e})}v.update(),I.root="/book/"+y.data.book.id,c.path(I.root+"/reader"),u.initialize(),setTimeout(function(){m.initialize()},1e3)})}):v.update()})},200)},I.removeBookConfigElem=function(){for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++)if(e[t].hasAttribute("bookconfig")){e[t].parentNode.removeChild(e[t]);break}if(T){for(var n in config)"kotobee"!=n&&delete config[n];for(var n in T)config[n]=T[n];s.injectUserCSS(config)}};var T;return I.loadBook=function(){function n(){b.addStat({action:"open"}),C("chapterHtml")(y.data.toc),y.data.book.chapters=y.data.toc.innerHTML,c.resolve()}var s={func:arguments.callee,args:arguments},c=h.defer();return y.resetBook(),g.clearCache(),f.clearCache(),m.clearCache(),e.get(cacheBust(ph.join(bookPath,"META-INF/container.xml"))).success(function(c){config.kotobee.encodekey&&(c=config.v>=1.1?CryptoJS.AES.decrypt(c,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,c));var l=parser.parseFromString(c,"text/xml");y.data.epub={};try{y.data.packageURL=l.getElementsByTagName("rootfile")[0].getAttribute("full-path")}catch(e){return v.update(),void t.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit})}var d=config.v,u=native||isKotobeeHosted();!function(n){window.location.origin;var r=Math.round(9999*Math.random());"book"==config.kotobee.mode&&!o.readerApp&&d>=1.3&&!u?e.get("js/templates.js?c="+r).success(n).error(function(){t.update({error:"networkError",ref:s})}):n()}(function(r){e.get(cacheBust(ph.join(bookPath,y.data.packageURL))).success(function(t){function s(){var e=angular.element(document.getElementById("home"));e&&(e.scope().hideLoading=!0,o.$$phase||o.$apply()),v.update(),a.show({mode:"generalError",errorOptions:{msg:i.get("errorLoadingPage")}})}if("book"==config.kotobee.mode&&!o.readerApp)if(d>=1.3){if(u){if(0!=config.checksum.indexOf(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()))return void s()}else if(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()+CryptoJS.MD5(r).toString()!=config.checksum)return void s()}else if(d>=1.2&&CryptoJS.MD5(t).toString()!=config.checksum)return void s();config.kotobee.encodekey&&(t=config.v>=1.1?CryptoJS.AES.decrypt(t,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,t)),t=t.replace(/href="([^"]*?&[^"]*?)"/g,function(e,t){return'href="'+t.replace(/&/g,"")+'"'});var c=parser.parseFromString(t,"text/xml");y.data.epub.metadata=c.getElementsByTagName("metadata")[0],y.data.epub.manifest=c.getElementsByTagName("manifest")[0],y.data.epub.spine=c.getElementsByTagName("spine")[0];y.data.mediaList=[],y.data.book.meta={},y.data.book.version=3;try{for(w=0;w<y.data.epub.metadata.childNodes.length;w++){var l=y.data.epub.metadata.childNodes[w];if(8!=l.nodeType&&"#text"!=l.nodeName)if(l.hasAttribute("name")&&"meta"==l.nodeName.toLowerCase())y.data.book.meta[l.getAttribute("name")]=l.getAttribute("content");else for(var p,f=(p=l.hasAttribute("property")?l.getAttribute("property"):l.nodeName).split(":"),m=y.data.book.meta,g=0;g<f.length;g++)g==f.length-1?m[f[g].toLowerCase()]=l.innerHTML?l.innerHTML:l.textContent:(m[f[g].toLowerCase()]||(m[f[g].toLowerCase()]={}),m=m[f[g].toLowerCase()])}}catch(e){}y.initializeSettings();for(var h="image/.*",b=getElementsByAttribute(y.data.epub.manifest,"item","media-type",h),w=0;w<b.length;w++){var E=b[w].getAttribute("href");if(0!=E.indexOf("js/widgets/")&&(0!=E.indexOf("xhtml/pdf")||-1==E.indexOf("/page"))){(m={}).thumbnail=ph.join(bookPath,y.data.packageURL,b[w].getAttribute("href")),m.title=ph.removeExtension(ph.basename(m.thumbnail));h=b[w].getAttribute("media-type");m.type=h.split("image/")[1],y.data.mediaList.push(m),chromeApp&&isAbsoluteURLAndNotDataPath(m.thumbnail)&&(y.data.chromeAssets[m.thumbnail]?m.thumbnail=y.data.chromeAssets[m.thumbnail]:function(e,t){getImgDataSrc(e.thumbnail,function(n){y.data.chromeAssets[e.thumbnail]=n,e.thumbnail=n,t&&t()})}(m))}}var I=getElementsByAttribute(y.data.epub.manifest,"item","properties","cover-image");I.length>0?y.data.epub.bookThumb=C("coverPath")(I[0].getAttribute("href")):y.data.book.meta.cover&&(I=getElementsByAttribute(y.data.epub.manifest,"item","id",y.data.book.meta.cover)).length>0&&(y.data.epub.bookThumb=C("coverPath")(I[0].getAttribute("href"))),chromeApp&&y.data.epub.bookThumb&&(y.data.chromeAssets[y.data.epub.bookThumb]?y.data.epub.bookThumb=y.data.chromeAssets[y.data.epub.bookThumb]:getImgDataSrc(y.data.epub.bookThumb,function(e){y.data.chromeAssets[y.data.epub.bookThumb]=e,y.data.epub.bookThumb=e}));try{y.data.tocPath=getElementsByAttribute(y.data.epub.manifest,"item","properties","[s]*nav[s]*")[0].getAttribute("href")}catch(e){var T=y.data.epub.spine.getAttribute("toc");if(!T)return void n();try{y.data.book.version=2,y.data.tocPath=getElementsByAttribute(y.data.epub.manifest,"item","id",T)[0].getAttribute("href")}catch(e){return void n()}}e.get(cacheBust(ph.join(bookPath,y.data.packageURL,y.data.tocPath))).success(function(e){if(config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e)),2==y.data.book.version){var t=(o=parser.parseFromString(e,"text/xml")).getElementsByTagName("navMap");t.length&&(y.data.toc=x(t[0]))}else for(var o=parser.parseFromString(e,"text/html"),r=o.getElementsByTagName("ol"),i=0,a=0;a<r.length;a++){var s=r[a].getElementsByTagName("a");if(!(s.length<i)){i=s.length,y.data.toc=r[a];for(var c=s.length;c--;)s[c].getAttribute("href")?s[c].setAttribute("href",ph.join(y.data.tocPath,s[c].getAttribute("href"))):s[c].setAttribute("href","")}}n()}),k.send({verb:"opened",activity:"Book: "+y.data.book.meta.dc.title})}).error(function(){t.update({error:"networkError",ref:s})})})}).error(function(e){v.update(),native||desktop||"file://"!=window.location.origin?t.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit}):t.update({error:"This browser failed to run the ebook app locally. Please try a different browser, or upload the web files to your server and run the web app online"})}),c.promise},I.getTitleByIndex=function(e){if(y.data.toc)try{for(var t=y.data.toc.getElementsByTagName("li"),n=[],o=0;o<t.length;o++)if(t[o]){var r=t[o].getElementsByTagName("a");r.length&&"true"!=r[0].getAttribute("data-dontshow")&&n.push(t[o])}return n[e].getElementsByTagName("a")[0].textContent}catch(e){}},I}]),app.factory("bookinfo",["$http","error","$timeout","auth","$rootScope","crdv","np","library","book","sync","$location","translit","modals","cssInjector","jsParser","chapters","cssParser","$q","status","backend","tinCan","stg","$sce","$filter",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C,E){function x(e){var t={};return t.background="url('"+e+"')",t["background-size"]="cover",t["background-position"]="center center",t.opacity="1",t}function I(){N(),(native||desktop)&&"download"==P&&(P="loading"),native||desktop||"open"!=P||(P="loading"),"login"==P&&(D.unauthredirect&&(D.redirect=w.data.currentLibrary.unauthredirect),D.overrideunauthredirect&&(D.redirect=D.unauthredirect)),B()}function T(){"loading"==P&&(D.redirect=null,k.hasAccessTo({testagainst:D.id},function(e){e.success?N():(P="denied",D.redirect=w.data.currentLibrary.unauthredirect,D.overrideunauthredirect&&(D.redirect=D.unauthredirect)),B(),r.$$phase||r.$apply()}))}function S(e,t,n,o){native?i.writeEbook(e,t,n,o):desktop&&a.writeEbook(e,t,n,o)}function A(e){return w.data.info||(w.data.info={}),w.data.info["book"+e.id]||(w.data.info["book"+e.id]={}),w.data.info["book"+e.id]}function N(){D&&(native||desktop?P=D.exists?"open":A(D).loading?"downloading":A(D).extracting?"extracting":k.cloudParam("public")?"download":w.data.user.loggedIn?"download":k.cloudParam("entry")?"login":"download":k.cloudParam("public")?P="open":w.data.user.loggedIn?P="open":k.cloudParam("entry")&&(P="login"))}function B(){R&&R.ui&&(R.ui.actionBtnIcon=O(),R.ui.actionBtnSpinnerIcon=$(),R.ui.actionBtnLabel=M(),R.ui.actionBtnStyle=L())}function L(){return"open"==P?"openBtn":"login"==P?"openBtn":"downloading"==P?"downloadingBtn":"extracting"==P?"downloadingBtn":"loading"==P?"loadingBtn":"denied"==P?"deniedBtn":"downloadBtn"}function O(){return"open"==P?"ion-eye size18":"login"==P?"ion-person":"download"==P?"ion-code-download":"downloading"==P?null:"loading"==P?null:void 0}function $(){return"downloading"==P?"dots":"loading"==P?"dots":void 0}function M(){return"open"==P?"openBook":"login"==P?"loginToRead":"download"==P?"download":"downloading"==P?"downloading":"extracting"==P?"extracting":"loading"==P?"pleaseWait":"denied"==P?"bookAccessDenied":void 0}function H(e,t){native?i.deleteEbook(e,t):desktop&&a.deleteEbook(e,t)}var P,D,R,F,z={};return z.redeemCode=function(){p.hide(),o.redeemCode({source:"bookinfo"},function(){z.show(F)})},z.show=function(e,t){t||(t={}),F=e,D=e.book,native&&i.vibrate(),e.book.coverImg=c.getCoverImgPath(e.book),e.book.coverStyle=e.book.bannerStyle={"background-image":"url('"+e.book.coverImg+"')"},e.book.bgimg&&(e.book.bannerStyle=x(c.getBgImgPath(e.book))),chromeApp&&(w.data.chromeAssets[e.book.coverImg]?e.book.coverStyle=e.book.bannerStyle={"background-image":"url('"+w.data.chromeAssets[e.book.coverImg]+"')"}:getImgDataSrc(e.book.coverImg,function(t){w.data.chromeAssets[e.book.coverImg]=t,e.book.coverStyle={"background-image":"url('"+t+"')"},e.book.bgimg||(e.book.bannerStyle=e.book.coverStyle)}),e.book.bgimg&&(w.data.chromeAssets[e.book.bgImg]?e.book.bannerStyle=x(w.data.chromeAssets[e.book.bgImg]):getImgDataSrc(c.getBgImgPath(e.book),function(t){w.data.chromeAssets[e.book.bgImg]=t,e.book.bannerStyle=x(t)})));var n={};e.book.meta||(e.book.meta={});for(var o in e.book.meta)n[o]=e.book.meta[o];e.book.meta.dc=n;var r={};r.book=e.book,r.categoryClicked=e.categoryClicked,r.ui={},R=r;var a="slide-in-up";"none"==t.animation&&(a="none"),p.show({mode:"bookInfo",dynamic:!0,animation:a,bookInfoOptions:r}),I(),setTimeout(T,mobile?1e3:500)},z.download=function(e){function t(t){A(e).progress=Math.ceil(100*t),r.$$phase||r.$apply()}A(e).loading||(i.vibrate(),i.toast(u.get("bookIsDownloading")),A(e).loading=!0,N(),B(),A(e).progress=0,setTimeout(function(){k.downloadEbook(e,t,function(t){A(e).loading=null,t&&(A(e).extracting=!0,N(),B(),n(function(){S("src.zip",e,t,function(t){A(e).extracting=null,N(),B(),p.hide(),n(function(){p.show({mode:"bookDownloaded",downloadedOptions:{book:e,open:c.open},apply:!0}),i.applyExistingBooks(w.data.currentLibrary.books),k.addBookStat({type:"download"})},1e3)})}))})},500))},z.action=function(e){"loading"!=P&&"denied"!=P&&("open"==P?c.open(e):"login"==P?(p.hide(),setTimeout(k.login,1e3)):"download"==P&&z.download(e),N(),B())},z.delete=function(e){i.toast(u.get("deletingBook")),i.vibrate(),H(e,function(){N(),B(),r.$$phase||r.$apply()})},z.toggleFav=function(e){e.favorite?z.removeFav(e,!0):z.addToFav(e,!0)},z.addToFav=function(e,t){t?e.favorite=!0:b.update(u.get("addingToFavorites"),null,{dots:!0}),k.addtoFav(e,function(){e.favorite=!0,t||b.update()})},z.removeFav=function(e,t){t?e.favorite=!1:b.update(u.get("removingFromFavorites"),null,{dots:!0}),k.removeFav(e,function(){e.favorite=!1,t||b.update(),angular.element(document.getElementById("library")).scope().loadFavorites()})},z}]),app.factory("cache",function(){var e={},t={};return e.initialize=function(){e.setOb("body",document.getElementsByTagName("body")[0]);var t=document.getElementsByTagName("title"),n=null;t.length?n=t[0]:(n=document.createElement("title"),document.head.appendChild(n)),e.setOb("title",n)},e.setOb=function(e,n){return t[e]=n,n},e.getOb=function(e){return t[e]},e}),app.factory("chapters",["$http","tinCan","backend","library","error","crdv","$stateParams","sync","scorm","cache","modals","status","$injector","$timeout","virt","$ionicPopup","translit","selection","$ionicScrollDelegate","$filter","$rootScope","cssInjector","cssParser","jsParser","$location","$sce","$q","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k,y,w,C,E,x,I,T,S){function A(){var e=document.getElementById("ebookLoaderAnim");e&&addClass(e,"hide")}function N(){var e=document.getElementById("ebookLoaderAnim");e&&removeClass(e,"hide")}function B(e,t){e||(e={});var n=l.getOb("epubContainer");if(null==currentIndex)return n.style.opacity=0,N(),void(t&&t());if(e.page!=currentIndex-1&&e.page!=currentIndex+1)return n.style.opacity=0,e.page!=currentIndex&&N(),void(t&&t());var o=e.page>currentIndex?"next":"prev",r=document.getElementById(o+"Page"),i=H(ph.join(bookPath,S.data.packageURL,G.getChapterURL(e.page)));if(i&&i.viewport){var a=r.getElementsByTagName("iframe");if(a.length){a[0].contentDocument.getElementById("epubContainer");var s=a[0].contentDocument.getElementById("epubContent"),c=a[0].contentDocument.getElementById("epubScroller");s&&(s.style.width=i.viewport.width+"px",s.style.height=i.viewport.height+"px"),c&&autoprefixTransform(c,"scale("+p.get("nav").getFxlBestFit(i,s)+")")}}if("navSlide"==S.data.settings.navAnim)S.data.settings.rtl?r.style.transform="translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)":r.style.transform="translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)",setTimeout(function(){e.animID==U&&(S.data.settings.rtl?autoprefixTransform(n,"translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)"):autoprefixTransform(n,"translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)"),r.style.transform="translate3d(0,0,0)",addClass(n,"anim"),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==U&&(autoprefixTransform(n,null),removeClass(n,"anim"),t&&t())},330))},30);else if("navFade"==S.data.settings.navAnim)r.style.left=0,r.style.opacity=1,addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==U&&t&&t()},330);else if("navFlip"==S.data.settings.navAnim)addClass(n,"anim"),S.data.settings.rtl?(autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"),autoprefixTransform(r,"next"==o?"rotateY(-90deg)":"rotateY(90deg)")):(autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)"),autoprefixTransform(r,"next"==o?"rotateY(90deg)":"rotateY(-90deg)")),setTimeout(function(){e.animID==U&&(autoprefixTransform(r,null),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==U&&(removeClass(n,"anim"),autoprefixTransform(n,null),t&&t())},630))},30);else if("navBookBlock"==S.data.settings.navAnim){var d=document.createElement("div");d.className="shadow",d.style.opacity=0,d.appendChild(document.createElement("div")),n.appendChild(d),addClass(n,"anim"),S.data.settings.rtl?autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"):autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)");var u=n.style.transform||n.style.webkitTransform||n.style.mozTransform;n.style.transformOrigin=n.style.webkitTransformOrigin=n.style.mozTransformOrigin="rotateY(90deg)"==u?"right top":"left top",addClass(r,"anim"),addClass(r,"activeSlidePage");var f=document.createElement("div");f.className="shadow",f.style.opacity=.7,r.appendChild(f),d.style.opacity=0,d.style.height=n.scrollHeight+"px",setTimeout(function(){e.animID==U&&(f.style.opacity=null,setTimeout(function(){d.style.opacity=.4,setTimeout(function(){n.style.transformOrigin=n.style.webkitTransformOrigin=n.style.mozTransformOrigin=null,f.parentNode&&f.parentNode.removeChild(f),d.parentNode&&d.parentNode.removeChild(d),e.animID==U&&(removeClass(n,"anim"),autoprefixTransform(n,null),t&&t())},430)},200))},30)}}function L(){var e=l.getOb("epubContainer");null!=e.style.opacity&&(e.style.opacity=null,A()),native&&(e.scrollTop=0);var t=document.getElementsByClassName("activeSlidePage");if(t.length){var n=t[0];"navSlide"==S.data.settings.navAnim?n.style.transform=null:"navFade"==S.data.settings.navAnim?n.style.opacity=null:"navFlip"==S.data.settings.navAnim?autoprefixTransform(n,null):"navBookBlock"==S.data.settings.navAnim&&autoprefixTransform(n,null),removeClass(n,"anim"),removeClass(n,"activeSlidePage");var o='<h3 id="ebookLoaderAnim"><div class="splashSpinner large"><div class="dot1"></div><div class="dot2"></div></div></h3>';document.getElementById("nextPage").innerHTML=o,document.getElementById("prevPage").innerHTML=o}}function O(){function e(){if(!G.isFirstChapter()){var e=ph.join(bookPath,S.data.packageURL,G.getChapterURL(currentIndex-1));$(e,function(t){var n=document.getElementById("prevPage");M(e,t,n)})}}if(G.isLastChapter())e();else{var t=ph.join(bookPath,S.data.packageURL,G.getChapterURL(currentIndex+1));$(t,function(n){var o=document.getElementById("nextPage");M(t,n,o),e()})}}function $(t,n){function o(){C.inject([{type:"local",val:_,root:t,noMarker:!0,xparentClass:""}],function(e){n(e)})}if(_)n(C.applyRoot(t,_));else{var r=isKotobeeHosted(),i="lib/ionic/release/css/ionic.min.css";r&&(i="/bundles/vijualib/templates/reader/cloud/lib/ionic/release/css/ionic.min.css"),e.get(i).success(function(i){if(V=i,r)e.get("/bundles/vijualib/templates/reader/cloud/css/styles.min.css").success(function(e){_=e,o()}).error(function(){n(C.applyRoot(t,_))});else{var a="css/styles.min.css",s="http://localhost:8080"==window.location.origin;s&&(a="css/style.css"),e.get(a).success(function(t){_=t,s?e.get("css/base.css").success(function(t){_=t+_,e.get("css/kotobeeInteractive.css").success(function(e){_+=e,o()}).error(function(){o()})}).error(function(){o()}):o()}).error(function(){n(C.applyRoot(t,_))})}}).error(function(){n(C.applyRoot(t,_))})}}function M(e,t,n,o){function r(r){var i=ph.removeHash(window.location.href),a=document.createElement("html"),s=document.createElement("head");ios&&(s.innerHTML="<meta http-equiv=\"Content-Security-Policy\" content=\"default-src * filesystem: data:; style-src 'self' 'unsafe-inline' filesystem: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.youtube.com http://*.youtube.com https://*.ytimg.com http://*.ytimg.com;img-src * filesystem: data: file:\">"),a.appendChild(s);var c=document.createElement("base"),l=document.getElementsByTagName("base");if(l.length)for(E=0;E<l.length;E++){var d=l[E].getAttribute("href");if(d){i=0==d.indexOf("/")||isAbsoluteURLPath(d)?d:ph.join(window.location.origin,d);break}}c.setAttribute("href",ph.join(i,ph.removeFilename(e))+"/"),s.appendChild(c);var u=document.createElement("style"),f="";V&&(f+=V);var m=" body{margin:0; padding-top:0px;} #epubContainer{padding-top:0px;position:absolute;top:0;left:0;right:0;bottom:0 !important}";if(mobile||(m+="body, #epubContainer{padding-top:1px;}"),f+=m,f+="html,#epubContainer{overflow-y:"+(mobile?"hidden":"auto")+"}",f+="#epubScroller{position: static;height: 100%;width: 100%;padding:10px;box-sizing: border-box;}",f+=" #epubContent{margin: 20px 30px !important}",S.data.settings.rtl&&(f+="#epubContainer{direction:rtl !important}"),r.viewport&&r.viewport.width){var g=p.get("nav").getFxlBestFit(r,document.createElement("div"));f+="#epubScroller{transform:scale("+g+");-webkit-transform:scale("+g+");-moz-transform:scale("+g+");-ms-transform:scale("+g+");}",f+="#epubScroller{transform-origin: top left; height: 100%;}",f+="#epubContent{width:"+r.viewport.width+"px;height:"+r.viewport.height+"px}",f+="html{overflow-x:"+(mobile?"hidden":"auto")+"}",g>=1&&(f+="#epubContainer #epubContent{margin-left:auto !important; margin-right:auto !important}")}f+=" #epubContent{padding:0px} ",f+=" #epubContent{margin: 20px 30px !important} ",f+=" #epubContent{font-size:"+S.data.settings.textSize+" !important}",f+=" #epubContent.hide{display:block !important}",f+=" #epubContent section{margin-top:0 !important}",S.data.settings.textSize&&(f+=" #epubContent{font-size: "+S.data.settings.textSize+"}"),f+=t;var h=/url\((.*?)\)/g;f=(f+=r.styles.replace(h,function(t,n){return 0==n.indexOf('"')&&(n=n.substr(1,n.length-2)),0==n.indexOf("'")&&(n=n.substr(1,n.length-2)),-1==n.indexOf("http://")&&-1==n.indexOf("https://")&&0!=n.indexOf("data:")&&(n=ph.relative(ph.removeFilename(e),n)),"url("+n+")"})).replace("background-color:#e7e3d9 !important;",""),u.innerHTML=f,u.setAttribute("type","text/css"),s.appendChild(u);var v=document.createElement("div");v.className="stylesEnabled",v.id="epubContainer";var b=document.createElement("div");b.id="epubScroller",v.appendChild(b);var k=document.createElement("div");k.id="epubInner",b.appendChild(k);var w=r.content;w=(w=(w=w.replace(/<div class="answer correct">/g,'<div class="answer">')).replace(/<div class="correct">/g,"<div>")).replace(/<p class="explanation">.*?<\/p>/g,"");isKotobeeHosted();y.readerApp||(w=w.replace(/src="(?!http[s]?\:\/\/)([^"]*)?"/g,function(t,n){return'src="'+ph.relative(e,n)+'"'}));r.title;k.innerHTML=w;for(var C=k.getElementsByTagName("audio"),E=C.length;E--;){try{C[E].pause(),C[E].children.length||(C[E].src="")}catch(e){}var x=C[E].parentNode;x.previousSibling&&hasClass(x.previousSibling,"playBtn")&&removeClass(x.previousSibling,"hide"),x.removeChild(C[E])}for(var I=k.getElementsByTagName("video"),E=I.length;E--;){try{I[E].pause(),I[E].children.length||(I[E].src="")}catch(e){}var T=I[E].parentNode;T.previousSibling&&hasClass(T.previousSibling,"playBtn")&&removeClass(T.previousSibling,"hide"),T.removeChild(I[E])}var A=document.createElement("body");S.data.settings.rtl&&A.setAttribute("class","rtl"),A.appendChild(v),a.appendChild(A);var N=document.createElement("iframe");if(N.setAttribute("srcdoc",a.outerHTML),detectIE()||native&&ios){var B="javascript: window.frameElement.getAttribute('srcdoc');";N.setAttribute("src",B),N.contentWindow&&(N.contentWindow.location=B)}n&&(n.innerHTML="",n.appendChild(N),o&&o(N))}if(n){t||(t="");var i=H(e);i?r(i):D(e,{},r)}}function H(e){for(var t=0;t<Z.length;t++)if(Z[t].url==e){var n=Z[t];return Z.splice(t,1),Z.push(n),n}}function P(){timeOut(function(){u.update(null)},1e3)}function D(t,n,o){var i={func:arguments.callee,args:arguments};n||(n={}),e.get(cacheBust(t)).success(function(e){config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e));for(var n=parser.parseFromString(e,"text/html"),r=k("contentHtml")(n,t),i=n.getElementsByTagName("meta"),a=null,s=0;s<i.length;s++){var c=i[s].getAttribute("name");if(c&&"viewport"==c.toLowerCase()){a={};var l=i[s].getAttribute("content");if(!l)break;for(var d=l.split(","),u=0;u<d.length;u++){var p=d[u].split("=");a[p[0].trim()]=Number(p[1].trim())}}}k("js")(n).then(function(e){k("styles")(n,{path:t}).then(function(i){var s,c=n.getElementsByTagName("title");if(c.length)s=c[0].textContent.trim();else{var l=n.getElementsByTagName("h1");l.length&&(s=l[0].textContent.trim())}s||(s=S.data.book.meta.dc.title);var d={url:t,title:s,viewport:a,content:r.outerHTML,styles:i,script:e};G.addToCache(d),o&&o(d)})})}).error(function(){n.showError&&(r.update({error:"networkError",ref:i}),n.deferred&&n.deferred.reject({}),P())})}function R(){var e=ph.removeHash(window.location.href),t=document.getElementsByTagName("base");if(t.length)for(var n=0;n<t.length;n++)if(t[n].getAttribute("href")){e=window.location.origin+"/"+t[n].getAttribute("href");break}return isAbsoluteURLPath(S.data.book.chapter.absoluteURL)?S.data.book.chapter.absoluteURL:ph.join(e,S.data.book.chapter.absoluteURL)}var F,z,j,q,U,V,_,W,K,Y,J,G={},X=[],Z=[];return G.busy=!0,G.initialize=function(){currentIndex=null,F=S.data.epub.spine.getElementsByTagName("itemref").length,z=F;for(var e=S.data.epub.spine.getElementsByTagName("itemref"),t=e.length;t--;)if(!e[t].hasAttribute("linear")||"no"!=e[t].getAttribute("linear")){z=t+1;break}j=0;for(t=0;t<e.length;t++)if(!e[t].hasAttribute("linear")||"no"!=e[t].getAttribute("linear")){j=t;break}var o=S.data.book.chapters?S.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+h.get("noTOC")+"</h5>";replaceHTML(document.getElementById("chaptersInner"),o),l.setOb("title",replaceHTML(l.getOb("title"),S.data.book.meta.dc.title)),n.addBookStat({type:"view"}),q||(h.addListener(function(){var e=document.getElementById("chaptersInner");e&&replaceHTML(e,S.data.book.chapters?S.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+h.get("noTOC")+"</h5>")}),q=!0),k("bookSetup")(),N();var r=0,i=0;if(null!=G.startChapter&&"book"==config.kotobee.mode){var a=p.get("book").root+"/reader/chapter/"+G.startChapter;return G.startHash&&(a+="/"+G.startHash),x.path(a),A(),s.trigger(),void y.$apply()}S.readSlot("lastLoc"+S.getBookId(),function(e){S.readSlot("lastLocY"+S.getBookId(),function(t){config.preserveLoc&&"app"!=config.kotobee.mode&&(r=e?Number(e):0,i=t?Number(t):0),S.data.user&&null!=S.data.user.lastchap&&(r=Number(S.data.user.lastchap));var n=c.getBookmark();n&&(r=Number(n));var o={noPopup:!0};i&&(o.scroll=i),G.loadChapterByIndex(r,o).then(function(){A(),s.trigger()})})})},G.clearCache=function(){Z=[]},G.addListener=function(e){X.push(e)},G.removeListener=function(e){for(var t=X.length;t--;)X[t]==e&&X.splice(t,1)},G.loadLocation=function(e,t){var n=T.defer();if(t||(t={}),e.match(/[^0-9.]/g))m.safeAnchorScroll("content",e,!0),n.resolve();else{var o=v.getElemsByLocation(e);if(!o[0])return;m.safeScrollToElem("content",o[0],!0),n.resolve()}return n.promise},G.hashedIndexFromIndex=function(e,t){S.data.epub.spine.getElementsByTagName("itemref")[e].getAttribute("idref")},G.indexFromUrl=function(e){var t,n=ph.getHash(e);e=ph.removeHash(ph.normalize(e));for(var o=S.data.epub.manifest.getElementsByTagName("item"),r=0;r<o.length;r++)if(ph.removeHash(ph.normalize(o[r].getAttribute("href")))==e){t=o[r].getAttribute("id");break}o=S.data.epub.spine.getElementsByTagName("itemref");var i;for(r=0;r<o.length;r++)if(o[r].getAttribute("idref")==t&&(i=r,o[r].getAttribute("id")==n))return r;return i},G.nextChapter=function(e){if(G.isLastChapter(),G.isLastChapter())i.toast(h.get("inLastChapter"));else{for(var t=currentIndex+1,n=S.data.epub.spine.getElementsByTagName("itemref")[t];n&&n.hasAttribute("linear")&&"no"==n.getAttribute("linear");){if(++t>=n.length-1)return void i.toast(h.get("inLastChapter"));n=S.data.epub.spine.getElementsByTagName("itemref")[t]}var o=n.getAttribute("id"),r=p.get("book").root+"/reader/chapter/"+t+(o?"/"+o:"");x.path(r)}},G.prevChapter=function(e){if(G.isFirstChapter(),G.isFirstChapter())i.toast(h.get("inFirstChapter"));else{for(var t=currentIndex-1,n=S.data.epub.spine.getElementsByTagName("itemref")[t];n&&n.hasAttribute("linear")&&"no"==n.getAttribute("linear");){if(--t<0)return void i.toast(h.get("inFirstChapter"));n=S.data.epub.spine.getElementsByTagName("itemref")[t]}var o=n.getAttribute("id"),r=p.get("book").root+"/reader/chapter/"+t+(o?"/"+o:"");x.path(r)}},G.loadChapterByIndex=function(e,t){var n=T.defer();if(void 0==e&&(e=currentIndex),e<0)return n.resolve(),n;e>F&&(e=0);var o=G.getChapterURL(e);if(t||(t={}),t.index=e,y.renderScope.applyHeader("default"),G.urlMatchesIndex(o,currentIndex)){currentIndex=e;var r=t.hash;return r||(r=ph.getHash(o)),r?G.loadLocation(r):b.$getByHandle("content").scrollTop(!0),S.data.book.chapter.url=o,void(S.data.book.chapter.absoluteURL=ph.join(bookPath,S.data.packageURL,S.data.book.chapter.url))}return L(),setTimeout(function(){U=Math.round(1e4*Math.random());var r={page:e,animID:U};B(r,function(){G.loadChapterByURL(o,t,function(){setTimeout(function(){r.animID==U&&(L(),O(),n.resolve())},mobile?500:0)})})}),n.promise},G.urlMatchesIndex=function(e,t){if(null!=t){var n,o=ph.removeHash(ph.normalize(e)),r=S.data.epub.spine.getElementsByTagName("itemref")[t];if(r){for(var i=S.data.epub.manifest.getElementsByTagName("item"),a=0;a<i.length;a++)i[a].getAttribute("id")==r.getAttribute("idref")&&(n=i[a].getAttribute("href"));return!!n&&ph.removeHash(ph.normalize(n))==ph.removeHash(ph.normalize(o))}}},G.applyChapterStateFromURL=function(e,t){if(t||(t={}),0!=e.indexOf("#")){var n=ph.getHash(e),o=t.index?t.index:G.indexFromUrl(e);if(null!=o){var r=p.get("book").root+"/reader/chapter/"+o;n&&(r+="/"+n),x.path(r),y.$$phase||y.$apply()}}else x.path(p.get("book").root+"/reader/chapter/"+currentIndex+"/"+e.substr(1))},G.loadChapterByURL=function(e,t,o){t||(t={});var r=T.defer();if(0==e.indexOf("#"))return o&&o(),G.loadLocation(e.substr(1));var i=t.hash?t.hash:ph.getHash(e),s=t.index?t.index:G.indexFromUrl(e);if(null!=s)return G.urlMatchesIndex(e,currentIndex)?(currentIndex=s,i?(o&&o(),G.loadLocation(i)):(a.hash?(b.$getByHandle("content").scrollTop(!0),r.resolve()):r.resolve(),o&&o(),r.promise)):(desktop&&require("nw.gui").App.clearCache(),kInteractive.clearAudioVideo(document),S.data.book.chapter.absoluteURL&&G.addToCache({url:S.data.book.chapter.absoluteURL,title:S.data.book.chapter.title,viewport:S.data.book.chapter.viewport,content:document.getElementById("epubInner").innerHTML,styles:C.getStyles(),script:E.getScript()}),currentIndex=s,mobile&&b.$getByHandle("content").resize(),G.busy=!0,G.loadChapterByURLRaw(e,t).then(function(e){G.busy=!1,t.scroll&&b.$getByHandle("content").scrollTo(0,t.scroll,!1),config.kotobee.cloudid&&(config.kotobee.public||n.setLastChapter()),i?(G.loadLocation(i),P(),o&&o()):setTimeout(function(){m.reset(t.scroll?t.scroll:0),E.replaceScript(e||[]),P(),o&&o()},30)}));o&&o()},G.addToCache=function(e){var t=H(e.url);if(t)return t.url=e.url,t.title=e.title,t.viewport=e.viewport,t.content=e.content,t.styles=e.styles,void(t.script=e.script);Z.length>20&&Z.shift(),Z.push(e)},G.loadChapterByURLRaw=function(e,o){function r(){D(S.data.book.chapter.absoluteURL,{showError:!0,deferred:a},function(e){i(e.title,e.content,e.viewport,e.styles,e.script)})}function i(e,o,r,i,s,d){S.data.book.chapter.title=e,t.send({verb:"navigated",activity:(currentIndex?"Chapter "+currentIndex+": ":"")+e}),n.addStat({action:"chapter",param:e}),pauseVideoAndAudio(replaceHTML("epubInner",o)),l.setOb("epubContent",document.getElementById("epubContent")),l.getOb("epubContainer").focus(),r&&(r.width&&(l.getOb("epubContent").style.width=r.width-0+"px"),r.height&&(l.getOb("epubContent").style.height=r.height-0+"px")),S.data.book.chapter.viewport=r,S.data.book.chapter.notLastChapter=!G.isLastChapter(),S.data.book.chapter.notFirstChapter=!G.isFirstChapter();var u=document.getElementById("chapters");removeClass(u,["rfl","fxl"]),addClass(u,S.data.book.chapter.viewport?"fxl":"rfl"),kInteractive.postRender(document),C.replaceStyles(i),config.preserveLoc&&"app"!=config.kotobee.mode&&S.writeSlot("lastLoc"+S.getBookId(),currentIndex),S.writeSlot("lastLocY"+S.getBookId(),0);for(var p=0;p<X.length;p++)X[p]("newChapter");k("contentJs")(d).then(function(){v.reset(),m.unlock(),c.setBookmark(currentIndex);var t={};t.id="chapter-"+currentIndex,t.description="View chapter: "+e,t.learnerResponses="Viewed",t.type="other",t.timestamp=new Date,c.setInteractions([t]),a.resolve(s)})}arguments.callee;var a=T.defer();o||(o={}),S.data.book.chapter.url=e,S.data.book.chapter.absoluteURL=ph.join(bookPath,S.data.packageURL,S.data.book.chapter.url);ph.getHash(S.data.book.chapter.url);m.disable(),m.lock(),u.update(null);var s=H(S.data.book.chapter.absoluteURL);return s?i(s.title,s.content,s.viewport,s.styles,s.script,!0):(o.noPopup,r()),a.promise},G.clearContent=function(){replaceHTML("epubInner","")},G.getChapterURL=function(e){void 0==e&&(e=currentIndex);var t;try{t=S.data.epub.spine.getElementsByTagName("itemref")[e]}catch(e){}var n=getElementsByAttribute(S.data.epub.manifest,"item","id",t.getAttribute("idref"))[0].getAttribute("href"),o=t.getAttribute("id");return o&&(n+="#"+o),n},G.isFirstChapter=function(){return 0==currentIndex},G.isFirstVisibleChapter=function(){return currentIndex<=j},G.isLastChapter=function(){return currentIndex==F-1},G.isLastVisibleChapter=function(){return currentIndex>=z-1},G.pdfPrint=function(){function e(e){e||(e={}),e.scale||(e.scale=100);var o=R(),i=S.data.book.chapter.title,a={url:o,filename:i};u.update(h.get("pleaseWait"),null,{dots:!0}),n.createRequest(config.kotobee.liburl+"link/pdfgenerate/url",a,function(n){function i(){W&&W.parentNode&&W.parentNode.removeChild(W),K&&K.parentNode&&K.parentNode.removeChild(K),u.update()}if(!n)return u.update(),void r.update({error:"networkError",ref:t});var a=n;W&&W.parentNode&&W.parentNode.removeChild(W),(W=document.createElement("iframe")).setAttribute("style","display:none"),W.setAttribute("name","pdfFrame"),document.body.appendChild(W),K&&K.parentNode&&K.parentNode.removeChild(K),(K=document.createElement("form")).setAttribute("style","visibility:hidden:position:absolute"),K.setAttribute("method","post"),K.setAttribute("action",a),K.setAttribute("target","pdfFrame"),addFormHiddenInput("url",o,K),addFormHiddenInput("filename",S.data.book.chapter.title,K),addFormHiddenInput("fileext","pdf",K),addFormHiddenInput("scale",e.scale,K),addFormHiddenInput("format",config.pdfMode?config.pdfMode:"imgpdf",K),document.body.appendChild(K),K.submit(),setTimeout(function(){W.addEventListener?W.addEventListener("load",i,!0):W.attachEvent&&W.attachEvent("onload",i)}),setTimeout(function(){u.update()},4e3)})}var t={func:arguments.callee,args:arguments};if(preview)r.update({error:"savePdfUnsupportedInPreview"});else if(!desktop&&!native)if(config.pdfsavingOptions){var o={scale:100};o.submit=function(){d.hide(),e({scale:o.scale})},d.show({mode:"pdfSave",pdfSaveOptions:o})}else e()},G.pdfPrintOld=function(){preview?r.update({error:"savePdfUnsupportedInPreview"}):desktop||native||(u.update(h.get("pleaseWait"),null,{dots:!0}),window.location.href="https://www.kotobee.com/link/pdfgenerate?url="+R(),setTimeout(function(){u.update()},4e3))},G.printAsBitmap=function(){var e={func:arguments.callee,args:arguments};if(!native&&!mobile){var t=R(),o=S.data.book.chapter.title,i={url:t,filename:o};u.update(h.get("pleaseWait"),null,{dots:!0}),n.createRequest(config.kotobee.liburl+"link/pdfgenerate/url",i,function(n){if(!n)return u.update(),void r.update({error:"networkError",ref:e});var o=n;Y&&Y.parentNode&&Y.parentNode.removeChild(Y),(Y=document.createElement("iframe")).setAttribute("style","display:none"),Y.setAttribute("name","printFrame"),Y.id="printContainer",Y.style.visibility="hidden",Y.style.position="fixed",Y.style.right="0",Y.style.bottom="0",document.body.appendChild(Y),J&&J.parentNode&&J.parentNode.removeChild(J),(J=document.createElement("form")).setAttribute("style","visibility:hidden:position:absolute"),J.setAttribute("method","post"),J.setAttribute("action",o),J.setAttribute("target","printFrame"),addFormHiddenInput("url",t,J),addFormHiddenInput("filename",S.data.book.chapter.title,J),addFormHiddenInput("fileext","pdf",J),addFormHiddenInput("print",!0,J),addFormHiddenInput("format","imghtml",J),document.body.appendChild(J),J.submit(),Y.onload=function(){try{var e=this.contentWindow;setTimeout(function(){e.__container__=this,e.focus(),e.print(),u.update()},2500)}catch(e){u.update()}},setTimeout(function(){u.update()},8e3)})}},G.print=function(){function e(){document.body.removeChild(this.__container__)}function t(){var e=document.getElementById("printContainer");e&&e.parentNode&&e.parentNode.removeChild(e)}if(!native&&!mobile)if(S.data.book.chapter.viewport)G.printAsBitmap();else{u.update(h.get("pleaseWait"),null,{dots:!0}),t();var n=document.createElement("iframe");n.id="printContainer",n.onload=function(){try{var n=this.contentWindow;setTimeout(function(){n.__container__=this,n.onbeforeunload=e,n.onafterprint=e,n.focus(),n.print(),u.update(),setTimeout(function(){t()},4e3)},2500)}catch(e){u.update()}},n.style.visibility="hidden",n.style.position="fixed",n.style.right="0",n.style.bottom="0",n.src=R(),document.body.appendChild(n)}},G}]),app.factory("crdv",["stg","status","error","translit","$rootScope","$http","$ionicSideMenuDelegate",function(e,t,n,o,r,i,a){function s(t){e.data.settings.rtl?a.toggleLeft():a.toggleRight()}function c(){try{return cordova,!0}catch(e){return!1}}function l(e,n,o,r){try{t.updateProgress(0),e.getEntries(function(i){function a(){if(s>=i.length)e.close(function(){o&&o()});else{t.updateProgress(s/i.length);var c=i[s];s++,c.getData(new zip.BlobWriter,function(e){try{if("/"==c.filename.substr(-1))return void a();u.writeFile(e,ph.join(n,c.filename),u.libEbooksDirectory,function(){a()})}catch(e){r&&r()}},function(e,t){})}}var s=0;a()})}catch(e){r&&r()}}function d(e){switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:"QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:"NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:"SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:"INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:"INVALID_STATE_ERR";break;default:"Unknown Error"}}var u={};return u.initialize=function(t,o){t.putTest("in1"),c()?(t.putTest("in3"),e.data.cordova=!0,t.putTest("in4"),t.putTest("in5"),t.$$phase||t.$apply(),e.copyLocalToNativeStorage(),u.initAds(),u.initDirectories(function(){i.get("permit.json").success(function(e){function t(){var e={error:"errorAndCallback",msg:"noAppPermit",cb:u.exit};n.update(e),r.$$phase||r.$apply()}("udid"==e.type?window.plugins.uniqueDeviceID.get:"mac"==e.type?window.MacAddress.getMacAddress:window.plugins.imeiplugin.getImei)(function(n){n||t();try{for(var r,i=e.list.split("\n"),a=0;a<i.length;a++){var s=i[a].trim().split(" ")[0].trim(),c=i[a].trim().split("/")[0].trim();if(s==n||c==n){r=!0;break}}}catch(e){return void t()}r?o():t()},t)}).error(function(){o()})}),document.addEventListener("menubutton",s,!1),t.$$phase||t.$apply()):o()},u.showKeyboard=function(){try{cordova.plugins.Keyboard.show()}catch(e){}},u.hideKeyboard=function(){try{cordova.plugins.Keyboard.close()}catch(e){}},u.tts=function(e,t){var n={text:e,rate:1};try{"iOS"==window.device.platform&&("9"==window.device.version.charAt(0)?n.rate=1.5:"10"==window.device.version.substr(0,2)?n.rate=1.5:"11"==window.device.version.substr(0,2)&&(n.rate=1.5))}catch(e){}TTS.speak(n,function(){t(!0)},function(e){u.toast(o.get("ttsUnavailableMsg")),t(!1)})},u.toast=function(e){c()&&window.plugins.toast.showShortBottom(e)},u.copyToClipboard=function(e){if(c())try{cordova.plugins.clipboard?cordova.plugins.clipboard.copy(e):window.plugins.clipboard.copy(e),u.toast(o.get("copiedToClipboard"))}catch(e){}},u.share=function(e){if(c())try{window.plugins.socialsharing.share(e)}catch(e){}},u.createPDF=function(e,t,n){try{var r=new jsPDF;margins={top:10,bottom:0,left:10,width:180},r.fromHTML(e,margins.left,margins.top,{width:margins.width},function(e){try{cordova,u.docDirectory.getFile(t,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){},e.onerror=function(e){},e.write(r.output()),u.toast(o.get("pdfSaved"))},d)},d)}catch(e){try{setTimeout(function(){r.save(t)},1e3)}catch(e){}}},margins)}catch(e){}},u.initDirectories=function(e){function t(e){}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(window.TEMPORARY,10485760,function(n){u.cacheDirectory=n.root,window.requestFileSystem(window.PERSISTENT,0,function(n){u.docDirectory=n.root;var o="kotobeeReader";r.readerApp?o="kotobeeReaderApp":config.kotobee.cloudid&&(o+=config.kotobee.cloudid),u.docDirectory.getDirectory(o,{create:!0},function(n){u.appDirectory=n,u.appDirectory.getDirectory("library",{create:!0},function(n){u.libEbooksDirectory=n,u.appDirectory.getDirectory("local",{create:!0},function(n){u.localDirectory=n,u.localDirectory.getDirectory("books",{create:!0},function(n){u.localBooksDirectory=n,u.localDirectory.getDirectory("thumbs",{create:!0},function(n){u.localThumbsDirectory=n,u.libEbooksDirectory.getFile(".nomedia",{create:!0},function(){u.localDirectory.getFile(".nomedia",{create:!0},function(){e()},t)},t)},t)},t)},t)},t)},t)},t)},t)},u.exit=function(){c()&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},u.applyExistingBooksOld=function(e,t){function n(e){return Array.prototype.slice.call(e||[],0)}if(c()){var o=u.libEbooksDirectory.createReader(),r=[],i=function(){o.readEntries(function(o){if(o.length)r=r.concat(n(o)),i();else{for(var a=0;a<r.length;a++)for(var s=r[a].name,c=0;c<e.length;c++)e[c].path==s&&(e[c].exists=!0);t()}},function(e){})};i()}else t()},u.applyExistingBooks=function(t){if((native||desktop)&&(t||e.data.currentLibrary&&(t=e.data.currentLibrary.books),t)){for(i=0;i<t.length;i++)t[i].exists=!1;for(n=0;n<e.data.downloaded.length;n++)e.data.downloaded[n].favorite=!1;for(var n=0;n<e.data.downloaded.length;n++){var o=e.data.downloaded[n].path;e.data.downloaded[n].favorite=null;for(var i=0;i<t.length;i++)if(t[i].path==o){t[i].exists=!0,e.data.downloaded[n].favorite=t[i].favorite;break}}r.$$phase||r.$apply()}},u.vibrate=function(e){c()&&(e||(e=40),ios||(ios&&(e/=4),navigator&&navigator.notification&&navigator.notification.vibrate&&navigator.notification.vibrate(e)))},u.deleteEbook=function(t,n){u.libEbooksDirectory.getDirectory(t.path,{},function(o){o.removeRecursively(function(){for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].path==t.path&&(t.exists=!1,e.data.downloaded.splice(o,1),o--);e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){n()})},function(e){})},d)},u.writeEbook=function(t,n,o,r){var i=o;u.libEbooksDirectory.getDirectory(n.path,{create:!0},function(o){var a=ph.join(n.path,t);u.writeFile(i,a,u.libEbooksDirectory,function(){u.unzipViaPlugin(ph.join(u.libEbooksDirectory.nativeURL,a),ph.join(u.libEbooksDirectory.nativeURL,n.path,"EPUB"),function(t){n.exists=!0,e.data.downloaded.push(n),u.applyExistingBooks(e.data.currentLibrary.books),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){r()})})})})},u.unzip=function(e,t,n,o){u.unzipBlob(e,t,n,o)},u.unzipBlob=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.BlobReader(e),function(e){l(e,t,n,o)})},u.unzipViaPlugin=function(e,t,n,o){zip.unzip(e,t,n,o)},u.unzipURLOld=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.HttpReader(e),function(e){l(e,t,n,o)})},u.unzipData64=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",setTimeout(function(){zip.createReader(new zip.Data64URIReader(e),function(e){setTimeout(function(){l(e,t,n,o)},100)})},100)},u.writeFile=function(e,t,n,o){var r=ph.basename(t);try{u.getDirectoryRelativeToBooks(ph.normalize(t),n,function(t){try{t.getFile(r,{create:!0},function(t){t.createWriter(function(t){function n(){var a=Math.min(i,e.size-r),s=e.slice(r,r+a);t.write(s),r+=a,t.onwrite=function(t){r<e.size?n():o&&o(!0)},t.onerror=function(e){o&&o(!1)}}var r=0,i=4194304;n()},d)},function(e,t){})}catch(e){}})}catch(e){}},u.getDirectoryRelativeToBooks=function(e,t,n){t||(t=u.libEbooksDirectory);var o=e.split("/");if(1!=o.length){var r=o[0];t.getDirectory(r,{create:!0},function(e){o.shift();var t=o.join("/");u.getDirectoryRelativeToBooks(t,e,n)},function(e){})}else n(t)},u.openInNativeBrowser=function(e,t){e=e.toString();try{if(t)return void window.open(e,"_system");try{if(cordova.InAppBrowser){window.plugins.toast.show("  "+o.get("loadingExternalPage")+"  ",4e4,"bottom");var n=ios?"yes":"no",r=cordova.InAppBrowser.open(e,"_blank","location=no,hidden=no,clearcache=yes,closebuttoncaption=Go back to App,toolbar="+n+",presentationstyle=formsheet");return r.addEventListener("loadstart",function(){}),r.addEventListener("loadstop",function(){ios||window.plugins.toast.hide()}),void r.addEventListener("loaderror",function(){if(!ios){try{r&&r.close()}catch(e){}window.plugins.toast.hide(),window.plugins.toast.showLongBottom("  "+o.get("errorLoadingPage")+"  ")}})}}catch(e){}try{if(window.inAppBrowserXwalk){var i={toolbarColor:"#FFFFFF",toolbarHeight:"40",closeButtonText:"< Close",closeButtonSize:"25",closeButtonColor:"#000000",openHidden:!1};return void window.inAppBrowserXwalk.open(e,i)}}catch(e){}return void window.open(e,"_system")}catch(e){}},u.initAds=function(){try{if(!admob)return}catch(e){return}config.kotobee.admobId&&(admob.setOptions({publisherId:config.kotobee.admobId}),admob.createBannerView())},u}]),app.factory("cssParser",["$http","cache","stg",function(e,t,n){var o,r,i={},a=[];return i.clearCache=function(){a=[]},i.inject=function(t,n){function r(e){for(var t=0;t<a.length;t++)if(a[t].url==e)return a.push(a[t]),a[t]}function s(e){a.length>5&&a.shift(),a.push(e)}function c(n,a){function u(e,t,o){e=(e=(e=(e=i.applyRoot(t,e)).replace(/\/\*[\s\S]*?\*\//g,"")).replace(/<!--/g,"")).replace(/-->/g,"");for(var r=(n.parentClass?n.parentClass:"#epubContainer.stylesEnabled")+" #epubContent",a=e.split("}"),c=0;c<a.length;c++)if(a[c].indexOf("@keyframes")>=0||a[c].indexOf("@-webkit-keyframes")>=0||a[c].indexOf("@-moz-keyframes")>=0)for(g=c+1;g<a.length&&""!=a[g].trim();g++)a[c]+="}"+a[g];else{var d=a[c].split("{");if(!(d.length<=1)){d[0]=d[0].replace(";",",");for(var u=d[0].split(","),m=!1,g=0;g<u.length;g++)if(u[g]=" "+u[g].trim(),"@"!=u[g].trim()[0]&&"::"!=u[g].trim().substr(0,2)){" body"==u[g]&&(m=!0);var h=u[g].toLowerCase().indexOf(" body");h>=0&&(u[g]=u[g].substr(0,h)+u[g].substr(h+5));var v=u[g].toLowerCase().indexOf(" html");v>=0&&(u[g]=u[g].substr(0,v)+u[g].substr(v+5)),u[g]=" "+r+u[g]}if(d[0]=u.join(","),a[c]=d.join("{"),m){for(var b=d[1].split(";"),k="",y=0;y<b.length;y++)b[y]&&-1!=b[y].trim().indexOf("background")&&(k+="} #epubContainer.stylesEnabled{"+b[y].trim()+"} ",b[y]=null);k&&(d[1]=b.join(";"),a[c]=d.join("{")+k)}}}e=l(e=a.join("}")),"url"==o&&s({url:f,val:e}),p(e)}function p(e){e&&(d+=e),++o<t.length?c(t[o],a):(n.noMarker||(d="#epubContainer div#epubContent, #epubContainer.stylesEnabled div#epubContent { background-color:#e7e3d9 !important;}"+d),a&&a(d))}if(!n)return n={},void p();if("path"==n.type){var f=n.val;if(!f||f.indexOf("EPUB/css/kotobeeInteractive.css")>=0)return void p();var m=r(f);m?p(m.val):e.get(n.dontCache?f:cacheBust(f)).success(function(e){u(e,f,"url")}).error(function(){p()})}else u(n.val,n.root)}function l(e){var t=e;return t=t.replace(/\/\*(?:(?!\*\/)[\s\S])*\*\/|[\r\n\t]+/g,""),t=t.replace(/ {2,}/g," "),t=t.replace(/ ([{:}]) /g,"$1"),t=t.replace(/([;,]) /g,"$1"),t=t.replace(/ !/g,"!")}var d="";c(t[o=0],n)},i.applyRoot=function(e,t){var n=/url\((.*?)\)/g;return t.replace(n,function(t,n){return 0==n.indexOf('"')&&(n=n.substr(1,n.length-2)),0==n.indexOf("'")&&(n=n.substr(1,n.length-2)),-1==n.indexOf("http://")&&-1==n.indexOf("https://")&&0!=n.indexOf("data:")&&(n=ph.join(e,n)),"url("+n+")"})},i.getStyles=function(){return r},i.replaceStyles=function(e){for(var t,n=document.getElementsByTagName("style"),o=0;o<n.length;o++)if(void 0!=n[o].getAttribute("kotobee")){t=n[o];break}t=replaceHTML(t,r=e)},i.hideStyles=function(){removeClass(t.getOb("epubContainer"),"stylesEnabled")},i.showStyles=function(){addClass(t.getOb("epubContainer"),"stylesEnabled")},i.stylize=function(e,t){for(var n=document.getElementById(e),o=n.getAttribute("style"),r=Object.keys(t),i=o?o+";":"",a=0;a<r.length;a++)i+=r[a]+":"+t[r[a]]+";";n.setAttribute("style",i)},i}]),app.factory("design",["cssParser","$interpolate","$http",function(e,t,n){var o,r,i={};return i.getBgStyle=function(){return o||"stretch"==(o={"background-image":'url("'+(config.splashBg?"imgUser/"+config.splashBg:rootDir+"img/ui/defaultWelcomeBG.jpg")+'")',"background-color":config.splashBgColor?config.splashBgColor:"white",color:(config.splashColor?config.splashColor:"#000")+" !important","background-size":config.splashBgSize?config.splashBgSize:"cover"})["background-size"]&&(o["background-size"]="100% 100%"),o},i.convertTabs=function(){if(config.tabs)for(var e=0;e<config.tabs.length;e++){var t=document.createElement("div");t.setAttribute("data-kotobee",config.tabs[e]),config.tabs[e]=kInteractive.readData(t)}},i.injectUserCSS=function(e){function o(){for(var n=document.getElementsByTagName("style"),o=0;o<n.length;o++)if(n[o].hasAttribute("user")){n[o].innerHTML=t(r)(e);break}}r?o():n.get(cacheBust(rootDir+"css/user.css")).success(function(e){r=e,o()})},i.stylize=function(t,n){e.stylize(t,n)},i}]),app.factory("error",["modals","translit","$injector","$location","$ionicHistory",function(e,t,n,o,r){var i={},a=[];return i.modal=null,i.update=function(s){var c,l=n.get("backend");if(s)switch(s.error){case"s_authError":"library"==config.kotobee.mode&&l.cloudParam("entry")?c={mode:"login",dynamic:!0,animation:"slide-in-up",loginOptions:{}}:(o.path("/login"),r.clearHistory());break;case"networkError":c={mode:"networkError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"localonlyError":c={mode:"localOnlyError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"errorAndCallback":c={mode:"generalError",errorOptions:{msg:t.get(s.msg),cb:s.cb}};break;default:c={mode:"generalError",errorOptions:{msg:t.get(s.error)}}}for(var d=0;d<a.length;d++)a[d].error==s.error&&a[d].func(c);c&&e.show(c)},i.retry=function(t){e.hide(),timeOut(function(){t.func.apply(null,t.args)},100)},i.detect=function(e,t){a.push({error:e,func:t})},i.removeDetection=function(e,t){for(var n=0;n<a.length;n++)if(t==a[n].func&&e==a[n].error)return void a.splice(n,1)},i}]),app.factory("initializer",["$rootScope","$injector","translit","scorm","cssParser","tinCan","book","$location","chapters","error","modals","$ionicHistory","$ionicPlatform","crdv","cache","auth","design","stg","backend","settings",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m,g,h,v,b,k){function y(){document.onkeydown=function(t){"app"!=config.kotobee.mode&&document.activeElement&&"epubContainer"==document.activeElement.id&&(d.shown()||("37"==(t=t||window.event).keyCode?(c.prevChapter(),e.$$phase||e.$apply()):"39"==t.keyCode&&(c.nextChapter(),e.$$phase||e.$apply())))}}function w(){setTimeout(function(){ionic.tap.requiresNativeClick=function(e){return!(!ionic.Platform.isWindowsPhone()||"A"!=e.tagName&&"BUTTON"!=e.tagName&&!e.hasAttribute("ng-click")&&("INPUT"!=e.tagName||"button"!=e.type&&"submit"!=e.type))||(!!(!e||e.disabled||/^(file|range)$/i.test(e.type)||/^(object|video|audio)$/i.test(e.tagName)||ionic.tap.isLabelContainingFileInput(e))||ionic.tap.isElementTapDisabled(e))}},1e3)}function C(){window.addEventListener("message",function(e){var n=e.data.split(":");if("next"==n[0])c.nextChapter();else if("prev"==n[0])c.prevChapter();else if("notebook"==n[0])angular.element(document.getElementById("tabMenu")).scope().notebookClicked();else if("goto"==n[0])s.path(t.get("library").root+"/reader/chapter/"+Number(n[1]));else if("zoom"==n[0])for(var o=document.getElementsByTagName("meta"),r=0;r<o.length;r++)"viewport"==o[r].getAttribute("name")&&o[r].setAttribute("content","initial-scale="+n[1])},!1),window.kbOpenChapterURL=function(e){e&&(-1==e.indexOf(":/")&&(e=ph.join(v.data.book.chapter.url,e)),c.applyChapterStateFromURL(e))}}function E(){for(var e=0;e<L.length;e++)L[e].apply(this,arguments)}function x(e){var t=document.getElementById("iconDetector");if(preview&&-1!=window.location.href.indexOf("&screenshot"))return t.style.opacity=1,void(-1==window.location.href.indexOf("&startup")&&e&&e());I(t,function(){O||(O=setTimeout(function(){t.style.opacity=1,e&&e()},8e3)),t.offsetWidth<10?setTimeout(function(){x(e)},1e3):(clearTimeout(O),t.style.opacity=1,setTimeout(function(){e&&e()},1e3))})}function I(e,t){e.className="",setTimeout(function(){e.className="icon fa fa-cog fa-spin size16",setTimeout(t,400)},500)}function T(){if(A)for(;A.items.length;)A.removeAt(0);S()}function S(){function t(e){this.label.toLowerCase()==n.get("exit").toLowerCase()&&r.App.quit()}function o(e,t,n){return t&&(e.click=t),n&&(e.submenu=n),new r.MenuItem(e)}var r=require("nw.gui");A||(A=new r.Menu({type:"menubar"}));var i=new r.Menu;i.append(o({label:n.get("exit")},t)),A.append(o({label:n.get("file")},t,i));for(var a=new r.Menu,s=new r.Menu,c=v.data.languages,l=0;l<c.length;l++)s.append(o({label:c[l].label},function(t){var n=this.label;setTimeout(function(){for(var t=0;t<v.data.languages.length;t++)if(v.data.languages[t].label==n)return v.data.settings.language=v.data.languages[t].val,k.langChanged(),void(e.$$phase||e.$apply())},300)}));a.append(o({label:n.get("language")},t,s)),A.append(o({label:n.get("settings")},t,a)),r.Window.get().menu=A}var A,N,B={},L=[];B.preInitialize=function(e){e.putTest("preInitialize"),h.stylize("home",h.getBgStyle()),h.injectUserCSS(config);var t=B.getLogo();B.playAudio();for(var r=document.getElementsByTagName("link"),a=0;a<r.length;a++)if("shortcut icon"==r[a].getAttribute("rel")){r[a].getAttribute("href")||r[a].setAttribute("href",config.icon?config.icon:t.logo);break}h.convertTabs(),e.putTest("preInitialize2"),m.initialize(),i.initialize(),v.initialize(),o.initialize(),v.initializeSettings(function(){k.langChanged(),e.putTest("preInitialize3"),C(),w(),desktop&&S(),native||y(),e.putTest("preInitialize4"),m.setOb("title",replaceHTML(m.getOb("title"),n.get("loading")+"..")),n.addListener(function(){desktop&&T(),N||v.data.book||v.data.book.meta||m.setOb("title",replaceHTML(m.getOb("title"),n.get("loading")+"..")),e.putTest("translit.addListener2"),N=!0}),e.putTest("preInitialize5")})},B.playAudio=function(){if(config.audio){var e="imgUser/"+config.audio,t=document.createElement("audio");t.setAttribute("data-dontclose",!0),t.setAttribute("controls","true"),t.setAttribute("autoplay","true"),t.setAttribute("src",e),config.audioLoop&&t.setAttribute("loop","true"),t.setAttribute("data-tap-disabled","false");var n=document.createElement("source");n.src=e,t.appendChild(n),t.appendChild(document.createTextNode("Your browser does not support the audio element")),t.oncanplay=function(){kInteractive.tinCan({verb:"played",activity:"Audio: "+e})},t.play(),document.bgAudio=t}},B.getLogo=function(){return{logo:config.logo?"imgUser/"+config.logo:rootDir+"img/ui/defaultWelcomeLogo.png",slogan:config.slogan?config.slogan:""}},B.addListener=function(e){L.push(e)},B.postInitialize=function(t){t.putTest("postInitialize start"),x(function(){t.putTest("postInitialize start2"),b.initialize(t).then(function(){if(t.putTest("MM"),t.$$phase||t.$apply(),"library"==config.kotobee.mode||e.readerApp){try{v.readSlot("downloaded"+v.getBookId(!0),function(e){v.data.downloaded=e,t.putTest("MMMM")})}catch(e){v.data.downloaded=[]}v.data.downloaded||(v.data.downloaded=[])}else"book"==config.kotobee.mode?(bookPath="epub/",preview&&(bookPath=config.kotobee.bookPath),bookPath||(bookPath="epub/")):"app"==config.kotobee.mode||(status.update(),l.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:f.exit}));g.authenticate(t)}),p.registerBackButtonAction(function(t){var n=u.currentView();"forgotPwd"==n.stateId?s.path("/login"):"register"==n.stateId?s.path("/login"):"library"==n.stateId&&e.readerApp?s.path("/app"):d.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){f.exit()}}}),e.$apply()},101),B.initialized=!0,E()})};var O;return B}]),app.factory("jsParser",["$http","cache",function(e,t){var n,o,r,i={},a=[];return i.clearCache=function(){a=[]},i.inject=function(t,o){function r(e){for(var t=0;t<a.length;t++)if(a[t].url==e)return a.push(a[t]),a[t]}function i(e){a.length>5&&a.shift(),a.push(e)}function s(o,a){function d(e){e&&l.push(e),u()}function u(){++n<t.length?s(t[n],a):(c(),a&&a(l))}if(o)if("code"==o.mode)l.push(o.val),u();else{var p=r(o.val);p?d(p.val):e.get(cacheBust(o.val)).success(function(e){i({url:o.val,val:e}),d(e)}).error(function(){d()})}else u()}function c(){for(var e=0;e<l.length;e++)if(l[e]){var t;l[e].indexOf("window.location.href")>=0&&(t=/window\.location\.href[\s]*?=(.*?)[;\n]/g,l[e]=l[e].replace(t,"try { kbOpenChapterURL($1); } catch(er){};")),l[e].indexOf("event.stopPropagation()")>=0&&(t=/event\.stopPropagation\(\)/g,l[e]=l[e].replace(t,"void(0)")),l[e].indexOf("<![CDATA[")>=0&&(t=/<!\[CDATA\[/g,l[e]=l[e].replace(t,"//<![CDATA["),t=/\]\]>/g,l[e]=l[e].replace(t,"//]]>"))}}var l=[];s(t[n=0],o)},i.getScript=function(){return o},i.replaceScript=function(e){if(o=e,r&&r.length)for(t=0;t<r.length;t++)r[t].parentNode&&r[t].parentNode.removeChild(r[t]);r=[];for(var t=0;t<e.length;t++){var n=document.createElement("script");n.setAttribute("kotobee",""),n.setAttribute("type","text/javascript"),n.innerHTML=e[t],r.push(n);try{document.head.appendChild(n)}catch(e){}try{document.dispatchEvent(new Event("DOMContentLoaded"))}catch(e){}}},i}]),app.factory("library",["stg","translit","cache","$rootScope","backend","crdv",function(e,t,n,o,r,i){function a(e){e||(e={}),d.maxResults=e.large?40:20}function s(e){e||(e={}),d.maxResults+=e.large?20:6}function c(){for(var e=0;e<u.length;e++)u[e].apply(this,arguments)}var l,d={},u=[];return d.sortMethod={},d.root="",d.initialize=function(){d.setBrowserTitle(),a(),u=[]},d.setMax=function(e){d.maxResults=e},d.setBrowserTitle=function(){n.setOb("title",replaceHTML(n.getOb("title"),e.data.currentLibrary.name?e.data.currentLibrary.name:t.get("library")))},d.addListener=function(e){u.push(e)},d.getEbooks=function(t,n){function o(n){try{t.favs?e.data.favorites=n:e.data.currentLibrary.books=n}catch(e){}}t||(t={}),l=Math.round(1e5*Math.random()),c("preload",t),t.accumulated||addClass(document.getElementById("libraryThumbs"),"dim"),t.more?s(t.contentkey?{large:!0}:{}):a(t.contentkey?{large:!0}:{}),t.sort=d.sortMethod.data,t.sortDir=d.sortMethod.dir,t.max=d.maxResults,r.getEbooks(t,l,function(r,a){if(a==l){removeClass(document.getElementById("libraryThumbs"),"dim"),r.error||(i.applyExistingBooks(r),o(r));var s=t.favs?e.data.favorites:e.data.currentLibrary.books;s&&s.length||(r.empty=!0),c("postload",t,r),n&&n(r)}})},d}]),app.factory("markers",["$rootScope","error","cache","stg","$location","$injector","$ionicScrollDelegate",function(e,t,n,o,r,i,a){function s(){return!(r.path()&&r.path().indexOf("/reader")>=0)}var c={},l=new Array,d={};return c.addMarker=function(e){l.push(e),c.refreshMarker(e)},c.deleteMarker=function(e){for(var t=0;t<l.length;t++)l[t].id==e&&l.splice(t,1)},c.windowResize=function(){s()||d.width==window.innerWidth&&d.height==window.innerHeight||(c.refreshMarkers(),d.width=window.innerWidth,d.height=window.innerHeight)},c.refreshMarkers=function(){for(var e=0;e<l.length;e++)c.refreshMarker(l[e])},c.refreshMarkerById=function(e){for(var t=0;t<l.length;t++)if(l[t].id==e)return void c.refreshMarker(l[t])},c.getMarker=function(e){for(var t=0;t<l.length;t++)if(l[t].id==e)return l[t]},c.refreshMarker=function(e){var t=e.target();if(t&&e.elem){var r="",a="page";(hasClass(e.elem,"contentSideNoteMarker")||hasClass(e.elem,"contentBookMarker"))&&(a="side");var s=n.getOb("epubContainer").getElementsByClassName("scroll")[0],c=n.getOb("epubContent");if(s){var l=t.getBoundingClientRect(),d=s.getBoundingClientRect(),u=c.getBoundingClientRect(),p=0,f=0,m=1;p=s.scrollTop,f=s.scrollLeft;var g=i.get("nav");o.data.book.chapter.viewport&&(m=g.getFxlScale());var h,v,b,k=(l.top+p-(d.top+0))/m;if("side"==a){h=0;var y=u.left-d.left+f,w=d.right-u.right+f;(b=o.data.book.chapter.viewport?y:y<w?y:w)<30&&(b=30),o.data.settings.rtl&&(v=0,h=null)}else{if(0==e.elem.offsetWidth)return;h=(l.left+f-d.left)/m}null!=k&&(r+="top: "+(k+e.offsetTop)+"px; "),null!=h&&(r+="left: "+(h+e.offsetLeft)+"px; "),null!=v&&(r+="right: "+(v-e.offsetLeft)+"px; "),null!=b&&(r+="width: "+b+"px; ");var C=1/m;""!=(r+="transform:scale("+C+");-webkit-transform:scale("+C+");-moz-transform:scale("+C+");")&&(e.elem.style.cssText=r),e.callback&&e.callback()}}},c.show=function(){for(var e=0;e<l.length;e++)l[e].elem.style.visibility="shown"},c.hide=function(){for(var e=0;e<l.length;e++)l[e].elem.style.visibility="hidden"},window.addEventListener("resize",c.windowResize,!0),c}]),app.factory("media",["$ionicModal","tinCan","$rootScope","modals",function(e,t,n,o){var r={};return r.show=function(e){t.send({verb:"viewed image",activity:e.title?e.title:e.thumbnail}),o.show({mode:"image",dynamic:!0,animation:"slide-in-up",image:e})},r.hide=function(){o.hide()},r}]),app.factory("modals",["$ionicModal","$q","$injector","$ionicPlatform","$rootScope",function(e,t,n,o,r){function i(){if(c=null,u.length){var e=u[0];e&&((c=e).hidden?i():(p.backdropClickToClose=!!e.backdropClickToClose&&e.backdropClickToClose,p.animation=e.animation?e.animation:"zoom-in",f().then(function(){s.modal=e,a&&(a.show(),s.$$phase||s.$apply(),c.timeLimit&&(l=setTimeout(function(){var e=c;d.hide(c);var t={wait:function(){d.hide(),d.show(e)}};d.show({mode:"waitTimeout",timeoutOptions:t})},c.timeLimit)),setTimeout(function(){e.cb&&e.cb(a)},750))})))}}var a,s,c,l,d={},u=[],p={animation:"zoom-in",focusFirstInput:!1,backdropClickToClose:!1};d.setScope=function(e){function t(){for(var e=document.getElementsByClassName("modal-backdrop"),t=e.length;t--;)hasClass(e[t],"hide")&&e[t].parentNode.removeChild(e[t])}(s=e).hideModal=d.hide,a||f(),s.$on("modal.hidden",function(e){l&&clearTimeout(l),setTimeout(function(){u.shift(),i(),t()},500)})};var f=function(){var n=t.defer(),o=clone(p);return o.scope=s,e.fromTemplateUrl(kTemplate("modals/modals.html"),o).then(function(e){a=e,n.resolve()}),n.promise};return d.show=function(e){if(a)return u.push(e),q=u,1==u.length&&i(),e;f().then(function(){d.show(e)})},d.obShown=function(e){return c==e},d.shown=function(){return!!a&&a.isShown()},d.hide=function(e,t){a&&(e?c==e?(a.hide(),native&&n.get("crdv").hideKeyboard()):e.hidden=!0:(a.hide(),native&&n.get("crdv").hideKeyboard()),t&&t())},d}]),app.factory("nav",["cache","crdv","$ionicGesture","$location","selection","markers","settings","$timeout","chapters","$ionicScrollDelegate","stg",function(e,t,n,o,r,i,a,s,c,l,d){function u(){for(var e=0;e<A.length;e++)A[e].apply(this,arguments)}function p(){if(N=l.$getByHandle("content"),mobile){var e=N.getScrollView().options;e.scrollbarFadeDelay=0,e.scrollingY=!0,e.minZoom=.2,e.maxZoom=3.5,e.zooming=!0,d.data.book.chapter.viewport?(e.deceleration=.85,e.scrollingX=!0,e.scrollbarY=!1,setTimeout(function(){N.zoomTo(x.getFxlBestFit(),!1),N.scrollTo(0,0,!1),setTimeout(f,1e3)},500)):(N.scrollTo(0,0,!1),e.zooming&&N.zoomTo(1,!1,0,0),e.deceleration=.95,e.scrollbarY=!0,config.textSizeControls||(e.zooming=!1),setTimeout(function(){e.scrollingX=!1,config.textSizeControls||(e.zooming=!1)},500)),setTimeout(i.refreshMarkers,1e3)}else N.scrollTop(!1),d.data.book.chapter.viewport?(N.scrollTop(!1),h(x.getFxlBestFit(),!0)):(N.scrollTo(0,0,!1),h(1,!0))}function f(){if(mobile){var e=x.getFxlScale(),t=x.getFxlBestFit(),n=N.getScrollView().options;n.scrollingX=!(e<=t)}}function m(e){if(!(C()||mobile&&b())){var t=d.data.book.chapter.viewport?1:.8,n=d.data.book.chapter.viewport?100:70;if(!(Math.abs(e.gesture.velocityX)<t||Math.abs(e.gesture.distance)<n||e.gesture.touches.length>1))return!0}}function g(){return!(o.path()&&o.path().indexOf("/reader")>=0)}function h(t,n){var o=e.getOb("epubContainer").children[0];k(o)!="scale("+t+")"&&(y(o,"scale("+t+")"),w(o,t>1?"none":null),n&&(o.style.transition="initial"),setTimeout(function(){n&&(o.style.transition=null),redrawForChrome(document.body)},500),setTimeout(i.refreshMarkers,1e3))}function v(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.msFullscreenElement)return document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozExitFullscreen?document.mozExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),!0}function b(){var e=document.getElementById("readerBody").style.transform||document.getElementById("readerBody").style.webkitTransform;if(e&&"translate3d(0px, 0px, 0px)"!=e&&"translate3d(0px, 0, 0)"!=e)return!0}function k(e){return e.style.webkitTransform||e.style.mozTransform||e.style.transform}function y(e,t){autoprefixTransform(e,t)}function w(e,t){e.style.perspective=e.style.msPerspective=e.style.webkitPerspective=e.style.mozPerspective=t}function C(){return T>I}var E,x={},I=15,T=0,S={},A=[];x.init=function(e){mobile&&(n.on("swipeleft",x.swipeLeft,e),n.on("swiperight",x.swipeRight,e)),n.on("dragstart",x.dragStart,e),n.on("drag",x.drag,e),n.on("tap",x.tap,e),n.on("doubletap",x.fxlToggleTapZoom,e),n.on("transformstart",x.transformstart,e),n.on("transformend",x.transformend,e),E||(window.addEventListener("resize",x.windowResize,!0),S.width=window.innerWidth,S.height=window.innerHeight,c.addListener(p),E=!0,document.body.addEventListener("keyup",function(e){27==e.keyCode&&v()}))},x.addListener=function(e){A.push(e)};var N;return x.windowResize=function(){g()||S.width==window.innerWidth&&S.height==window.innerHeight||(x.fxlZoomFit(),S.width=window.innerWidth,S.height=window.innerHeight)},x.getScroller=function(){return N},x.transformstart=function(){x.transforming=!0},x.transformend=function(){if(x.transforming=!1,!g())if(d.data.book.chapter.viewport){var t=x.getFxlScale(),n=x.getFxlBestFit();t<n?l.$getByHandle("content").zoomTo(n,!0):t>3&&l.$getByHandle("content").zoomTo(3,!0),f(),setTimeout(i.refreshMarkers,1e3),x.repaint()}else{if(!config.textSizeControls)return;var o=N.getScrollPosition().zoom,r=a.getTextSize(),s=Math.round(o*r*10)/10;s<.2&&(s=.2),d.data.settings.textSize=s+"em",a.updateTextSize(),a.writeTextSize(),N.zoomTo(1,!0);var c=angular.element(e.getOb("epubContent")).scope();c.header.mode="textSize",c.$$phase||c.$apply(),setTimeout(i.refreshMarkers,1e3)}},x.repaint=function(){redrawForChrome(e.getOb("epubContent"))},x.resize=function(){N.resize()},x.swipeRight=function(n){if(!g()&&m(n))if(N.resize(),native&&t.vibrate(),"chapter"!=swipeMode){var o=l.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)c.prevChapter();else if(o.getScrollPosition().top<=10)c.prevChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),s(function(){o.scrollBy(0,-o.getScrollView().__clientHeight)},200),s(function(){removeClass(r,"fadeOut")},300)}}else d.data.settings.rtl?c.nextChapter():c.prevChapter()},x.swipeLeft=function(n){if(!g()&&m(n))if(N.resize(),native&&t.vibrate(),"chapter"!=swipeMode){var o=l.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)c.nextChapter();else if(o.getScrollPosition().top>=o.getScrollView().__contentHeight-o.getScrollView().__clientHeight-30)c.nextChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),s(function(){o.scrollBy(0,o.getScrollView().__clientHeight)},200),s(function(){removeClass(r,"fadeOut")},300)}}else d.data.settings.rtl?c.prevChapter():c.nextChapter()},x.dragStart=function(){g()||(d.data.book.chapter.viewport||N.zoomTo(1,!1),T=0,N.freezeScroll(!1))},x.drag=function(e){T++},x.tap=function(e){u("tap")},x.fxlToggleTapZoom=function(t){e.getOb("epubContent")&&d.data.book.chapter.viewport&&d.data.book.chapter.viewport.width&&(x.getFxlScale()!=x.getFxlBestFit()?x.fxlZoomFit(t):(l.$getByHandle("content").zoomTo(2*x.getFxlBestFit(),!0,t.gesture.center.pageX,t.gesture.center.pageY),r.reset()),setTimeout(f,1e3),setTimeout(i.refreshMarkers,1e3),setTimeout(x.repaint,1e3))},x.fxlZoomIn=function(e){r.reset();var t=1.2*x.getFxlScale();x.getFxlBestFit();t>3&&(t=3),mobile?l.$getByHandle("content").zoomTo(t,!0):h(t),setTimeout(f,1e3),setTimeout(i.refreshMarkers,1e3)},x.fxlZoomOut=function(e){r.reset();var t=.8*x.getFxlScale(),n=x.getFxlBestFit();t<n&&(t=n),mobile?l.$getByHandle("content").zoomTo(t,!0):h(t),setTimeout(f,1e3),setTimeout(i.refreshMarkers,1e3)},x.fxlZoomFit=function(t){e.getOb("epubContent")&&d.data.book.chapter.viewport&&d.data.book.chapter.viewport.width&&(r.reset(),mobile?N.zoomTo(x.getFxlBestFit(),!0):h(x.getFxlBestFit()),setTimeout(f,1e3),setTimeout(i.refreshMarkers,1e3))},x.getFxlBestFit=function(t,n){t||(t={}),t.viewport||(t.viewport=d.data.book.chapter.viewport);var o=30;mobile||(o=30);var r=t.viewport.width+2*o+20,i=t.viewport.height,a=document.getElementById("readerBody"),s=document.getElementById("readerHeader"),c=document.getElementById("tabMenu");n||(n=e.getOb("epubContent"));var l=a.getBoundingClientRect().width/r,u=l;u>=1&&(u=1);var p=(a.getBoundingClientRect().height-s.getBoundingClientRect().height-c.getBoundingClientRect().height)/(i+2*o);if(config.fitToScreen)return p<l?p:l;var f=!1;if((p/=u)<1&&p>=.75&&(u*=p,f=!0),u>=1)n.style.setProperty("margin-left","auto","important"),n.style.setProperty("margin-right","auto","important");else if(f){var m=(a.getBoundingClientRect().width-10-t.viewport.width*u)/2;n.style.setProperty("margin-left",Math.round(m/u)+"px","important"),n.style.setProperty("margin-right",Math.round(m/u)+"px","important")}else n.style.marginLeft&&(n.style.marginLeft=n.style.marginRight=null);return u},x.getFxlScale=function(){if(mobile)return l.$getByHandle("content").getScrollPosition().zoom;var t=k(e.getOb("epubContainer").children[0]);if(!t)return 1;if(""==t)return 1;var n=t.split("scale");if(n.length<=1)return 1;var o=n[1].split("(");if(o.length<=1)return 1;var r=o[1].split(")");return Number(r[0])},x.fullscreen=function(){var e=document.body;v()||(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen())},x}]),app.factory("np",["stg","status","error","translit","$rootScope","crdv","modals","$http","$ionicSideMenuDelegate",function(e,t,n,o,r,i,a,s,c){var l,d,u,p,f,m,g,h,v,b,k,y,w,C={};return C.init=function(e){desktop?(p=require("nw.gui"),f=require("child_process").exec,m=p.Window.get(),g=process.cwd(),v=(process.env.HOME||process.env.USERPROFILE)+"/Desktop",h=require("path").dirname(process.execPath),w=h+"/node_modules/","mac"==os&&(w=""),r.readerApp&&(w=""),w="",l=require(w+"fs.extra"),d=require(w+"async"),u=require(w+"buckle"),b=p.App.dataPath,k=b+"/temp",y=b+"/Books",C.createIfNotExists(y),C.createIfNotExists(k),m.removeAllListeners(),m.on("close",function(){C.exit()}),e&&e()):e()},C.createIfNotExists=function(e,t){desktop&&l.exists(e,function(n){n?t&&t():C.createIfNotExists(ph.parent(e),function(){l.mkdirSync(e),t&&t()})})},C.createIfNoParentsExists=function(e,t){desktop&&l.exists(e,function(n){n?t&&t():C.createIfNoParentsExists(ph.parent(e),function(){l.mkdirSync(e),t&&t()})})},C.writeEbook=function(t,n,o,r){desktop&&C.createTempDir(function(t){var a=new FileReader;a.onload=function(){var o=ph.join(t,"book.zip");"mac"==os&&(o=t+"/book.zip"),l.writeFileSync(o,Buffer.from(new Uint8Array(a.result)));var s=ph.join(y,n.path);"mac"==os&&(s=y+"/"+n.path),C.extractZip(o,s,function(){n.exists=!0,e.data.downloaded.push(n),i.applyExistingBooks(e.data.currentLibrary.books),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){C.removeDirectory(t,function(){r&&r()})})})},a.readAsArrayBuffer(o)})},C.deleteEbook=function(t,n){C.removeDirectory(ph.join(y,t.path),function(){for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].path==t.path&&(t.exists=!1,e.data.downloaded.splice(o,1),o--);e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){n&&n()})})},C.fileExists=function(e,t){l.exists(e,function(e){t(e)})},C.removeFile=function(e,t){C.removeDirectory(e,t)},C.removeDirectory=function(e,t){l.rmrf(e,function(e){t&&t(e)})},C.extractZip=function(e,t,n){u.open(e,t,function(){l.readdir(t,n)})},C.createTempDir=function(e){var t=k+"/f"+randStr(5);C.fileExists(t,function(n){n?C.createTempDir(e):l.mkdir(t,function(){e(t)})})},C.openLink=function(e){p.Shell.openExternal(e)},C.getBooksPath=function(){return y+"/"},C.writeArrayBuffer=function(e,t,n,o){var r=arrayBufferToBuffer(e);l.open(t,"w",function(e,t){if(e)throw"error opening file: "+e;l.write(t,r,0,r.length,null,function(e){e?o&&o(!1):l.close(t,function(){o&&o(!0)})})})},C.copy=function(e,t,n,o){if(n||(n={}),n.replace)for(var r=0;r<n.replace.length;r++)e=e.replace(n.replace[r].key,n.replace[r].val);n.header&&(e=n.header+e),n.footer&&(e+=n.footer),n.encoding||(n.encoding="ascii"),e=(e+="").replace(/\xA0/g," "),e=utf8Encode(e),l.writeFile(t,e,n.encoding,function(t,n){o&&o(e)})},C.exit=function(){e.getActions(function(e){if(e&&e.length){a.hide();var t={title:"confirmation",msg:"annotationsSyncExitWarning",barStyle:"bar-dark"},n={label:"delete",style:"button-assertive"};n.func=function(){p.App.quit()};var o={label:"cancel"};o.func=function(){a.hide()},t.btns=[n,o],a.show({mode:"confirm",confirmOptions:t})}else p.App.quit()})},C}]),app.factory("popovers",["$ionicPopover","$q","$rootScope",function(e,t,n){function o(){if(0!=s.length){var e=s.shift();e.apply?i.$apply(function(){i.popover=e}):i.popover=e,r&&(r.isShown()||r.show(e.event))}}var r,i,a={},s=[];a.setScope=function(e){i=e,r||c()};var c=function(){var o=t.defer();return i||(i=n),e.fromTemplateUrl(kTemplate("modals/popovers.html"),{scope:i}).then(function(e){r=e,o.resolve()}),o.promise};return a.show=function(e){r?(s.push(e),1==s.length&&o()):c().then(function(){a.show(e)})},a.shown=function(){return!!r&&r.isShown()},a.hide=function(){r&&(i.popover=null,r&&r.hide(),o())},a}]),app.factory("scorm",["scormWrapper",function(e){function t(e){var t=e.getSeconds();t<10&&(t="0"+t);var n=e.getMinutes();n<10&&(n="0"+n);var o=e.getHours();return o<10&&(o="0"+o),o+":"+n+":"+t}function n(e){var t=e.toISOString().split(".");return t.splice(t.length-1,1),t.join(".")}function o(e){var t=Math.floor(e/3600);e-=60*t*60;var n=Math.floor(e/60);return(e-=60*n)<10&&(e="0"+e),t<10&&(t="0"+t),n<10&&(n="0"+n),t+":"+n+":"+e}function r(e){var t=e,n=Math.floor(t/31104e3);t=e-31104e3*n;var o=Math.floor(t/2592e3);t=e-2592e3*o;var r=Math.floor(t/86400);t=e-86400*r;var i=Math.floor(t/3600);t=e-3600*i;var a=Math.floor(t/60);return"P"+n+"Y"+o+"M"+r+"DT"+i+"H"+a+"M"+(t=e-60*a)+"S"}function i(){if(p.length){for(var e=Number(c("cmi.objectives._count")),t={},n=0;n<p.length;n++)t[p[n].qid]=p[n];for(n=0;n<e;n++){var o=c("cmi.objectives."+n+".id");if(o){i=0;for(var r in t)t[r].objective==o&&(i+=t[r].scoreMax);m.setObjective({id:o,scoreMax:i},!0),m.setObjective({id:o,scoreRaw:0},!0)}}var i=0;for(var r in t)i+=t[r].scoreMax;l(1.2==f?"cmi.core.score.max":"cmi.score.max",i),l(1.2==f?"cmi.core.score.min":"cmi.score.min",0),l(1.2==f?"cmi.core.score.raw":"cmi.score.raw",0);for(var a=0;a<p.length;a++){for(var d=p[a],u=null,g=null,n=0;n<e;n++)d.objective==s("cmi.objectives",n,"id")&&(u=d.objective,g=n);if(u){var h=Number(c("cmi.objectives."+g+".score.raw"));h||(h=0);var v={};v.id=u,v.scoreRaw=d.result*d.weighting+h,v.scoreMin=0,v.scoreScaled=v.scoreRaw/v.scoreMax,v.completionStatus="unknown",v.successStatus="unknown",m.setObjective(v,!0)}var b=Number(c(1.2==f?"cmi.core.score.raw":"cmi.score.raw"));b||(b=0),l(1.2==f?"cmi.core.score.raw":"cmi.score.raw",d.result*d.weighting+b)}}}function a(){e.doLMSCommit("")}function s(e,t,n){var o=c(e+"."+t+"."+n);return o&&""!=o||(o=c(e+"_"+t+"."+n)),o}function c(t){return e.doLMSGetValue(t)}function l(t,n){return e.doLMSSetValue(t,n)}function d(){try{var e=c("cmi.suspend_data");return JSON.parse(e)}catch(e){return[]}}function u(e){try{l("cmi.suspend_data",JSON.stringify(e))}catch(e){}}var p,f,m={};return m.initialize=function(){if(!(config.v<1.2)){kInteractive.scorm=this;try{if(!scormEnabled)return}catch(e){return}e.doLMSInitialize(""),1.2==(f=e.getAPIVersion())?"not attempted"==c("cmi.core.lesson_status")&&(l("cmi.core.lesson_status","browsed"),a()):"not attempted"==c("cmi.completion_status")&&(l("cmi.completion_status","unknown"),a()),p=d();try{for(var t=0;t<config.scorm.objectives.length;t++){var n=Number(c("cmi.objectives._count"));n||(n=0);for(var o=n,r=config.scorm.objectives[t],i=0;i<n;i++)s("cmi.objectives",i,"id")==r.id&&(o=i);l("cmi.objectives."+o+".id",r.id),1.2!=f&&l("cmi.objectives."+o+".description",r.name)}}catch(e){}a()}},m.setBookmark=function(e,t){try{if(!scormEnabled)return}catch(e){return}l(1.2==f?"cmi.core.lesson_location":"cmi.location",e),t||a()},m.getBookmark=function(){try{if(!scormEnabled)return}catch(e){return}return c(1.2==f?"cmi.core.lesson_location":"cmi.location")},m.setInteractions=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=0;t<e.length;t++){for(var n=p.length,o=0;o<p.length;o++)p[o].id==e[t].id&&(n=o);p[n]=e[t],m.setInteraction(n,e[t],!0)}i(),u(p),a()},m.setInteraction=function(e,i,s){try{if(!scormEnabled)return}catch(e){return}i.id&&l("cmi.interactions."+e+".id",i.id),i.result&&l("cmi.interactions."+e+".result",i.result),i.correctResponses&&l("cmi.interactions."+e+".correct_responses.0.pattern",i.correctResponses),i.type&&l("cmi.interactions."+e+".type",i.type),i.weighting&&l("cmi.interactions."+e+".weighting",i.weighting),i.objective&&l("cmi.interactions."+e+".objectives.0.id",i.objective),1.2==f?(i.timestamp&&l("cmi.interactions."+e+".time",t(i.timestamp)),i.latency&&l("cmi.interactions."+e+".latency",o(i.latency)),i.learnerResponses&&l("cmi.interactions."+e+".student_response",i.learnerResponses)):(i.timestamp&&l("cmi.interactions."+e+".timestamp",n(i.timestamp)),i.latency&&l("cmi.interactions."+e+".latency",r(i.latency)),i.learnerResponses&&l("cmi.interactions."+e+".learner_responses",i.learnerResponses),i.description&&l("cmi.interactions."+e+".description",i.description)),s||a()},m.setObjective=function(e,t){try{if(!scormEnabled)return}catch(e){return}for(var n=Number(c("cmi.objectives._count")),o=n,r=0;r<n;r++)s("cmi.objectives",r,"id")==e.id&&(o=r);null!=e.id&&l("cmi.objectives."+o+".id",e.id),null!=e.scoreRaw&&l("cmi.objectives."+o+".score.raw",e.scoreRaw),null!=e.scoreMin&&l("cmi.objectives."+o+".score.min",e.scoreMin),null!=e.scoreMax&&l("cmi.objectives."+o+".score.max",e.scoreMax),1.2==f?null!=e.successStatus&&l("cmi.objectives."+o+".status",e.successStatus):(null!=e.description&&l("cmi.objectives."+o+".description",e.description),null!=e.successStatus&&l("cmi.objectives."+o+".success_status",e.successStatus),null!=e.completionStatus&&l("cmi.objectives."+o+".completion_status",e.completionStatus),null!=e.scoreScaled&&l("cmi.objectives."+o+".score.scaled",e.scoreScaled)),t||a()},m.interactionExistsOld=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=Number(c("cmi.interactions._count")),n=0;n<t;n++)if(s("cmi.interactions",n,"id")==e)return!0},m.interactionExists=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=0;t<p.length;t++)if(p[t].id==e)return!0},m.objectiveExists=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=Number(c("cmi.objectives._count")),n=0;n<t;n++)if(s("cmi.objectives",n,"id")==e)return!0},m}]),app.factory("search",["$http","error","book","chapters","cache","$timeout","$filter","translit","virt","selection","stg",function(e,t,n,o,r,i,a,s,c,l,d){function u(e,t,n,o){function r(e){for(var o=e,r=l.convertElemsToLocation([o],t),i='<span class="searchItem">'+o.textContent+"</span>",a=(i.toLowerCase().indexOf(g.key.toLowerCase()),i.length+Math.round((70-i.length)/2));;){if(!o.previousSibling)break;if(i.length>=a)break;o.previousSibling.textContent&&(i=o.previousSibling.textContent+i),o=o.previousSibling}i.length;for(o=e;;){if(!o.nextSibling)break;if(i.length>=70)break;o.nextSibling.textContent&&(i+=o.nextSibling.textContent),o=o.nextSibling}g.result[n].matches.push({chapter:n,elem:e,hint:i.trim(),location:r})}function i(e){return(e.textContent.toLowerCase().match(new RegExp(g.key.toLowerCase(),"g"))||[]).length}if(0!=e.children.length){for(var a=0;a<e.children.length;a++)0!=i(e.children[a])&&(o=!1,hasClass(e.children[a],"k-section")&&c.checkIfRequiresParse(e.children[a]),u(e.children[a],t,n,!0));o&&r(e)}else i(e)>0&&r(e)}function p(e,t){var n=0;e.start&&(n=e.start);var o=f(),r=function(i){e.limit&&f()-o>=e.limit?t({results:g.result,more:!0,key:g.key}):i?m(n++,r):t({results:g.result,key:g.key})};m(n,r)}function f(){for(var e=0,t=g.result.length;t--;)if(g.result[t])for(var n=g.result[t].matches.length;n--;)e++;return e}function m(t,n){var o=d.data.epub.spine.getElementsByTagName("itemref");{if(!(t>o.length-1)){var r=o[t].getAttribute("idref"),i=getElementsByAttribute(d.data.epub.manifest,"item","id",r)[0].getAttribute("href"),c=ph.join(bookPath,d.data.packageURL,i);return e.get(cacheBust(c)).success(function(e){config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e));var o=parser.parseFromString(e,"text/html"),e=a("contentHtml")(o),r=o.getElementsByTagName("title");g.result[t]=[],g.result[t].title=r.length?r[0].textContent:s.get("chapter")+": "+(t+1),g.result[t].matches=[],u(e,e,t),n(!0)}).error(function(e,t){n(!1)})}n(!1)}}var g={};return g.start=function(e,t){if(g.key=e.key,e.array?g.result=e.array:g.result=new Array,"all"==e.mode)p(e,t);else if("chapter"==e.mode){var n=r.getOb("epubContent");g.result[currentIndex]=[],g.result[currentIndex].matches=[],u(n,n,currentIndex),t({results:g.result,key:g.key})}},g}]),app.factory("selection",["markers","cache","error","stg","virt","$rootScope","$injector","$ionicScrollDelegate",function(e,t,n,o,r,a,s,c){function l(e,t){for(t||(t=e);!e.nextSibling;)if((e=e.parentNode)==t)return;for(e=e.nextSibling;e.childNodes[0];)e=e.childNodes[0];return"#text"==e.nodeName&&e.textContent.trim()?e:l(e,t)}function d(e,t){for(t||(t=e);!e.previousSibling;)if((e=e.parentNode)==t)return;for(e=e.previousSibling;e.childNodes.length;)e=e.childNodes[e.childNodes.length-1];return"#text"==e.nodeName&&e.textContent.trim()?e:d(e,t)}function u(e){return 8==e.nodeType||"#text"==e.nodeName||"br"==e.nodeName.toLowerCase()||(0==e.offsetWidth||void 0)}function p(e){var t=1;return o.data.book.chapter.viewport&&(t=s.get("nav").getFxlScale()),e.getBoundingClientRect().width/t}var f,m,g,h,v,b,k,y,w,C,E,x,I,T,S,A,N,B,L,O,$={};$.getLocation=function(){return S};var M;$.elementDown=function(e,t){if(C=e,!mobile){var n=!0;"a"==e.nodeName.toLowerCase()&&(n=!1),hasClass(e,"ki-noHighlight")&&(n=!1),e.parentNode&&("a"==e.parentNode.nodeName.toLowerCase()&&(n=!1),hasClass(e.parentNode,"ki-noHighlight")&&(n=!1)),n&&addClass(e,"highlightOver")}redrawForChrome(C.parentElement),x=setTimeout($.elementHeld,mobile&&!mobileDebug?400:100),mobile&&!mobileDebug?(T=t.touches[0],L=T.clientX,O=T.clientY):(L=t.clientX,O=t.clientY,T=t),document.body.addEventListener(mobile&&!mobileDebug?"touchend":"mouseup",$.elementUp),document.body.addEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",H)};var H=function(e){T=mobile&&!mobileDebug?e.touches[0]:e,"activated"==A&&e.stopPropagation()};$.elementUp=function(e){C&&(mobile||removeClass(C,"highlightOver"),C=null,clearTimeout(x)),M&&removeClass(t.getOb("epubContent"),"disableEvents"),M=!1,document.body.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",$.elementUp),document.body.removeEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",H),a.$$phase||a.$apply()},$.elementHeld=function(){s.get("nav").transforming||Math.abs(T.clientX-L)>(mobile?30:10)||Math.abs(T.clientY-O)>(mobile?30:10)||hasClass(C,"ki-noHighlight")||(addClass(C,"highlightSelected"),J(C),$.elementUp())},$.getSelectedText=function(){for(var e=document.getElementsByClassName("highlightSelected"),t="",n=0;n<e.length;n++)t+=e[n].textContent;return t},$.getElemsByLocation=function(e,n){n||(n=t.getOb("epubContent"));var o=new Array;if(!e)return o;for(var i=e.split(","),a=0;a<i.length;a++)if(i[a]){for(var s=i[a].split("."),c=n,l=0;l<s.length;l++)c&&(1==l&&r.checkIfRequiresParseAndAnnotations(c.children[Number(s[l])]),c=c.children[Number(s[l])]);o.push(c)}return o},$.expand=function(){g=g.parentNode,z(),g=h=w,q(),mobile&&P(),F()},$.extendRight=function(e){if(e||"rtl"!=getComputedStyle(g).direction){if(I){n=l(g,t.getOb("epubContent"));if(g=n.parentNode,u(g))return void $.extendRight(e)}else{var n=l(h,t.getOb("epubContent"));if(h=n.parentNode,u(h))return void $.extendRight(e)}z(),q(),mobile&&P(),F()}else $.extendLeft(!0)},$.extendLeft=function(e){if(e||"rtl"!=getComputedStyle(g).direction){if(I){n=d(g,t.getOb("epubContent"));if(h=n.parentNode,u(h))return void $.extendLeft(e)}else{var n=d(g,t.getOb("epubContent"));if(g=n.parentNode,u(g))return void $.extendLeft(e)}z(),q(),mobile&&P(),F()}else $.extendRight(!0)},$.newChapter=function(){mobile&&(e.deleteMarker("anchor1Marker"),e.deleteMarker("anchor2Marker"),f=$.createAnchorMarker("anchor1"),m=$.createAnchorMarker("anchor2"),addClass(f,"disable"),addClass(m,"disable"))},$.getTopCornerLocation=function(){var e=$.getTopCornerElement();return $.convertElemsToLocation([e])},$.getTopCornerElement=function(){for(var e=t.getOb("epubContent"),n=t.getOb("epubContainer"),o=e.children[0],r=c.$getByHandle("content").getScrollPosition().top+25,i=new Array,a=o.getElementsByClassName("k-section"),s=0;s<a.length;s++)hasClass(a[s],"cNone")||i.push(a[s]);for(var l,d=document.getElementById("readerHeader").offsetHeight+10,s=0;s<i.length;s++)for(var u=i[s].getElementsByTagName("*"),p=0;p<u.length;p++){var f=u[p].getBoundingClientRect();if(f.bottom>d){if(f.top>d&&f.top<d+60)return u[p];var m=f.top-d;l?m<l.distance&&f.bottom<d+n.offsetHeight&&(l={elem:u[p],bounds:f,distance:m}):l={elem:u[p],bounds:f,distance:m}}}if(l)return l.elem;for(s=0;s<i.length;s++)if(i[s].offsetTop-r>0)return i[s];return i[0]},$.getIdArray=function(e){for(var n=$.getTopCornerElement(),o=[];;){if(!n)break;if(n==t.getOb("epubContent"))break;n.getAttribute&&n.getAttribute("id")&&o.push(n.getAttribute("id")),n=n.previousSibling?n.previousSibling:n.parentNode}return o};var P=function(){e.refreshMarkerById("anchor1Marker"),e.refreshMarkerById("anchor2Marker")},D=function(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t},R=function(e,n){n||(n=t.getOb("epubContent"));for(var o="";e!=n;)o=D(e)+"."+o,e=e.parentNode;return""==o?"":o.substr(0,o.length-1)},F=function(){return S=$.convertElemsToLocation(document.getElementsByClassName("highlightSelected"))};$.convertElemsToLocation=function(e,n){var o="";n||(n=t.getOb("epubContent"));for(var r=0;r<e.length;r++)o+=(r?",":"")+R(e[r],n);return o};var z=function(){v=new Array,b=new Array;for(var e=t.getOb("epubContent").parentNode,n=g;;)if(v.push(n),(n=n.parentNode)==e)break;for(n=h;;)if(b.push(n),(n=n.parentNode)==e)break;var o=function(){for(i=0;i<v.length;i++)for(j=0;j<b.length;j++)if(b[j]==v[i])return[b[j],i,j]}();for(w=o[0],k=o[1],y=o[2],i=0;i<w.childNodes.length;i++){if(w.childNodes[i]==v[k-1]){I=!1;break}if(w.childNodes[i]==b[y-1]){I=!0;break}}},q=function(){try{if(_(),addClass(g,"highlightSelected"),addClass(h,"highlightSelected"),g==h)return void(S=R(g));if(g==w)return void(S=R(g));if(h==w)return void(S=R(h));U(I?h:g,I?g:h)}catch(e){}},U=function(e,t,n){var o;if(n||(n="first"),"first"==n){if(e.parentNode==w)return void U(e,t,"second");for(o=e;(o=o.nextSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");U(e.parentNode,t,"first")}else if("second"==n){if(t.parentNode==w)return void U(e,t,"third");for(o=t;(o=o.previousSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");U(e,t.parentNode,n)}else if("third"==n){var r,a=I?b[y-1]:v[k-1],s=I?v[k-1]:b[y-1];for(i=0;i<w.childNodes.length;i++)if(a!=w.childNodes[i]){if(s==w.childNodes[i])break;r&&"#text"!=w.childNodes[i].nodeName&&8!=w.childNodes[i].nodeType&&addClass(w.childNodes[i],"highlightSelected")}else r=!0}},V=function(){_(),mobile&&(addClass(f,"disable"),addClass(m,"disable"),removeClass(f,"tween"),removeClass(m,"tween")),A=null,I=null,$.listener&&$.listener("deactivated")},_=function(){try{var e=document.getElementsByClassName("highlightSelected");if(!e)return;for(var t=e.length;t--;)removeClass(e[t],"highlightSelected");mobile&&r.forceRepaint()}catch(e){}};$.listener=null,$.addSpanAtCloseTag=function(){var e=document.createElement("span"),t=I?g:h;return t.parentNode.insertBefore(e,t.nextSibling),e},$.getSelectedNodes=function(){return document.getElementsByClassName("highlightSelected")},$.reset=function(){V()},$.deleteNoteMarker=function(t){var n=document.getElementById("note"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("noteMarker"+t)},$.getNoteMarker=function(t){return e.getMarker("noteMarker"+t)},$.createAnchorMarker=function(n){var o=document.createElement("span");return o.setAttribute("id",n+"Marker"),o.setAttribute("anchor",n),addClass(o,"anchorMarker"),t.getOb("epubMeta").appendChild(o),o.addEventListener(mobileDebug?"mousedown":"touchstart",function(e){addClass(E=o,"selected"),B=null,document.addEventListener(mobileDebug?"mousemove":"touchmove",W),N&&clearInterval(N),N=setInterval(K,60),document.addEventListener(mobileDebug?"mouseup":"touchend",Y),addClass(t.getOb("epubContent"),"defaultCursor"),A="anchorDragged",e.stopPropagation()}),e.addMarker({id:n+"Marker",elem:o,offsetTop:-45,offsetLeft:-10,target:function(){var e,t=0;if("anchor1"==n){if(!(e=g))return void(this.offsetLeft=-10);try{o="rtl"==getComputedStyle(e).direction}catch(e){}t=I?o?0:p(e):o?p(e):0}else{if(!(e=h))return void(this.offsetLeft=-10);var o;try{o="rtl"==getComputedStyle(e).direction}catch(e){}t=I?o?p(e):0:o?0:p(e)}return this.offsetLeft=-10+t,e}}),o},$.createNoteMarker=function(n,o,r){if(r||(r={}),!document.getElementById("note"+n.nid)){var i=document.createElement("span");return i.setAttribute("id","note"+n.nid),addClass(i,r.class?r.class:"contentNoteMarker"),t.getOb("epubMeta").appendChild(i),e.addMarker({id:"noteMarker"+n.nid,elem:i,offsetTop:-17,target:function(){return hasClass(this.elem,"contentNoteMarker")?this.offsetLeft=p(o)-13:this.offsetLeft=0,o},callback:n.callback}),i}},$.deleteBookMarker=function(t){var n=document.getElementById("bookmark"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("bookMarker"+t)},$.createBookMarker=function(n,o){var r=document.createElement("span");return r.setAttribute("id","bookmark"+n.bmid),addClass(r,"contentBookMarker"),t.getOb("epubMeta").appendChild(r),e.addMarker({id:"bookMarker"+n.bmid,elem:r,offsetLeft:0,offsetTop:-10,target:function(){return o},callback:n.callback}),r},$.embedAnchorMarker=function(e){};var W=function(e){B=e,e.stopPropagation()},K=function(e){try{if(e&&e.stopPropagation(),mobile){if("anchorDragged"!=A)return;if(!B)return}var n;if(mobile){var o=mobileDebug?B:B.targetTouches[0];n=document.elementFromPoint(o.clientX,Math.round(o.clientY+f.offsetHeight/2))}else n=e.target;if(t.getOb("epubContent")==n)return;if(!t.getOb("epubContent").contains(n))return;if((n.textContent.match(new RegExp(" ","g"))||[]).length>1)return;if(mobile)if("anchor1"==E.getAttribute("anchor")){if(g==n)return;g=n}else{if(h==n)return;h=n}else h=n;z(),q(),redrawForChrome(g.parentElement),redrawForChrome(h.parentElement),mobile&&P()}catch(e){}},Y=function(e){try{var n=t.getOb("epubContainer");document.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",Y),mobile?(document.removeEventListener(mobileDebug?"mousemove":"touchmove",W),removeClass(E,"selected"),clearInterval(N)):n.removeEventListener("mousemove",K),removeClass(t.getOb("epubContent"),"defaultCursor"),E=null,S=F(),A="selectionFixed",$.listener&&$.listener(A),e.stopPropagation()}catch(e){}},J=function(e){try{var n=t.getOb("epubContainer");g=h=e,mobile?(removeClass(f,"disable"),removeClass(m,"disable"),timeOut(function(){addClass(f,"tween"),addClass(m,"tween")},100),P()):(n.addEventListener("mousemove",K),document.addEventListener("mouseup",Y)),F(),A="activated",$.listener&&$.listener(A)}catch(e){}};return $.active=function(){return"selectionFixed"==A||"activated"==A},$}]),app.factory("settings",["$http","error","book","cache","modals","$ionicScrollDelegate","translit","$timeout","virt","selection","stg","markers","sync","crdv","cssParser",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,m){var g={};return g.pinchActive=!1,g.stylesInitialize=function(){},g.initialize=function(){g.stylingChanged(),g.lineAdjustChanged(),g.updateTextSize(),u.refreshMarkers()},g.getTextSize=function(){return Number(d.data.settings.textSize.slice(0,-2))},g.updateTextSize=function(){try{var e=o.getOb("epubContent"),t=o.getOb("epubContent").style;if(t.fontSize==d.data.settings.textSize)return;t.fontSize=d.data.settings.textSize;var n,r=o.getOb("epubContainer"),a=e.parentNode.parentNode,s=a.style.webkitTransform||a.style.mozTransform||a.style.transform;n=overflowScroll?o.getOb("epubContainer").scrollTop:Number(s.split(",")[1].slice(0,-2));var l=e.offsetHeight,u=r.offsetTop,p=r.offsetHeight;l+n<p+u?c.safeScroll("content",0,u+l-p,!0):l<p&&i.$getByHandle("content").scrollTop(!1),c.reset()}catch(e){}},g.writeTextSize=function(){d.writeSlot("settings"+d.getBookId(!0),d.data.settings,function(){u.refreshMarkers()})},g.stylingChanged=function(){d.data.settings.styling?m.showStyles():m.hideStyles(),u.refreshMarkers()},g.saveSettings=function(){d.writeSlot("settings"+d.getBookId(!0),d.data.settings)},g.langChanged=function(){"ar"==d.data.settings.language?d.data.settings.rtl=!0:d.data.settings.rtl=!1,d.writeSlot("settings"+d.getBookId(!0),d.data.settings,function(){a.setLang(d.data.settings.language),u.refreshMarkers()})},g.lineAdjustChanged=function(){d.data.settings.lineAdjust?addClass(o.getOb("epubContent"),"adjustedLineHeight"):removeClass(o.getOb("epubContent"),"adjustedLineHeight"),u.refreshMarkers()},g.sync=function(){p.onOnline(function(){native?f.toast(a.get("syncComplete")):r.show({mode:"success",successOptions:{msg:a.get("syncComplete")}})})},g}]),app.factory("status",["$ionicLoading","translit","$q",function(e,t,n){function o(){i&&(clearTimeout(i),i=null)}function r(){o(),s&&(i=setTimeout(function(){a.update().then(function(){a.showAndHide(t.get("statusTimeoutError"),3e3)})},s))}var i,a={},s=1e4;return a.update=function(t,i,c){var l=n.defer();if(c||(c={}),c.dots&&(t+=' <ion-spinner icon="dots" class="loadingSpinner"></ion-spinner>'),c.progress&&(t+='<div class="loadingProgress"></div>'),s=c.timeoutDuration?c.timeoutDuration:1e4,o(),t){r();var d={template:t};for(var u in c)d[u]=c[u];e.show(d),a.updateProgress()}else e.hide();return timeOut(function(){l.resolve()},i||250),l.promise},a.updateProgress=function(e){e||(e=0),e>1&&(e=1);var t=document.getElementsByClassName("loadingProgress");t.length&&(t[0].style.width=Math.round(100*e)+"%"),e>0&&r()},a.showAndHide=function(e,t){a.update(e,t).then(function(){a.update()})},a}]),app.factory("stg",["sync","$rootScope",function(e,t){var n={};return n.data={},n.view={},n.initialize=function(){t.data=n.data,t.view=n.view,n.reset(),n.setLanguages(),preview&&n.clearSlots()},n.initializeSettings=function(e){function t(){n.applyDefaultSettings();try{if(config.defaultLanguage&&(n.data.settings.language=config.defaultLanguage),n.data.settings.navAnim=config.defaultNavAnim?config.defaultNavAnim:"navBookBlock",n.data.settings.navMode=config.defaultNavMode?config.defaultNavMode:"v",!preview)return void n.readSlot("settings"+n.getBookId(!0),function(t){t&&(t.language&&(n.data.settings.language=t.language),t.navAnim&&(n.data.settings.navAnim=t.navAnim),t.navMode&&(n.data.settings.navMode=t.navMode)),e&&e()})}catch(e){}e&&e()}try{n.readSlot("settings"+n.getBookId(!0),function(e){n.data.settings=e,0==n.data.settings.length&&(n.data.settings={}),t()})}catch(e){n.data.settings={},t()}},n.reset=function(){n.resetBook(),n.resetLibrary()},n.setLanguages=function(){n.data.languages=[{label:"English",val:"en"},{label:"Franais",val:"fr"},{label:"Espaol",val:"es"},{label:"Portugus",val:"pt"},{label:"Nederlands",val:"nl"},{label:"Deutsch",val:"de"},{label:"Magyar",val:"hu"},{label:"Italiano",val:"it"},{label:"Svenska",val:"sw"},{label:"Melayu",val:"ms"},{label:"Norsk",val:"no"},{label:"Polski",val:"pl"},{label:"Romn",val:"ro"},{label:"P",val:"ru"},{label:"Trke",val:"tr"},{label:"",val:"ar"},{label:"",val:"zh"},{label:"",val:"jp"},{label:"",val:"ko"}]},n.resetBook=function(){n.data.epub={},n.data.toc="",n.data.mediaList=[],n.data.packageURL="",n.data.book={},n.data.book.chapter={},n.data.chromeAssets=[]},n.resetLibrary=function(){n.data.downloaded=[],n.data.favorites=[],n.data.currentLibrary={}},n.applyDefaultSettings=function(){n.data.settings&&(n.data.settings.styling||(n.data.settings.styling=!0),n.data.settings.textSize||(n.data.settings.textSize="1em"),n.data.settings.lineAdjust||(n.data.settings.lineAdjust=!0),n.data.settings.language||(n.data.settings.language="en"))},n.getBookId=function(e){if(!config.kotobee.cloudid){var t,o="",r="";try{t=n.data.book.meta.dc.identifier}catch(e){}if(desktop){var i=require("nw.gui");r=t||i.App.manifest.name+(i.App.manifest.rand?i.App.manifest.rand:"")}else if(native)r=t||(cordova.rand?cordova.rand:"");else{r=(r=(r=(r=location.href.split("#")[0]).replace("https://","http://")).replace("http://www.","http://")).replace("http://","");try{o=e?"":t||n.data.book.meta.dc.title}catch(e){}}return"_"+(r+o).replace(/[\/\s:#]/g,"")}return"book"==config.kotobee.mode?"_"+config.kotobee.cloudid:"library"==config.kotobee.mode?"_"+config.kotobee.cloudid+"_"+(e?"":n.data.book.id):void 0},n.addBookmark=function(t,o){n.readSlot("bookmark"+n.getBookId(),function(r){function i(r){r&&(a=r),t.chapter=currentIndex,t.cloudid=config.kotobee.cloudid,a.push(t),n.writeSlot("bookmark"+n.getBookId(),a,function(){return e.queue("bookmark/add",t),o&&o(!0),!0})}var a=r;null!=t.bmid?n.deleteBookmark(t.bmid,null,i):n.uniqueId(a,"bmid",function(e){t.bmid=e,i()})})},n.getBookmarks=function(e){n.readSlot("bookmark"+n.getBookId(),function(t){e&&e(t)})},n.deleteBookmark=function(t,o,r){n.readSlot("bookmark"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].bmid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("bookmark"+n.getBookId(),i,function(){o||e.queue("bookmark/delete",s),r&&r(i)})}})},n.deleteNote=function(t,o,r){n.readSlot("note"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].nid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("note"+n.getBookId(),i,function(){o||e.queue("note/delete",s),r&&r(i)})}})},n.addNote=function(t,o){try{n.readSlot("note"+n.getBookId(),function(r){function i(i){i&&(r=i),t.chapter=currentIndex,t.cloudid=config.kotobee.cloudid;var a={};for(var s in t)"event"!=s&&(a[s]=t[s]);r.push(a),n.writeSlot("note"+n.getBookId(),r,function(){return e.queue("note/add",a),o&&o(!0),!0})}null!=t.nid?n.deleteNote(t.nid,null,i):n.uniqueId(r,"nid",function(e){t.nid=e,i()})})}catch(e){}return!0},n.getNotes=function(e){n.readSlot("note"+n.getBookId(),e)},n.deleteHlight=function(t,o,r){n.readSlot("hlight"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].hid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("hlight"+n.getBookId(),i,function(){o||e.queue("hlight/delete",s),r&&r(i)})}})},n.addHlight=function(t,o){n.readSlot("hlight"+n.getBookId(),function(r){function i(i){i&&(r=i),t.chapter=currentIndex,t.cloudid=config.kotobee.cloudid,r.push(t),n.writeSlot("hlight"+n.getBookId(),r,function(){return e.queue("hlight/add",t),o&&o(!0),!0})}null!=t.hid?n.deleteHlight(t.hid,null,i):n.uniqueId(r,"hid",function(e){t.hid=e,i()})})},n.getHlightById=function(e,t){n.getHlights(function(n){for(var o=0;o<n.length;o++)if(n[o].hid==e)return t&&t(n[o]),n[o]})},n.getHlights=function(e){n.readSlot("hlight"+n.getBookId(),e)},n.addAction=function(e,t){n.readSlot("actions"+n.getBookId(),function(o){o.push(e),n.writeSlot("actions"+n.getBookId(),o,function(){return t&&t(!0),!0})})},n.deleteAction=function(e,t){n.readSlot("actions"+n.getBookId(),function(o){for(var r=0;r<o.length;r++)if(JSON.stringify(e)==JSON.stringify(o[r]))return o.splice(r,1),void n.writeSlot("actions"+n.getBookId(),o,function(){return t&&t(o),o});t&&t()})},n.getActions=function(e){n.readSlot("actions"+n.getBookId(),e)},n.readSlot=function(e,t){function n(){if(!(o=localStorage[e]))return t&&t([]),[];var n=JSON.parse(o);return t&&t(n),n}var o;if(chromeApp)chrome.storage.local.get(e,function(n){n=n?isEmpty(n)?[]:n[e]:[],t&&t(n)});else if(native)try{NativeStorage.getItem(e,function(e){e||t([]);var n=JSON.parse(e);t&&t(n)},function(){t&&t([])})}catch(e){n()}else n()},n.writeSlot=function(e,t,n){function o(){localStorage[e]=JSON.stringify(t),n&&n()}if(chromeApp){var r={};r[e]=t,chrome.storage.local.set(r,function(){n&&n()})}else if(native)try{NativeStorage.setItem(e,JSON.stringify(t),function(){n&&n()},function(e){o()})}catch(e){o()}else o()},n.clearSlot=function(e,t){function n(){delete localStorage[e],t&&t()}if(chromeApp)chrome.storage.local.remove(e,function(){t&&t()});else if(native)try{NativeStorage.remove(e,function(){t&&t()},function(){n()})}catch(e){}else n()},n.clearSlots=function(e){function t(){function t(){if(++i>=o.length)e&&e();else{var r=o[i];0==r.indexOf("note_")?n.clearSlot(r,t):0==r.indexOf("bookmark_")?n.clearSlot(r,t):0==r.indexOf("hlight_")?n.clearSlot(r,t):0==r.indexOf("settings_")&&n.clearSlot(r,t)}}var o=[];for(var r in localStorage)o.push(r);var i=-1;t()}if(chromeApp)chrome.storage.local.clear(e);else if(native)try{NativeStorage.clear(e,function(){t()})}catch(e){}else t()},n.copyLocalToNativeStorage=function(){if(native)try{for(var e in localStorage)NativeStorage.setItem(e,localStorage[e]),delete localStorage[e]}catch(e){}},n.uniqueId=function(e,t,o){var r=0;t||(t="id");for(var i=0;i<e.length;i++)Number(e[i][t])>r&&(r=Number(e[i][t]));n.readSlot("actions"+n.getBookId(),function(e){for(var n=0;n<e.length;n++)Number(e[n].data[t])>r&&(r=Number(e[n].data[t]));return o&&o(r+1),r+1})},n}]),app.factory("sync",["$injector","translit","$rootScope","$http","error",function(e,t,n,o,r){function i(){n.data.syncing||(n.data.syncing=!0,n.$$phase||n.$apply())}function a(){n.data.syncing&&(n.data.syncing=!1,n.$$phase||n.$apply())}var s,c,l,d,u,p,f,m={};return m.initialize=function(){config.kotobee.cloudid&&(c||(c=e.get("stg")),l||(l=e.get("bookmarks")),d||(d=e.get("notes")),u||(u=e.get("hlights")),p||(p=e.get("chapters")),c.getActions(function(e){s=e,window.addEventListener?(window.addEventListener("offline",m.onOffline,!1),window.addEventListener("online",m.onOnline,!1)):(document.addEventListener("offline",m.onOffline,!1),document.addEventListener("online",m.onOnline,!1))}))},m.trigger=function(){m.offline()?m.onOffline():m.onOnline()},m.offline=function(){if(e.get("backend").cloudParam("sync"))try{return"NONE"==navigator.network.connection.type.toUpperCase()&&"UNKNOWN"==navigator.network.connection.type.toUpperCase()}catch(e){return!1}},m.onOffline=function(){e.get("backend").cloudParam("sync")},m.onOnline=function(t){e.get("backend").cloudParam("sync")&&(f||m.applyChanges(function(){i();arguments.callee;var s=getFormData(e.get("backend").getAuthVars());o.post(config.kotobee.liburl+"library/notebook/all",s,postOptions).success(function(e){if(a(),e.error)return r.update(e),void(t&&t());var n=e.notes?e.notes:[],o=e.bookmarks?e.bookmarks:[],i=e.hlights?e.hlights:[];d.deleteAll(!0,function(){d.addNotesFromSync(n,function(){l.deleteAll(!0,function(){l.addBookmarksFromSync(o,function(){u.deleteAll(!0,function(){u.addHlightsFromSync(i,function(){t&&t()})})})})})})}).error(function(e){n.data.syncing=!1,r.update({error:"cantLoadNodes"}),t&&t()})}))},m.queue=function(e,t){if(c&&config.kotobee.cloudid&&!config.kotobee.public){var n={type:e,data:clone(t)};s.push(n),c.addAction(n,function(){m.offline()||f||m.applyChanges()})}},m.applyChanges=function(t){if(a(),e.get("backend").cloudParam("sync")&&c&&c.data.user&&(c.data.user.email||c.data.user.code))try{var n={func:arguments.callee,args:arguments};if(0==s.length)return f=!1,void(t&&t());i(),f=!0;var l=s[0],d=getFormData(e.get("backend").getAuthVars());for(var u in l.data)d.append(u,l.data[u]);o.post(config.kotobee.liburl+"library/"+l.type,d,postOptions).success(function(e){s.splice(0,1),c.deleteAction(l,function(){m.applyChanges()})}).error(function(e){f=!1,setTimeout(a,300),r.update({error:"syncOnConnectionMsg",ref:n})})}catch(e){}},m}]),app.factory("tinCan",["stg","backend",function(e,t){function n(t){try{if(!config.gAnalyticsID)return;if(!ga)return}catch(e){return}ga("send","event",t.activity,t.verb,e.data.book.meta.dc.title)}var o={};return o.initialize=function(){},o.send=function(o){n(o),t.cloudParam("tincan")&&(o.name=e.data.user.name?e.data.user.name:"User",e.data.user.email?o.email=e.data.user.email:e.data.user.code&&(o.email=e.data.user.code+"@promocode"),o.lrs=t.cloudParam("tincanlrs"),o.lrsver=t.cloudParam("tincanlrsver"),o.lrsuser=t.cloudParam("tincanlrsuser"),o.lrspwd=t.cloudParam("tincanlrspwd"),t.tincan(o))},o}]),app.factory("translit",["$interpolate","$http","$injector","$rootScope","cache",function(e,t,n,o,r){function i(){for(var e=0;e<d.length;e++)d[e](a)}var a,s,c={},l={},d=[];return c.addListener=function(e){d.push(e)},c.setLangOld=function(e){a=e},c.setLang=function(e,t){n.get("backend").getServerLang({lang:e}).success(function(n){s=n,a=e,o.data&&(o.data.lc||(o.data.lc=0),o.data.lc=Number(o.data.lc)+1),i(),r.getOb("viewContainer")||r.setOb("viewContainer",document.getElementsByClassName("view-container")[0]),"ar"==e?(r.getOb("body")&&addClass(r.getOb("body"),"rtl"),r.getOb("viewContainer")&&r.getOb("viewContainer").setAttribute("dir","rtl")):(r.getOb("body")&&removeClass(r.getOb("body"),"rtl"),r.getOb("viewContainer")&&r.getOb("viewContainer").setAttribute("dir","ltr")),t&&t()}).error(function(e,t){})},c.getLang=function(){return a},c.get=function(t,n){if(!s)return t;if(!a)return t;if(s[t]&&(t=s[t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},c.getOld=function(t,n){if(l[a][t]&&(t=l[a][t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},c}]),app.factory("view",["stg",function(e){var t={};return t.generate=function(){var t=e.data.currentLibrary,n=e.data.currentLibrary.cloud,o=e.view;o.registration={},o.registration.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.inregistration,o.topmenu={},o.topmenu.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.intopmenu,o.topmenu={},o.topmenu.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.intopmenu,o.bookinfo={},o.bookinfo.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.inbookinfo},t}]),app.factory("virt",["$ionicScrollDelegate","$filter","$location","cache","$q",function(e,t,n,o,r){var i,a,s,c,l={};l.lock=function(){a=!0},l.unlock=function(){a=!1},l.enable=function(){i||a||(i=!0,c&&clearInterval(c),s=setInterval(d,60),d())},l.disableAfter=function(e){c&&clearInterval(c),c=setInterval(function(){l.disable(),clearInterval(c)},e)},l.disable=function(){i&&(a||(i=!1,clearInterval(s)))};var d=function(){a||t("contentVirt")()};return l.reset=function(e){a||(l.reveal(!0),t("contentVirt")("reset"),t("contentVirt")(null,e),l.reveal(!1))},l.checkIfRequiresParse=function(e){parseSecsSeparate&&(hasClass(e,"parsed")||t("contentVirt")("parse",e))},l.checkIfRequiresParseAndAnnotations=function(e){hasClass(e,"parsed")||t("contentVirt")("parseAndAnnotations",e)},l.reveal=function(e){a||t("contentVirt")(e?"reveal":"undoReveal")},l.safeAnchorScroll=function(e,t,n){if(!a){var o=r.defer();l.reveal(!0);var i=document.getElementById(t);return l.safeScrollToElem(e,i,n),timeOut(function(){l.reset(),o.resolve()},1300),o.promise}},l.safeScroll=function(t,n,o,i){if(!a){var s=r.defer();return i||(i=!0),l.reveal(!0),e.$getByHandle(t).scrollTo(Math.round(n),Math.round(o),i),timeOut(function(){l.reset(),s.resolve()},1300),s.promise}},l.safeScrollToElem=function(t,n,r){if(n&&!a){l.reveal(!0);var i=o.getOb("epubContainer"),s=0,c=getComputedStyle(i).paddingTop;c&&(s=Number(c.split("px")[0]));var d=e.$getByHandle(t).getScrollPosition().top-(i.getBoundingClientRect().top+s)-25;return l.safeScroll(t,0,n.getBoundingClientRect().top+d,r)}},l.forceRepaint=function(){var e=document.createTextNode(" ");document.appendChild(),setTimeout(function(){e.parentNode.removeChild(e)},0)},l}]),app.factory("bookmarks",["selection","translit","crdv","popovers","stg","cache","modals","virt","chapters",function(e,t,n,o,r,i,a,s,c){function l(e,t){r.readSlot("bookmark"+r.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(c.busy||arrayContainsProperty(n,"bmid",e.bmid)||d.addIcon(e)),n.push(e),r.writeSlot("bookmark"+r.getBookId(),n,t)})}var d={};return d.addBookmark=function(){var o={};o.chapter=currentIndex,o.location=e.getTopCornerLocation(),r.addBookmark(o,function(){d.addIcon(o),n.toast(t.get("bookmarked"))})},d.addBookmarksFromSync=function(e,t){function n(){++o>=e.length?t&&t():l(e[o],n)}var o=-1;n()},d.addIconIfNotShown=function(e){d.addIcon(e)},d.addIcon=function(n){var r=e.getElemsByLocation(n.location);if(r[0]){var i=e.createBookMarker(n,r[0]);if(i.className="contentBookMarker",i.setAttribute("bmid",n.bmid),i.setAttribute("bloc",r[0].offsetTop),i.addEventListener("click",function(e){s.safeScrollToElem("content",i,!0);var t={};t.bmid=this.getAttribute("bmid"),t.location=this.getAttribute("bloc")}),i.addEventListener("hold",function(e){var r=[{name:t.get("delete"),func:function(){d.delete(n.bmid),o.hide()}},{name:t.get("cancel"),func:function(){o.hide()}}];o.show({mode:"list",listOb:r,backdropClickToClose:!1})}),!mobile){var c=document.createElement("span");c.className="editIcon icon ion-ios-close",c.addEventListener("click",function(e){var t={title:"confirmation",msg:"bookmarkDeleteConfirm",barStyle:"bar-dark"},o={label:"delete",style:"button-assertive"};o.func=function(){d.delete(n.bmid),a.hide()};var r={label:"cancel"};r.func=function(){a.hide()},t.btns=[o,r],a.show({mode:"confirm",confirmOptions:t})}),i.appendChild(c),i.addEventListener("mouseover",function(e){addClass(i,"edit"),i.addEventListener("mouseout",function(e){removeClass(i,"edit")})})}}},d.delete=function(t,n,o){e.deleteBookMarker(t),r.deleteBookmark(t,n,o)},d.deleteAll=function(e,t){r.getBookmarks(function(n){function o(){++r>=n.length?t&&t():d.delete(n[r].bmid,e,o)}var r=-1;o()})},d}]),app.factory("hlights",["selection","crdv","backend","stg","$rootScope","modals","chapters",function(e,t,n,o,r,i,a){function s(e,t){o.readSlot("hlight"+o.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(a.busy||arrayContainsProperty(n,"hid",e.hid)||c.addHlight(e)),n.push(e),o.writeSlot("hlight"+o.getBookId(),n,t)})}var c={};return c.addHlightsFromSync=function(e,t){function n(){++o>=e.length?t&&t():s(e[o],n)}var o=-1;n()},c.addHlight=function(t){for(var n=document.getElementsByClassName("hlight"+t.hid),o=n.length;o--;)n[o].style.backgroundColor=null,removeClass(n[o],"contentHlightBG"),removeClass(n[o],"hlight"+t.hid);for(o=(n=e.getElemsByLocation(t.location)).length;o--;)n[o]&&(addClass(n[o],"contentHlightBG"),addClass(n[o],"hlight"+t.hid),n[o].style.backgroundColor=t.color);return c},c.showPopup=function(t,n){r.$new(!0).hlightOb={},t||(t={});var a={};a.save=function(r){t.chapter||(t.chapter=currentIndex),t.color=r,t.src=e.getSelectedText(),o.addHlight(t,function(){c.addHlight(t),timeOut(function(){i.hide(),n&&n(!0)},300)})},a.color=t.color?t.color:"#fffb85",t.hid&&(a.delete=function(){c.delete(t.hid,null,function(){timeOut(function(){i.hide(),n&&n()},300)})}),i.show({mode:"hlight",hlightOptions:a})},c.delete=function(e,t,n){for(var r=document.getElementsByClassName("hlight"+e),i=r.length;i--;)i==r.length-1&&removeClass(r[i],"last"),removeClass(r[i],"contentHlightBG"),r[i].style.backgroundColor=null,removeClass(r[i],"hlight"+e);o.deleteHlight(e,t,n)},c.deleteAll=function(e,t){o.getHlights(function(n){function o(){++r>=n.length?t&&t():c.delete(n[r].hid,e,o)}var r=-1;o()})},c}]),app.factory("notes",["selection","translit","crdv","stg","$rootScope","cache","modals","popovers","virt","$timeout","chapters",function(e,t,n,o,r,i,a,s,c,l,d){function u(e){for(var t=e.split(" "),n=0;n<t.length;n++)if(t[n]&&0==t[n].trim().indexOf("note"))return t[n].trim().substr(4)}function p(e,t){o.readSlot("note"+o.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(d.busy||arrayContainsProperty(n,"nid",e.nid)||f.addIcon(e)),n.push(e),o.writeSlot("note"+o.getBookId(),n,t)})}var f={};return f.addNotesFromSync=function(e,t){function n(){++o>=e.length?t&&t():p(e[o],n)}var o=-1;n()},f.addNotesFromQuestions=function(t,n){function r(e){e>=s.length?i(0):o.addNote(s[e].ob,function(){addClass(s[e].elem,"note"+s[e].ob.nid),r(++e)})}function i(e){e>=c.length?n&&n():o.deleteNote(c[e].nid,null,function(){removeClass(c[e].elem,"note"+c[e].nid),i(++e)})}for(var a=t.elem.getElementsByClassName("ques"),s=[],c=[],l=0;l<a.length;l++)for(var d=a[l],p=d.getElementsByTagName("p")[0].textContent,f=d.getElementsByClassName("ans"),m=0;m<f.length;m++){var g=f[m],h=g.className;h=h.split(" ");var v;"radio"==g.type?v="mcq":"checkbox"==g.type?v="mmcq":"text"==g.type?v="sa":"textarea"==g.type&&(v="sa");var b=u(g.className),k="";if("mcq"==v||"mmcq"==v){if(!g.checked){b&&c.push({nid:b,elem:g});continue}k=g.nextElementSibling.textContent}if("sa"==v){if(""==g.value){b&&c.push({nid:b,elem:g});continue}k=g.value}var y={};y.chapter||(y.chapter=currentIndex),y.location||(y.location=e.convertElemsToLocation([g],t.root),t.rootIndex&&(y.location=t.rootIndex+"."+y.location)),y.type||(y.type="content"),y.src||(y.src=p),y.note=k,b&&(y.nid=b),s.push({ob:y,elem:g})}r(0)},f.addIcon=function(n,r){if("page"==n.type){if(!(u=e.getElemsByLocation(n.location))[0])return;var i=e.createNoteMarker(n,u[0],{class:"contentSideNoteMarker"});if(i.setAttribute("nid",n.nid),i.setAttribute("ncontent",n.note?n.note:""),i.setAttribute("nloc",n.location),i.addEventListener("click",function(e){c.safeScrollToElem("content",i,!0);var t={};t.note=this.getAttribute("ncontent"),t.nid=this.getAttribute("nid"),t.location=this.getAttribute("nloc"),t.type="page",f.noteClicked(t)}),i.addEventListener("hold",function(r){var i=[{name:t.get("edit"),func:function(){s.hide(),f.noteClicked(n)}},{name:t.get("delete"),func:function(){o.deleteNote(n.nid,null,function(){e.deleteNoteMarker(n.nid),s.hide()})}},{name:t.get("cancel"),func:function(){s.hide()}}];s.show({mode:"list",listOb:i,backdropClickToClose:!1})}),!mobile){var d=document.createElement("span");d.className="editIcon icon ion-ios-close",d.addEventListener("click",function(t){var r={title:"confirmation",msg:"noteDeleteConfirm",barStyle:"bar-dark"},i={label:"delete",style:"button-assertive"};i.func=function(){o.deleteNote(n.nid,null,function(){e.deleteNoteMarker(n.nid)}),a.hide()};var s={label:"cancel"};s.func=function(){a.hide()},r.btns=[i,s],a.show({mode:"confirm",confirmOptions:r}),t.stopPropagation()}),i.appendChild(d),i.addEventListener("mouseover",function(e){addClass(i,"edit"),i.addEventListener("mouseout",function(e){removeClass(i,"edit")})})}}if("content"==n.type){for(var u=e.getElemsByLocation(n.location,r),p=0;p<u.length;p++)u[p]&&addClass(u[p],"note"+n.nid);if(1==u.length&&u[0]){var m=u[0].type;if("radio"==m||"checkbox"==m)return void(u[0].checked=!0);if("text"==m||"textarea"==m)return void(u[0].value=n.note)}for(p=0;p<u.length;p++)u[p]&&addClass(u[p],"contentNoteBG");var g=u[u.length-1];if(!g)return;g.setAttribute("ncontent",n.note?n.note:""),g.setAttribute("nloc",n.location),addClass(g,"last"),l(function(){try{var t=e.createNoteMarker(n,g);t&&(t.onclick=function(e){var t=this.getAttribute("id"),n=document.getElementsByClassName(t),o=n[n.length-1],r=(o.getAttribute("ncontent"),{});r.note=o.getAttribute("ncontent"),r.location=o.getAttribute("nloc"),r.nid=t.substr(4),r.type="content",r.src=o.textContent,f.noteClicked(r),e.stopPropagation(),e.preventDefault()})}catch(e){}})}},f.noteClicked=function(t,n){try{t||(t={});var r={};r.save=function(r){t.chapter||(t.chapter=currentIndex),t.location||(t.location=e.getTopCornerLocation()),t.type||(t.type="page"),t.src||(t.src="content"==t.type?e.getSelectedText():"");var i=null==t.nid;t.note=r,o.addNote(t,function(){if(i)f.addIcon(t);else{e.getNoteMarker(t.nid).elem.setAttribute("ncontent",t.note);var o=e.getElemsByLocation(t.location),r=o[o.length-1];r&&r.setAttribute("ncontent",t.note)}l(function(){a.hide(),n&&n(!0)},300)})},t.nid&&(r.delete=function(){f.delete(t.nid,null,function(){l(function(){a.hide(),n&&n()},300)})}),t.note&&(r.note=t.note),a.show({mode:"note",dynamic:!0,animation:"slide-in-up",noteOptions:r,event:t.event})}catch(e){}},f.delete=function(t,n,r){e.deleteNoteMarker(t);for(var i=document.getElementsByClassName("note"+t),a=i.length;a--;)a==i.length-1&&(removeClass(i[a],"last"),i[a].removeAttribute("nloc"),i[a].removeAttribute("ncontent")),removeClass(i[a],"contentNoteBG"),removeClass(i[a],"note"+t);o.deleteNote(t,n,r)},f.deleteAll=function(e,t){o.getNotes(function(n){function o(){++r>=n.length?t&&t():f.delete(n[r].nid,e,o)}var r=-1;o()})},f}]);