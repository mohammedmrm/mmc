bwdefine("HotspotImage",["config","BWAUDIO","BWYT","bw/draggable","bw/widget","bw/images","jquery","bw/uriEncodeImage","bw/adaptToPageProtocol","bw/popuphelper","bw/openWidget","studentaccount","studentaccountbutton","bw/ProgressLogger","bw/tr"],function(e,t,o,i,n,s,a,r,p,c,l,d,h,g,u){"use strict";return a(function(){function f(){a(".popup").addClass("hidden"),a("video").each(function(){this.pause()})}function v(e,o,i){console.log("Creating audio: "+e);var n=t.addElement(e,i);o.tapOrClick(function(){k.registerAccess(a(this).attr("id")),n.paused()===!0?n.play():n.pause()})}function w(e){return console.log("checking link"),e.indexOf("bookwidgets.com/play/")!==-1}function m(e,t){t.tapOrClick(function(){if(w(e)){var t=e.indexOf("?")===-1?"?":"&";e+=t+"noiframe=1",l(e)}else window.location.href=e})}function b(e){e.find("a").filter(function(){return w(a(this).attr("href"))}).replaceWith(function(){console.log("make link widget play link");var e=a(this),t=e.attr("href"),o=t.indexOf("?")===-1?"?":"&";return t+=o+"noiframe=1",a(document.createElement("div")).attr("onclick","OpenWidgetLink('"+t+"'); return false;").html(e.html())})}n.makeWidget({"no-user-select":!0});var y=g(),k=y.registerSet("hotspots",u("Hotspots accessed"),u("Hotspot accesses"),e.hotspots.length);void 0===e.support_student_account&&alert("Incorrect schema.xml, must include studentaccountconfig.xml if widget depends on widgetstorage.js"),d.isStudentAccountsSupported()&&h.init(),console.log("running config");var x;a("#container").css("background","black url("+r(e.background_picture)+") no-repeat center center"),"Cover entire area, keep aspect ratio"===e["resize-policy"]?a("#container").css("background-size","cover"):"Contain entire picture, keep aspect ratio"===e["resize-policy"]?a("#container").css("background-size","contain"):"Cover entire area with entire picture"===e["resize-policy"]&&a("#container").css("background-size","100% 100%"),a('<div id="hotspots"></div>').appendTo(a("#container")),a('<div id="popups"></div>').appendTo(a("#container"));for(var T=0;T<e.hotspots.length;++T){var z,C=e.hotspots[T],_="popup_"+T,P="hotspot_"+T,W=a('<div class="hotspot" id="'+P+'" popupid="'+_+'" type="'+C.Type+'"></div>').appendTo(a("#hotspots"));"image"===C["marker-type"]?(W.addClass("image"),z=a('<div class="content"><img src="'+r(C["marker-image"])+'"></img></div>').appendTo(W)):"label"===C["marker-type"]?(W.addClass("label"),z=a('<div class="content">'+C["marker-label"]+"</div>").appendTo(W)):(W.addClass("none"),z=W);var I=a('<div id="'+_+'" hotspotid="'+P+'" class="popup hidden" ></div>').appendTo(a("#popups")),A=a('<div class="popupcontent"></div>').appendTo(I);if("TextPopup"===C.Type)A.html(C.text),o.resolveYoutubePlaceholders(A),t.processAudioTags("#"+_),b(A),s.processRichTextImages(A);else if("ImagePopup"===C.Type)A.html('<img src="'+r(C.image)+'" ></img>');else if("VideoPopup"===C.Type){var O=""!==C.width?'width="'+C.width+'" ':"",H=""!==C.height?'height="'+C.height+'" ':"",Y='<video id="video'+T+' " controls preload="auto" '+O+H+'poster="" data-setup=\'{"example_option":true}\'><source src="'+C.video+"\" type='video/mp4' /></video>";A.html(Y)}else if("WebPopup"===C.Type){var O=""!==C.width?'width="'+C.width+'" ':"",H=""!==C.height?'height="'+C.height+'" ':"";A.html('<div class="webpopup" '+O+H+'"><iframe src="'+p(C.url)+'" '+O+H+"></iframe></div>")}else"AudioPopup"===C.Type?v(C.audiofile,z,A):"WebLink"===C.Type?m(C.url,z,A):console.log("Unknown hotspot type: "+C.Type);I.css({left:C.position.X+"px",top:C.position.Y+"px"}),"AudioPopup"!==C.Type&&"WebLink"!==C.Type&&z.tapOrClick(function(e){e.stopPropagation(),k.registerAccess(a(this).attr("id"));var t=this;f(),setTimeout(function(){var e=25,o=a("body").width(),i=a("body").height(),n=a("#container").width(),s=a("#container").height();n>o&&(o=n),s>i&&(i=s);var r=a("#container").position().left,p=a("#container").position().top,l=a(t);l.hasClass("hotspot")||(l=l.parent());var d,h,g,u,f=l.find(".content");f.length>0?(g=f.width(),u=f.height(),d=l.position().left,h=l.position().top):(g=l.width(),u=l.height(),d=l.position().left+g/2,h=l.position().top+u/2);var v=a("#"+l.attr("popupid"));c.positionPointerPopup(e,v,{x:l.position().left,y:l.position().top,width:g,height:u,centerx:d,centery:h},r,p,o,i)},0)})}var X,L;x=function(){function t(e){return s+e*i}function o(e){return r+e*n}console.log("Resizing...");var i,n,s,r,p=a("body").width(),c=a("body").height();if("Image draggable and resizeable"===e["resize-policy"]){var l=a("#container").width(),d=a("#container").height();console.log("container_width: "+l),console.log("container_height: "+d),s=0,r=0,i=l/X,n=d/L}else if(console.log("setting container width: "+p),console.log("setting container height: "+c),a("#container").css({width:p,height:c}),"Cover entire area, keep aspect ratio"===e["resize-policy"]){var h=p/X,g=c/L;h<g?(i=g,n=g):(i=h,n=h),s=(p-X*i)/2,r=(c-L*n)/2}else if("Contain entire picture, keep aspect ratio"===e["resize-policy"]){var h=p/X,g=c/L;h>g?(i=g,n=g):(i=h,n=h),s=(p-X*i)/2,r=(c-L*n)/2}else"Cover entire area with entire picture"===e["resize-policy"]?(s=0,r=0,i=p/X,n=c/L):(i=1,n=1,s=(p-X)/2,r=(c-L)/2);console.log("offset_x: ",s),console.log("offset_y: ",r),console.log("scale_x: ",i),console.log("scale_y: ",n);for(var u=0;u<e.hotspots.length;++u){var f=e.hotspots[u],v="#hotspot_"+u,w=a(v);"label"===f["marker-type"]||"image"===f["marker-type"]?w.css({left:t(f.point.x)+"px",top:o(f.point.y)+"px"}):w.css({left:t(f.position.X)+"px",top:o(f.position.Y)+"px",width:f.position.Width*i+"px",height:f.position.Height*n+"px"});var m=w.find(".content");m.length>0&&m.css({left:(w.width()-m.outerWidth())/2,top:(w.height()-m.outerHeight())/2})}},s.getImageSize(e.background_picture,function(t,o){if(X=t,L=o,console.log("pic_width: "+X),console.log("pic_height: "+L),"Image draggable and resizeable"===e["resize-policy"]){a("#container").css({position:"absolute",left:"0",top:"0",width:X+"px",height:L+"px","background-size":"contain"}),i.bwMakeDragAndResizable(a("#container"),a("#zoomin"),a("#zoomout"),void 0,function(){f(),x()});var n=e.position;if(""!==n.X&&""!==n.Y&&""!==n.Width&&""!==n.Height){var s=parseInt(n.X),r=parseInt(n.Y),t=parseFloat(n.Width),o=parseFloat(n.Height);if(t>0&&o>0){var p=a(window).width(),c=a(window).height();console.log("window size: "+p+" "+c);var l=p/t,d=c/o;console.log("scaleX: "+l),console.log("scaleY: "+d);var h=l<d?l:d;console.log("scale: "+h),a("#container").width(X*h),a("#container").height(L*h);var g=s+t/2,u=r+o/2;console.log("Center: "+g+" "+u);var v=p/2-g*h,w=c/2-u*h;console.log("container position: "+v+" "+w),a("#container").css("left",v),a("#container").css("top",w)}}a("#tools").removeClass("hidden")}x()}),window.onresize=x,a("#container").tapOrClick(function(e){(e.gesture&&e.gesture.target===a("#container")[0]||!e.gesture&&e.target===a("#container")[0])&&f()}),window.widget||(window.widget=[]),n.pauseAudioVisual=function(){f()}}),null}),bwdefine.finalize();