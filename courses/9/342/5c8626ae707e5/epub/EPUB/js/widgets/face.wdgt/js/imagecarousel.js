bwdefine("ImageCarousel",["config","bw/widget","bw/images","jquery","bw/dialog","bw/uriEncodeImage","bw/ProgressLogger","bw/tr","bw/InitGoogleMapsApiAndWrapper"],function(e,i,t,a,n,o,r,s,c){"use strict";a(function(){function p(){a(".popup").hide()}function d(i,t,n,o){var r=i+"_"+o,s=a('<div id="HS_'+r+'"hsnr="'+o+"\" class='hotspotimg'></div"),c='<circle cx="18" cy="18" r="10"/>';s.html('<svg class="symbol" xmlns="http://www.w3.org/2000/svg" version="1.1" width="40" height="40">'+c+"</svg>"),s.css({top:parseInt(n.y),left:parseInt(n.x)});var d;if("TextBalloon"==n.Type)d=a('<div class="popup popuptext">'+n.text+"</div>"),d.hide(),d.appendTo(t);else if("ImageBalloon"==n.Type){d=a('<div class="popup popupimg P_'+r+'"></div>');a('<img  src="'+n.image+'" />').appendTo(d);if(void 0!=n.imagecaption&&""!=n.imagecaption){a('<div class="imagecaption">'+n.imagecaption+"</div>").appendTo(d)}d.hide(),d.appendTo(t)}"right-to-left"==e.direction?d.css("direction","rtl"):d.css("direction","ltr"),s.appendTo(t),s.tapOrClick(function(e){var i=a("body"),t=20,n=i.width()-t,o=i.height()-a("#bar").height()-t;e.stopPropagation(),p(),a(".mainimage").addClass("dimimg"),setTimeout(function(){d.show();var e=s.position().left-d.outerWidth()/2,i=s.position().top-d.outerHeight()/2;e<t&&(e=t),e+d.width()>=n&&(e=n-d.width()),i<t&&(i=t),i+d.height()>o&&(i=o-d.height()),d.css({top:i,left:e})},0)})}function l(i,t){for(var a=e.images[i],n=0;n<a.hotspots.length;++n)d(i,t,a.hotspots[n],n)}function g(i,t,n,o,r){function s(e){return l+e*p}function c(e){return g+e*d}var p,d,l,g,m=e.images[i],v=m["resize-policy"];if("Cover entire area, keep aspect ratio"==v){var h=t/o,u=n/r;h<u?(p=u,d=u):(p=h,d=h),l=(t-o*p)/2,g=(n-r*d)/2}else if("Contain entire picture, keep aspect ratio"==v){var h=t/o,u=n/r;h>u?(p=u,d=u):(p=h,d=h),l=(t-o*p)/2,g=(n-r*d)/2}else"Cover entire area with entire picture"==v?(l=0,g=0,p=t/o,d=n/r):(p=1,d=1,l=(t-o)/2,g=(n-r)/2);for(var f=0;f<m.hotspots.length;++f){var w=m.hotspots[f],b="#HS_"+i+"_"+f,y=a(b);y.css({left:s(w.x)+"px",top:c(w.y)+"px"})}}function m(i,t){for(var a=0;a<e.images.length;++a)g(a,i,t,T[a].width,T[a].height)}function v(i,n,r,s){var c,d=e.images[i],m=d["resize-policy"],v=d.img;c="Cover entire area, keep aspect ratio"==m?"cover":"Contain entire picture, keep aspect ratio"==m?"contain":"Cover entire area with entire picture"==m?"100% 100%":"auto";var h=a('<div id="S_'+i+'" class="slide"></div>').appendTo(n),u=a('<div class="slideimg"></div>').appendTo(h);u.css({background:d.fillcolor+" url("+o(v)+") no-repeat center center","background-size":c,left:100*i+"%"}),l(i,u),t.getImageSize(v,function(e,t){g(i,r,s,e,t),T[i]={width:e,height:t}}),h.tapOrClick(p)}function h(){for(var i=a("body"),t=i.width(),n=i.height(),o=a("#slides"),r=0;r<e.images.length;++r)v(r,o,t,n)}function u(i,t,n){i!==x&&C.registerAccess(i),n=void 0!==n||400,a(".slide").removeClass("visible"),a("#S_"+x+", #S_"+i).addClass("visible");var o=e.images[i];x=i;var r=t?"easeOutQuad":"swing",s=a("#slides");s.animateTranslate(-i*a("body").width(),0,n,r,function(){a(".slide").removeClass("visible"),a("#S_"+(x-1)+", #S_"+x+", #S_"+(x+1)).addClass("visible")});var c=a("#maincaption");c.animate({opacity:0},n/2,"swing",function(){var e=o.caption;c.html(e),c.animate({opacity:1},n/2)}),0==i?a("#prevarrow").animate({opacity:0}):a("#prevarrow").animate({opacity:1}),i==e.images.length-1?a("#nextarrow").animate({opacity:0}):a("#nextarrow").animate({opacity:1});var p=""!=o.latlong;p?setTimeout(function(){a("#maplink").removeClass("hidden"),a("#maplink").animate({opacity:1})},n/2):(console.log("hiding map"),a("#maplink").animate({opacity:0},n/2,function(){a("#maplink").addClass("hidden")}))}function f(){x>0&&u(x-1)}function w(){x<e.images.length-1&&u(x+1)}function b(i){a("#map").remove(),a("#closebtn").remove();var t=a('<div id="map" class="divcontrol"></div>');t.appendTo("body");for(var n=0;n<e.images.length;n++)if(""!=e.images[n].latlong){var o={position:e.images[n].latlong,bounds:!0,title:e.images[n].mapcaption,cardindex:n};n===i&&(o.icon="img/greenmarker.png");var r=t.gmap("addMarker",o);_.push(r),n===i&&t.gmap("openInfoWindow",{content:e.images[n].mapcaption},r),r.click(function(){for(var e=0;e<_.length;e++)_[e][0].setOptions({icon:null});this.setOptions({icon:"img/greenmarker.png"}),t.gmap("openInfoWindow",{content:this.title},this),u(this.cardindex)})}var s=a("<img id = 'closebtn' src ='img/closebtn.png' />");s.appendTo("body"),s.tapOrClick(function(){_=[],a("#map").remove(),a("#closebtn").remove()})}function y(){var e=a("body").width(),i=a("body").height();m(e,i),u(x,0,0)}if(c(e.apikey,function(){a("body").removeClass("nogooglemaps")}),i.makeWidget({"no-user-select":!0}),0==e.images.length)return n.showAlert("The Image Carousel configuration is empty.<br>To configure this widget add a number of images with caption, location and hotspots.","Configuration error"),void a(".bw-button").hide();var k=r(),C=k.registerSet("images",s("Images viewed"),s("Image views"),e.images.length);"right-to-left"==e.direction?a("#maincaption").css("direction","rtl"):a("#maincaption").css("direction","ltr");var T={};h();var x=null;u(0);var I;a("#slides").hammer({transform:!1}).on("panstart",function(e){var i=a("#slides");I=i.position().left;var t=I+e.gesture.deltaX;a("#slides").setTranslate(t,0)}).on("panmove",function(e){var i=I+e.gesture.deltaX;a("#slides").setTranslate(i,0)}).on("panend",function(i){var t=I+i.gesture.deltaX;a("#slides").setTranslate(t,0);var n=x;i.gesture.deltaX>100&&--n,i.gesture.deltaX<-100&&++n,n<0&&(n=0),n>=e.images.length&&(n=e.images.length-1),u(n,i.gesture.velocityX)}),a("#prevarrow").tapOrClick(f),a("#nextarrow").tapOrClick(w),document.onkeydown=function(e){switch(e=e||window.event,e.keyCode){case 37:f();break;case 39:w()}};var _=[];a("#maplink").tapOrClick(function(){b(x)}),a(window).bind("load",y),a(window).bind("resize",y),a(window).bind("orientationchange",y)})}),bwdefine.finalize();