function kInteractionStart(){this.log=function(e){},kInteractive.setDOMParser(),kInteractive.preRender(),kInteractive.postRender()}function kInteractionStartSingleElem(e){kInteractive.setDOMParser(),kInteractive.preRender(e,{singleElem:!0}),kInteractive.postRender(e,{singleElem:!0})}var kInteractive={scormWrapper:null,preRender:function(e,t){t||(t={});var n,i=t.singleElem,a=(new DOMParser,e||document);i?(n=[e],a=document):n=a.getElementsByClassName("kInteractive");var r;"undefined"!=typeof isKotobee&&(r=t.chapterUrl?t.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var o=n.length;o--;){var s=n[o];if(this.hasClass(s,"gallery")){var c=a.createDocumentFragment(),l=kInteractive.readData(s);if(!l)continue;s.innerHTML="";var d=document.createElement("div");d.className="imgMask";var u=document.createElement("div");u.className="images "+l.scale,d.appendChild(u);for(T=0;T<l.imgs.length;T++){var m=document.createElement("div");m.className="imgContainer"+(T?"":" selected");ee="undefined"==typeof isKotobee?l.imgs[T].path:ph.join(r,l.imgs[T].path);m.setAttribute("style","background-color:"+l.bgColor+";background-image:url('"+ee+"')"+(T?"":";display:block")),l.imgs[T].caption&&m.setAttribute("data-caption",l.imgs[T].caption),u.appendChild(m)}c.appendChild(d);var p=document.createElement("div");p.className="imgCaption";var h=document.createElement("div");h.className="inner",h.style.display="none",l.imgs[0]&&l.imgs[0].caption&&(h.innerHTML=l.imgs[0].caption,h.style.display=null),p.appendChild(h),c.appendChild(p);var v=document.createElement("a");v.className="next btn ki-btn",1==l.imgs.length&&(v.className+=" disable"),c.appendChild(v);var f=document.createElement("a");f.className="prev btn ki-btn disable",c.appendChild(f),"undefined"==typeof isKotobee&&(v.addEventListener("click",this.actionEvent),f.addEventListener("click",this.actionEvent));X=document.createElement("div");l.style&&kInteractive.c.addClass(X,l.style),X.appendChild(c),s.appendChild(X)}if(this.hasClass(s,"image")||"img"==s.nodeName.toLowerCase()){var g=kInteractive.readData(s);if(!g)continue;g.style&&kInteractive.c.addClass(s,g.style)}if(this.hasClass(s,"questions")){var c=a.createDocumentFragment(),y=kInteractive.readData(s);if(!y)continue;var k=y.dict,b=y.userDict;k||(k={}),b||(b=k),y.options||(y.options={}),s.id||(s.id="ki-qs-"+o+"-"+Math.ceil(1e3*Math.random()));if(s.innerHTML="",y.layout&&y.layout.popup&&!this.hasClass(s,"inpopup")){var C=document.createElement("img"),I=y.layout.popupImg;C.src=I,c.appendChild(C),"undefined"==typeof isKotobee&&C.addEventListener("click",this.actionEvent),s.appendChild(c);continue}if(y.options.randomize){for(T=0;T<y.q.length;T++)y.q[T].origin=T;for(var E,w,N=y.q.length;0!==N;)w=Math.floor(Math.random()*N),N-=1,E=y.q[N],y.q[N]=y.q[w],y.q[w]=E}if(y.options.questionsDisplayed){var A=Number(y.options.questionsDisplayed);y.q=y.q.slice(0,A)}if(y.title){var x=document.createElement("span");x.innerHTML="<h4>"+kInteractive.escapeHtml(y.title)+"</h4>",c.appendChild(x)}for(var T=0;T<y.q.length;T++){var q=y.q[T],L=document.createElement("div");if(L.className="ques",null!=q.origin&&L.setAttribute("data-o",q.origin),L.innerHTML="<p><strong><span class='no'>"+(T+1)+"</span> "+kInteractive.escapeHtml(q.q)+"</strong></p>",q.path){var B=document.createElement("img");B.src=q.path,L.appendChild(B)}if("sa"==q.type){var H=q.lines?q.lines:1,M=document.createElement(H>1?"textarea":"input");M.name="sa-"+T,1==H?M.type="text":M.rows=q.lines?q.lines:1,M.className="ans txtfield";D="ki-sa-"+o+"-"+T;M.id=D,document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[T]&&(M.value=document[s.id].q[T]),L.appendChild(M)}else if("mcq"==q.type||"mmcq"==q.type)for(var S=q.c,O=0;O<S.length;O++){var D="ki-mcq-"+o+"-"+T+"-"+O,R=document.createElement("input");"mmcq"==q.type?(R.name="name",R.type="checkbox"):(R.name="mcq-"+T,R.type="radio"),R.className="ans",R.id=D,(Y=document.createElement("label")).htmlFor=D,Y.innerHTML=" "+kInteractive.escapeHtml(S[O].t)+"<br/>",Y.className="ki-noHighlight",(P=document.createElement("div")).className="answer",document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[T]&&(R.checked=document[s.id].q[T][O],y.options&&y.options.highlightCorrect&&y.q[T].c[O].a&&kInteractive.c.addClass(P,"correct")),P.appendChild(R),P.appendChild(Y),L.appendChild(P)}else if("tf"==q.type)for(O=0;O<2;O++){var D="ki-tf-"+o+"-"+T+"-"+O,F=document.createElement("input");F.type="radio",F.name="tf-"+T,F.className="ans",F.id=D,(Y=document.createElement("label")).htmlFor=D,q.choice1&&q.choice2?Y.innerHTML=kInteractive.escapeHtml(" "+(0==O?q.choice1:q.choice2)):Y.innerHTML=" "+(0==O?"True":"False"),Y.className="ki-noHighlight";var P=document.createElement("div");document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[T]&&(F.checked=document[s.id].q[T][O],y.options&&y.options.highlightCorrect&&(0==O&&y.q[T].a||1==O&&!y.q[T].a)&&kInteractive.c.addClass(P,"correct")),P.appendChild(F),P.appendChild(Y),L.appendChild(P)}if((J=document.createElement("p")).className="separator",L.appendChild(J),document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[T]){if(y.q[T].exp&&!L.getElementsByClassName("explanation").length){var j=document.createElement("p");j.className="explanation",j.innerHTML=kInteractive.escapeHtml(y.q[T].exp),kInteractive.appendAfterDelay(L,j)}if(y.q[T].ref&&!L.getElementsByClassName("reference").length){var z=document.createElement("a");z.className="reference",z.innerHTML=b.learnMode?b.learnMode:"Learn more",z.setAttribute("href",kInteractive.escapeHtml(y.q[T].ref)),z.setAttribute("target","_blank"),kInteractive.appendAfterDelay(L,z)}}c.appendChild(L)}if(y.options.emailForm){var K=document.createElement("div");K.setAttribute("class","emailForm"),function(e,t,n){var i=document.createElement("div");i.className="address",i.innerHTML="<p><strong>"+e+"</strong><em>"+t+"</em></p>";var a=document.createElement("input");a.name=n,a.type="text",a.className="txtfield",i.appendChild(a);var r=document.createElement("p");r.className="separator",i.appendChild(r),K.appendChild(i)}(b.recipientEmail?b.recipientEmail:"Recipient email",b.separateEmails?b.separateEmails:"Separate multiple emails with commas","recipientEmail"),c.appendChild(K)}var W=null;if("none"!=y.action){var _="ki-"+o+"-btn";(W=document.createElement("input")).type="submit",W.value=b.submit?b.submit:"Submit Answers",W.id=_,W.className="btn ki-btn ki-mcq"}var U=null,V=null;if(y.options&&(y.options.clearAnswers&&((U=document.createElement("input")).type="submit",U.value=b.clear?b.clear:"Clear Answers",U.className="btn ki-btn ki-questions questions-clear","undefined"==typeof isKotobee&&U.addEventListener("click",this.actionEvent)),y.options.addToNotebook&&((U=document.createElement("input")).type="submit",U.value=b.notebook?b.notebook:"Save to Notebook",U.className="btn ki-btn ki-questions questions-notebook","undefined"==typeof isKotobee&&U.addEventListener("click",this.actionEvent)),y.options.preserveAnswers)){(V=document.createElement("div")).style.marginTop="5px";var Q=document.createElement("input");Q.type="checkbox",Q.name="preserveAnswers",Q.className="ki-btn ki-questions questions-preserve",Q.id="ki-"+o+"-preserveAnswersBtn",document[s.id]&&(Q.checked=document[s.id].preserve),V.appendChild(Q);var Y=document.createElement("label");Y.htmlFor=Q.id,Y.innerHTML=" "+(b.preserve?b.preserve:"Preserve submitted answers"),Y.className="ki-noHighlight",V.appendChild(Y),"undefined"==typeof isKotobee&&Q.addEventListener("change",this.actionEvent)}"undefined"==typeof isKotobee&&W&&W.addEventListener("click",this.actionEvent),W&&c.appendChild(W),c.appendChild(document.createTextNode(" ")),U&&c.appendChild(U),V&&c.appendChild(V);var J=document.createElement("p");J.className="separator",c.appendChild(J),y.options.rtl?(s.style.direction="rtl",kInteractive.c.addClass(s,"rtl")):s.style.direction="ltr";var X=document.createElement("div");y.style&&kInteractive.c.addClass(X,y.style),X.appendChild(c),s.appendChild(X)}if(this.hasClass(s,"image")){if(s.parentNode&&this.hasClass(s.parentNode,"link"))continue;"undefined"==typeof isKotobee&&s.addEventListener("click",this.actionEvent)}if(this.hasClass(s,"link")){var G=kInteractive.readData(s);if(!G)continue;if("undefined"!=typeof editorMode&&editorMode)continue;if("div"==s.nodeName.toLowerCase()){var $=document.createElement("a");$.setAttribute("href","popup"==G.type?"":s.getAttribute("href")),$.setAttribute("target",G.target),$.setAttribute("style",s.getAttribute("style")),$.setAttribute("data-kotobee",s.getAttribute("data-kotobee")),$.className="kInteractive link btn",$.style.opacity=Number(G.transparency)/100,s.parentNode.replaceChild($,s),s=$}"undefined"==typeof isKotobee&&("popup"!=G.type&&"audio"!=G.type&&"action"!=G.type||s.setAttribute("onclick","return false;"),s.addEventListener("click",this.actionEvent))}if(this.hasClass(s,"container")){var Z=kInteractive.readData(s);if(!Z)continue;if(Z.path){var ee=Z.path;"undefined"!=typeof isKotobee&&(ee=ph.join(r,Z.path));var te=s.getAttribute("style");s.setAttribute("style",te+' background-image:url("'+ee+'");')}}}},clearAudioVideo:function(e){var t=e||document;kInteractive.stopCurrentMedia();for(var n=t.getElementsByTagName("audio"),i=n.length;i--;)try{if(n[i].hasAttribute("data-dontclose"))continue;n[i].pause(),n[i].children.length||(n[i].src="")}catch(e){}for(var a=t.getElementsByTagName("video"),i=a.length;i--;)a[i].pause(),a[i].children.length||(a[i].src="")},postRender:function(e,t){t||(t={});var n,i=t.singleElem;"undefined"!=typeof isKotobee&&(n=t.chapterUrl?t.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL),kInteractive.videoIsFullscreen=!1,kInteractive.timestamp=new Date,kInteractive.currentVideo=kInteractive.currentAudio=null,kInteractive.clearAudioVideo(e);var a,r=e||document;i?(a=[e],r=document):a=r.getElementsByClassName("kInteractive");for(var o=a.length;o--;){var s=a[o];if(this.hasClass(s,"container")){var c=kInteractive.readData(s);if(!c)continue;kInteractive.isMobile()&&"cScroll"==c.type&&"undefined"!=typeof isKotobee&&angular.element(document.body).scope().applyNativeScroll(s)}else if(this.hasClass(s,"questions")){var l=kInteractive.readData(s);if(!l)continue;var d=l.dict,u=l.userDict;d||(d={}),u||(u=d);for(var m=s.getElementsByClassName("ques"),p=s.getElementsByClassName("explanation"),h=p.length;h--;)p[h].parentNode.removeChild(p[h]);for(var v=s.getElementsByClassName("reference"),h=v.length;h--;)v[h].parentNode.removeChild(v[h]);for(var f=0;f<m.length;f++){var g=m[f].getElementsByClassName("ans"),y=(g.length,f);if(l.options.randomize&&(y=Number(m[f].getAttribute("data-o"))),document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[y]){if(l.q[y].exp&&!m[f].getElementsByClassName("explanation").length){var k=document.createElement("p");k.className="explanation",k.innerHTML=kInteractive.escapeHtml(l.q[y].exp),kInteractive.appendAfterDelay(m[f],k)}if(l.q[y].ref&&!m[f].getElementsByClassName("reference").length){var b=document.createElement("a");b.className="reference",b.innerHTML=u.learnMode?u.learnMode:"Learn more",b.setAttribute("href",kInteractive.escapeHtml(l.q[y].ref)),b.setAttribute("target","_blank"),kInteractive.appendAfterDelay(m[f],b)}}for(h=0;h<g.length;h++)kInteractive.c.removeClass(g[h].parentNode,"correct"),g[h].getAttribute("id").indexOf("ki-tf-")>=0?document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[y]&&(g[h].checked=document[s.id].q[y][h],l.options&&l.options.highlightCorrect&&(0==h&&l.q[y].a||1==h&&!l.q[y].a)&&kInteractive.c.addClass(g[h].parentNode,"correct")):g[h].getAttribute("id").indexOf("ki-sa-")>=0?document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[y]&&(g[h].value=document[s.id].q[y]):document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[y]&&(g[h].checked=document[s.id].q[y][h],l.options&&l.options.highlightCorrect&&l.q[y].c[h].a&&kInteractive.c.addClass(g[h].parentNode,"correct"));if(document[s.id]){var C=s.getElementsByClassName("questions-preserve");C.length&&(C[0].checked=document[s.id].preserve)}}}else if(this.hasClass(s,"widget")){var I=r.createDocumentFragment(),E=kInteractive.readData(s);if(!E)continue;var w=E.name,N=(E.src,E.width),A=E.height;if("page"==E.mode){if(s.children.length)continue;var x=document.createElement("div");x.className="cover",I.appendChild(x),E.interaction&&(x.style.pointerEvents="none");var T=document.createElement("div");T.className="iframeContainer";var q=document.createElement("iframe");q.setAttribute("nwdisable","true"),q.setAttribute("nwfaketop","true"),q.setAttribute("width",s.style.width?s.style.width:N+E.widthUnit),q.setAttribute("height",s.style.height?s.style.height:A+"px"),q.src=kInteractive.getWidgetUrl(E,t),T.appendChild(q),I.appendChild(T);var L=s.style.width,B=s.style.height;L.indexOf("px")>=0&&(E.widthUnit="px"),L.indexOf("%")>=0&&(E.widthUnit="%");try{E.widthUnit?E.width=Number(L.split(E.widthUnit)[0]):E.width=Number(L)}catch(e){E.width=Number(L)}try{E.height=Number(B.split("px")[0])}catch(e){E.height=Number(B)}kInteractive.writeData(s,E)}else{if(!s.children.length&&!s.innerHTML.trim()){var H=document.createElement("img");H.src=kInteractive.getWidgetHome(E,t)+"/"+w+"/Icon.png",H.className="wdgtIcon",I.appendChild(H)}"undefined"==typeof isKotobee&&s.addEventListener("click",this.actionEvent)}s.appendChild(I)}else if(this.hasClass(s,"video")){var I=r.createDocumentFragment(),M=kInteractive.readData(s);if(!M)continue;var S="";if(M.splash&&(S="undefined"==typeof isKotobee?M.splash:ph.join(n,M.splash)),S){s.style.backgroundImage=null;var O=s.style.cssText;s.setAttribute("style","background-image:url('"+S+"');"+O)}s.setAttribute("id","ki-video-"+o),s.innerHTML="",(R=document.createElement("div")).setAttribute("id","ki-video-"+o+"-container"),R.className="container";P=document.createElement("div");M.style&&kInteractive.c.addClass(P,M.style),(F=document.createElement("a")).className="playBtn ki-btn",F.appendChild(document.createElement("span")),"undefined"==typeof isKotobee&&F.addEventListener("click",this.actionEvent),I.appendChild(F),I.appendChild(R),P.appendChild(I),s.appendChild(P),M.autoplay&&kInteractive.action(s)}else if(this.hasClass(s,"audio")){var I=r.createDocumentFragment(),D=kInteractive.readData(s);s.setAttribute("id","ki-audio-"+o),s.innerHTML="";var R=document.createElement("div");R.setAttribute("id","ki-audio-"+o+"-container"),R.className="container";var F=document.createElement("a");F.className="playBtn ki-btn",F.appendChild(document.createElement("span")),"undefined"==typeof isKotobee&&F.addEventListener("click",this.actionEvent);var P=document.createElement("div");D.style&&kInteractive.c.addClass(P,D.style),I.appendChild(F),I.appendChild(R),P.appendChild(I),s.appendChild(P)}else if(this.hasClass(s,"threed")){var I=r.createDocumentFragment(),j=kInteractive.readData(s);if(!j)continue;s.innerHTML="";var z=s.getAttribute("style");j.inter.placeholderPath&&(z+="background-image:url('"+("undefined"==typeof isKotobee?j.inter.placeholderPath:ph.join(n,j.inter.placeholderPath))+"');"),s.setAttribute("style",z);var K=document.createElement("a");j.inter.includeMsg?(K.innerHTML=kInteractive.escapeHtml(j.inter.msg),K.className="msgBtn ki-btn"):K.className="invisibleBtn ki-btn",I.appendChild(K),"undefined"==typeof isKotobee&&K&&K.addEventListener("click",this.actionEvent),s.appendChild(I)}else if(this.hasClass(s,"gallery"));else if(this.hasClass(s,"image")){var W=kInteractive.readData(s);if(!W)continue;W&&(W.behavior&&"none"!=W.behavior||(s.style.transition=s.style.webkitTransition=s.style.mozTransition="none"))}}this.firstRun&&(window.addEventListener("resize",function(t){kInteractive.resizeEvent(e,i)}),this.firstRun=!1),kInteractive.resizeEvent(e,i)},actionEvent:function(e){kInteractive.action(e.target)},action:function(e,t){function n(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t}function i(){var e="Questions: "+f+". Score: "+y+" questions out of "+b;e+=". Action: "+W,"selfAnswerReport"==W&&(e+=". Details: "+C),kInteractive.tinCan({verb:"solved",activity:e})}function a(){ve||(kInteractive.c.addClass(ge,"hide"),ve=!0)}function r(e,t){e.style.webkitAnimation=e.style.mozAnimation=e.style.animation=t}function o(e,t){e.style.webkitAnimationDuration=e.style.mozAnimationDuration=e.style.animationDuration=t}function s(e,t){e.style.webkitAnimationIterationCount=e.style.mozAnimationIterationCount=e.style.animationIterationCount=t}function c(e){var t=document.createElement("video");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("src",e),t.setAttribute("autoplay","true"),t.setAttribute("data-tap-disabled","false");var n;0!=e.indexOf("http://")&&0!=e.indexOf("https://")||(n=!0),n&&t.setAttribute("crossorigin","anonymous");var i=!1;try{i=navigator.userAgent.toLowerCase().indexOf("android")>-1}catch(e){}i||t.setAttribute("type","video/mp4"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.className="ki-noHighlight",Me.hideDownloadBtn&&(t.className+=" hideDownloadBtn"),t.innerHTML="Your browser doesn't support HTML5 video.",n&&(t.crossOrigin="anonymous"),t.oncanplay=function(){kInteractive.currentVideo==u&&(me.className="playBtn ki-btn hide",kInteractive.tinCan({verb:"played",activity:"Video: "+e}))},t.addEventListener("error",function(e){kInteractive.stopCurrentMedia()}),t.addEventListener("webkitfullscreenchange",function(e){var t=null!==document.webkitFullscreenElement;kInteractive.videoIsFullscreen=t});var a=u.getElementsByClassName("container")[0];a.setAttribute("data-tap-disabled","true"),a.appendChild(t)}function l(){function e(e){function n(t){if(!(t>=je.objects.length)){var i=je.objects[t],r="undefined"==typeof isKotobee?i.path:ph.join(d,i.path);new THREE.OBJLoader(l).load(r,function(r){ze&&ze.parentNode&&ze.parentNode.removeChild(ze),a.domElement.parentNode||e.appendChild(a.domElement),r.position.set(i.x,i.y,i.z),r.traverse(function(e){if(e instanceof THREE.Mesh){var a=e==r.children[r.children.length-1];if(i.textPath){var o=new THREE.ImageLoader(l),s="undefined"==typeof isKotobee?i.textPath:ph.join(d,i.textPath);o.load(s,function(i){var o=new THREE.Texture;o.image=i,o.needsUpdate=!0,e.material.map=o,a&&c.add(r),n(++t)},function(){},function(e){})}else a&&c.add(r),n(++t)}})},function(e){e.lengthComputable&&(e.loaded,e.total)},function(e){})}}function i(){try{a.render(c,s)}catch(e){return}y.getDelta();t=requestAnimFrame(i)}kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("_3D",je.name?je.name:"Model"),e.description="Opened 3D model: "+(je.name?je.name:"No name"),e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800),t&&cancelAnimationFrame(t);var a;a=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}()?new THREE.WebGLRenderer({precision:"highp"}):new THREE.CanvasRenderer;var r=e.offsetWidth,o=e.offsetHeight,s=new THREE.PerspectiveCamera(je.camera.viewAngle,r/o,je.camera.near,je.camera.far),c=new THREE.Scene;null!=je.scene.bgColor&&a.setClearColor(je.scene.bgColor,1),c.add(s),s.position.x=je.camera.x,s.position.y=je.camera.y,s.position.z=je.camera.z,a.setSize(r,o),je.scene.floor&&(floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500,1,1),new THREE.MeshPhongMaterial({color:je.scene.floorColor?je.scene.floorColor:10066329})),floor.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),floor.position.y=-80,floor.receiveShadow=!0,c.add(floor));var l=new THREE.LoadingManager;l.onProgress=function(e,t,n){},n(0),new THREE.OrbitControls(s,a.domElement).target=new THREE.Vector3(0,0,0);for(var u=0;u<je.lights.length;u++)if("pointLight"==je.lights[u].type){var m=new THREE.PointLight(je.lights[u].color);m.position.set(je.lights[u].x,je.lights[u].y,je.lights[u].z),c.add(m)}else if("directionalLight"==je.lights[u].type){var p=new THREE.DirectionalLight(je.lights[u].color,je.lights[u].intensity);p.position.set(je.lights[u].x,je.lights[u].y,je.lights[u].z),c.add(p)}else if("hemisphereLight"==je.lights[u].type){var h=new THREE.HemisphereLight(je.lights[u].sky,je.lights[u].ground,je.lights[u].intensity);h.position.set(je.lights[u].x,je.lights[u].y,je.lights[u].z),c.add(h)}else if("spotLight"==je.lights[u].type){var v=new THREE.SpotLight(je.lights[u].color,je.lights[u].intensity,je.lights[u].distance,je.lights[u].angle,je.lights[u].exponent,je.lights[u].decay);v.position.set(je.lights[u].x,je.lights[u].y,je.lights[u].z),c.add(v)}else if("ambientLight"==je.lights[u].type){var f=new THREE.AmbientLight(je.lights[u].color);c.add(f)}else if("areaLight"==je.lights[u].type){var g=new THREE.AreaLight(je.lights[u].color,je.lights[u].intensity);c.add(g)}var y=new THREE.Clock;i()}var t,n=u;if("inPanel"==je.inter.target){var i={};i.class="threed",i.cb=function(t){var n=document.createElement("div");n.className="container",t.appendChild(n),e(n)},i.closed=function(){kInteractive.c.removeClass(u,"running")},kInteractive.openFrame(i)}else e(n)}if("undefined"==typeof editorMode||!editorMode){var d;"undefined"!=typeof isKotobee&&(d=angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var u=e;!this.hasClass(u,"kInteractive");){if(!u.parentNode)return;if((u=u.parentNode)==document.body)return}if(this.hasClass(u,"questions")){var m=kInteractive.readData(u);if(!m)return;var p=m.dict,h=m.userDict;if(p||(p={}),h||(h=p),m.layout&&m.layout.popup&&!this.hasClass(u,"inpopup")&&"img"==e.nodeName.toLowerCase()){var v=document.getElementById("epubContent");return v&&u.setAttribute("data-loc",function(e,t){for(var i="";e!=t;)i=n(e)+"."+i,e=e.parentNode;return""==i?"":i.substr(0,i.length-1)}(u,v)),(oe=document.createElement("iframe")).setAttribute("nwdisable","true"),oe.setAttribute("nwfaketop","true"),m.cb=function(e){function t(){if("undefined"!=typeof isKotobee){var e={};e.root=oe.contentDocument.documentElement.ownerDocument.body,e.rootIndex=u.getAttribute("data-loc"),angular.element(document.body).scope().getNotebookShortcut(e,function(){})}}var n,i=document.createElement("head");if("undefined"==typeof isKotobee){for(var a=document.getElementsByTagName("link"),r=0;r<a.length;r++){var o=a[r];if(o.getAttribute("href").indexOf("base.css")>=0){var s=o.getAttribute("href").split("/");delete s[s.length-1],n=s.join("/");break}}if(!n)return}var c="undefined"==typeof isKotobee?n+"../xhtml/":bookPath+"EPUB/xhtml/",i="<head>";if(i+='<base href="'+kInteractive.c.removeFilename(kInteractive.c.removeHash(window.location.href))+"/"+c+'"/>',i+='<link rel="stylesheet" type="text/css" href="../css/base.css" />',i+='<link rel="stylesheet" type="text/css" href="../css/global.css" />',i+='<link rel="stylesheet" type="text/css" href="../css/kotobeeInteractive.css" />',i+='<script type="text/javascript" src="../js/kotobeeInteractive.js"><\/script>',i+='<script type="text/javascript" src="../js/global.js"><\/script>',"undefined"!=typeof isKotobee){var l=clone(config);l.kotobee.email=angular.element(document.body).scope().data.user.email,i+='<script type="text/javascript">var config='+JSON.stringify(l)+";<\/script>"}i+='<meta charset="utf-8" />',i+="</head>";var d=u.outerHTML;d=(d=(d=(d=(d=(d=d.replace("<img",'<img style="display:none"')).replace(/([;\s]*?height:)(.*)?;/i,"$1auto")).replace(/([;\s]*?width:)(.*)?;/i,"$1auto")).replace(/([;\s]*?top:)(.*)?;/i,"$1auto")).replace(/([;\s]*?left:)(.*)?;/i,"$1auto")).replace('class="','class="inpopup ');var m="<html>"+i+"<body>"+(d+='<div class="vSpace20"></div>')+"</body></html>";oe.setAttribute("srcdoc",m);var p="javascript: window.frameElement.getAttribute('srcdoc');";oe.setAttribute("src",p),oe.contentWindow&&(oe.contentWindow.location=p),e.appendChild(oe),oe.addEventListener?oe.addEventListener("load",t,!0):oe.attachEvent&&oe.attachEvent("onload",t)},m.closed=function(){},m.pos=m.layout.pos,kInteractive.openFrame(m),kInteractive.tinCan({verb:"opened",activity:"Questions: "+m.title}),void(kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("question",m.title),e.description="Opened question popup: "+m.title,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800))}var f="Untitled questions",g=u.getElementsByTagName("h4");g.length&&(f=g[0].textContent||g[0].data);var y=0,k=u.getElementsByClassName("ques"),b=k.length,C="";if(this.hasClass(e,"kInteractive"))return;if(this.hasClass(e,"questions-clear")){for(var I=u.getElementsByClassName("ans"),E=0;E<I.length;E++)I[E].checked=!1,I[E].value=null,kInteractive.c.removeClass(I[E].parentNode,"correct");for(E=(P=u.getElementsByClassName("explanation")).length;E--;)P[E].parentNode.removeChild(P[E]);for(E=(j=u.getElementsByClassName("reference")).length;E--;)j[E].parentNode.removeChild(j[E]);return void(document[u.id]=null)}if(this.hasClass(e,"questions-notebook")){var w=m.layout&&m.layout.popup&&this.hasClass(u,"inpopup");if("undefined"==typeof isKotobee&&!w)return void kInteractive.alert({content:p.kotobeeOnly,title:h.sorry?h.sorry:"Sorry"});var N,A={elem:u};if("undefined"!=typeof isKotobee)N=angular.element(document.body).scope();else{try{N=window.parent.getGlobal()}catch(e){return void kInteractive.alert({content:p.kotobeeOnly,title:h.sorry?h.sorry:"Sorry"})}A.rootIndex=u.getAttribute("data-loc"),A.root=u}return kInteractive.c.addClass(e,"busy"),void N.questionsAddToNotebookShortcut(A,function(){kInteractive.c.removeClass(e,"busy"),kInteractive.alert({content:h.savedToNotebook?h.savedToNotebook:"Saved to notebook!"})})}if(this.hasClass(e,"questions-preserve"))return document[u.id]||(document[u.id]={}),void(document[u.id].preserve=e.checked);for(var x=0,T=0,q=[],E=0;E<k.length;E++){var L=(I=k[E].getElementsByClassName("ans")).length>0,B=m.q[E];if(m.options.randomize&&(B=m.q[Number(k[E].getAttribute("data-o"))]),kInteractive.scorm&&m.options&&m.options.answerOnce&&kInteractive.scorm.interactionExists(kInteractive.getScormId(u.id+"-"+(E+1),B.q))){U="<p style='text-align:center'>"+(h.alreadySubmitted?h.alreadySubmitted:"This test has already been submitted!")+"</p>";return void kInteractive.alert({content:U})}var H={};q.push(H),H.id=kInteractive.getScormId(u.id+"-"+(E+1),B.q),H.qid=u.id,H.type=I[0].getAttribute("id").indexOf("ki-tf-")>=0?"true-false":"choice",H.objective=m.options?m.options.objective:null,H.timestamp=kInteractive.timestamp,H.latency=Math.round(((new Date).getTime()-kInteractive.timestamp.getTime())/1e3),H.description=B.q;for(te=0;te<I.length;te++)if(I[te].getAttribute("id").indexOf("ki-tf-")>=0)0==te&&B.a?H.correctResponses=B.choice1:1!=te||B.a||(H.correctResponses=B.choice2),I[te].checked?(H.learnerResponses=te?B.choice2:B.choice1,0!=te||B.a?1==te&&B.a&&(L=!1):L=!1):0==te&&B.a?L=!1:1!=te||B.a||(L=!1),m.options&&m.options.highlightCorrect&&(0==te&&B.a||1==te&&!B.a)&&kInteractive.c.addClass(I[te].parentNode,"correct");else if(I[te].getAttribute("id").indexOf("ki-sa-")>=0){(Z=I[te].value.toLowerCase())&&(Z=Z.trim()),L=!0;for(var M="",S=0;S<B.k.length;S++){var O=B.k[S].t;if(!O){L=!1;break}O=O.toLowerCase(),M&&(M+="+"),M+=O;for(var D=O.split(","),R=!1,F=0;F<D.length;F++)if(Z.indexOf(D[F].trim())>=0){R=!0;break}if(!R){L=!1;break}}H.correctResponses=M,H.learnerResponses=Z}else B.c[te].a&&(H.correctResponses=B.c[te].t),I[te].checked&&(H.learnerResponses=B.c[te].t),I[te].checked&&!B.c[te].a?L=!1:!I[te].checked&&B.c[te].a&&(L=!1),m.options&&m.options.highlightCorrect&&B.c[te].a&&kInteractive.c.addClass(I[te].parentNode,"correct");if(H.result=0,null!=B.weight&&(x+=B.weight,L&&(T+=B.weight,H.result=B.weight)),H.scoreMax=m.options?Number(m.options.totalScore):null,B.exp&&!k[E].getElementsByClassName("explanation").length){var P=document.createElement("p");P.className="explanation",P.innerHTML=kInteractive.escapeHtml(B.exp),kInteractive.appendAfterDelay(k[E],P)}if(B.ref&&!k[E].getElementsByClassName("reference").length){var j=document.createElement("a");j.className="reference",j.innerHTML=h.learnMode?h.learnMode:"Learn more",j.setAttribute("href",kInteractive.escapeHtml(B.ref)),j.setAttribute("target","_blank"),kInteractive.appendAfterDelay(k[E],j)}var z=h.question?h.question.replace("[no]",E+1):"Question "+(E+1);L?(C+="<span style='border-bottom: dotted 1px #aaa;' title='"+B.q.replace(/'/g,"&#39;")+"'>"+z+".</span>  <span style='color:#366c20'>"+h.correct+"</span><br/>",y++):C+="<span style='border-bottom: dotted 1px #aaa;' title='"+B.q.replace(/'/g,"&#39;")+"'>"+z+".</span>  <span style='color:#7a1818'>"+h.incorrect+"</span><br/>"}for(E=0;E<q.length;E++)q[E].weighting=Math.round(1e3*m.options.totalScore/x)/1e3;var K,W=m.action;if(m.options.totalScore&&x&&(K=Math.round(10*m.options.totalScore*T/x)/10),"selfAnswer"==W||"selfAnswerReport"==W){var _="";"ar"==m.options.language&&(_=' direction="rtl"');var U="";if(h.scoreWeight){if(null!=K){var V="";m.options.passScore&&(K>=m.options.passScore||K==m.options.totalScore?V+=h.pass:V+=h.fail),V&&(V+=". "),U+="<h3"+_+">"+(V||"")+h.scoreWeight.replace("[score]",K).replace("[total]",m.options.totalScore)+"</h3>"}U+="<p"+_+">"+h.score.replace("[correct]",y).replace("[total]",b)+"</p>"}else U="You scored "+y+" question(s) out of "+b;"selfAnswerReport"==W&&(U="<p"+_+"><strong>"+U+"</strong></p><p><strong>"+(h.details?h.details:"Details")+"</strong></p><p class='kbAlertScroll'>"+C+"</p>"),kInteractive.alert({content:U}),i()}if("email"==W||m.options.reportEmail||m.options.emailForm){var Q="selfAnswer"!=W&&"selfAnswerReport"!=W&&"email"!=W;try{if(!config.kotobee.cloudid)return void(Q&&kInteractive.alert({content:p.cloudOnly,title:h.sorry?h.sorry:"Sorry"}))}catch(e){return void(Q&&kInteractive.alert({content:p.cloudOnly,title:h.sorry?h.sorry:"Sorry"}))}(be={}).ans=new Array;for(te=0;te<k.length;te++)for(var I=k[te].getElementsByClassName("ans"),E=0;E<I.length;E++)I[E].checked&&be.ans.push({q:te,index:E,label:I[E].nextSibling.textContent||I[E].nextSibling.data});if(be.title=f,(ye={}).recipient=m.address,m.options.reportEmail&&(ye.recipient=m.options.reportEmail),ye.content=JSON.stringify(be),ye.mode=config.kotobee.mode,ye.cloudid=config.kotobee.cloudid,ye.email=config.kotobee.email?config.kotobee.email:angular.element(document.body).scope().data.user.email,m.options.emailForm){var Y=document.getElementsByName("recipientEmail");Y.length&&(ye.recipient=ye.recipient?ye.recipient+","+Y[0].value:Y[0].value)}var J=e.value;e.value=h.submitting?h.submitting:"Submitting ..",e.setAttribute("disabled","true");var X=new XMLHttpRequest;X.onreadystatechange=function(){try{if(4===X.readyState&&200===X.status){if(e.value=J,e.removeAttribute("disabled"),!Q)return;JSON.parse(X.responseText).success?kInteractive.alert({content:h.submitted?h.submitted:"Answers submitted!"}):kInteractive.alert({content:h.errorSubmitting?h.errorSubmitting:"An error has occurred while sending answers to the server"})}}catch(t){if(e.value=J,e.setAttribute("value",e.value),e.removeAttribute("disabled"),!Q)return;kInteractive.alert({content:h.errorSubmitting?h.errorSubmitting:"An error has occurred while sending answers to the server"})}};re=config.kotobee.liburl?config.kotobee.liburl:"http://www.kotobee.com/";re+="library/report/questions",X.open("POST",re),X.setRequestHeader("Content-type","application/x-www-form-urlencoded");var G="a=a";for(var $ in ye){var Z=ye[$];void 0!=Z&&("object"!=typeof Z&&("string"==typeof Z&&(Z=encodeURIComponent(Z)),"boolean"==typeof Z&&(Z=Z?1:0),G+="&"+$+"="+Z))}X.send(G),i()}document[u.id]||(document[u.id]={}),document[u.id].q=[];for(var ee=u.getElementsByClassName("ques"),te=0;te<ee.length;te++){var ne=te;m.options.randomize&&(ne=Number(ee[te].getAttribute("data-o"))),document[u.id].q[ne]=[];for(var ie=ee[te].getElementsByClassName("ans"),E=0;E<ie.length;E++)kInteractive.hasClass(ie[E],"txtfield")?document[u.id].q[ne][E]=ie[E].value:document[u.id].q[ne][E]=ie[E].checked}kInteractive.scorm&&setTimeout(function(){kInteractive.scorm.setInteractions(q)},500)}else if(this.hasClass(u,"widget")){var ae=kInteractive.readData(u);if(!ae)return;var re=kInteractive.getWidgetUrl(ae),oe=document.createElement("iframe");oe.setAttribute("nwdisable","true"),oe.setAttribute("nwfaketop","true"),ae.cb=function(e){oe.src=re,e.appendChild(oe)},ae.cb1="yes",ae.closed=function(){},kInteractive.openFrame(ae),kInteractive.tinCan({verb:"opened",activity:"Widget: "+ae.name}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("widget",ae.name),e.description="Opened popup widget: "+ae.name,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else{if(this.hasClass(e,"link")){if(!(ye=kInteractive.readData(e)))return;if("popup"==ye.type){if(U=(U="<div class='kbAlertScroll'>"+ye.msg+"</div>").replace(/src="(.*?)"/g,function(){var e=arguments[1];return"undefined"!=typeof isKotobee&&(e=ph.join(d,e)),'src="'+e+'"'}),"image"==ye.popupMode){var se=ye.popupImg;"undefined"!=typeof isKotobee&&(se=ph.join(d,se)),U="<img src='"+se+"'/>"}kInteractive.alert({content:U}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("popup",ye.msg),e.description="Shown popup message: "+ye.msg,e.type="other",e.learnerResponses="Shown",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else if("action"==ye.type){var ce=ye.asset,W=ye.action;if(ce.remote){if("widget"==ce.type){var le=document.createElement("div");le.className="kInteractive widget kbHidden",le.setAttribute("data-kotobee",ce.data),document.body.appendChild(le),this.trigger("click",le)}return}for(var de=document.getElementsByClassName(ce.classname),te=0;te<de.length;te++)if(this.hasClass(de[te],"kInteractive")&&this.hasClass(de[te],ce.type))if("activate"==W)if("gallery"==ce.type){var ue=de[te].getElementsByClassName("next");this.trigger("click",ue[0])}else if("questions"==ce.type){for(var me=de[te].getElementsByClassName("ki-btn"),E=0;E<me.length;E++)if("submit"==me[E].type){this.trigger("click",me[E]);break}}else this.trigger("click",de[te]);else"visibility"==W&&kInteractive.c.toggleClass(de[te],"kbHidden")}else if("audio"==ye.type){kInteractive.stopCurrentMedia();var pe=document.createElement("audio"),he=ye.src;"file"==ye.audioType&&(he="undefined"==typeof isKotobee?ye.audio:ph.join(d,ye.audio)),pe.setAttribute("src",he);var ve,fe=document.createElement("div");fe.className="kiAudioLoader",fe.style.transform=fe.style.webkitTransform=fe.style.mozTransform="scale(1)";var ge=document.createElement("div");ge.className="kiAudioSpinner",fe.appendChild(ge),e.parentNode.insertBefore(fe,e),pe.onplaying=a,setTimeout(a,5e3),pe.play(),kInteractive.currentAudio=pe,kInteractive.tinCan({verb:"played",activity:"Audio: "+he}),kInteractive.scorm&&((H={}).id=kInteractive.getScormId(e.textContent,he),H.description="Played audio link: "+he,H.type="other",H.learnerResponses="Played",H.objective=ye.options?ye.options.objective:null,H.timestamp=new Date,kInteractive.scorm.setInteractions([H]))}return!1}if(this.hasClass(e,"image")){if(e.parentNode&&this.hasClass(e.parentNode,"kInteractive")&&this.hasClass(e.parentNode,"link"))return void this.action(e.parentNode,t);var ye=kInteractive.readData(e);if(!ye)return;var ke=ye.behavior;if("none"==ke){if(ye.popup){var be={};be.class="image";var Ce=document.createElement("img");Ce.src=ye.path,this.isAbsolutePath(ye.path)||"undefined"!=typeof isKotobee&&(Ce.src=ph.join(d,ye.path)),be.width=Ce.naturalWidth,be.height=Ce.naturalHeight,be.pos="side",be.cb=function(e){e.appendChild(Ce)},be.closed=function(){},kInteractive.openFrame(be)}return}r(e,"none"),o(e,"none"),s(e,"none"),setTimeout(function(){function t(i){r(e,"none"),o(e,"none"),s(e,"none"),e.removeEventListener(n,t)}"wiggle"==ke?(r(e,"wiggle"),o(e,"0.5s"),s(e,"1")):"jump"==ke?(r(e,"jump"),o(e,"0.7s"),s(e,"1")):"scale"==ke&&(r(e,"scale"),o(e,"0.5s"),s(e,"1"));var n=function(){var e,t=document.createElement("fakeelement"),n={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}();n&&e.addEventListener(n,t)}),kInteractive.tinCan({verb:"clicked",activity:ke+"image: "+e.getAttribute("src")})}else if(this.hasClass(u,"gallery")){var Ie=u.getElementsByClassName("images")[0],y=Ie.children.length,Ee=u.getElementsByClassName("selected")[0],we=Number(Ee.style.left.slice(0,-2)),Ne=Number(Ie.style.left.slice(0,-2));if(this.hasClass(e,"next")){var Ae=Ee.nextSibling;if(!Ae)return;kInteractive.c.removeClass(Ee,"selected"),kInteractive.c.addClass(Ae,"selected"),Ae.style.left=we+Ie.offsetWidth+"px",Ae.style.display="block",Ie.style.left=Ne-Ie.offsetWidth+"px",Ae.nextSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(u.getElementsByClassName("prev")[0],"disable"),Ee=Ae}else if(this.hasClass(e,"prev")){var xe=Ee.previousSibling;if(!xe)return;kInteractive.c.removeClass(Ee,"selected"),kInteractive.c.addClass(xe,"selected"),xe.style.left=we-Ie.offsetWidth+"px",xe.style.display="block",Ie.style.left=Ne+Ie.offsetWidth+"px",xe.previousSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(u.getElementsByClassName("next")[0],"disable"),Ee=xe}var Te=u.getElementsByClassName("imgCaption");if(!Te.length)return;var qe=(Te=Te[0]).getElementsByClassName("inner");if(!qe.length)return;(qe=qe[0]).style.display="none",Ee.hasAttribute("data-caption")&&(qe.innerHTML=Ee.getAttribute("data-caption"),qe.style.display=null)}else if(this.hasClass(u,"audio")){kInteractive.stopCurrentMedia();var Le=kInteractive.readData(u);if(!Le)return;Le.audioType||(Le.audioType=Le.type);Se=u.getAttribute("id")+"-container";(me=u.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn hide";he=Le.src;"file"==Le.audioType&&(he="undefined"==typeof isKotobee?Le.audio:Le.relToRoot?ph.join(bookPath,Le.audio):ph.join(d,Le.audio)),kInteractive.scorm&&((H={}).id=kInteractive.getScormId(u.getAttribute("id"),he),H.description="Played audio: "+he,H.type="other",H.learnerResponses="Played",H.objective=Le.options?Le.options.objective:null,H.timestamp=new Date,kInteractive.scorm.setInteractions([H]));var Be=document.createElement("audio");Be.setAttribute("controls","true"),Be.setAttribute("autoplay","true"),Be.setAttribute("data-tap-disabled","false");var He=document.createElement("source");He.src=he,Be.appendChild(He),Be.appendChild(document.createTextNode("Your browser does not support the audio element")),Be.className="ki-noHighlight",Be.oncanplay=function(){kInteractive.currentAudio==u&&kInteractive.tinCan({verb:"played",activity:"Audio: "+he})},u.getElementsByClassName("container")[0].appendChild(Be),Be.play(),kInteractive.currentAudio=u,kInteractive.c.addClass(kInteractive.currentAudio,"playing")}else if(this.hasClass(u,"video")){var Me=kInteractive.readData(u);if(!Me)return;var Se=u.getAttribute("id")+"-container";if((me=u.getElementsByClassName("playBtn")[0]).className.indexOf("loading")>=0)return;if(kInteractive.stopCurrentMedia(),me.className="playBtn ki-btn loading",Me.autoplay&&(me.className="playBtn ki-btn hide"),kInteractive.scorm&&((H={}).id=kInteractive.getScormId(u.getAttribute("id"),Me.src),H.description="Played video: "+Me.src,H.type="other",H.learnerResponses="Played",H.objective=Me.options?Me.options.objective:null,H.timestamp=new Date,kInteractive.scorm.setInteractions([H])),"file"==Me.type)c(he="undefined"==typeof isKotobee?Me.video:ph.join(d,Me.video));else if(Me.src.indexOf("youtube.com")>=0||Me.src.indexOf("youtu.be/")>=0){var Oe;if(Me.src.indexOf("youtube.com")>=0)Oe=(De=Me.src.split("watch?v="))[1];else{if(!(Me.src.indexOf("youtu.be/")>=0))return;var De=Me.src.split("youtu.be/");Oe=De[De.length-1]}if(window&&window.iBooks)return setTimeout(function(){me.className="playBtn ki-btn"},1500),void(window.location.href=Me.src);var Re={videoId:Oe,playerVars:{autoplay:1,rel:"0"},events:{onReady:function(){},onStateChange:function(e){e.data==YT.PlayerState.PLAYING&&kInteractive.tinCan({verb:"played",activity:"Video: "+Me.src})}}};if(kInteractive.youTubeStatus)if("loading"==kInteractive.youTubeStatus){if(kInteractive.vQueue)return;kInteractive.vQueue=function(){me.className="playBtn ki-btn hide",new YT.Player(Se,Re)}}else"ready"==kInteractive.youTubeStatus&&(me.className="playBtn ki-btn hide",new YT.Player(Se,Re));else{window.onYouTubePlayerAPIReady=function(){kInteractive.youTubeStatus="ready",kInteractive.vQueue(),kInteractive.vQueue=null};var Fe=document.createElement("script");Fe.src="https://www.youtube.com/player_api";var Pe=document.getElementsByTagName("script")[0];Pe.parentNode.insertBefore(Fe,Pe),kInteractive.youTubeStatus="loading",kInteractive.vQueue=function(){me.className="playBtn ki-btn hide",new YT.Player(Se,Re)}}}else c(Me.src);kInteractive.currentVideo=u,kInteractive.c.addClass(kInteractive.currentVideo,"playing")}else if(this.hasClass(u,"threed")){var je=kInteractive.readData(u);if(!je)return;"inPanel"==je.inter.target?kInteractive.c.addClass(u,"running"):u.innerHTML="";var ze=document.createElement("div");if(ze.className="loading",u.appendChild(ze),"undefined"==typeof THREE){var Ke,We=document.getElementsByTagName("head")[0],_e=We.getElementsByTagName("script");if("undefined"!=typeof isKotobee)Ke=bookPath+"EPUB/js/kotobeeInteractive3D.js";else for(te=0;te<_e.length;te++)if(_e[te].src.indexOf("kotobeeinteractive.js")>=0){Ke=_e[te].src.replace("kotobeeinteractive.js","kotobeeinteractive3D.js");break}if(!Ke)return;var Ue=document.createElement("script");Ue.type="text/javascript",Ue.src=Ke,Ue.onload=l,Ue.onreadystatechange=function(){"complete"==this.readyState&&l()},We.appendChild(Ue)}else l()}}}},trigger:function(e,t){this.action(t,e)},openFrame:function(e){function t(){i.style.display="block",i.className="show";var t=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,r=window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth;t-=20,r-=20;var o=1;if(e.width&&e.height){var s=r/e.width,l=t/e.height;(o=s<l?s:l)>1&&(o=1)}var d="display:block;";d+=a;var u=e.width||e.height?"-50%,-50%":"0%,0%";d+="-webkit-transform:translate("+u+") scale("+o+");-moz-transform:translate("+u+") scale("+o+");transform:translate("+u+") scale("+o+");",d+="position:fixed;","undefined"==typeof isKotobee&&"-50%,-50%"==u&&(d+="top:"+Math.round(window.innerHeight/2)+"px;",d+="left:"+Math.round(window.innerWidth/2)+"px;"),n.style.cssText=d,n.className=c+" ready";var m=n.getElementsByClassName("closeBtn");if(m.length){var p=m[0],h=1/o,v="-50%";kInteractive.hasClass(p,"side")&&(v="0%"),p.style.cssText="-webkit-transform: translate("+v+",0%) scale("+h+");-webkit-transform-origin: 50% 50%;-moz-transform: translate("+v+",0%) scale("+h+");-moz-transform-origin: 50% 50%;transform: translate("+v+",0%) scale("+h+");transform-origin: 50% 50%;"}}var n=document.getElementById("kInteractiveFrame"),i=document.getElementById("kiDarkOverlay"),a="";if(e.dict||(e.dict={}),e.width&&(a+="width:"+e.width+"px;max-width:"+e.width+"px;"),e.height&&(a+="height:"+e.height+"px;max-height:"+e.height+"px;"),n||((i=document.createElement("div")).id="kiDarkOverlay",document.body.appendChild(i),i.style.display="none",i.style.position="fixed",i.addEventListener("click",kInteractive.closeFrame),(n=document.createElement("div")).id="kInteractiveFrame"),e.pos||(e.pos="top"),"none"!=e.pos){var r=document.createElement("a"),o="closeBtn";e.pos&&(o+=" "+e.pos),r.className=o;var s=e.dict.close?e.dict.close:"Close";try{s=angular.element(document.body).scope().translit("close")}catch(e){}"side"!=e.pos&&(r.innerHTML=s),r.addEventListener("click",kInteractive.closeFrame),n.appendChild(r)}var c=e.class?e.class:"";(e.width||e.height)&&(c+=" fixed"),n.style.display="block",n.className=c,document.body.appendChild(n),kInteractive.frameIsOpen=!0,kInteractive.frameOb=e,kInteractive.openFrame.resized=t,window.addEventListener("resize",t),setTimeout(function(){t(),e.cb&&e.cb(n)},100)},closeAlert:function(e){e&&e.stopPropagation();var t=document.getElementById("kiSystemAlertBox"),n=document.getElementById("kiSystemAlertBackdrop");t.parentNode.removeChild(t),n.parentNode.removeChild(n),kInteractive.alertIsOpen=!1,window.removeEventListener("resize",kInteractive.alert.resized),kInteractive.alert.resized=null},closeFrame:function(){var e=document.getElementById("kInteractiveFrame"),t=document.getElementById("kiDarkOverlay");kInteractive.frameIsOpen=!1,window.removeEventListener("resize",kInteractive.openFrame.resized),kInteractive.openFrame.resized=null,kInteractive.c.removeClass(e,"ready");var n=kInteractive.frameOb,i="";n.width&&(i+="width:"+n.width+"px;max-width:"+n.width+"px;"),n.height&&(i+="height:"+n.height+"px;max-height:"+n.height+"px;"),e.style.cssText=i,t.className="",setTimeout(function(){e.innerHTML="",e.style.display=t.style.display="none",n.closed&&n.closed(),kInteractive.frameOb=null},300)},stopCurrentMedia:function(){if(kInteractive.currentVideo){var e=kInteractive.currentVideo.getAttribute("id")+"-container";(t=document.getElementById(e))&&(t.parentNode.removeChild(t),(n=document.createElement("div")).setAttribute("id",e),n.className="container",(i=kInteractive.currentVideo.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentVideo,"playing"),kInteractive.currentVideo.appendChild(n))}if(kInteractive.currentAudio)if(e=kInteractive.currentAudio.getAttribute("id")){e+="-container";var t=document.getElementById(e);if(t){t.parentNode.removeChild(t);var n=document.createElement("div");n.setAttribute("id",e),n.className="container";var i=kInteractive.currentAudio.getElementsByClassName("playBtn")[0];i.className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentAudio,"playing"),kInteractive.currentAudio.appendChild(n)}}else try{var a=kInteractive.currentAudio.getElementsByTagName("audio");a.length&&(a[0].pause(),a[0].src=""),kInteractive.currentAudio.pause&&(kInteractive.currentAudio.pause(),kInteractive.currentAudio.src="");for(var r=document.getElementsByClassName("kiAudioLoader"),o=r.length;o--;)r[o].parentNode.removeChild(r[o])}catch(e){}},hasClass:function(e,t){if(e&&e.className)for(var n=e.className.trim().split(" "),i=0;i<n.length;i++)if(n[i]&&n[i].trim()==t)return!0},appendAfterDelay:function(e,t){setTimeout(function(){e.appendChild(t)},30)},replaceHTML:function(e,t){var n="string"==typeof e?document.getElementById(e):e,i=n.cloneNode(!1);return i.innerHTML=t,n.parentNode.replaceChild(i,n),i},tinCan:function(e){if("undefined"!=typeof isKotobee)try{angular.element(document.body).scope().tinCanShortcut(e)}catch(e){}},setDOMParser:function(){!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var i,a=document.implementation.createHTMLDocument(""),r=a.documentElement;return r.innerHTML=e,i=r.firstElementChild,1===r.childElementCount&&"html"===i.localName.toLowerCase()&&a.replaceChild(i,r),a}return n.apply(this,arguments)}}(DOMParser)},readData:function(e){try{var t=e.getAttribute("data-kotobee");return t||(t=e.getAttribute("data")),JSON.parse(decodeURI(kInteractive.XORCipher().decode("kotobee%%author",t)))}catch(e){try{return JSON.parse(kInteractive.XORCipher().decode("kotobee%%author",t))}catch(e){}}},writeData:function(e,t){var n=encodeURI(JSON.stringify(t)),i=e.hasAttribute("data-kotobee")?"data-kotobee":"data";e.setAttribute(i,kInteractive.XORCipher().encode("kotobee%%author",n))},XORCipher:function(){function e(e){var t,n,i,a,r,s,c=0,l="";if(!e)return e;do{t=(r=e[c++]<<16|e[c++]<<8|e[c++])>>18&63,n=r>>12&63,i=r>>6&63,a=63&r,l+=o.charAt(t)+o.charAt(n)+o.charAt(i)+o.charAt(a)}while(c<e.length);return((s=e.length%3)?l.slice(0,s-3):l)+"===".slice(s||3)}function t(e){var t,n,i,a,r,s,c=0,l=[];if(!e)return e;e+="";do{t=(s=o.indexOf(e.charAt(c++))<<18|o.indexOf(e.charAt(c++))<<12|(a=o.indexOf(e.charAt(c++)))<<6|(r=o.indexOf(e.charAt(c++))))>>16&255,n=s>>8&255,i=255&s,l.push(t),64!==a&&(l.push(n),64!==r&&l.push(i))}while(c<e.length);return l}function n(e,t){return e.charCodeAt(Math.floor(t%e.length))}function i(e,t){return r(t,function(t,i){return t.charCodeAt(0)^n(e,i)})}function a(e,t){return r(t,function(t,i){return String.fromCharCode(t^n(e,i))}).join("")}function r(e,t){for(var n=[],i=0;i<e.length;i++)n[i]=t(e[i],i);return n}var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t,n){return n=i(t,n),e(n)},decode:function(e,n){return n=t(n),a(e,n)}}},getScormId:function(e,t){return t&&(t=t.replace(/[^a-zA-Z0-9]/g,"-").substr(0,80)),e+"-"+t},alert:function(e){function t(){"undefined"==typeof isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px")}var n=document.createElement("div");n.setAttribute("id","kiSystemAlertBox"),n.style.position="fixed","undefined"==typeof isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px");var i=document.createElement("div");i.innerHTML=e.content.replace("&nbsp;","&#160;"),i.className="content",n.appendChild(i);var a=document.createElement("div");if(a.className="footer",e.title){var r=document.createElement("div");r.innerHTML=e.title.replace("&nbsp;","&#160;"),r.className="header",n.insertBefore(r,n.firstChild)}var o=document.createElement("a"),s="OK";try{s=angular.element(document.body).scope().translit("ok")}catch(e){}o.innerHTML=s.replace("&nbsp;","&#160;"),o.className="okBtn",kInteractive.alertIsOpen=!0,o.addEventListener("click",kInteractive.closeAlert),a.appendChild(o),n.appendChild(a);var c=document.createElement("div");c.setAttribute("id","kiSystemAlertBackdrop"),c.addEventListener("click",kInteractive.closeAlert),c.style.position="fixed",document.body.appendChild(c),document.body.appendChild(n),o.focus(),kInteractive.alert.resized=t,window.addEventListener("resize",t),setTimeout(function(){n.className="show",c.className="show"},50)},c:{addClass:function(e,t){var n=e.className.trim();if(t instanceof Array){for(var i=!0,a=0;a<t.length;a++)-1==n.indexOf(t[a])&&(i=!1,n+=(""==n?"":" ")+t[a]);if(i)return}else{if(n.indexOf(t)>=0)return;n+=(""==n?"":" ")+t}e.className=n},toggleClass:function(e,t){this.strHasClass(e.className,t)?this.removeClass(e,t):this.addClass(e,t)},hasClass:function(e,t){return this.strHasClass(e.className,t)},strHasClass:function(e,t){e||(e="");for(var n=e.trim().split(" "),i=0;i<n.length;i++)if(n[i]==t)return!0;return!1},removeClass:function(e,t){var n=e.className;if(t instanceof Array){for(var i=!0,a=0;a<t.length;a++)n.indexOf(t[a])>=0&&(i=!1,n=n.replace(t[a],""));if(i)return}else{if(-1==n.indexOf(t))return;n=n.replace(t,"")}""==(n=n.trim())?e.removeAttribute("class"):e.className=n},removeHash:function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},removeFilename:function(e){var t=kInteractive.c.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},normalizedArray:function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t}},escapeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},resizeEvent:function(e,t){function n(e,t){if(e&&e.disableWrapForMobile&&"none"!=e.float){var n=t.parentNode;t.offsetWidth>.6*n.offsetWidth&&.4*(n.offsetWidth-t.offsetWidth)<100?kInteractive.c.addClass(t,"fullRow"):kInteractive.c.removeClass(t,"fullRow")}}var i,a=e||document;t&&(a=document);for(var r=(i=a.getElementsByClassName("kInteractive")).length;r--;){var o=i[r];if(this.hasClass(o,"image")){var s=kInteractive.readData(o);if(!s)return;n(s,o)}else if(this.hasClass(o,"gallery")){var c=kInteractive.readData(o);if(!c)return;n(c,o)}else if(this.hasClass(o,"container")){var l=kInteractive.readData(o);if(!l)return;n(l,o)}else if(this.hasClass(o,"video")){var d=kInteractive.readData(o);if(!d)return;if(n(d,o),!d.maintainRatio)continue;if("px"!=d.widthUnit)continue;if(!d.height||!d.width)continue;o.style.height=o.offsetWidth*(d.height/d.width)+"px"}else if(this.hasClass(o,"widget")){var u=kInteractive.readData(o);if(!u)return;if("page"!=u.mode)continue;if("px"!=u.widthUnit)continue;var m=u.width,p=u.height,h=o.parentNode;if(!h)continue;if(m>h.offsetWidth){var v=h.offsetWidth/m,f=o.children.length-1;o.children[f].style.transform=o.children[f].style.webkitTransform=o.children[f].style.mozTransform="scale("+v+")",o.children[f].style.transformOrigin=o.children[f].style.webkitTransformOrigin=o.children[f].style.mozTransformOrigin="0 0",o.style.maxWidth=o.style.width,o.style.height=Math.round(p*v)+"px"}else{for(f=0;f<o.children.length;f++)o.children[f].style.transform=o.children[f].style.webkitTransform=o.children[f].style.mozTransform=o.children[f].style.transformOrigin=o.children[f].style.webkitTransformOrigin=o.children[f].style.mozTransformOrigin=null;o.style.maxWidth=null,o.style.height=p+"px"}}}},isAbsolutePath:function(e){if(e)return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||(0==e.trim().indexOf("data:")||void 0)))},isMobile:function(e){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return!0;try{if(window.location.href.indexOf("?preview")>0){var t=window.location.href.split("?");t=t[1].split("&");for(var n={},i=0;i<t.length;i++){var a=t[i].split("=");n[a[0]]=a[1]}if(n.mobile)return!0}}catch(e){}},closeFullscreenVideo:function(){kInteractive.currentVideo&&(kInteractive.currentVideo.webkitExitFullscreen?kInteractive.currentVideo.webkitExitFullscreen():kInteractive.currentVideo.mozCancelFullScreen?kInteractive.currentVideo.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen(),kInteractive.videoIsFullscreen=!1)},getWidgetHome:function(e,t){return t||(t={}),e.path?"undefined"==typeof isKotobee?e.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,e.path):"undefined"==typeof isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/"},getWidgetUrl:function(e,t){var n=kInteractive.getWidgetHome(e,t)+"/"+e.name+"/"+e.src;if("undefined"!=typeof isKotobee){var i=angular.element(document.body).scope().data.user;i&&i.email&&i.signatures&&i.signatures.bookwidgets&&e.id&&0==e.id.indexOf("com.kidimedia")&&(n+="?oauth_signature="+i.signatures.bookwidgets.signature,n+="&oauth_nonce="+i.signatures.bookwidgets.nonce,n+="&oauth_timestamp="+i.signatures.bookwidgets.timestamp,n+="&oauth_consumer_key="+i.signatures.bookwidgets.key,n+="&lti_version=LTI-1p0",n+="&oauth_signature_method=HMAC-SHA1",n+="&oauth_version=1.0",n+="&tool_consumer_info_product_family_code=kotobee",n+="&lis_person_contact_email_primary="+i.email,n+="&lis_person_name_full="+(i.name?i.name:""),n+="&user_id="+i.id,n+="&lti_message_type=basic-lti-launch-request",angular.element(document.body).scope().refreshSignatures&&angular.element(document.body).scope().refreshSignatures())}return n},vQueue:[],youTubeReady:!1,firstRun:!0};if("undefined"==typeof isKotobee)try{document.addEventListener("DOMContentLoaded",kInteractionStart,!1)}catch(e){window.addEventListener("load",kInteractionStart,!1)}