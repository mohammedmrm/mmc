function getElementsByAttribute(e,t,n,o){for(var r,i,a="*"==t&&e.all?e.all:e.getElementsByTagName(t),s=new Array,l=void 0!==o?new RegExp("(^|\\s)"+o+"(\\s|$)","i"):null,c=0;c<a.length;c++)"string"==typeof(i=(r=a[c]).getAttribute&&r.getAttribute(n))&&i.length>0&&(void 0===o||l&&l.test(i))&&s.push(r);return s}function toggleClass(e,t){strHasClass(e.className,t)?removeClass(e,t):addClass(e,t)}function addRemoveClass(e,t,n){var o=e.className,r=!0;if(t)for(i=0;i<t.length;i++)strHasClass(o,t[i])||(r=!1,o+=(""==o?"":" ")+t[i]);if(n)for(var i=0;i<n.length;i++)strHasClass(o,n[i])&&(r=!1,o=strRemoveClass(o,n[i]));r||(e.className=o.trim())}function addClass(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])||(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(strHasClass(n,t))return;n+=(""==n?"":" ")+t}e.className=n}function removeClass(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])&&(o=!1,n=strRemoveClass(n,t[r]));if(o)return}else{if(!strHasClass(n,t))return;n=strRemoveClass(n,t)}""==(n=n.trim())?e.removeAttribute("class"):e.className=n}function getClassThatStartsWith(e,t){for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o].indexOf(t)>-1)return n[o]}function hasClass(e,t){return strHasClass(e.className,t)}function strHasClass(e,t){e||(e="");for(var n=e.trim().split(" "),o=0;o<n.length;o++)if(n[o]==t)return!0;return!1}function strRemoveClass(e,t){e||(e="");for(var n=e.trim().split(" "),o=0;o<n.length;o++)n[o]==t&&(n[o]=null);return n.join(" ")}function shouldParse(e){if(!e.match(/^http[s]?:/g)&&0!=e.indexOf("/")&&0!=e.indexOf("#dontparse"))return!0}function removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function randStr(e,t){return t||(t="s"),t+Math.random().toString(36).substring(5).substr(0,e)}function getDateTime(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),i=e.getMinutes(),a=e.getSeconds();if(1==n.toString().length)n="0"+n;if(1==o.toString().length)o="0"+o;if(1==r.toString().length)r="0"+r;if(1==i.toString().length)i="0"+i;if(1==a.toString().length)a="0"+a;return t+"/"+n+"/"+o+" "+r+":"+i+":"+a}function getFormData(e){e||(e={});var t=new FormData;for(var n in e)e[n]&&t.append(n,e[n]);return t}function newBlob(e,t){try{var n=new Blob([e],{type:t});return n}catch(r){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==r.name&&window.BlobBuilder){var o=new BlobBuilder;return o.append(e.buffer),n=o.getBlob(t)}if("InvalidStateError"==r.name)return n=new Blob([e.buffer],{type:t})}}function clone(e){if(null==e||"object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=clone(e[n]));return t}function rgb2hex(e){function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return/^#[0-9A-F]{6}$/i.test(e)?e:(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+t(e[1])+t(e[2])+t(e[3]):void 0}function timeOut(e,t){var n=setInterval(function(){clearInterval(n),e()},t);return n}function wrapNode(e,t){var n=document.createRange();n.selectNode(e),n.surroundContents(document.createElement(t))}function wrapNodeFromTo(e,t,n,o){var r=document.createRange();r.setStart(e,n),r.setEnd(e,o),r.surroundContents(document.createElement(t))}function XMLEscape(e,t){for(var n="",o=0;o<e.length;o++){var r=e.charAt(o);n+="&"==r?"&amp;":"'"==r?t?"&apos;":"&#39;":r}return n}function replaceHTML(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o}function kTemplate(e){return mobile?(config.overflowScroll?"templates/mobileOverflow/":"templates/mobile/")+e:"templates/web/"+e}function arrayContainsProperty(e,t,n){for(var o=0;o<e.length;o++)if(e[o][t]==n)return!0;return!1}function cacheBust(e){if(desktop&&(0==e.indexOf("/")||0==e.indexOf("file://")||0==e.indexOf("chrome-extension://")))return e;var t="?";return e.indexOf("?")>=0&&(t="&"),e+t+Math.floor(9999*Math.random())}function addPrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.addEventListener(o[r]+t,n,!1)}function removePrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.removeEventListener(o[r]+t,n,!1)}function redrawForChrome(e){-1!=navigator.userAgent.toLowerCase().indexOf("chrome")&&(e.style.display="inline-block",e.offsetHeight,e.style.display="")}function pauseVideoAndAudio(e){for(var t=e.getElementsByTagName("audio"),n=t.length;n--;)try{t[n].pause()}catch(e){}for(var o=e.getElementsByTagName("video"),n=o.length;n--;)try{o[n].pause()}catch(e){}}function isEmpty(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return JSON.stringify(e)===JSON.stringify({})}function asyncCheck(e,t,n,o){return e?o():(n.push(o),t.apply(this,n))}function autoprefixTransform(e,t){t||(t=""),e.style.transform=e.style.msTransform=e.style.webkitTransform=e.style.mozTransform=t}function deleteTransform(e){e&&(e.style.transform=e.style.msTransform=e.style.webkitTransform=e.style.mozTransform=null)}function deleteTransformOrigin(e){e&&(e.style.transformOrigin=e.style.msTransformOrigin=e.style.webkitTransformOrigin=e.style.mozTransformOrigin=null)}function getChildIndex(e){for(var t=0;null!=(e=e.previousSibling);)t++;return t}function getFilteredChildIndex(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t}function autoprefixTransformOrigin(e,t){t||(t=""),e.style.transformOrigin=e.style.msTransformOrigin=e.style.webkitTransformOrigin=e.style.mozTransformOrigin=t}function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);if(e.indexOf("Trident/")>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}var o=e.indexOf("Edge/");return o>0&&parseInt(e.substring(o+5,e.indexOf(".",o)),10)}function getImgDataSrc(e,t){var n=new XMLHttpRequest;n.open("GET",e),n.responseType="blob",n.onload=function(){var e=new FileReader;e.onloadend=function(){t&&t(e.result)},e.readAsDataURL(n.response)},n.send()}function isAbsoluteURLPath(e){return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||(0==e.trim().indexOf("data:")||void 0)))}function isAbsoluteURLAndNotDataPath(e){return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||void 0))}function isKotobeeHosted(e){e||(e=window.location.href);var t=e.split("://");if(!(t.length<=1)){for(var n=t[1],o=["kotobee.com"],r=0;r<o.length;r++){if(n.indexOf(o[r]+"/ebook")>=0)return!0;if(n.indexOf(o[r]+"/library")>=0)return!0;if(n.indexOf(o[r]+"/lti")>=0)return!0}if(e.indexOf(".kotobee.com")>=0){var i=e.replace(/https?:\/\/(.*?\.)kotobee\.com/g,"$1");if(i){var a=i.replace(/(.*?)\./g,"$1");return"www"!=a&&("dev"!=a&&("test"!=a&&"qa"!=a))}}}}function decodeHTMLEntities(e){for(var t=[["amp","&"],["apos","'"],["#x27","'"],["#x2F","/"],["#39","'"],["#47","/"],["lt","<"],["gt",">"],["nbsp"," "],["quot",'"']],n=0,o=t.length;n<o;++n)e=e.replace(new RegExp("&"+t[n][0]+";","g"),t[n][1]);return e}function addFormHiddenInput(e,t,n){var o=document.createElement("input");o.setAttribute("name",e),o.setAttribute("type","hidden"),o.setAttribute("value",t),n.appendChild(o)}function getElemMargin(e,t){return getElemDim(e,"margin",t)}function getElemPadding(e,t){return getElemDim(e,"padding",t)}function getElemDim(e,t,n){n||(n={});var o={},r=n.computed?getComputedStyle(e):e.style;return o.left=r[t+"Left"].split("px")[0],o.right=r[t+"Right"].split("px")[0],"auto"==o.left?o.x="auto":"auto"==o.left?o.x="auto":o.x=Math.round(o.left)+Math.round(o.right),o.top=r[t+"Top"].split("px")[0],o.bottom=r[t+"Bottom"].split("px")[0],"auto"==o.top?o.y="auto":"auto"==o.bottom?o.y="auto":o.y=Math.round(o.top)+Math.round(o.bottom),o}function makeArrayUnique(e){for(var t=0;t<e.length;t++)for(var n=e[t],o=e.length;o--;)t!=o&&e[o].length+"  "+n.length&&e[o]==n&&e.splice(o,1)}function cloneNodeAttributes(e){var t=document.createElement(e.nodeName);return copyAttributes(e,t),t}function copyAttributes(e,t){for(var n=0;n<e.attributes.length;n++)t.setAttribute(e.attributes[n].name,e.attributes[n].value)}function getBoundingBox(e){if(3==e.nodeType){var t=document.createRange();t.selectNode(e);var n=t.getBoundingClientRect();return t.detach(),n}return e.getBoundingClientRect()}function parents(e){for(var t=[];e;e=e.parentNode)t.unshift(e);return t}function getCurrentTime(){return Math.floor(Date.now()/1e3)}function getQueryStringValue(e){var t=window.location.href.split("?");if(!(t.length<=1))for(var n=t[1].split("&"),o=0;o<n.length;o++){var r=n[o].split("=");if(r[0]==e)return r[1]}}function copyObjToObj(e,t,n){n||(n={});for(var o in e)n.onlyIfNotExists&&null!=t[o]||(t[o]=e[o])}function traverseToBottom(e,t){for(;e&&e.children.length;){if(t&&e.id==t)return e;e=e.children[0]}return e}function traverseToTop(e,t){for(;e&&e.parentNode;){if(t&&e.id==t)return e;e=e.parentNode}return!e||e.parentNode?null:e.id!=t?null:e}function getDomainFromURL(e){var t=new URL(e);return t.protocol+"//"+t.hostname}function stopAllAudio(){for(var e=document.getElementsByTagName("audio"),t=0;t<e.length;t++)e[t].pause(),e[t].src="";try{document.bgAudio&&(document.bgAudio.pause(),document.bgAudio.src="")}catch(e){}}function applyPreview(e){var t=angular.element(document.body).scope();t.config=config=e,t.$apply(),angular.element(document.getElementById("home")).scope().injectUserCSS(e)}function previewPage(e,t){var n=angular.element(document.body).scope();n.previewPage&&n.previewPage(e,t)}function getCookie(e){var t=("; "+document.cookie).split("; "+e+"=");if(2==t.length)return t.pop().split(";").shift()}function getVar(e){return Modernizr.localstorage?localStorage[e]:getCookie("continueWithoutHTML5")}function setVar(e,t){Modernizr.localstorage?localStorage[e]=t:document.cookie=e+"="+t}function getGlobal(){return angular.element(document.body).scope()}function closePrintIframe(){var e=document.getElementById("printContainer");e&&e.parentNode.removeChild(e)}function putTest(e){return}function continueLocally(){setVar("continueLocally","true"),location.reload()}function continueWithoutHTML5(){setVar("continueWithoutHTML5","true"),location.reload()}function kInteractionStart(){this.log=function(e){},kInteractive.setDOMParser(),kInteractive.preRender(),kInteractive.postRender()}function kInteractionStartSingleElem(e){kInteractive.setDOMParser(),kInteractive.preRender(e,{singleElem:!0}),kInteractive.postRender(e,{singleElem:!0})}!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser),ph={},ph.removeHash=function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},ph.getHash=function(e){if(e.indexOf("#")>=0)return e.substr(e.lastIndexOf("#")+1)},ph.normalize=function(e){var t=ph.normalizedArray(e).join("/");return arguments.length&&"/"==arguments[0].substr(0,1)&&(t="file:///"+t),t},ph.normalizedArray=function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t},ph.basename=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1]},ph.removeFilename=function(e){var t=ph.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},ph.removeExtension=function(e){if(-1==e.indexOf("."))return e;var t=e.split(".");return t.splice(t.length-1,1),t.join(".")},ph.getExtension=function(e){if(-1==e.indexOf("."))return"";var t=e.split(".");return t[t.length-1]},ph.dirname=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1].indexOf(".")>=0&&t.splice(t.length-1,1),1==t.length?t[0]:t[t.length-1]},ph.relative=function(e,t){var n,o,r=ph.normalizedArray(e),i=ph.normalizedArray(t),a=new Array;for(r[r.length-1].indexOf(".")>=0&&r.splice(r.length-1,1),n=0;n<r.length&&r[n]==i[n];n++);for(o=n;o<r.length;o++)a.push("..");for(o=n;o<i.length;o++)a.push(i[o]);return a.join("/")},ph.join=function(){for(var e=new Array,t=0;t<arguments.length;t++){var n=ph.normalizedArray(arguments[t]);t<arguments.length-1&&!isAbsoluteURLPath(n[n.length-1])&&n[n.length-1].indexOf(".")>=0&&n.splice(n.length-1,1),e=e.concat(n)}var o=ph.normalize(e.join("/"));return"/"==arguments[0].substr(0,1)&&(o=desktop?"file:////"+o:"/"+o),o},ph.parent=function(e){e=ph.removeFilename(e);var t=ph.normalizedArray(e);t.splice(t.length-1,1);var n=t.join("/");return arguments.length&&"/"==arguments[0].substr(0,1)&&(n="/"+n),n};var startDate=Date.now(),LoggerWorker;try{(loggerWorker=new Worker(rootDir+"js/app/workers/logger.js")).addEventListener("error",function(){loggerWorker=null},!1)}catch(e){}var kLog=function(e){if(debug){null==e&&(e="null"),debugDuration&&(e=Date.now()-startDate+" "+e);try{if(loggerWorker)return void loggerWorker.postMessage({func:"log",params:arguments})}catch(e){}console.log.apply(this,arguments)}},log=kLog,Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(e){var t=e.length/4*3,n=new ArrayBuffer(t);return this.decode(e,n),n},decode:function(e,t){var n=this._keyStr.indexOf(e.charAt(e.length-1)),o=this._keyStr.indexOf(e.charAt(e.length-2)),r=e.length/4*3;64==n&&r--,64==o&&r--;var i,a,s,l,c,d,u,p=0,f=0;for(i=t?new Uint8Array(t):new Uint8Array(r),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),p=0;p<r;p+=3)a=this._keyStr.indexOf(e.charAt(f++))<<2|(c=this._keyStr.indexOf(e.charAt(f++)))>>4,s=(15&c)<<4|(d=this._keyStr.indexOf(e.charAt(f++)))>>2,l=(3&d)<<6|(u=this._keyStr.indexOf(e.charAt(f++))),i[p]=a,64!=d&&(i[p+1]=s),64!=u&&(i[p+2]=l);return i}},currentIndex,currentVIndex,parser=new DOMParser,preview,previewParams,app,mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),mobileDebug=!1,ios=/iPhone|iPad|iPod/i.test(navigator.userAgent),readerV=1.4,debug=!1,native,bookPath,noFlash,desktop,chromeApp,os,uuid,loggerWorker,partitionEnabled="Android"==mobile&&config.kotobee.segregate,isKotobee=!0,debugDuration=!1,swipeMode="chapter",parseSecsSeparate=!0,overflowScroll=!mobile|config.overflowScroll,rootDir="",postOptions={transformRequest:angular.identity,headers:{"Content-Type":void 0}};null==config.mediaTab&&(config.mediaTab=!0),null==config.settingsTab&&(config.settingsTab=!0),null==config.notebookTab&&(config.notebookTab=!0),null==config.textSizeControls&&(config.textSizeControls=!0),null==config.chaptersTab&&(config.chaptersTab=!0),null==config.showCategories&&(config.showCategories=!0),null==config.styleControls&&(config.styleControls=!1),function(){function e(){for(var e=document.getElementsByTagName("head")[0],t=e.innerHTML,n=[],o=[],r=document.getElementsByTagName("script"),i=0;i<r.length;i++)if(r[i].getAttribute("src")&&r[i].getAttribute("src").indexOf("lib/ionic/release/js")>=0){var a=r[i].getAttribute("src").split("lib/ionic/release/js");rootDir=a[0];break}try{(loggerWorker=new Worker(rootDir+"js/workers/logger.js")).addEventListener("error",function(){loggerWorker=null},!1)}catch(e){}n=[rootDir+"lib/ionic/release/css/ionic.min.css"];for(i=0;i<o.length;i++)t+='<script src="'+o[i]+'"><\/script>';for(i=0;i<n.length;i++)t='<link rel="stylesheet" href="'+n[i]+'">'+t;e.innerHTML=t}function t(){var e=document.getElementsByTagName("body");e.length?addClass(e[0],"ie"):timeOut(t,100)}if(detectIE()&&t(),window.location.href.indexOf("?preview")>0){preview=!0,mobileDebug=!0;var n=window.location.href.split("?");n=n[1].split("&"),previewParams={};for(var o=0;o<n.length;o++){var r=n[o].split("=");previewParams[r[0]]=r[1]}mobile=previewParams.mobile}else{if(config.gAnalyticsID){var i="";isKotobeeHosted()&&(i="/bundles/vijualib/templates/reader/public/");var a="";(native||desktop)&&(a="ga('set','checkProtocolTask',null);ga('set','anonymizeIp',true);ga('set','forceSSL',true)");var s="'auto'";native?s="{'storage':'none','clientId':device.uuid}":desktop&&(s="{'storage':'none'}");var l=document.createElement("script");l.innerHTML="(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','"+i+"lib/gAnalytics/analytics.js','ga');ga('create', '"+config.gAnalyticsID+"', "+s+");"+a;var c=document.getElementsByTagName("head");c.length&&c[0].appendChild(l)}if("file:"==window.location.protocol||"undefined"!=typeof require){if(mobile)native=!0;else if("undefined"!=typeof require)desktop=!0,os="mac",process.env.OS&&process.env.OS.toLowerCase().indexOf("windows")>=0&&(os=process.env.PROCESSOR_ARCHITECTURE.indexOf("64")>=0?"win64":"win32");else if(window.chrome&&chrome.app&&chrome.app.runtime&&chrome.storage){try{if(!chromeEnabled)return}catch(e){return}chromeApp=!0}else if("true"!=getVar("continueLocally"))return timeOut(function(){document.getElementById("localFallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e()}else"chrome-extension:"==window.location.protocol&&(chromeApp=!0)}if(!chromeApp){if("true"!=getVar("continueWithoutHTML5")&&!(Modernizr.audio&&Modernizr.video&&Modernizr.backgroundsize&&Modernizr.borderradius&&Modernizr.canvas&&Modernizr.opacity&&Modernizr.localstorage&&Modernizr.rgba))return timeOut(function(){document.getElementById("html5Fallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e();setVar("continueLocally","false"),setVar("continueWithoutHTML5","false")}e(),angular.module("ngIOS9UIWebViewPatch",["ng"]).config(["$provide",function(e){"use strict";e.decorator("$browser",["$delegate","$window",function(e,t){return function(e){return/(iPhone|iPad|iPod).* OS 9_\d/.test(e)&&!/Version\/9\./.test(e)}(t.navigator.userAgent)?function(e){function t(){n=null}var n=null,o=e.url;return e.url=function(){return arguments.length?(n=arguments[0],o.apply(e,arguments)):n||o.apply(e,arguments)},window.addEventListener("popstate",t,!1),window.addEventListener("hashchange",t,!1),e}(e):e}])}]),app=angular.module("reader.Kotobee",["templates","ionic","angular.css.injector","scormwrapper","ngIOS9UIWebViewPatch"]),ionic.Platform.isFullScreen=!1,app.config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider","$compileProvider",function(e,t,n,o){(chromeApp||desktop)&&(o.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),o.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|chrome-extension):/)),n.views.swipeBackEnabled(!1),t.otherwise("/loading"),e.state("home",{url:"/loading",templateUrl:kTemplate("views/home.html")}).state("login",{url:"/login",templateUrl:kTemplate("views/login.html")}).state("register",{url:"/register",templateUrl:kTemplate("views/register.html")}).state("forgotPwd",{url:"/forgotpwd",templateUrl:kTemplate("views/forgotPwd.html")}).state("redeemCode",{url:"/redeemcode",templateUrl:kTemplate("views/redeemCode.html")}).state("library",{url:"/library",templateUrl:kTemplate("views/library.html")}).state("library_tab",{url:"/library/tab/:tab",templateUrl:kTemplate("views/library.html")}).state("reader",{url:"/reader",templateUrl:kTemplate("views/reader.html")}).state("reader.chapter",{url:"/chapter/:ch",templateUrl:kTemplate("views/reader.html")}).state("reader.chapterhash",{url:"/chapter/:ch/:hash",templateUrl:kTemplate("views/reader.html")}).state("libraryreader",{url:"/book/:book/reader",templateUrl:kTemplate("views/reader.html")}).state("libraryreader.chapter",{url:"/chapter/:ch",templateUrl:kTemplate("views/reader.html")}).state("libraryreader.chapterhash",{url:"/chapter/:ch/:hash",templateUrl:kTemplate("views/reader.html")}).state("app",{url:"/app",templateUrl:kTemplate("views/app.html")})}]),putTest("prerun timeout start"),window.setTimeout(function(){putTest("prerun timeout found!!")},300),app.run(["$ionicPlatform","$location","chapters","library",function(e,t,n,o){var r=t.path();if(0==r.indexOf("/book/")&&(a=(i=r.split("/book/")[1]).split("/")).length>0&&(o.startBook=Number(a[0])),r.indexOf("/reader/chapter/")>=0){var i=r.split("/reader/chapter/")[1],a=i.split("/");a.length>0&&(n.startChapter=Number(a[0])),a.length>1&&(n.startHash=a[1])}t.path("/loading"),e.ready(function(){try{try{ios||StatusBar&&(StatusBar.overlaysWebView(!1),StatusBar.backgroundColorByHexString("#2c1c3c"))}catch(e){}try{document.addEventListener("deviceready",function(){},!1)}catch(e){}try{navigator.splashscreen&&setTimeout(function(){navigator.splashscreen.hide()},1e3)}catch(e){}putTest("app 1"),putTest(setTimeout),putTest(window.setTimeout),putTest(window.setTimeout==setTimeout),window.setTimeout(function(){putTest("timeout A")},100),putTest("app 1b"),window.setTimeout(function(){putTest("timeout B")},300),putTest("app 1c"),setTimeout(function(){putTest("timeout C")},600),putTest("app 1d"),window.setTimeout(function(){putTest("timeout D")},600),putTest("app 1e"),setTimeout(function(){putTest("app 1a");try{cordova,window.cordova,cordova.plugins,window.cordova.plugins;putTest("app 2")}catch(e){putTest("app 3")}putTest("app 4"),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),putTest("app 5"),window.StatusBar&&StatusBar.styleDefault(),putTest("app 6"),putTest(angular.element(document.body).scope().start),angular.element(document.body).scope().start(),putTest("app 7")},native?1e3:0),putTest("setTimeout called")}catch(e){putTest("in catch"),putTest(e)}})}])}();var kInteractive={scormWrapper:null,preRender:function(e,t){t||(t={});var n,o=t.singleElem,r=(new DOMParser,e||document);o?(n=[e],r=document):n=r.getElementsByClassName("kInteractive");var i;void 0!==isKotobee&&(i=t.chapterUrl?t.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var a=n.length;a--;){var s=n[a];if(this.hasClass(s,"gallery")){var l=r.createDocumentFragment(),c=kInteractive.readData(s);if(!c)continue;s.innerHTML="";var d=document.createElement("div");d.className="imgMask";var u=document.createElement("div");u.className="images "+c.scale,d.appendChild(u);for(S=0;S<c.imgs.length;S++){var p=document.createElement("div");p.className="imgContainer"+(S?"":" selected");ee=void 0===isKotobee?c.imgs[S].path:ph.join(i,c.imgs[S].path);p.setAttribute("style","background-color:"+c.bgColor+";background-image:url('"+ee+"')"+(S?"":";display:block")),c.imgs[S].caption&&p.setAttribute("data-caption",c.imgs[S].caption),u.appendChild(p)}l.appendChild(d);var f=document.createElement("div");f.className="imgCaption";var g=document.createElement("div");g.className="inner",g.style.display="none",c.imgs[0]&&c.imgs[0].caption&&(g.innerHTML=c.imgs[0].caption,g.style.display=null),f.appendChild(g),l.appendChild(f);var h=document.createElement("a");h.className="next btn ki-btn",1==c.imgs.length&&(h.className+=" disable"),l.appendChild(h);var m=document.createElement("a");m.className="prev btn ki-btn disable",l.appendChild(m),void 0===isKotobee&&(h.addEventListener("click",this.actionEvent),m.addEventListener("click",this.actionEvent));Z=document.createElement("div");c.style&&kInteractive.c.addClass(Z,c.style),Z.appendChild(l),s.appendChild(Z)}if(this.hasClass(s,"image")||"img"==s.nodeName.toLowerCase()){var v=kInteractive.readData(s);if(!v)continue;v.style&&kInteractive.c.addClass(s,v.style)}if(this.hasClass(s,"questions")){var l=r.createDocumentFragment(),b=kInteractive.readData(s);if(!b)continue;var y=b.dict,k=b.userDict;y||(y={}),k||(k=y),b.options||(b.options={}),s.id||(s.id="ki-qs-"+a+"-"+Math.ceil(1e3*Math.random()));if(s.innerHTML="",b.layout&&b.layout.popup&&!this.hasClass(s,"inpopup")){var w=document.createElement("img"),C=b.layout.popupImg;w.src=C,l.appendChild(w),void 0===isKotobee&&w.addEventListener("click",this.actionEvent),s.appendChild(l);continue}if(b.options.randomize){for(S=0;S<b.q.length;S++)b.q[S].origin=S;for(var x,I,E=b.q.length;0!==E;)I=Math.floor(Math.random()*E),E-=1,x=b.q[E],b.q[E]=b.q[I],b.q[I]=x}if(b.options.questionsDisplayed){var T=Number(b.options.questionsDisplayed);b.q=b.q.slice(0,T)}if(b.title){var O=document.createElement("span");O.innerHTML="<h4>"+kInteractive.escapeHtml(b.title)+"</h4>",l.appendChild(O)}for(var S=0;S<b.q.length;S++){var A=b.q[S],B=document.createElement("div");if(B.className="ques",null!=A.origin&&B.setAttribute("data-o",A.origin),B.innerHTML="<p><strong><span class='no'>"+(S+1)+"</span> "+kInteractive.escapeHtml(A.q)+"</strong></p>",A.path){var N=document.createElement("img");N.src=A.path,B.appendChild(N)}if("sa"==A.type){var L=A.lines?A.lines:1,M=document.createElement(L>1?"textarea":"input");M.name="sa-"+S,1==L?M.type="text":M.rows=A.lines?A.lines:1,M.className="ans txtfield";H="ki-sa-"+a+"-"+S;M.id=H,document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[S]&&(M.value=document[s.id].q[S]),B.appendChild(M)}else if("mcq"==A.type||"mmcq"==A.type)for(var $=A.c,P=0;P<$.length;P++){var H="ki-mcq-"+a+"-"+S+"-"+P,R=document.createElement("input");"mmcq"==A.type?(R.name="name",R.type="checkbox"):(R.name="mcq-"+S,R.type="radio"),R.className="ans",R.id=H,(Y=document.createElement("label")).htmlFor=H,Y.innerHTML=" "+kInteractive.escapeHtml($[P].t)+"<br/>",Y.className="ki-noHighlight",(F=document.createElement("div")).className="answer",document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[S]&&(R.checked=document[s.id].q[S][P],b.options&&b.options.highlightCorrect&&b.q[S].c[P].a&&kInteractive.c.addClass(F,"correct")),F.appendChild(R),F.appendChild(Y),B.appendChild(F)}else if("tf"==A.type)for(P=0;P<2;P++){var H="ki-tf-"+a+"-"+S+"-"+P,D=document.createElement("input");D.type="radio",D.name="tf-"+S,D.className="ans",D.id=H,(Y=document.createElement("label")).htmlFor=H,A.choice1&&A.choice2?Y.innerHTML=kInteractive.escapeHtml(" "+(0==P?A.choice1:A.choice2)):Y.innerHTML=" "+(0==P?"True":"False"),Y.className="ki-noHighlight";var F=document.createElement("div");document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[S]&&(D.checked=document[s.id].q[S][P],b.options&&b.options.highlightCorrect&&(0==P&&b.q[S].a||1==P&&!b.q[S].a)&&kInteractive.c.addClass(F,"correct")),F.appendChild(D),F.appendChild(Y),B.appendChild(F)}if((J=document.createElement("p")).className="separator",B.appendChild(J),document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[S]){if(b.q[S].exp&&!B.getElementsByClassName("explanation").length){var z=document.createElement("p");z.className="explanation",z.innerHTML=kInteractive.escapeHtml(b.q[S].exp),kInteractive.appendAfterDelay(B,z)}if(b.q[S].ref&&!B.getElementsByClassName("reference").length){var j=document.createElement("a");j.className="reference",j.innerHTML=k.learnMode?k.learnMode:"Learn more",j.setAttribute("href",kInteractive.escapeHtml(b.q[S].ref)),j.setAttribute("target","_blank"),kInteractive.appendAfterDelay(B,j)}}l.appendChild(B)}if(b.options.emailForm){var V=document.createElement("div");V.setAttribute("class","emailForm"),function(e,t,n){var o=document.createElement("div");o.className="address",o.innerHTML="<p><strong>"+e+"</strong><em>"+t+"</em></p>";var r=document.createElement("input");r.name=n,r.type="text",r.className="txtfield",o.appendChild(r);var i=document.createElement("p");i.className="separator",o.appendChild(i),V.appendChild(o)}(k.recipientEmail?k.recipientEmail:"Recipient email",k.separateEmails?k.separateEmails:"Separate multiple emails with commas","recipientEmail"),l.appendChild(V)}var U=null;if("none"!=b.action){var q="ki-"+a+"-btn";(U=document.createElement("input")).type="submit",U.value=k.submit?k.submit:"Submit Answers",U.id=q,U.className="btn ki-btn ki-mcq"}var W=null,_=null;if(b.options&&(b.options.clearAnswers&&((W=document.createElement("input")).type="submit",W.value=k.clear?k.clear:"Clear Answers",W.className="btn ki-btn ki-questions questions-clear",void 0===isKotobee&&W.addEventListener("click",this.actionEvent)),b.options.addToNotebook&&((W=document.createElement("input")).type="submit",W.value=k.notebook?k.notebook:"Save to Notebook",W.className="btn ki-btn ki-questions questions-notebook",void 0===isKotobee&&W.addEventListener("click",this.actionEvent)),b.options.preserveAnswers)){(_=document.createElement("div")).style.marginTop="5px";var K=document.createElement("input");K.type="checkbox",K.name="preserveAnswers",K.className="ki-btn ki-questions questions-preserve",K.id="ki-"+a+"-preserveAnswersBtn",document[s.id]&&(K.checked=document[s.id].preserve),_.appendChild(K);var Y=document.createElement("label");Y.htmlFor=K.id,Y.innerHTML=" "+(k.preserve?k.preserve:"Preserve submitted answers"),Y.className="ki-noHighlight",_.appendChild(Y),void 0===isKotobee&&K.addEventListener("change",this.actionEvent)}void 0===isKotobee&&U&&U.addEventListener("click",this.actionEvent),U&&l.appendChild(U),l.appendChild(document.createTextNode(" ")),W&&l.appendChild(W),_&&l.appendChild(_);var J=document.createElement("p");J.className="separator",l.appendChild(J),b.options.rtl?(s.style.direction="rtl",kInteractive.c.addClass(s,"rtl")):s.style.direction="ltr";var Z=document.createElement("div");b.style&&kInteractive.c.addClass(Z,b.style),Z.appendChild(l),s.appendChild(Z)}if(this.hasClass(s,"image")){if(s.parentNode&&this.hasClass(s.parentNode,"link"))continue;void 0===isKotobee&&s.addEventListener("click",this.actionEvent)}if(this.hasClass(s,"link")){var G=kInteractive.readData(s);if(!G)continue;if("undefined"!=typeof editorMode&&editorMode)continue;if("div"==s.nodeName.toLowerCase()){var X=document.createElement("a");X.setAttribute("href","popup"==G.type?"":s.getAttribute("href")),X.setAttribute("target",G.target),X.setAttribute("style",s.getAttribute("style")),X.setAttribute("data-kotobee",s.getAttribute("data-kotobee")),X.className="kInteractive link btn",X.style.opacity=Number(G.transparency)/100,s.parentNode.replaceChild(X,s),s=X}void 0===isKotobee&&("popup"!=G.type&&"audio"!=G.type&&"action"!=G.type||s.setAttribute("onclick","return false;"),s.addEventListener("click",this.actionEvent))}if(this.hasClass(s,"container")){var Q=kInteractive.readData(s);if(!Q)continue;if(Q.path){var ee=Q.path;void 0!==isKotobee&&(ee=ph.join(i,Q.path));var te=s.getAttribute("style");s.setAttribute("style",te+' background-image:url("'+ee+'");')}}}},clearAudioVideo:function(e){var t=e||document;kInteractive.stopCurrentMedia();for(var n=t.getElementsByTagName("audio"),o=n.length;o--;)try{if(n[o].hasAttribute("data-dontclose"))continue;n[o].pause(),n[o].children.length||(n[o].src="")}catch(e){}for(var r=t.getElementsByTagName("video"),o=r.length;o--;)r[o].pause(),r[o].children.length||(r[o].src="")},postRender:function(e,t){t||(t={});var n,o=t.singleElem;void 0!==isKotobee&&(n=t.chapterUrl?t.chapterUrl:angular.element(document.body).scope().data.book.chapter.absoluteURL),kInteractive.videoIsFullscreen=!1,kInteractive.timestamp=new Date,kInteractive.currentVideo=kInteractive.currentAudio=null,kInteractive.clearAudioVideo(e);var r,i=e||document;o?(r=[e],i=document):r=i.getElementsByClassName("kInteractive");for(var a=r.length;a--;){var s=r[a];if(this.hasClass(s,"container")){var l=kInteractive.readData(s);if(!l)continue;kInteractive.isMobile()&&"cScroll"==l.type&&void 0!==isKotobee&&angular.element(document.body).scope().applyNativeScroll(s)}else if(this.hasClass(s,"questions")){var c=kInteractive.readData(s);if(!c)continue;var d=c.dict,u=c.userDict;d||(d={}),u||(u=d);for(var p=s.getElementsByClassName("ques"),f=s.getElementsByClassName("explanation"),g=f.length;g--;)f[g].parentNode.removeChild(f[g]);for(var h=s.getElementsByClassName("reference"),g=h.length;g--;)h[g].parentNode.removeChild(h[g]);for(var m=0;m<p.length;m++){var v=p[m].getElementsByClassName("ans"),b=(v.length,m);if(c.options.randomize&&(b=Number(p[m].getAttribute("data-o"))),document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[b]){if(c.q[b].exp&&!p[m].getElementsByClassName("explanation").length){var y=document.createElement("p");y.className="explanation",y.innerHTML=kInteractive.escapeHtml(c.q[b].exp),kInteractive.appendAfterDelay(p[m],y)}if(c.q[b].ref&&!p[m].getElementsByClassName("reference").length){var k=document.createElement("a");k.className="reference",k.innerHTML=u.learnMode?u.learnMode:"Learn more",k.setAttribute("href",kInteractive.escapeHtml(c.q[b].ref)),k.setAttribute("target","_blank"),kInteractive.appendAfterDelay(p[m],k)}}for(g=0;g<v.length;g++)kInteractive.c.removeClass(v[g].parentNode,"correct"),v[g].getAttribute("id").indexOf("ki-tf-")>=0?document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[b]&&(v[g].checked=document[s.id].q[b][g],c.options&&c.options.highlightCorrect&&(0==g&&c.q[b].a||1==g&&!c.q[b].a)&&kInteractive.c.addClass(v[g].parentNode,"correct")):v[g].getAttribute("id").indexOf("ki-sa-")>=0?document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[b]&&(v[g].value=document[s.id].q[b]):document[s.id]&&document[s.id].preserve&&document[s.id].q&&document[s.id].q[b]&&(v[g].checked=document[s.id].q[b][g],c.options&&c.options.highlightCorrect&&c.q[b].c[g].a&&kInteractive.c.addClass(v[g].parentNode,"correct"));if(document[s.id]){var w=s.getElementsByClassName("questions-preserve");w.length&&(w[0].checked=document[s.id].preserve)}}}else if(this.hasClass(s,"widget")){var C=i.createDocumentFragment(),x=kInteractive.readData(s);if(!x)continue;var I=x.name,E=(x.src,x.width),T=x.height;if("page"==x.mode){if(s.children.length)continue;var O=document.createElement("div");O.className="cover",C.appendChild(O),x.interaction&&(O.style.pointerEvents="none");var S=document.createElement("div");S.className="iframeContainer";var A=document.createElement("iframe");A.setAttribute("nwdisable","true"),A.setAttribute("nwfaketop","true"),A.setAttribute("width",s.style.width?s.style.width:E+x.widthUnit),A.setAttribute("height",s.style.height?s.style.height:T+"px"),A.src=kInteractive.getWidgetUrl(x,t),S.appendChild(A),C.appendChild(S);var B=s.style.width,N=s.style.height;B.indexOf("px")>=0&&(x.widthUnit="px"),B.indexOf("%")>=0&&(x.widthUnit="%");try{x.widthUnit?x.width=Number(B.split(x.widthUnit)[0]):x.width=Number(B)}catch(e){x.width=Number(B)}try{x.height=Number(N.split("px")[0])}catch(e){x.height=Number(N)}kInteractive.writeData(s,x)}else{if(!s.children.length&&!s.innerHTML.trim()){var L=document.createElement("img");L.src=kInteractive.getWidgetHome(x,t)+"/"+I+"/Icon.png",L.className="wdgtIcon",C.appendChild(L)}void 0===isKotobee&&s.addEventListener("click",this.actionEvent)}s.appendChild(C)}else if(this.hasClass(s,"video")){var C=i.createDocumentFragment(),M=kInteractive.readData(s);if(!M)continue;var $="";if(M.splash&&($=void 0===isKotobee?M.splash:ph.join(n,M.splash)),$){s.style.backgroundImage=null;var P=s.style.cssText;s.setAttribute("style","background-image:url('"+$+"');"+P)}s.setAttribute("id","ki-video-"+a),s.innerHTML="",(R=document.createElement("div")).setAttribute("id","ki-video-"+a+"-container"),R.className="container";F=document.createElement("div");M.style&&kInteractive.c.addClass(F,M.style),(D=document.createElement("a")).className="playBtn ki-btn",D.appendChild(document.createElement("span")),void 0===isKotobee&&D.addEventListener("click",this.actionEvent),C.appendChild(D),C.appendChild(R),F.appendChild(C),s.appendChild(F),M.autoplay&&kInteractive.action(s)}else if(this.hasClass(s,"audio")){var C=i.createDocumentFragment(),H=kInteractive.readData(s);s.setAttribute("id","ki-audio-"+a),s.innerHTML="";var R=document.createElement("div");R.setAttribute("id","ki-audio-"+a+"-container"),R.className="container";var D=document.createElement("a");D.className="playBtn ki-btn",D.appendChild(document.createElement("span")),void 0===isKotobee&&D.addEventListener("click",this.actionEvent);var F=document.createElement("div");H.style&&kInteractive.c.addClass(F,H.style),C.appendChild(D),C.appendChild(R),F.appendChild(C),s.appendChild(F)}else if(this.hasClass(s,"threed")){var C=i.createDocumentFragment(),z=kInteractive.readData(s);if(!z)continue;s.innerHTML="";var j=s.getAttribute("style");z.inter.placeholderPath&&(j+="background-image:url('"+(void 0===isKotobee?z.inter.placeholderPath:ph.join(n,z.inter.placeholderPath))+"');"),s.setAttribute("style",j);var V=document.createElement("a");z.inter.includeMsg?(V.innerHTML=kInteractive.escapeHtml(z.inter.msg),V.className="msgBtn ki-btn"):V.className="invisibleBtn ki-btn",C.appendChild(V),void 0===isKotobee&&V&&V.addEventListener("click",this.actionEvent),s.appendChild(C)}else if(this.hasClass(s,"gallery"));else if(this.hasClass(s,"image")){var U=kInteractive.readData(s);if(!U)continue;U&&(U.behavior&&"none"!=U.behavior||(s.style.transition=s.style.webkitTransition=s.style.mozTransition="none"))}}this.firstRun&&(window.addEventListener("resize",function(t){kInteractive.resizeEvent(e,o)}),this.firstRun=!1),kInteractive.resizeEvent(e,o)},actionEvent:function(e){kInteractive.action(e.target)},action:function(e,t){function n(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t}function o(){var e="Questions: "+m+". Score: "+b+" questions out of "+k;e+=". Action: "+U,"selfAnswerReport"==U&&(e+=". Details: "+w),kInteractive.tinCan({verb:"solved",activity:e})}function r(){he||(kInteractive.c.addClass(ve,"hide"),he=!0)}function i(e,t){e.style.webkitAnimation=e.style.mozAnimation=e.style.animation=t}function a(e,t){e.style.webkitAnimationDuration=e.style.mozAnimationDuration=e.style.animationDuration=t}function s(e,t){e.style.webkitAnimationIterationCount=e.style.mozAnimationIterationCount=e.style.animationIterationCount=t}function l(e){var t=document.createElement("video");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("src",e),t.setAttribute("autoplay","true"),t.setAttribute("data-tap-disabled","false");var n;0!=e.indexOf("http://")&&0!=e.indexOf("https://")||(n=!0),n&&t.setAttribute("crossorigin","anonymous");var o=!1;try{o=navigator.userAgent.toLowerCase().indexOf("android")>-1}catch(e){}o||t.setAttribute("type","video/mp4"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.className="ki-noHighlight",Me.hideDownloadBtn&&(t.className+=" hideDownloadBtn"),t.innerHTML="Your browser doesn't support HTML5 video.",n&&(t.crossOrigin="anonymous"),t.oncanplay=function(){kInteractive.currentVideo==u&&(pe.className="playBtn ki-btn hide",kInteractive.tinCan({verb:"played",activity:"Video: "+e}))},t.addEventListener("error",function(e){kInteractive.stopCurrentMedia()}),t.addEventListener("webkitfullscreenchange",function(e){var t=null!==document.webkitFullscreenElement;kInteractive.videoIsFullscreen=t});var r=u.getElementsByClassName("container")[0];r.setAttribute("data-tap-disabled","true"),r.appendChild(t)}function c(){function e(e){function n(t){if(!(t>=ze.objects.length)){var o=ze.objects[t],i=void 0===isKotobee?o.path:ph.join(d,o.path);new THREE.OBJLoader(c).load(i,function(i){je&&je.parentNode&&je.parentNode.removeChild(je),r.domElement.parentNode||e.appendChild(r.domElement),i.position.set(o.x,o.y,o.z),i.traverse(function(e){if(e instanceof THREE.Mesh){var r=e==i.children[i.children.length-1];if(o.textPath){var a=new THREE.ImageLoader(c),s=void 0===isKotobee?o.textPath:ph.join(d,o.textPath);a.load(s,function(o){var a=new THREE.Texture;a.image=o,a.needsUpdate=!0,e.material.map=a,r&&l.add(i),n(++t)},function(){},function(e){})}else r&&l.add(i),n(++t)}})},function(e){e.lengthComputable&&(e.loaded,e.total)},function(e){})}}function o(){try{r.render(l,s)}catch(e){return}b.getDelta();t=requestAnimFrame(o)}kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("_3D",ze.name?ze.name:"Model"),e.description="Opened 3D model: "+(ze.name?ze.name:"No name"),e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800),t&&cancelAnimationFrame(t);var r;r=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}()?new THREE.WebGLRenderer({precision:"highp"}):new THREE.CanvasRenderer;var i=e.offsetWidth,a=e.offsetHeight,s=new THREE.PerspectiveCamera(ze.camera.viewAngle,i/a,ze.camera.near,ze.camera.far),l=new THREE.Scene;null!=ze.scene.bgColor&&r.setClearColor(ze.scene.bgColor,1),l.add(s),s.position.x=ze.camera.x,s.position.y=ze.camera.y,s.position.z=ze.camera.z,r.setSize(i,a),ze.scene.floor&&(floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500,1,1),new THREE.MeshPhongMaterial({color:ze.scene.floorColor?ze.scene.floorColor:10066329})),floor.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),floor.position.y=-80,floor.receiveShadow=!0,l.add(floor));var c=new THREE.LoadingManager;c.onProgress=function(e,t,n){},n(0),new THREE.OrbitControls(s,r.domElement).target=new THREE.Vector3(0,0,0);for(var u=0;u<ze.lights.length;u++)if("pointLight"==ze.lights[u].type){var p=new THREE.PointLight(ze.lights[u].color);p.position.set(ze.lights[u].x,ze.lights[u].y,ze.lights[u].z),l.add(p)}else if("directionalLight"==ze.lights[u].type){var f=new THREE.DirectionalLight(ze.lights[u].color,ze.lights[u].intensity);f.position.set(ze.lights[u].x,ze.lights[u].y,ze.lights[u].z),l.add(f)}else if("hemisphereLight"==ze.lights[u].type){var g=new THREE.HemisphereLight(ze.lights[u].sky,ze.lights[u].ground,ze.lights[u].intensity);g.position.set(ze.lights[u].x,ze.lights[u].y,ze.lights[u].z),l.add(g)}else if("spotLight"==ze.lights[u].type){var h=new THREE.SpotLight(ze.lights[u].color,ze.lights[u].intensity,ze.lights[u].distance,ze.lights[u].angle,ze.lights[u].exponent,ze.lights[u].decay);h.position.set(ze.lights[u].x,ze.lights[u].y,ze.lights[u].z),l.add(h)}else if("ambientLight"==ze.lights[u].type){var m=new THREE.AmbientLight(ze.lights[u].color);l.add(m)}else if("areaLight"==ze.lights[u].type){var v=new THREE.AreaLight(ze.lights[u].color,ze.lights[u].intensity);l.add(v)}var b=new THREE.Clock;o()}var t,n=u;if("inPanel"==ze.inter.target){var o={};o.class="threed",o.cb=function(t){var n=document.createElement("div");n.className="container",t.appendChild(n),e(n)},o.closed=function(){kInteractive.c.removeClass(u,"running")},kInteractive.openFrame(o)}else e(n)}if("undefined"==typeof editorMode||!editorMode){var d;void 0!==isKotobee&&(d=angular.element(document.body).scope().data.book.chapter.absoluteURL);for(var u=e;!this.hasClass(u,"kInteractive");){if(!u.parentNode)return;if((u=u.parentNode)==document.body)return}if(this.hasClass(u,"questions")){var p=kInteractive.readData(u);if(!p)return;var f=p.dict,g=p.userDict;if(f||(f={}),g||(g=f),p.layout&&p.layout.popup&&!this.hasClass(u,"inpopup")&&"img"==e.nodeName.toLowerCase()){var h=document.getElementById("epubContent");return h&&u.setAttribute("data-loc",function(e,t){for(var o="";e!=t;)o=n(e)+"."+o,e=e.parentNode;return""==o?"":o.substr(0,o.length-1)}(u,h)),(ae=document.createElement("iframe")).setAttribute("nwdisable","true"),ae.setAttribute("nwfaketop","true"),p.cb=function(e){function t(){if(void 0!==isKotobee){var e={};e.root=ae.contentDocument.documentElement.ownerDocument.body,e.rootIndex=u.getAttribute("data-loc"),angular.element(document.body).scope().getNotebookShortcut(e,function(){})}}var n,o=document.createElement("head");if(void 0===isKotobee){for(var r=document.getElementsByTagName("link"),i=0;i<r.length;i++){var a=r[i];if(a.getAttribute("href").indexOf("base.css")>=0){var s=a.getAttribute("href").split("/");delete s[s.length-1],n=s.join("/");break}}if(!n)return}var l=void 0===isKotobee?n+"../xhtml/":bookPath+"EPUB/xhtml/",o="<head>";if(o+='<base href="'+kInteractive.c.removeFilename(kInteractive.c.removeHash(window.location.href))+"/"+l+'"/>',o+='<link rel="stylesheet" type="text/css" href="../css/base.css" />',o+='<link rel="stylesheet" type="text/css" href="../css/global.css" />',o+='<link rel="stylesheet" type="text/css" href="../css/kotobeeInteractive.css" />',o+='<script type="text/javascript" src="../js/kotobeeInteractive.js"><\/script>',o+='<script type="text/javascript" src="../js/global.js"><\/script>',void 0!==isKotobee){var c=clone(config);c.kotobee.email=angular.element(document.body).scope().data.user.email,o+='<script type="text/javascript">var config='+JSON.stringify(c)+";<\/script>"}o+='<meta charset="utf-8" />',o+="</head>";var d=u.outerHTML;d=(d=(d=(d=(d=(d=d.replace("<img",'<img style="display:none"')).replace(/([;\s]*?height:)(.*)?;/i,"$1auto")).replace(/([;\s]*?width:)(.*)?;/i,"$1auto")).replace(/([;\s]*?top:)(.*)?;/i,"$1auto")).replace(/([;\s]*?left:)(.*)?;/i,"$1auto")).replace('class="','class="inpopup ');var p="<html>"+o+"<body>"+(d+='<div class="vSpace20"></div>')+"</body></html>";ae.setAttribute("srcdoc",p);var f="javascript: window.frameElement.getAttribute('srcdoc');";ae.setAttribute("src",f),ae.contentWindow&&(ae.contentWindow.location=f),e.appendChild(ae),ae.addEventListener?ae.addEventListener("load",t,!0):ae.attachEvent&&ae.attachEvent("onload",t)},p.closed=function(){},p.pos=p.layout.pos,kInteractive.openFrame(p),kInteractive.tinCan({verb:"opened",activity:"Questions: "+p.title}),void(kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("question",p.title),e.description="Opened question popup: "+p.title,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800))}var m="Untitled questions",v=u.getElementsByTagName("h4");v.length&&(m=v[0].textContent||v[0].data);var b=0,y=u.getElementsByClassName("ques"),k=y.length,w="";if(this.hasClass(e,"kInteractive"))return;if(this.hasClass(e,"questions-clear")){for(var C=u.getElementsByClassName("ans"),x=0;x<C.length;x++)C[x].checked=!1,C[x].value=null,kInteractive.c.removeClass(C[x].parentNode,"correct");for(x=(F=u.getElementsByClassName("explanation")).length;x--;)F[x].parentNode.removeChild(F[x]);for(x=(z=u.getElementsByClassName("reference")).length;x--;)z[x].parentNode.removeChild(z[x]);return void(document[u.id]=null)}if(this.hasClass(e,"questions-notebook")){var I=p.layout&&p.layout.popup&&this.hasClass(u,"inpopup");if(void 0===isKotobee&&!I)return void kInteractive.alert({content:f.kotobeeOnly,title:g.sorry?g.sorry:"Sorry"});var E,T={elem:u};if(void 0!==isKotobee)E=angular.element(document.body).scope();else{try{E=window.parent.getGlobal()}catch(e){return void kInteractive.alert({content:f.kotobeeOnly,title:g.sorry?g.sorry:"Sorry"})}T.rootIndex=u.getAttribute("data-loc"),T.root=u}return kInteractive.c.addClass(e,"busy"),void E.questionsAddToNotebookShortcut(T,function(){kInteractive.c.removeClass(e,"busy"),kInteractive.alert({content:g.savedToNotebook?g.savedToNotebook:"Saved to notebook!"})})}if(this.hasClass(e,"questions-preserve"))return document[u.id]||(document[u.id]={}),void(document[u.id].preserve=e.checked);for(var O=0,S=0,A=[],x=0;x<y.length;x++){var B=(C=y[x].getElementsByClassName("ans")).length>0,N=p.q[x];if(p.options.randomize&&(N=p.q[Number(y[x].getAttribute("data-o"))]),kInteractive.scorm&&p.options&&p.options.answerOnce&&kInteractive.scorm.interactionExists(kInteractive.getScormId(u.id+"-"+(x+1),N.q))){W="<p style='text-align:center'>"+(g.alreadySubmitted?g.alreadySubmitted:"This test has already been submitted!")+"</p>";return void kInteractive.alert({content:W})}var L={};A.push(L),L.id=kInteractive.getScormId(u.id+"-"+(x+1),N.q),L.qid=u.id,L.type=C[0].getAttribute("id").indexOf("ki-tf-")>=0?"true-false":"choice",L.objective=p.options?p.options.objective:null,L.timestamp=kInteractive.timestamp,L.latency=Math.round(((new Date).getTime()-kInteractive.timestamp.getTime())/1e3),L.description=N.q;for(te=0;te<C.length;te++)if(C[te].getAttribute("id").indexOf("ki-tf-")>=0)0==te&&N.a?L.correctResponses=N.choice1:1!=te||N.a||(L.correctResponses=N.choice2),C[te].checked?(L.learnerResponses=te?N.choice2:N.choice1,0!=te||N.a?1==te&&N.a&&(B=!1):B=!1):0==te&&N.a?B=!1:1!=te||N.a||(B=!1),p.options&&p.options.highlightCorrect&&(0==te&&N.a||1==te&&!N.a)&&kInteractive.c.addClass(C[te].parentNode,"correct");else if(C[te].getAttribute("id").indexOf("ki-sa-")>=0){(Q=C[te].value.toLowerCase())&&(Q=Q.trim()),B=!0;for(var M="",$=0;$<N.k.length;$++){var P=N.k[$].t;if(!P){B=!1;break}P=P.toLowerCase(),M&&(M+="+"),M+=P;for(var H=P.split(","),R=!1,D=0;D<H.length;D++)if(Q.indexOf(H[D].trim())>=0){R=!0;break}if(!R){B=!1;break}}L.correctResponses=M,L.learnerResponses=Q}else N.c[te].a&&(L.correctResponses=N.c[te].t),C[te].checked&&(L.learnerResponses=N.c[te].t),C[te].checked&&!N.c[te].a?B=!1:!C[te].checked&&N.c[te].a&&(B=!1),p.options&&p.options.highlightCorrect&&N.c[te].a&&kInteractive.c.addClass(C[te].parentNode,"correct");if(L.result=0,null!=N.weight&&(O+=N.weight,B&&(S+=N.weight,L.result=N.weight)),L.scoreMax=p.options?Number(p.options.totalScore):null,N.exp&&!y[x].getElementsByClassName("explanation").length){var F=document.createElement("p");F.className="explanation",F.innerHTML=kInteractive.escapeHtml(N.exp),kInteractive.appendAfterDelay(y[x],F)}if(N.ref&&!y[x].getElementsByClassName("reference").length){var z=document.createElement("a");z.className="reference",z.innerHTML=g.learnMode?g.learnMode:"Learn more",z.setAttribute("href",kInteractive.escapeHtml(N.ref)),z.setAttribute("target","_blank"),kInteractive.appendAfterDelay(y[x],z)}var j=g.question?g.question.replace("[no]",x+1):"Question "+(x+1);B?(w+="<span style='border-bottom: dotted 1px #aaa;' title='"+N.q.replace(/'/g,"&#39;")+"'>"+j+".</span>  <span style='color:#366c20'>"+g.correct+"</span><br/>",b++):w+="<span style='border-bottom: dotted 1px #aaa;' title='"+N.q.replace(/'/g,"&#39;")+"'>"+j+".</span>  <span style='color:#7a1818'>"+g.incorrect+"</span><br/>"}for(x=0;x<A.length;x++)A[x].weighting=Math.round(1e3*p.options.totalScore/O)/1e3;var V,U=p.action;if(p.options.totalScore&&O&&(V=Math.round(10*p.options.totalScore*S/O)/10),"selfAnswer"==U||"selfAnswerReport"==U){var q="";"ar"==p.options.language&&(q=' direction="rtl"');var W="";if(g.scoreWeight){if(null!=V){var _="";p.options.passScore&&(V>=p.options.passScore||V==p.options.totalScore?_+=g.pass:_+=g.fail),_&&(_+=". "),W+="<h3"+q+">"+(_||"")+g.scoreWeight.replace("[score]",V).replace("[total]",p.options.totalScore)+"</h3>"}W+="<p"+q+">"+g.score.replace("[correct]",b).replace("[total]",k)+"</p>"}else W="You scored "+b+" question(s) out of "+k;"selfAnswerReport"==U&&(W="<p"+q+"><strong>"+W+"</strong></p><p><strong>"+(g.details?g.details:"Details")+"</strong></p><p class='kbAlertScroll'>"+w+"</p>"),kInteractive.alert({content:W}),o()}if("email"==U||p.options.reportEmail||p.options.emailForm){var K="selfAnswer"!=U&&"selfAnswerReport"!=U&&"email"!=U;try{if(!config.kotobee.cloudid)return void(K&&kInteractive.alert({content:f.cloudOnly,title:g.sorry?g.sorry:"Sorry"}))}catch(e){return void(K&&kInteractive.alert({content:f.cloudOnly,title:g.sorry?g.sorry:"Sorry"}))}(ke={}).ans=new Array;for(te=0;te<y.length;te++)for(var C=y[te].getElementsByClassName("ans"),x=0;x<C.length;x++)C[x].checked&&ke.ans.push({q:te,index:x,label:C[x].nextSibling.textContent||C[x].nextSibling.data});if(ke.title=m,(be={}).recipient=p.address,p.options.reportEmail&&(be.recipient=p.options.reportEmail),be.content=JSON.stringify(ke),be.mode=config.kotobee.mode,be.cloudid=config.kotobee.cloudid,be.email=config.kotobee.email?config.kotobee.email:angular.element(document.body).scope().data.user.email,p.options.emailForm){var Y=document.getElementsByName("recipientEmail");Y.length&&(be.recipient=be.recipient?be.recipient+","+Y[0].value:Y[0].value)}var J=e.value;e.value=g.submitting?g.submitting:"Submitting ..",e.setAttribute("disabled","true");var Z=new XMLHttpRequest;Z.onreadystatechange=function(){try{if(4===Z.readyState&&200===Z.status){if(e.value=J,e.removeAttribute("disabled"),!K)return;JSON.parse(Z.responseText).success?kInteractive.alert({content:g.submitted?g.submitted:"Answers submitted!"}):kInteractive.alert({content:g.errorSubmitting?g.errorSubmitting:"An error has occurred while sending answers to the server"})}}catch(t){if(e.value=J,e.setAttribute("value",e.value),e.removeAttribute("disabled"),!K)return;kInteractive.alert({content:g.errorSubmitting?g.errorSubmitting:"An error has occurred while sending answers to the server"})}};ie=config.kotobee.liburl?config.kotobee.liburl:"http://www.kotobee.com/";ie+="library/report/questions",Z.open("POST",ie),Z.setRequestHeader("Content-type","application/x-www-form-urlencoded");var G="a=a";for(var X in be){var Q=be[X];void 0!=Q&&("object"!=typeof Q&&("string"==typeof Q&&(Q=encodeURIComponent(Q)),"boolean"==typeof Q&&(Q=Q?1:0),G+="&"+X+"="+Q))}Z.send(G),o()}document[u.id]||(document[u.id]={}),document[u.id].q=[];for(var ee=u.getElementsByClassName("ques"),te=0;te<ee.length;te++){var ne=te;p.options.randomize&&(ne=Number(ee[te].getAttribute("data-o"))),document[u.id].q[ne]=[];for(var oe=ee[te].getElementsByClassName("ans"),x=0;x<oe.length;x++)kInteractive.hasClass(oe[x],"txtfield")?document[u.id].q[ne][x]=oe[x].value:document[u.id].q[ne][x]=oe[x].checked}kInteractive.scorm&&setTimeout(function(){kInteractive.scorm.setInteractions(A)},500)}else if(this.hasClass(u,"widget")){var re=kInteractive.readData(u);if(!re)return;var ie=kInteractive.getWidgetUrl(re),ae=document.createElement("iframe");ae.setAttribute("nwdisable","true"),ae.setAttribute("nwfaketop","true"),re.cb=function(e){ae.src=ie,e.appendChild(ae)},re.cb1="yes",re.closed=function(){},kInteractive.openFrame(re),kInteractive.tinCan({verb:"opened",activity:"Widget: "+re.name}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("widget",re.name),e.description="Opened popup widget: "+re.name,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else{if(this.hasClass(e,"link")){if(!(be=kInteractive.readData(e)))return;if("popup"==be.type){if(W=(W="<div class='kbAlertScroll'>"+be.msg+"</div>").replace(/src="(.*?)"/g,function(){var e=arguments[1];return void 0!==isKotobee&&(e=ph.join(d,e)),'src="'+e+'"'}),"image"==be.popupMode){var se=be.popupImg;void 0!==isKotobee&&(se=ph.join(d,se)),W="<img src='"+se+"'/>"}kInteractive.alert({content:W}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("popup",be.msg),e.description="Shown popup message: "+be.msg,e.type="other",e.learnerResponses="Shown",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else if("action"==be.type){var le=be.asset,U=be.action;if(le.remote){if("widget"==le.type){var ce=document.createElement("div");ce.className="kInteractive widget kbHidden",ce.setAttribute("data-kotobee",le.data),document.body.appendChild(ce),this.trigger("click",ce)}return}for(var de=document.getElementsByClassName(le.classname),te=0;te<de.length;te++)if(this.hasClass(de[te],"kInteractive")&&this.hasClass(de[te],le.type))if("activate"==U)if("gallery"==le.type){var ue=de[te].getElementsByClassName("next");this.trigger("click",ue[0])}else if("questions"==le.type){for(var pe=de[te].getElementsByClassName("ki-btn"),x=0;x<pe.length;x++)if("submit"==pe[x].type){this.trigger("click",pe[x]);break}}else this.trigger("click",de[te]);else"visibility"==U&&kInteractive.c.toggleClass(de[te],"kbHidden")}else if("audio"==be.type){kInteractive.stopCurrentMedia();var fe=document.createElement("audio"),ge=be.src;"file"==be.audioType&&(ge=void 0===isKotobee?be.audio:ph.join(d,be.audio)),fe.setAttribute("src",ge);var he,me=document.createElement("div");me.className="kiAudioLoader",me.style.transform=me.style.webkitTransform=me.style.mozTransform="scale(1)";var ve=document.createElement("div");ve.className="kiAudioSpinner",me.appendChild(ve),e.parentNode.insertBefore(me,e),fe.onplaying=r,setTimeout(r,5e3),fe.play(),kInteractive.currentAudio=fe,kInteractive.tinCan({verb:"played",activity:"Audio: "+ge}),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(e.textContent,ge),L.description="Played audio link: "+ge,L.type="other",L.learnerResponses="Played",L.objective=be.options?be.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L]))}return!1}if(this.hasClass(e,"image")){if(e.parentNode&&this.hasClass(e.parentNode,"kInteractive")&&this.hasClass(e.parentNode,"link"))return void this.action(e.parentNode,t);var be=kInteractive.readData(e);if(!be)return;var ye=be.behavior;if("none"==ye){if(be.popup){var ke={};ke.class="image";var we=document.createElement("img");we.src=be.path,this.isAbsolutePath(be.path)||void 0!==isKotobee&&(we.src=ph.join(d,be.path)),ke.width=we.naturalWidth,ke.height=we.naturalHeight,ke.pos="side",ke.cb=function(e){e.appendChild(we)},ke.closed=function(){},kInteractive.openFrame(ke)}return}i(e,"none"),a(e,"none"),s(e,"none"),setTimeout(function(){function t(o){i(e,"none"),a(e,"none"),s(e,"none"),e.removeEventListener(n,t)}"wiggle"==ye?(i(e,"wiggle"),a(e,"0.5s"),s(e,"1")):"jump"==ye?(i(e,"jump"),a(e,"0.7s"),s(e,"1")):"scale"==ye&&(i(e,"scale"),a(e,"0.5s"),s(e,"1"));var n=function(){var e,t=document.createElement("fakeelement"),n={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}();n&&e.addEventListener(n,t)}),kInteractive.tinCan({verb:"clicked",activity:ye+"image: "+e.getAttribute("src")})}else if(this.hasClass(u,"gallery")){var Ce=u.getElementsByClassName("images")[0],b=Ce.children.length,xe=u.getElementsByClassName("selected")[0],Ie=Number(xe.style.left.slice(0,-2)),Ee=Number(Ce.style.left.slice(0,-2));if(this.hasClass(e,"next")){var Te=xe.nextSibling;if(!Te)return;kInteractive.c.removeClass(xe,"selected"),kInteractive.c.addClass(Te,"selected"),Te.style.left=Ie+Ce.offsetWidth+"px",Te.style.display="block",Ce.style.left=Ee-Ce.offsetWidth+"px",Te.nextSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(u.getElementsByClassName("prev")[0],"disable"),xe=Te}else if(this.hasClass(e,"prev")){var Oe=xe.previousSibling;if(!Oe)return;kInteractive.c.removeClass(xe,"selected"),kInteractive.c.addClass(Oe,"selected"),Oe.style.left=Ie-Ce.offsetWidth+"px",Oe.style.display="block",Ce.style.left=Ee+Ce.offsetWidth+"px",Oe.previousSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(u.getElementsByClassName("next")[0],"disable"),xe=Oe}var Se=u.getElementsByClassName("imgCaption");if(!Se.length)return;var Ae=(Se=Se[0]).getElementsByClassName("inner");if(!Ae.length)return;(Ae=Ae[0]).style.display="none",xe.hasAttribute("data-caption")&&(Ae.innerHTML=xe.getAttribute("data-caption"),Ae.style.display=null)}else if(this.hasClass(u,"audio")){kInteractive.stopCurrentMedia();var Be=kInteractive.readData(u);if(!Be)return;Be.audioType||(Be.audioType=Be.type);$e=u.getAttribute("id")+"-container";(pe=u.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn hide";ge=Be.src;"file"==Be.audioType&&(ge=void 0===isKotobee?Be.audio:Be.relToRoot?ph.join(bookPath,Be.audio):ph.join(d,Be.audio)),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(u.getAttribute("id"),ge),L.description="Played audio: "+ge,L.type="other",L.learnerResponses="Played",L.objective=Be.options?Be.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L]));var Ne=document.createElement("audio");Ne.setAttribute("controls","true"),Ne.setAttribute("autoplay","true"),Ne.setAttribute("data-tap-disabled","false");var Le=document.createElement("source");Le.src=ge,Ne.appendChild(Le),Ne.appendChild(document.createTextNode("Your browser does not support the audio element")),Ne.className="ki-noHighlight",Ne.oncanplay=function(){kInteractive.currentAudio==u&&kInteractive.tinCan({verb:"played",activity:"Audio: "+ge})},u.getElementsByClassName("container")[0].appendChild(Ne),Ne.play(),kInteractive.currentAudio=u,kInteractive.c.addClass(kInteractive.currentAudio,"playing")}else if(this.hasClass(u,"video")){var Me=kInteractive.readData(u);if(!Me)return;var $e=u.getAttribute("id")+"-container";if((pe=u.getElementsByClassName("playBtn")[0]).className.indexOf("loading")>=0)return;if(kInteractive.stopCurrentMedia(),pe.className="playBtn ki-btn loading",Me.autoplay&&(pe.className="playBtn ki-btn hide"),kInteractive.scorm&&((L={}).id=kInteractive.getScormId(u.getAttribute("id"),Me.src),L.description="Played video: "+Me.src,L.type="other",L.learnerResponses="Played",L.objective=Me.options?Me.options.objective:null,L.timestamp=new Date,kInteractive.scorm.setInteractions([L])),"file"==Me.type)l(ge=void 0===isKotobee?Me.video:ph.join(d,Me.video));else if(Me.src.indexOf("youtube.com")>=0||Me.src.indexOf("youtu.be/")>=0){var Pe;if(Me.src.indexOf("youtube.com")>=0)Pe=(He=Me.src.split("watch?v="))[1];else{if(!(Me.src.indexOf("youtu.be/")>=0))return;var He=Me.src.split("youtu.be/");Pe=He[He.length-1]}if(window&&window.iBooks)return setTimeout(function(){pe.className="playBtn ki-btn"},1500),void(window.location.href=Me.src);var Re={videoId:Pe,playerVars:{autoplay:1,rel:"0"},events:{onReady:function(){},onStateChange:function(e){e.data==YT.PlayerState.PLAYING&&kInteractive.tinCan({verb:"played",activity:"Video: "+Me.src})}}};if(kInteractive.youTubeStatus)if("loading"==kInteractive.youTubeStatus){if(kInteractive.vQueue)return;kInteractive.vQueue=function(){pe.className="playBtn ki-btn hide",new YT.Player($e,Re)}}else"ready"==kInteractive.youTubeStatus&&(pe.className="playBtn ki-btn hide",new YT.Player($e,Re));else{window.onYouTubePlayerAPIReady=function(){kInteractive.youTubeStatus="ready",kInteractive.vQueue(),kInteractive.vQueue=null};var De=document.createElement("script");De.src="https://www.youtube.com/player_api";var Fe=document.getElementsByTagName("script")[0];Fe.parentNode.insertBefore(De,Fe),kInteractive.youTubeStatus="loading",kInteractive.vQueue=function(){pe.className="playBtn ki-btn hide",new YT.Player($e,Re)}}}else l(Me.src);kInteractive.currentVideo=u,kInteractive.c.addClass(kInteractive.currentVideo,"playing")}else if(this.hasClass(u,"threed")){var ze=kInteractive.readData(u);if(!ze)return;"inPanel"==ze.inter.target?kInteractive.c.addClass(u,"running"):u.innerHTML="";var je=document.createElement("div");if(je.className="loading",u.appendChild(je),"undefined"==typeof THREE){var Ve,Ue=document.getElementsByTagName("head")[0],qe=Ue.getElementsByTagName("script");if(void 0!==isKotobee)Ve=bookPath+"EPUB/js/kotobeeInteractive3D.js";else for(te=0;te<qe.length;te++)if(qe[te].src.indexOf("kotobeeinteractive.js")>=0){Ve=qe[te].src.replace("kotobeeinteractive.js","kotobeeinteractive3D.js");break}if(!Ve)return;var We=document.createElement("script");We.type="text/javascript",We.src=Ve,We.onload=c,We.onreadystatechange=function(){"complete"==this.readyState&&c()},Ue.appendChild(We)}else c()}}}},trigger:function(e,t){this.action(t,e)},openFrame:function(e){function t(){o.style.display="block",o.className="show";var t=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,i=window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth;t-=20,i-=20;var a=1;if(e.width&&e.height){var s=i/e.width,c=t/e.height;(a=s<c?s:c)>1&&(a=1)}var d="display:block;";d+=r;var u=e.width||e.height?"-50%,-50%":"0%,0%";d+="-webkit-transform:translate("+u+") scale("+a+");-moz-transform:translate("+u+") scale("+a+");transform:translate("+u+") scale("+a+");",d+="position:fixed;",void 0===isKotobee&&"-50%,-50%"==u&&(d+="top:"+Math.round(window.innerHeight/2)+"px;",d+="left:"+Math.round(window.innerWidth/2)+"px;"),n.style.cssText=d,n.className=l+" ready";var p=n.getElementsByClassName("closeBtn");if(p.length){var f=p[0],g=1/a,h="-50%";kInteractive.hasClass(f,"side")&&(h="0%"),f.style.cssText="-webkit-transform: translate("+h+",0%) scale("+g+");-webkit-transform-origin: 50% 50%;-moz-transform: translate("+h+",0%) scale("+g+");-moz-transform-origin: 50% 50%;transform: translate("+h+",0%) scale("+g+");transform-origin: 50% 50%;"}}var n=document.getElementById("kInteractiveFrame"),o=document.getElementById("kiDarkOverlay"),r="";if(e.dict||(e.dict={}),e.width&&(r+="width:"+e.width+"px;max-width:"+e.width+"px;"),e.height&&(r+="height:"+e.height+"px;max-height:"+e.height+"px;"),n||((o=document.createElement("div")).id="kiDarkOverlay",document.body.appendChild(o),o.style.display="none",o.style.position="fixed",o.addEventListener("click",kInteractive.closeFrame),(n=document.createElement("div")).id="kInteractiveFrame"),e.pos||(e.pos="top"),"none"!=e.pos){var i=document.createElement("a"),a="closeBtn";e.pos&&(a+=" "+e.pos),i.className=a;var s=e.dict.close?e.dict.close:"Close";try{s=angular.element(document.body).scope().translit("close")}catch(e){}"side"!=e.pos&&(i.innerHTML=s),i.addEventListener("click",kInteractive.closeFrame),n.appendChild(i)}var l=e.class?e.class:"";(e.width||e.height)&&(l+=" fixed"),n.style.display="block",n.className=l,document.body.appendChild(n),kInteractive.frameIsOpen=!0,kInteractive.frameOb=e,kInteractive.openFrame.resized=t,window.addEventListener("resize",t),setTimeout(function(){t(),e.cb&&e.cb(n)},100)},closeAlert:function(e){e&&e.stopPropagation();var t=document.getElementById("kiSystemAlertBox"),n=document.getElementById("kiSystemAlertBackdrop");t.parentNode.removeChild(t),n.parentNode.removeChild(n),kInteractive.alertIsOpen=!1,window.removeEventListener("resize",kInteractive.alert.resized),kInteractive.alert.resized=null},closeFrame:function(){var e=document.getElementById("kInteractiveFrame"),t=document.getElementById("kiDarkOverlay");kInteractive.frameIsOpen=!1,window.removeEventListener("resize",kInteractive.openFrame.resized),kInteractive.openFrame.resized=null,kInteractive.c.removeClass(e,"ready");var n=kInteractive.frameOb,o="";n.width&&(o+="width:"+n.width+"px;max-width:"+n.width+"px;"),n.height&&(o+="height:"+n.height+"px;max-height:"+n.height+"px;"),e.style.cssText=o,t.className="",setTimeout(function(){e.innerHTML="",e.style.display=t.style.display="none",n.closed&&n.closed(),kInteractive.frameOb=null},300)},stopCurrentMedia:function(){if(kInteractive.currentVideo){var e=kInteractive.currentVideo.getAttribute("id")+"-container";(t=document.getElementById(e))&&(t.parentNode.removeChild(t),(n=document.createElement("div")).setAttribute("id",e),n.className="container",(o=kInteractive.currentVideo.getElementsByClassName("playBtn")[0]).className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentVideo,"playing"),kInteractive.currentVideo.appendChild(n))}if(kInteractive.currentAudio)if(e=kInteractive.currentAudio.getAttribute("id")){e+="-container";var t=document.getElementById(e);if(t){t.parentNode.removeChild(t);var n=document.createElement("div");n.setAttribute("id",e),n.className="container";var o=kInteractive.currentAudio.getElementsByClassName("playBtn")[0];o.className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentAudio,"playing"),kInteractive.currentAudio.appendChild(n)}}else try{var r=kInteractive.currentAudio.getElementsByTagName("audio");r.length&&(r[0].pause(),r[0].src=""),kInteractive.currentAudio.pause&&(kInteractive.currentAudio.pause(),kInteractive.currentAudio.src="");for(var i=document.getElementsByClassName("kiAudioLoader"),a=i.length;a--;)i[a].parentNode.removeChild(i[a])}catch(e){}},hasClass:function(e,t){if(e&&e.className)for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o]&&n[o].trim()==t)return!0},appendAfterDelay:function(e,t){setTimeout(function(){e.appendChild(t)},30)},replaceHTML:function(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o},tinCan:function(e){if(void 0!==isKotobee)try{angular.element(document.body).scope().tinCanShortcut(e)}catch(e){}},setDOMParser:function(){!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(e){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser)},readData:function(e){try{var t=e.getAttribute("data-kotobee");return t||(t=e.getAttribute("data")),JSON.parse(decodeURI(kInteractive.XORCipher().decode("kotobee%%author",t)))}catch(e){try{return JSON.parse(kInteractive.XORCipher().decode("kotobee%%author",t))}catch(e){}}},writeData:function(e,t){var n=encodeURI(JSON.stringify(t)),o=e.hasAttribute("data-kotobee")?"data-kotobee":"data";e.setAttribute(o,kInteractive.XORCipher().encode("kotobee%%author",n))},XORCipher:function(){function e(e){var t,n,o,r,i,s,l=0,c="";if(!e)return e;do{t=(i=e[l++]<<16|e[l++]<<8|e[l++])>>18&63,n=i>>12&63,o=i>>6&63,r=63&i,c+=a.charAt(t)+a.charAt(n)+a.charAt(o)+a.charAt(r)}while(l<e.length);return((s=e.length%3)?c.slice(0,s-3):c)+"===".slice(s||3)}function t(e){var t,n,o,r,i,s,l=0,c=[];if(!e)return e;e+="";do{t=(s=a.indexOf(e.charAt(l++))<<18|a.indexOf(e.charAt(l++))<<12|(r=a.indexOf(e.charAt(l++)))<<6|(i=a.indexOf(e.charAt(l++))))>>16&255,n=s>>8&255,o=255&s,c.push(t),64!==r&&(c.push(n),64!==i&&c.push(o))}while(l<e.length);return c}function n(e,t){return e.charCodeAt(Math.floor(t%e.length))}function o(e,t){return i(t,function(t,o){return t.charCodeAt(0)^n(e,o)})}function r(e,t){return i(t,function(t,o){return String.fromCharCode(t^n(e,o))}).join("")}function i(e,t){for(var n=[],o=0;o<e.length;o++)n[o]=t(e[o],o);return n}var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t,n){return n=o(t,n),e(n)},decode:function(e,n){return n=t(n),r(e,n)}}},getScormId:function(e,t){return t&&(t=t.replace(/[^a-zA-Z0-9]/g,"-").substr(0,80)),e+"-"+t},alert:function(e){function t(){void 0===isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px")}var n=document.createElement("div");n.setAttribute("id","kiSystemAlertBox"),n.style.position="fixed",void 0===isKotobee&&(n.style.top=Math.round(window.innerHeight/2)+"px",n.style.left=Math.round(window.innerWidth/2)+"px");var o=document.createElement("div");o.innerHTML=e.content.replace("&nbsp;","&#160;"),o.className="content",n.appendChild(o);var r=document.createElement("div");if(r.className="footer",e.title){var i=document.createElement("div");i.innerHTML=e.title.replace("&nbsp;","&#160;"),i.className="header",n.insertBefore(i,n.firstChild)}var a=document.createElement("a"),s="OK";try{s=angular.element(document.body).scope().translit("ok")}catch(e){}a.innerHTML=s.replace("&nbsp;","&#160;"),a.className="okBtn",kInteractive.alertIsOpen=!0,a.addEventListener("click",kInteractive.closeAlert),r.appendChild(a),n.appendChild(r);var l=document.createElement("div");l.setAttribute("id","kiSystemAlertBackdrop"),l.addEventListener("click",kInteractive.closeAlert),l.style.position="fixed",document.body.appendChild(l),document.body.appendChild(n),a.focus(),kInteractive.alert.resized=t,window.addEventListener("resize",t),setTimeout(function(){n.className="show",l.className="show"},50)},c:{addClass:function(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)-1==n.indexOf(t[r])&&(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(n.indexOf(t)>=0)return;n+=(""==n?"":" ")+t}e.className=n},toggleClass:function(e,t){this.strHasClass(e.className,t)?this.removeClass(e,t):this.addClass(e,t)},hasClass:function(e,t){return this.strHasClass(e.className,t)},strHasClass:function(e,t){e||(e="");for(var n=e.trim().split(" "),o=0;o<n.length;o++)if(n[o]==t)return!0;return!1},removeClass:function(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)n.indexOf(t[r])>=0&&(o=!1,n=n.replace(t[r],""));if(o)return}else{if(-1==n.indexOf(t))return;n=n.replace(t,"")}""==(n=n.trim())?e.removeAttribute("class"):e.className=n},removeHash:function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},removeFilename:function(e){var t=kInteractive.c.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},normalizedArray:function(e){for(var t=(e=e.replace(/\\/g,"/")).split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t}},escapeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},resizeEvent:function(e,t){function n(e,t){if(e&&e.disableWrapForMobile&&"none"!=e.float){var n=t.parentNode;t.offsetWidth>.6*n.offsetWidth&&.4*(n.offsetWidth-t.offsetWidth)<100?kInteractive.c.addClass(t,"fullRow"):kInteractive.c.removeClass(t,"fullRow")}}var o,r=e||document;t&&(r=document);for(var i=(o=r.getElementsByClassName("kInteractive")).length;i--;){var a=o[i];if(this.hasClass(a,"image")){var s=kInteractive.readData(a);if(!s)return;n(s,a)}else if(this.hasClass(a,"gallery")){var l=kInteractive.readData(a);if(!l)return;n(l,a)}else if(this.hasClass(a,"container")){var c=kInteractive.readData(a);if(!c)return;n(c,a)}else if(this.hasClass(a,"video")){var d=kInteractive.readData(a);if(!d)return;if(n(d,a),!d.maintainRatio)continue;if("px"!=d.widthUnit)continue;if(!d.height||!d.width)continue;a.style.height=a.offsetWidth*(d.height/d.width)+"px"}else if(this.hasClass(a,"widget")){var u=kInteractive.readData(a);if(!u)return;if("page"!=u.mode)continue;if("px"!=u.widthUnit)continue;var p=u.width,f=u.height,g=a.parentNode;if(!g)continue;if(p>g.offsetWidth){var h=g.offsetWidth/p,m=a.children.length-1;a.children[m].style.transform=a.children[m].style.webkitTransform=a.children[m].style.mozTransform="scale("+h+")",a.children[m].style.transformOrigin=a.children[m].style.webkitTransformOrigin=a.children[m].style.mozTransformOrigin="0 0",a.style.maxWidth=a.style.width,a.style.height=Math.round(f*h)+"px"}else{for(m=0;m<a.children.length;m++)a.children[m].style.transform=a.children[m].style.webkitTransform=a.children[m].style.mozTransform=a.children[m].style.transformOrigin=a.children[m].style.webkitTransformOrigin=a.children[m].style.mozTransformOrigin=null;a.style.maxWidth=null,a.style.height=f+"px"}}}},isAbsolutePath:function(e){if(e)return 0==e.trim().indexOf("http://")||(0==e.trim().indexOf("https://")||(0==e.trim().indexOf("//")||(0==e.trim().indexOf("data:")||void 0)))},isMobile:function(e){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return!0;try{if(window.location.href.indexOf("?preview")>0){var t=window.location.href.split("?");t=t[1].split("&");for(var n={},o=0;o<t.length;o++){var r=t[o].split("=");n[r[0]]=r[1]}if(n.mobile)return!0}}catch(e){}},closeFullscreenVideo:function(){kInteractive.currentVideo&&(kInteractive.currentVideo.webkitExitFullscreen?kInteractive.currentVideo.webkitExitFullscreen():kInteractive.currentVideo.mozCancelFullScreen?kInteractive.currentVideo.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen(),kInteractive.videoIsFullscreen=!1)},getWidgetHome:function(e,t){return t||(t={}),e.path?void 0===isKotobee?e.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,e.path):void 0===isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/"},getWidgetUrl:function(e,t){var n=kInteractive.getWidgetHome(e,t)+"/"+e.name+"/"+e.src;if(void 0!==isKotobee){var o=angular.element(document.body).scope().data.user;o&&o.email&&o.signatures&&o.signatures.bookwidgets&&e.id&&0==e.id.indexOf("com.kidimedia")&&(n+="?oauth_signature="+o.signatures.bookwidgets.signature,n+="&oauth_nonce="+o.signatures.bookwidgets.nonce,n+="&oauth_timestamp="+o.signatures.bookwidgets.timestamp,n+="&oauth_consumer_key="+o.signatures.bookwidgets.key,n+="&lti_version=LTI-1p0",n+="&oauth_signature_method=HMAC-SHA1",n+="&oauth_version=1.0",n+="&tool_consumer_info_product_family_code=kotobee",n+="&lis_person_contact_email_primary="+o.email,n+="&lis_person_name_full="+(o.name?o.name:""),n+="&user_id="+o.id,n+="&lti_message_type=basic-lti-launch-request",angular.element(document.body).scope().refreshSignatures&&angular.element(document.body).scope().refreshSignatures())}return n},vQueue:[],youTubeReady:!1,firstRun:!0};if(void 0===isKotobee)try{document.addEventListener("DOMContentLoaded",kInteractionStart,!1)}catch(e){window.addEventListener("load",kInteractionStart,!1)}var log=kLog;app.directive("iframeOnload",[function(){return{scope:!1,link:function(e,t,n){t.on("load",function(){return e.modal.siteOptions.loaded()})}}}]),app.directive("containerScroll",["$timeout",function(e){return{scope:!1,link:function(t,n,o){function r(){e(function(){var e=document.getElementsByClassName("containerScroll"+i);e.length?e[0].addEventListener("touchstart",function(t){e[0].getElementsByClassName("kbContent");t.touches&&t.touches.length>1||t.stopPropagation()}):++a<50&&r()},40)}var i=Math.round(99999*Math.random());addClass(n[0],"containerMobileScroll containerScroll"+i),r();var a=0}}}]),app.directive("enterWithoutShift",function(){return function(e,t,n){var o;t.bind("keydown keypress",function(t){(o=t.shiftKey)||13===t.which&&(e.$apply(function(){e.$eval(n.enterWithoutShift)}),t.preventDefault())})}}),app.directive("enterWithCtrl",function(){return function(e,t,n){var o;t.bind("keydown keypress",function(t){(o=t.ctrlKey)&&13===t.which&&(e.$apply(function(){e.$eval(n.enterWithCtrl)}),t.preventDefault())})}}),app.directive("searchheader",["$timeout","$parse",function(e,t){return{restrict:"E",replace:!1,scope:{obj:"=obj",prop:"=prop",kotobeeGradient:"=kotobeeGradient",onValue:"=onValue",offValue:"=offValue",noCancel:"=noCancel",searchKeyOb:"=searchKeyOb",onsearch:"&"},templateUrl:kTemplate("headers/headerSearch.html"),link:function(n,o,r){n.$watch("obj[prop]",function(i,a){i===t(r.onValue)(n)&&e(function(){o[0].getElementsByTagName("input")[0].focus()})}),n.hide=function(){n.obj[n.prop]=n.offValue}}}}]),app.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),app.directive("nextchapterscroll",function(){return{restrict:"E",templateUrl:kTemplate("components/nextChapterScroll.html")}}),app.directive("autofocusme",["$timeout",function(e){return{link:function(t,n,o){e(function(){n[0].focus()},350)}}}]),app.directive("readerheader",function(){return{restrict:"E",templateUrl:kTemplate("headers/readerHeader.html"),scope:!1}}),app.directive("headerdefault",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerDefault.html"),scope:!1}}),app.directive("headerselection",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSelection.html"),scope:!1}}),app.directive("headersearchitems",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSearchItems.html"),scope:!1}}),app.directive("headertextsize",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerTextSize.html"),scope:!1}}),app.directive("mouseEvents",["$ionicGesture","settings","nav","stg","$ionicScrollDelegate",function(e,t,n,o,r){return{restrict:"A",link:function(e,t,o){n.init(t)}}}]),app.directive("vanillaScroll",function(){return{restrict:"A",link:function(e,t,n){t[0].addEventListener("scroll",function(){e.scroll(this)})}}}),app.directive("selectOptions",function(){return{restrict:"E",templateUrl:kTemplate("headers/selectOptions.html")}}),app.directive("media",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/media.html"),scope:!1}}),app.directive("noteitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/noteItem.html")}}),app.directive("bookmarkitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/bookmarkItem.html")}}),app.directive("hlightitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/hlightItem.html")}}),app.directive("bookThumb",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/bookThumb.html")}}),app.directive("thumbnail",function(){return{restrict:"A",link:function(e,t,n){t.attr("style","background-size:cover,width:50px,height:50px")}}}),app.directive("showafterimageload",function(){return{restrict:"A",link:function(e,t,n){t.bind("load",function(e){e.currentTarget.style.opacity=1,autoprefixTransform(e.currentTarget,"translate(-50%, -50%) scale(1)")})}}}),app.directive("headerShrink",["autohide",function(e){return{restrict:"A",link:function(t,n,o){e.setup(t,n,o)}}}]),app.directive("categoryList",["autohide",function(e){return{restrict:"E",templateUrl:kTemplate("components/categoryList.html"),scope:{rtl:"=rtl",list:"=list",parent:"=parent",backlist:"=backlist",odd:"=odd",categoryClicked:"=clicked",categoryBackClicked:"=backClicked"}}}]),app.controller("BookInfoCtrl",["$scope","np","$timeout","bookinfo","$element","$rootScope","translit","crdv","sync","status","stg","book","modals","chapters","$location","backend",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h){var m;e.init=function(){},e.open=function(e){m=e,u.open(e)},e.download=function(e){o.download(e)},e.actionBtnClicked=function(e){e.redirect?desktop?t.openLink(e.redirect):native&&s.openInNativeBrowser(e.redirect):o.action(e)},e.delete=function(e){o.delete(e)},e.addToFav=function(e){o.addToFav(e)},e.toggleFav=function(e){o.toggleFav(e)},e.removeFav=function(e){o.removeFav(e)},e.categoryClicked=function(t){p.hide(),e.modal.bookInfoOptions.categoryClicked(t)},e.redeemCodeClicked=function(){o.redeemCode()}}]),app.controller("BookSettingsCtrl",["$scope","stg","crdv","spread","$element","nav","backend","$location","$ionicSideMenuDelegate","cssParser","modals","sync","markers","settings","$timeout",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){e.init=function(){e.navAnims=[{label:"flip",val:"navBookBlock"},{label:"card",val:"navFlip"},{label:"slide",val:"navSlide"},{label:"fade",val:"navFade"}],e.navModes=[{label:"vertical",val:"vertical"},{label:"horizontal",val:"horizontal"}],e.viewModes=[{label:"auto",val:"auto"},{label:"singlePage",val:"single"},{label:"doublePage",val:"double"}]},e.stylingChanged=function(){g(f.stylingChanged,300)},e.navAnimChanged=function(){f.saveSettings()},e.viewModeChanged=function(){g(f.viewModeChanged,300),t.writeSlot("settings"+t.getBookId(!0),t.data.settings)},e.navModeChanged=function(){f.saveSettings()},e.lineAdjustChanged=function(){g(f.lineAdjustChanged,300)},e.singlePageScrollChanged=function(){g(f.viewModeChanged,300)},e.editFontSize=function(){e.header.mode="textSize",l.toggleRight(!1),l.toggleLeft(!1)},e.langChanged=function(){l.toggleLeft(!1),l.toggleRight(!1),g(f.langChanged,500)},e.sync=function(){l.toggleRight(!1),l.toggleLeft(!1),f.sync()},e.fullscreen=function(){l.toggleRight(!1),l.toggleLeft(!1),i.fullscreen()},e.logout=function(){l.toggleRight(!1),l.toggleLeft(!1),a.logout()},e.about=function(){e.openAuthorWebsite()},e.exit=function(){d.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}]),app.controller("CatMenuCtrl",["$scope","backend","translit","$ionicScrollDelegate","$ionicModal","$timeout","stg",function(e,t,n,o,r,i,a){}]),app.controller("ChaptersCtrl",["$scope","initializer","$stateParams","status","stg","nav","modals","$ionicHistory","crdv","virt","chapters","$ionicGesture","cache","$q","book","$timeout","$ionicPopup","$ionicSideMenuDelegate","$location","$ionicScrollDelegate","selection","$filter",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w){e.init=function(){e.putTest("ChaptersCtrl init"),e.$on("$stateChangeStart",function(e,t,n){if(0==t.name.indexOf("reader")||0==t.name.indexOf("libraryreader")){var o=n.ch?n.ch:0,r=n.hash?n.hash:null,i=getQueryStringValue("vi");d.loadChapterByIndex(Number(o),{hash:r,vIndex:i})}}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||!config.kotobee.public&&!r.data.user.loggedIn){var e="loading";s.forwardView()?e=s.forwardView().stateId:s.backView()&&(e=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),b.path("/"+e)}})},e.nextChapter=function(){return d.nextChapter()},e.prevChapter=function(){return d.prevChapter()},e.pinched=function(e){},e.applySelectedChapter=function(e,t){if(null==t&&(t=!0),addClass(e,"selected"),addClass(e,"currentChapter"),t){for(var n=e,o=p.getOb("chaptersContent");;){if(!(e=e.parentNode))break;if(e==o)break;"li"==e.nodeName.toLowerCase()&&addClass(e,"expanded")}overflowScroll?o.scrollTop=Math.round(n.offsetTop):y.$getByHandle("chapters").scrollTo(0,Math.round(n.offsetTop-o.parentNode.offsetHeight/2),!1)}},e.deApplySelectedChapter=function(){for(var e=p.getOb("chaptersContent"),t=e.getElementsByClassName("selected"),n=t.length;n--;)removeClass(t[n],"selected");for(n=(t=e.getElementsByClassName("currentChapter")).length;n--;)t[n].removeAttribute("name")},e.showBookInfo=function(){native&&l.vibrate();var e=r.data.book;e.coverImg=r.data.epub.bookThumb,e.coverStyle={"background-image":"url('"+e.coverImg+"')"},e.name=e.meta.dc.title;var t={};t.book=e,config.kotobee.cloudid&&"book"==config.kotobee.mode&&(t.book.stats=config.kotobee.stats),t.noAction=!0,a.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up",bookInfoOptions:t})}}]),app.controller("ContentCtrl",["$location","nav","virt","$sce","$filter","stg","crdv","$rootScope","$element","cache","$scope","settings","$ionicSideMenuDelegate","$http","chapters","$timeout","selection","book","$ionicScrollDelegate",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b){d.init=function(){},d.mouseDown=function(){mobile&&t.resize(),n.enable()},d.mouseUp=function(){n.disableAfter(2e3)};var y;d.scroll=function(){i.data.book&&(config.preserveLoc&&"app"!=config.kotobee.mode&&(y&&clearTimeout(y),y=setTimeout(function(){if("app"!=config.kotobee.mode){var e=b.$getByHandle("content");if(e){var t=e.getScrollPosition();t&&i.writeSlot("lastLocY"+i.getBookId(),t.top)}}},2e3)),mobile||(n.enable(),n.disableAfter(2e3)))}}]),app.controller("ForgotPwdCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){e.init=function(){mobile||(r.stylize("forgotPwd",r.getBgStyle()),d.addListener("pathsChanged",function(){r.stylize("forgotPwd",r.getBgStyle())})),e.$on("$ionicView.afterEnter",function(){p.setOb("title",replaceHTML(p.getOb("title"),f.get("forgotPwd")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||d.cloudParam("public")||i.data.user&&i.data.user.loggedIn){var e="loading";l.forwardView()?e=l.forwardView().stateId:l.backView()&&(e=l.backView().stateId),l.nextViewOptions({disableAnimate:!0}),a.path("/"+e)}})},e.showMenu=function(){var e=[{name:f.get("exit"),func:function(){n.hide(),s.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){e.user&&e.user.email&&d.forgotPwd(e.user,function(e){e.error?c.update({error:"s_authError"==e.error?"accessDenied":e.error}):(s.show({mode:"success",successOptions:{msg:f.get("pwdEmailSent")}}),g.history.back())})},e.backClicked=function(){g.history.back()}}]),app.controller("GlobalCtrl",["cache","modals","popovers","np","book","$http","$compile","$rootScope","initializer","translit","error","notes","$sce","design","settings","status","tinCan","$scope","backend","stg","$location",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k){v.putTest=function(e){return},v.init=function(){v.putTest("Global init"),v.mobile=mobile,v.native=native,v.desktop=desktop,v.ios=ios,v.preview=preview,v.config=config,v.putTest("Global init good"),o.init(function(){})},v.start=function(){v.putTest("Global Start"),v.putTest("TO HOME!"),v.cloudParam=b.cloudParam,t.setScope(v),n.setScope(v),v.started=!0,v.putTest("A!"),setTimeout(function(){v.putTest("timeout postInitialize"),l.postInitialize(v)},700),v.$$phase||v.$apply()},v.tinCanShortcut=function(e){m.send(e)},v.questionsAddToNotebookShortcut=function(e,t){u.addNotesFromQuestions(e,t||angular.noop)},v.getNotebookShortcut=function(e,t){y.getNotes(function(n){var o=[currentIndex];y.data.currentRPageOb&&o.push(y.data.currentRPageOb.index);for(var r=0;r<o.length;r++)for(var i=0;i<n.length;i++)n[i].chapter==o[r]&&0==n[i].location.indexOf(e.rootIndex)&&(n[i].location=n[i].location.split(e.rootIndex)[1],u.addIcon(n[i],e.root));t&&t()})},v.location=function(e){k.path(e)},v.kTemplate=function(e){return kTemplate(e)},v.translit=function(e){return c.get(e)},v.htmlSafe=function(e){return p.trustAsHtml(e)},v.openAuthorWebsite=function(){var e=y.data.settings.language;"en"!=e&&"es"!=e&&"ar"!=e&&"fr"!=e&&(e="en"),window.open("https://www.kotobee.com/"+e+"/products/author","_system")},v.applyNativeScroll=function(e){var t,n=e.getElementsByClassName("kbContent");if(n.length&&!(n[0].scrollHeight<=e.offsetHeight)){e.children.length&&"ion-scroll"==e.children[0].nodeName.toLowerCase()&&(t=e.children[0],e.appendChild(n[0]),e.removeChild(t),e.scrollTop=0),(t=document.createElement("ion-scroll")).setAttribute("scrollY","true"),t.setAttribute("overflow-scroll","false"),t.setAttribute("style","width:100%;height:100%"),t.setAttribute("container-scroll","true");for(var o=0;o<e.children.length;o++)t.appendChild(e.children[o]);setTimeout(function(){var n=a(t.outerHTML)(v);angular.element(e).append(n)},0)}},v.globalClick=function(){},v.globalTouch=function(){},v.refreshSignatures=function(){b.refreshSignatures()},v.testModals=function(){t.show({mode:"loading",loadingMsg:c.get("pleaseWait")});t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"update",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"generalError"}),t.show({mode:"loading",loadingMsg:c.get("pleaseWait"),backdropClickToClose:!0}),t.show({mode:"note",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"hlight"}),t.show({mode:"externalSite",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"flashUnsupported",flashOb:{text:"Text for flash unsupported site"}}),t.show({mode:"success",successOptions:{msg:"SUCCESS MSG"}}),t.show({mode:"localOnlyError"}),t.show({mode:"xFrameError"}),t.show({mode:"networkError"}),t.show({mode:"exit"}),t.show({mode:"waitTimeout"}),t.show({mode:"backToLib"}),t.show({mode:"notebook",dynamic:!0,animation:"slide-in-up",scope:{notebookClose:t.hide}}),t.show({mode:"search",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"image",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"encryptionKey",backdropClickToClose:!0});t.show({mode:"loading",loadingMsg:c.get("pleaseWait"),timeLimit:3e3});return}}]),app.controller("HomeCtrl",["$scope","design","backend","stg","initializer","$timeout","$ionicHistory","$location",function(e,t,n,o,r,i,a,s){function l(){var t=r.getLogo();e.$parent.logo=t.logo,e.$parent.slogan=t.slogan;var n=document.getElementById("home").getElementsByClassName("logo")[0],o=n.getElementsByTagName("img")[0],i=n.style.backgroundImage;if(!i){var l="";config.hideLogo?l+="display:none":l+="background-image:url('"+t.logo+"');",n.style.cssText=l,e.putTest("HomeCtrl1")}o.onload=function(){if(!i){var e=window,t=document,r=t.documentElement,a=t.getElementsByTagName("body")[0],s=e.innerWidth||r.clientWidth||a.clientWidth,c=e.innerHeight||r.clientHeight||a.clientHeight;s||(s=e.screen.width),c||(c=e.screen.height);var d={};d.width=s-80,d.height=.5*c-40,l+="opacity:1;",d.height<o.height||d.width<o.width?l+="background-size:contain;":l+="background-size:auto;",n.style.cssText=l}},e.putTest("HomeCtrl2"),r.initialized||r.preInitialize(e),e.putTest("k"),e.native||e.desktop||(e.putTest("k2"),e.$on("$ionicView.beforeEnter",function(){e.putTest("be4 enter"),r.initialized&&(e.putTest("obbaa"),a.forwardView()&&(e.putTest("yup"),a.nextViewOptions({disableAnimate:!0}),s.path("/"+a.forwardView().stateId)))}))}e.init=function(){e.putTest("HomeCtrl!"),l(),n.addListener("pathsChanged",l)},e.injectUserCSS=function(e){t.injectUserCSS(e)}}]),app.controller("LibraryCtrl",["$scope","error","bookinfo","autohide","$sce","$location","$ionicPlatform","$rootScope","$element","$ionicHistory","auth","modals","popovers","translit","library","chapters","status","book","$timeout","$ionicPopup","$ionicModal","$ionicScrollDelegate","backend","crdv","$filter","stg","settings",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C,x,I,E,T){function O(t){for(var n=0;n<e.sortOb.options.length;n++)if(e.sortOb.options[n].val==t)return e.sortOb.options[n]}function S(){if(g.initialize(),g.addListener(A),o.libInitialized(),e.initialized=!0,e.catList=E.data.currentLibrary.categories,E.data.user.loggedIn&&("account"!=E.data.currentLibrary.authbookview||C.cloudParam("public")||(e.supportsAccountView=!0)),"categories"==E.data.currentLibrary.startingpage)$(),L("categories");else if(0==i.path().indexOf("/library/tab/downloads"))e.downloadedClicked();else if(e.supportsAccountView)L("account"),b(function(){M({account:!0})});else if(!native&&!desktop||E.data.user.loggedIn||config.kotobee.public||!config.kotobee.offline){if(L("all"),!C.cloudParam("public")&&"hide"==E.data.currentLibrary.authbookview&&!E.data.user.loggedIn)return e.paneMsg="noEbooksAvailable",void $();b(M)}else L("downloaded"),e.paneMsg=null,0==E.data.downloaded.length&&(e.paneMsg="noEbooksDownloaded"),$();g.startBook&&(B(g.startBook),g.startBook=null)}function A(){var t,n=arguments[0];if("preload"==n&&(arguments[1].accumulated||(t=!0),mobile||(t=!0),e.paneMsg=null,t&&P()),"postload"==n){arguments[1];var o=arguments[2];t=!1,e.stopInfiniteScroll(),D=!1,e.stopRefresher();var r=N(o);e.moreData=r>=g.maxResults,e.moreData&&g.setMax(r)}}function B(e){if(E.data.user.loggedIn){if(E.data.currentLibrary&&E.data.currentLibrary.books)for(var t=0;t<E.data.currentLibrary.books.length;t++)if(E.data.currentLibrary.books[t].id==e)return void v.open(E.data.currentLibrary.books[t]);C.getEbook({bid:e},function(e){v.open(e)})}}function N(e){if(V){for(var t=0,n=0;n<e.length;n++)if(e[n].searchresults)for(var o=0;o<e[n].searchresults.length;o++)e[n].searchresults[o].results&&(t+=e[n].searchresults[o].results.length);return t}return e.length}function L(t){e.tab=t,mobile?w.$getByHandle("thumbs").scrollTop(!1):document.getElementById("libraryThumbs").scrollTop=0}function M(t){t||(t={}),e.paneMsg=null,z&&(t.catid=z.id,t.listmode=z.listmode),F&&(t.key=F),V&&(t.contentkey=V),g.getEbooks(t,function(t){"all"!=e.tab&&"account"!=e.tab||(t.empty&&(e.paneMsg="noEbooksAvailable"),$(),e.$$phase||e.$apply())})}function $(){for(var e=document.getElementsByClassName("libLoaderAnim"),t=0;t<e.length;t++)addClass(e[t],"hide")}function P(){for(var e=document.getElementsByClassName("libLoaderAnim"),t=0;t<e.length;t++)removeClass(e[t],"hide")}function H(e,t){t||(t=E.data.currentLibrary.categories);for(var n=0;n<t.length;n++){if(t[n].id==e)return t[n];if(t[n].children){var o=H(e,t[n].children);if(o)return o}}}function R(){j&&j(),j=a.registerBackButtonAction(function(t){e.searchOb.enabled?e.disableSearch():"categories"==e.tab&&e.catList!=E.data.currentLibrary.categories?e.categoryBackClicked():z?e.back():F?e.back():V&&e.back(),e.$apply()},102)}var D,F,z,j,V;e.initialized=!1,e.init=function(){document.getElementsByClassName("libraryView");C.setLibraryLoginCallback(function(){S()}),C.setLibraryLogoutCallback(function(){e.supportsAccountView&&"all"!=e.tab&&(L("all"),b(M)),e.supportsAccountView=!1,$()}),e.sortOb={},e.sortOb.options=[{name:"dateAddedNewestFirst",data:"date",dir:"desc",val:"dateDesc"},{name:"dateAddedOldestFirst",data:"date",dir:"asc",val:"dateAsc"},{name:"titleA-Z",data:"name",dir:"asc",val:"titleAsc"},{name:"titleZ-A",data:"name",dir:"desc",val:"titleDesc"},{name:"categoryA-Z",data:"cat",dir:"asc",val:"catAsc"},{name:"categoryZ-A",data:"cat",dir:"desc",val:"catDesc"}],e.sortOb.method=O("dateDesc"),E.data.currentLibrary&&E.data.currentLibrary.defaultsort&&(e.sortOb.method=O(E.data.currentLibrary.defaultsort)),g.sortMethod=e.sortOb.method;var t;e.$on("$ionicView.beforeEnter",function(n,o){if(t=null,!(e.native||e.desktop||d.authenticated&&"library"==config.kotobee.mode)){var r="loading";c.forwardView()?r=c.forwardView().stateId:c.backView()&&(r=c.backView().stateId),c.nextViewOptions({disableAnimate:!0}),i.path("/"+r)}c.forwardView()&&(t=c.forwardView().stateId),c.backView()&&(t=c.backView().stateId),"forward"==o.direction&&(E.data.currentLibrary.books=[],E.data.favorites=[])}),e.$on("$ionicView.afterEnter",function(e,t){if("back"==t.direction)return $(),void g.setBrowserTitle();C.cloudParam("entry")?C.login().then(function(e){e.error&&S()}):(C.cloudParam("public"),S())})},e.userLogin=function(){e.data.user.loggedIn?C.logout():t.update({error:"s_authError"})},e.langSelected=function(t){e.langDropdownExpanded=!1,E.data.settings.language=t,T.langChanged()},e.showLibraryMenu=function(){p.show({mode:"libraryMenu",menuItem:e.menuItemClicked,backdropClickToClose:!1})},e.scroll=function(t){var n=V?.95:.8;if(t.scrollTop/(document.getElementById("libraryThumbsContent").offsetHeight-t.offsetHeight)>n){if(D)return;if(!e.moreDataExists())return;D=!0,e.loadMore()}},e.bookClicked=function(t){n.show({book:t,categoryClicked:e.categoryClicked})},e.refresherExists=function(){try{if(!E.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;if("favorites"==e.tab)return!0;if("account"==e.tab)return!0;if("all"==e.tab)return!0}catch(e){return!1}return!0},e.doRefresh=function(){var t={accumulated:!0};"all"==e.tab?M(t):"account"==e.tab?(t.account=!0,M(t)):"favorites"==e.tab?e.loadFavorites(t):e.stopRefresher()},e.sort=function(){g.sortMethod=e.sortOb.method,"downloaded"==e.tab?I("orderBy")(e.data.downloaded,e.sortOb.method.data):"account"==e.tab?M({account:!0}):M()},e.menuItemClicked=function(n){"language"==n&&T.langChanged(),"redeemCode"==n&&(p.hide(),e.redeemCodeClicked()),"info"==n&&(p.hide(),u.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up",libraryInfo:E.data.currentLibrary.libraryinfo})),"logout"==n&&(p.hide(),e.data.user.pwd||e.data.user.code?C.logout():t.update({error:"s_authError"})),"exit"==n&&(p.hide(),u.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){x.exit()}}}))},e.loadFavorites=function(t){t||(t={}),e.paneMsg=null,z&&(t.catid=z.id),F&&(t.key=F),V&&(t.contentkey=V),t.favs=!0,g.getEbooks(t,function(t){"favorites"==e.tab&&(t.error&&(e.paneMsg="failedToGetFavs"),0==t.length&&(e.paneMsg="noFavsAvailable"),$())})},e.searchEbooksOld=function(t){e.subMode="search",e.title="searchResults",F=g.currentKey=t,z=g.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),b(function(){M({account:!0})})):(L("all"),b(M)),R()},e.searchEbooks=function(n){if(n&&n.length&&0!=n.length){if(n.length<3)return t.update({error:"lessThan3Characters"}),void u.hide();e.subMode="search",e.title="searchResults",config.searchLibContent?V=g.currentContentKey=n:F=g.currentKey=n,z=g.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),b(function(){M({account:!0})})):(L("all"),b(M)),R()}},e.enableSearch=function(){e.searchOb.enabled=!0,R()},e.disableSearch=function(){e.searchOb.enabled=!1,j&&j()},e.loadMore=function(){var t={more:!0,accumulated:!0};"all"==e.tab?M(t):"account"==e.tab?(t.account=!0,M(t)):"favorites"==e.tab?e.loadFavorites(t):(e.stopInfiniteScroll(),D=!0)},e.stopInfiniteScroll=function(){s.$broadcast("scroll.infiniteScrollComplete")},e.stopRefresher=function(){s.$broadcast("scroll.refreshComplete")},e.moreDataExists=function(){try{if(!E.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;var t;if("favorites"==e.tab&&(t=e.data.favorites),"all"==e.tab&&(t=E.data.currentLibrary.books),"account"==e.tab&&(t=E.data.currentLibrary.books),0==t.length)return!1}catch(e){return!1}return e.moreData},e.back=function(){e.subMode=!1,e.title=null,F=g.currentKey=null,V=g.currentContentKey=null,z=g.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(L("account"),b(function(){M({account:!0})})):(L("all"),b(M)),j&&j()},e.categoryBackClicked=function(){if(e.catList&&e.catList.length){var t=e.catList[0].parent;for(t=H(t.id);;){if(!(t=t.parent))return void(e.catList=E.data.currentLibrary.categories);if("separate"==(t=H(t.id)).submode)return void(e.catList=t.children)}}},e.categoryClicked=function(t){if(native&&x.vibrate(),"expand"!=t.submode)if("separate"!=t.submode){var n={};z=g.currentCat=t,F=g.currentKey=null,V=g.currentContentKey=null,n.catid=z.id,e.subMode="category",e.title=z.name,e.supportsAccountView?(L("account"),b(function(){M({account:!0})})):(L("all"),b(M)),R()}else e.catList=t.children;else t.expand=!t.expand},e.categoriesClicked=function(){native&&x.vibrate(),L("categories"),e.paneMsg=null,$()},e.accountClicked=function(){native&&x.vibrate(),L("account"),$(),b(function(){M({account:!0})})},e.allClicked=function(){native&&x.vibrate(),L("all"),b(M)},e.downloadedClicked=function(){native&&x.vibrate(),L("downloaded"),e.paneMsg=null,0==E.data.downloaded.length&&(e.paneMsg="noEbooksDownloaded"),$()},e.favoritesClicked=function(){native&&x.vibrate(),L("favorites"),e.loadFavorites()},e.redeemCodeClicked=function(){d.redeemCode({source:"topmenu"},function(){e.allClicked()})}}]),app.controller("LoginCtrl",["$scope","initializer","crdv","$ionicHistory","popovers","design","modals","error","backend","auth","stg","cache","translit","$location",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f){e.model={};e.init=function(){mobile||(i.stylize("login",i.getBgStyle()),l.addListener("pathsChanged",function(){i.stylize("login",i.getBgStyle())})),"email"==config.kotobee.loginmode?e.canLoginByEmail=!0:"code"==config.kotobee.loginmode?e.canLoginByCode=!0:e.canLoginByEmail=e.canLoginByCode=!0,e.mode=e.canLoginByEmail?"email":"code",e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),p.get("login")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||config.kotobee.public||d.data.user.loggedIn){var e="loading";o.forwardView()?e=o.forwardView().stateId:o.backView()&&(e=o.backView().stateId),o.nextViewOptions({disableAnimate:!0}),f.path("/"+e)}})},e.showMenu=function(){var e=[{name:p.get("exit"),func:function(){r.hide(),a.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}];r.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.login=function(){function t(){l.login({dontShowErrorDialog:!0,userInput:!0}).then(function(t){t.error?s.update({error:"s_authError"==t.error?"accessDenied":t.error}):(e.model.pwd=null,e.model.code=null,c.startup())})}if(e.model){if("code"==e.mode){if(!e.model.code)return void s.update({error:"enterYourCode"});d.data.user.code=e.model.code,d.data.user.email=d.data.user.pwd=null}else{if(!d.data.user.email)return void s.update({error:"enterYourEmail"});if(!e.model.pwd)return void s.update({error:"enterYourPwd"});d.data.user.pwd=e.model.pwd,d.data.user.code=null}config.kotobee.permsLoaded?t():c.getPermissions(t)}},e.register=function(){a.hide(),f.path("/register")},e.forgotPassword=function(){f.path("/forgotpwd")},e.signInByEmail=function(){e.mode="email"},e.redeemCode=function(){e.mode="code"}}]),app.controller("MediaCtrl",["$ionicScrollDelegate","media","$ionicModal","$location","$rootScope","$scope","selection","crdv","stg","$ionicLoading",function(e,t,n,o,r,i,a,s,l,c){i.init=function(){},i.mediaClicked=function(e){t.show(e)},i.hide=function(){t.hide()}}]),app.controller("NotebookCtrl",["$scope","$ionicScrollDelegate","$timeout","crdv","translit","$rootScope","selection","book","chapters","$location","modals","$stateParams","hlights","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f){e.model={},e.ui={},e.noteBtns={notes:!0,bookmarks:!0,hlights:!0};e.init=function(){},e.notebookClose=function(){d.hide(),e.bookmarkContent=null,e.noteContent=null,e.hlightContent=null,e.notebook={}},e.noteBtnClicked=function(e,n){"all"==e?n.notes=n.bookmarks=n.hlights=!(n.notes&&n.bookmarks&&n.hlights):(n.notes=n.bookmarks=n.hlights=!1,n[e]=!0),overflowScroll?document.getElementById("notebookContent").scrollTop=0:t.$getByHandle("notebookScroll").scrollTop()},e.pdfExport=function(){var t=e.serializeNotebookHtml(),i=(f.data.book.meta.dc.title?f.data.book.meta.dc.title:r.get("book"))+".pdf";n(function(){o.createPDF(t,i,function(e){})},500)},e.serializeNotebookHtml=function(){function e(e,t,n){for(var o="",r=0;r<e.length;r++){var i=e[r],a=/^[\u0000-\u007f]*$/.test(i);if(a)o+=a?i:"<em>Non-unicode text</em>";else for(var s=0;s<i.length;s++)o+=(a=/^[\u0000-\u007f]*$/.test(i[s]))?i[s]:"?"}return"<"+t+(n?" "+n:"")+">"+o+"</"+t+">"}var t="<br/>",n='<html><head><meta charset="UTF-8" /><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head><body>';n+=e([r.get("notebookFor"),' "'+f.data.book.meta.dc.title+'"'],"h1"),n+=t+t;for(var o=f.data.notebookContent.results,i=0;i<o.length;i++)if(o[i]){var a="";a+=e(s.getTitleByIndex(i),"h2")+t;var l="..................................................................................";a+=e([l+l],"p");for(var c=0;c<o[i].length;c++){var d=o[i][c],u="";null!=d.nid?"page"==d.type?u+=e([r.get("pageNote")+": ",d.note],"p")+t:"content"==d.type&&(u+=e([r.get("noteFor"),' "'+d.src+'"'],"p")+t,u+=e([r.get("note")+": ",d.note],"p")+t):null!=d.hid?(u+=e([r.get("highlightFor"),' "'+d.src+'"'],"p")+t,u+=e([r.get("highlightColor")+": "+d.color+t],"p",'style="background-color:'+d.color+'"')):null!=d.bmid&&(u+=e([r.get("contentBookmark")],"p")+t),a+=e([u],"p")}n+=e([a],"p",'style="border:solid 3px #000;background-color:#ddd"')}return n+="</body></html>"},e.shareNotebook=function(){var t=e.serializeNotebookTxt();o.share(t)},e.serializeNotebookTxt=function(){for(var e="\n",t=r.get("notebookFor")+' "'+f.data.book.meta.dc.title+'"'+e,n=t.length;n--;)t+="#";t+=e+e;for(var o=f.data.notebookContent.results,i=0;i<o.length;i++)if(o[i]){var a=r.get("chapter")+" "+(i+1);t+=a+e;for(n=a.length;n--;)t+="_";t+=e+e;for(var s=0;s<o[i].length;s++){var l=o[i][s];null!=l.nid?"page"==l.type?t+=r.get("pageNote")+": "+l.note+e:"content"==l.type&&(l.src?t+=r.get("noteFor")+' "'+l.src+'"'+e:t+=r.get("note")+e,t+=r.get("note")+": "+l.note+e):null!=l.hid?(t+=r.get("highlightFor")+' "'+l.src+'"'+e,t+=r.get("highlightColor")+" "+l.color+e):null!=l.bmid&&(t+=r.get("contentBookmark")+e),t+="........................\n\n"}}return t},e.deleteFromNotebookContent=function(e,t){for(var n=f.data.notebookContent.results,o=0;o<n.length;o++)if(n[o])for(var r=0;r<n[o].length;r++)if(n[o][r][e]==t)return n[o].splice(r,1),void(n[o].length||n.splice(o,1))},e.noteItemClicked=function(e){var t=e.chapter,o=e.location;o=o.split(",")[0],d.hide(),n(function(){l.redirect(t,{hash:o})},100)},e.deleteNote=function(t,n){f.deleteNote(t,null,function(n){e.noteContent=n,a.deleteNoteMarker(t),e.deleteFromNotebookContent("nid",t);for(var o=document.getElementsByClassName("note"+t),r=o.length;r--;)r==o.length-1&&(removeClass(o[r],"last"),o[r].removeAttribute("nloc"),o[r].removeAttribute("ncontent")),removeClass(o[r],"contentNoteBG"),removeClass(o[r],"note"+t);i.$$phase||i.$apply()}),n.stopPropagation()},e.deleteBookmark=function(t,n){f.deleteBookmark(t,null,function(n){e.bookmarkContent=n,a.deleteBookMarker(t),e.deleteFromNotebookContent("bmid",t),i.$$phase||i.$apply()}),n.stopPropagation()},e.deleteHlight=function(t,n){p.delete(t,null,function(o){e.hlightContent=o,e.deleteFromNotebookContent("hid",t),n.stopPropagation(),i.$$phase||i.$apply()})}}]),app.controller("PreviewCtrl",["cache","modals","popovers","bookinfo","crdv","np","book","$http","$rootScope","initializer","translit","error","notes","$sce","design","settings","status","tinCan","$scope","backend","stg","$location",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w){b.putTest=function(e){},b.init=function(){b.putTest("Preview init"),b.mobile=mobile,b.native=native,b.desktop=desktop,b.ios=ios,b.preview=preview,b.config=config,b.putTest("Global init good"),i.init(function(){})},b.start=function(){l.data=k.data,l.view=k.view,b.cloudParam=y.cloudParam,t.setScope(b),n.setScope(b),b.started=!0},b.previewPage=function(e,t){b.started?(e||(e="bookInfo"),t||(t={lang:"en",book:{name:"Alice",description:"A great book indeed"}}),"bookInfo"==e&&(config=t.config?t.config:{kotobee:{entry:1,mode:"library"}},k.data.user=t.user?t.user:{loggedIn:!0},k.data.currentLibrary=t.library?t.library:{},d.setLang(t.lang?t.lang:"en"),o.show({book:t.book},{animation:"none"}))):setTimeout(function(){b.previewPage(e,t)},100)},b.kTemplate=function(e){return kTemplate(e)},b.translit=function(e){return d.get(e)},b.htmlSafe=function(e){return f.trustAsHtml(e)}}]),app.controller("ReaderCtrl",["$ionicScrollDelegate","modals","library","$sce","$location","$rootScope","$scope","selection","$ionicSideMenuDelegate","$state","$ionicPopover","chapters","book","$timeout","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){a.init=function(){a.mode="reading"},a.chapterClicked=function(e){u.displayChapters()},a.backClicked=function(e){l.isOpenLeft()||t.show({mode:"backToLib",backdropClickToClose:!1,backToLibOptions:{back:function(){t.hide(),p.removeBookConfigElem(),u.clearContent(),setTimeout(n.setBrowserTitle,600),setTimeout(g.resetBook,600),r.path("/library")}}})},a.searchClicked=function(e){a.applyHeader("search")},a.menuClicked=function(e){},a.setting1Clicked=function(e){},a.setting2Clicked=function(e){},a.setting3Clicked=function(e){},a.linkClicked=function(){}}]),app.controller("RedeemCodeCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){e.init=function(){mobile||(r.stylize("redeemCode",r.getBgStyle()),d.addListener("pathsChanged",function(){r.stylize("redeemCode",r.getBgStyle())})),e.$on("$ionicView.afterEnter",function(){p.setOb("title",replaceHTML(p.getOb("title"),f.get("redeemCode")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||d.cloudParam("public")||i.data.user&&i.data.user.loggedIn){var e="loading";l.forwardView()?e=l.forwardView().stateId:l.backView()&&(e=l.backView().stateId),l.nextViewOptions({disableAnimate:!0}),a.path("/"+e)}})},e.showMenu=function(){var e=[{name:f.get("exit"),func:function(){n.hide(),s.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){function t(){d.cloudParam("entry")?(g.history.back(),d.login()):d.login().then(function(e){e.error?c.update({error:"s_authError"==e.error?"accessDenied":e.error}):u.startup()})}e.user&&e.user.code&&(i.data.user.code=e.user.code,i.data.user.email=i.data.user.pwd=null,config.kotobee.permsLoaded?t():u.getPermissions(t))},e.backClicked=function(){g.history.back()}}]),app.controller("RegisterCtrl",["$scope","initializer","popovers","crdv","modals","design","stg","$ionicHistory","$location","translit","backend","backend","translit","cache","error","$window",function(e,t,n,o,r,i,a,s,l,c,d,d,c,u,p,f){function g(){var t=e.user;return-1==t.email1.indexOf("@")?(p.update({error:"emailFormatError"}),!1):/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i.test(t.email1)?t.email1==t.email2||(p.update({error:"emailsDontMatch"}),!1):(p.update({error:"emailFormatError"}),!1)}e.init=function(){e.user={email1:"",email2:""},mobile||(i.stylize("register",i.getBgStyle()),d.addListener("pathsChanged",function(){i.stylize("register",i.getBgStyle())})),e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),c.get("register")))}),e.native||e.desktop||e.$on("$ionicView.beforeEnter",function(){if(!t.initialized||config.kotobee.public||a.data.user.loggedIn){var e="loading";s.forwardView()?e=s.forwardView().stateId:s.backView()&&(e=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),l.path("/"+e)}})},e.showMenu=function(){var e=[{name:c.get("exit"),func:function(){n.hide(),r.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.create=function(){g()&&d.register(e.user,function(e){if(e.error)p.update(e);else{var t="d_accountCreated";e.success&&e.success.approvalRequired&&(t="d_accountCreatedApprovalRequired"),r.show({mode:"success",successOptions:{msg:c.get(t)}}),f.history.back()}})},e.backClicked=function(){f.history.back()}}]),app.controller("RendererCtrl",["$rootScope","$ionicHistory","modals","nav","backend","library","settings","book","auth","status","popovers","$sce","error","translit","cache","$ionicPlatform","bookmarks","hlights","notes","$ionicSideMenuDelegate","$scope","$ionicScrollDelegate","$filter","chapters","$ionicPopup","$location","$timeout","selection","crdv","$ionicLoading","stg","search","$ionicModal",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C,x,I,E,T,O,S,A,B,N,L){k.init=function(){e.renderScope=k,O.listener=k.selection,k.searchContent={},k.sideMenuMode="bookSettings";var r=h.registerBackButtonAction(function(t){kInteractive.frameIsOpen?kInteractive.closeFrame():kInteractive.alertIsOpen?kInteractive.closeAlert():kInteractive.videoIsFullscreen?kInteractive.closeFullscreenVideo():"default"!=k.header.mode?"selection"==k.header.mode?O.reset():k.applyHeader("default"):B.data.book.chapter.viewport&&o.getFxlScale()!=o.getFxlFit().bestFit?o.fxlZoomFit():"library"==config.kotobee.mode?E.path("/library"):e.readerApp?E.path("/app"):n.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){S.exit()}}}),k.$apply()},103);if(k.$on("$destroy",r),!desktop&&!chromeApp&&!preview&&ZeroClipboard){ZeroClipboard.config({trustedDomains:["*"],trustedOrigins:["*"]});var i=new ZeroClipboard(document.getElementById("copyBtn"));i.on("ready",function(e){i.on("aftercopy",function(e){e.target.style.display="none",c.showAndHide(f.get("copiedToClipboard"),500)})}),i.on("error",function(e){noFlash=!0})}k.native||k.desktop||k.$on("$ionicView.beforeEnter",function(){if(!l.authenticated){var e="loading";t.forwardView()?e=t.forwardView().stateId:t.backView()&&(e=t.backView().stateId),t.nextViewOptions({disableAnimate:!0}),E.path("/"+e)}})},k.setSideMenuMode=function(e){k.sideMenuMode=e},k.applyHeader=function(e){try{k.header.mode=e}catch(e){}},k.header={mode:"default"},k.selection=function(e){mobile?"activated"==e||"selectionFixed"==e?k.applyHeader("selection"):"deactivated"==e&&k.applyHeader("default"):"selectionFixed"==e?(addClass(document.getElementById("selectionOptions"),"showBar"),document.getElementById("copyBtn").setAttribute("data-clipboard-text",O.getSelectedText())):"deactivated"==e&&removeClass(document.getElementById("selectionOptions"),"showBar")},k.contentLink=function(e){x.applyChapterStateFromURL(e.getAttribute("href"))},k.chapterLink=function(e){if(e.parentElement.getElementsByTagName("ol").length>0){var t=e.offsetHeight+20;if(overflowScroll||w.$getByHandle("chapters").scrollBy(0,t,!0),!e.getAttribute("href")||e.getAttribute("data-dontshow"))return void(hasClass(e.parentElement,"expanded")?removeClass(e.parentElement,"expanded"):addClass(e.parentElement,"expanded"));addClass(e.parentElement,"expanded")}y.toggleLeft(!1),y.toggleRight(!1),timeOut(function(){k.deApplySelectedChapter(),k.applySelectedChapter(e.parentNode,!1),E.search("vi"),x.applyChapterStateFromURL(e.getAttribute("href"),{vIndex:0}),k.$$phase||k.$apply()},250)},k.targetCurrentChapter=function(e){mobile&&o.resize();var t=O.getIdArray(),n=B.data.book.chapter.url;k.deApplySelectedChapter();for(var r=document.getElementById("chaptersContent").getElementsByTagName("a"),i=[],a=0;a<r.length;a++)-1!=r[a].getAttribute("href").indexOf(n)&&i.push({elem:r[a],id:ph.getHash(r[a].getAttribute("href"))});t.push(void 0);i.length&&k.applySelectedChapter(i[0].elem.parentNode)},k.externalLink=function(e){var t=e.getAttribute("href"),n=e.getAttribute("target");return void r.externalLink(t,{target:n})},k.bookmarkClicked=function(e){m.addBookmark()},k.noteClicked=function(e,t){b.noteClicked([e],t)},k.search=function(e,t,o,r){if(e&&e.length&&0!=e.length){if(e.length<3)return p.update({error:"lessThan3Characters"}),void n.hide();k.applyHeader("default"),void 0==o&&(k.searchStack=[0]),c.update(f.get("searching"),null,{dots:!0,timeoutDuration:6e4}),t||(t="all",o||(o=0));var i={key:e,mode:t,limit:40,start:o,array:r};T(function(){N.start(i,function(e){c.update(null),k.searchContent=e;for(var n=0;n<k.searchContent.results.length;n++)if(k.searchContent.results[n]&&k.searchContent.results[n].matches.length){k.searchContent.notEmpty=!0;break}"all"==t?(k.$broadcast("scroll.infiniteScrollComplete"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop()):"chapter"==t&&T(function(){k.applyHeader("searchItems")},500)})},500)}},k.searchMore=function(){for(var e,t=k.searchContent.results.length;t--;)if(k.searchContent.results[t]&&k.searchContent.results[t].matches[0]){e=k.searchContent.results[t].matches[0];break}e?(k.searchStack.push(e.chapter+1),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop(),k.search(k.searchContent.key,"all",e.chapter+1)):k.searchContent.more=!1},k.searchBack=function(){if(!(k.searchStack.length<=1)){k.searchStack.pop();var e=k.searchStack.pop();overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop(),k.search(k.searchContent.key,"all",e)}},k.locateInChapter=function(e){n.hide(),k.search(e,"chapter")},k.clearResults=function(){k.searchContent={},k.applyHeader("default"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:w.$getByHandle("searchScroll").scrollTop()},k.searchItemClickedVeryOld=function(e){var t=e.item;e.index,e.matches;n.hide(),timeOut(function(){function e(n){if("newChapter"==n){x.removeListener(e);var o=O.getElemsByLocation(t.location)[0];timeOut(function(){addClass(o,"searchItemHighlightFade"),timeOut(function(){removeClass(o,"searchItemHighlightFade")},2200)},1200)}}x.addListener(e),E.path(s.root+"/reader/chapter/"+t.chapter+"/"+t.location)},300)},k.searchItemClicked=function(t){N.searchItemClicked(t,{timer:!0},function(){e.renderScope.applyHeader(""),T(function(){e.renderScope.applyHeader("searchItems"),e.$$phase||e.$apply()})})},k.searchItemClickedOld=function(t,o){function r(e){"renderedChapter"==e&&(c.update(),x.removeListener(r),l.index=a,k.applyHeader("searchItems"))}o||(o={});var i=t.item,a=t.index,l=t.matches;n.hide(),timeOut(function(){c.update(f.get("pleaseWait"),null,{dots:!0}),x.addListener(r);var t=i.chapter,n=i.location,o={hash:n};x.getPageOb({page:t},function(i){if(x.shouldBePaged(i)){var a=O.getPageByLocation(i,n);null!=a&&(o.vIndex=a,E.search({vi:a}))}if(E.path(s.root+"/reader/chapter/"+t+"/"+n,o),i.index==currentIndex){if(o.vIndex&&o.vIndex==currentVIndex)return void r("renderedChapter");x.loadChapterByIndex(currentIndex,o)}e.$$phase||e.$apply()})},300)},k.fxlZoomIn=function(e){o.fxlZoomIn(e)},k.fxlZoomOut=function(e){o.fxlZoomOut(e)},k.fxlZoomFit=function(e){o.fxlZoomFit(e)}}]),app.controller("SearchItemsCtrl",["$ionicScrollDelegate","search","book","chapters","cache","$ionicModal","$location","virt","$rootScope","$scope","selection",function(e,t,n,o,r,i,a,s,l,c,d){c.index=0;c.init=function(){c.index=0,c.titleMode=3,c.results=[];var e=c.searchContent.results[currentIndex];e&&(c.results=e.matches),c.results.index&&(c.index=c.results.index),0==c.results.length?c.titleMode="empty":c.highlightCurrentItem({initial:!0}),c.$on("$destroy",function(){t.removeHighlights()})},c.backClicked=function(){c.applyHeader("default")},c.up=function(){0==c.index&&(c.index=c.results.length),c.index--,c.highlightCurrentItem()},c.down=function(){c.index==c.results.length-1&&(c.index=-1),c.index++,c.highlightCurrentItem()},c.highlightCurrentItem=function(e){function n(e){if("renderedChapter"==e){o.removeListener(n),o.hideLoader();var t=o.getCurrentHash(),r=d.getElemsByLocation(t);r[0]&&(r[0].offsetParent?(c.titleMode="title",addClass(r[0],"searchItemHighlight"),s.safeScrollToElem("content",r[0],!0)):c.titleMode="hidden")}}if(e||(e={}),c.results){var r;o.getPageOb({page:currentIndex},function(i){if(t.removeHighlights(),r=c.results[c.index].location,e.initial)return n("renderedChapter");o.addListener(n),o.redirect(currentIndex,{hash:r})})}}}]),app.controller("SelectionCtrl",["$ionicScrollDelegate","chapters","translit","error","status","modals","notes","$window","$location","$sce","$rootScope","backend","hlights","$scope","selection","crdv","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m){f.init=function(){},f.tts=function(){if(config.tts){var e=g.getSelectedText();if(e)if(desktop)o.update({error:"speechUnsupportedInDesktop"});else if(preview)o.update({error:"speechUnsupportedInPreview"});else if(native&&"undefined"!=typeof TTS)h.tts(e,function(e){});else try{if("speechSynthesis"in window&&SpeechSynthesisUtterance){r.showAndHide(n.get("preparingVoice"),600,{dots:!0}),window.speechSynthesis.cancel();var t=new SpeechSynthesisUtterance,i=window.speechSynthesis.getVoices();if(t.lang=config.defaultTtsLanguage?config.defaultTtsLanguage:"en-US",t.voice=i.filter(function(e){return e.lang==t.lang})[0],!t.voice)return;t.text=e,window.speechSynthesis.speak(t)}else o.update({error:"speechUnsupported"})}catch(e){o.update({error:"speechUnsupported"})}}},f.copy=function(){if(config.clipboardCopy){var e=g.getSelectedText();if(e)if(native)h.copyToClipboard(e);else if(desktop)require("nw.gui").Clipboard.get().set(e,"text"),r.showAndHide(n.get("copiedToClipboard"),500);else if(chromeApp){var t=document.createElement("textarea");document.body.appendChild(t),t.value=e,t.focus(),t.select(),document.execCommand("Copy"),t.remove(),r.showAndHide(n.get("copiedToClipboard"),500)}else noFlash&&(i.show({mode:"flashUnsupported",flashOb:{text:e}}),setTimeout(function(){document.getElementById("clipboardText").focus(),document.getElementById("clipboardText").select()},200))}},f.share=function(){if(config.share){var e=g.getSelectedText();e&&h.share(e)}},f.note=function(e){if(config.annotations){var n,o,r=g.getLocation(),i=[];r.left&&((n={}).type="content",n.location=r.left,o=g.getElemsByLocation(n.location),n.chapter=t.getElemChapterIndex(o[0]),n.src=g.getSelectedText(o),n.event=e,i.push(n)),r.right&&((n={}).type="content",n.location=r.right,o=g.getElemsByLocation(n.location),n.chapter=t.getElemChapterIndex(o[0]),n.src=g.getSelectedText(o),n.event=e,i.push(n)),a.noteClicked(i,function(e){g.reset()})}},f.highlight=function(){function e(){p.showPopup(i,function(e){g.reset()})}if(config.annotations){var n,o=g.getSelectedNodes(),r=g.getLocation(),i=[];r.left&&((n={}).location=r.left,o=g.getElemsByLocation(n.location),n.chapter=t.getElemChapterIndex(o[0]),n.src=g.getSelectedText(o),i.push(n)),r.right&&((n={}).location=r.right,o=g.getElemsByLocation(n.location),n.chapter=t.getElemChapterIndex(o[0]),n.src=g.getSelectedText(o),i.push(n));for(var a=0;a<o.length;a++)if(hasClass(o[a],"contentHlightBG")){for(var s=getClassThatStartsWith(o[a],"hlight"),l=0;l<i.length;l++)i[l].hid=s.substr(6);return void m.getHlightById(i[0].hid,function(t){for(var n=0;n<i.length;n++)i[n].color=t.color;e()})}e()}},f.google=function(){if(config.googleLookup){var e=g.getSelectedText();if(e)try{var t="http://www.google.com/custom?q="+e;return void u.externalLink(t,{secure:!0})}catch(e){}}},f.wikipedia=function(){if(config.wikipediaLookup){var e=g.getSelectedText();if(e)try{var t="https://"+(config.wikipediaLang?config.wikipediaLang:"en")+".wikipedia.org/wiki/"+e;u.externalLink(t,{secure:!0})}catch(e){}}},f.backClicked=function(){g.reset()}}]),app.controller("SelectionOptionsCtrl",["$scope","$http","stg","$ionicScrollDelegate","$ionicPopup","$timeout","selection",function(e,t,n,o,r,i,a){e.init=function(){},e.expand=function(){a.expand()},e.extendRight=function(){a.extendRight()},e.extendLeft=function(){a.extendLeft()}}]),app.controller("TabMenuCtrl",["$scope","cache","modals","nav","settings","book","notes","$rootScope","$ionicSideMenuDelegate","library","$stateParams","$location","$sce","$ionicScrollDelegate","chapters","virt","translit","$ionicModal","hlights","$timeout","$filter","stg","crdv","selection",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C,x){e.init=function(){e.$watch(function(){return l.isOpenRight()},function(t){t||y(function(){e.setSideMenuMode("bookSettings")},100)})},e.chaptersClicked=function(){g.displayChapters()},e.mediaClicked=function(){if(w.data.settings.rtl){if(l.isOpenLeft()&&"media"!=e.sideMenuMode)return l.toggleLeft(),void y(e.mediaClicked,300)}else if(l.isOpenRight()&&"media"!=e.sideMenuMode)return l.toggleRight(),void y(e.mediaClicked,300);native&&C.vibrate(),e.setSideMenuMode("media"),mobile&&o.resize(),w.data.settings.rtl?l.toggleLeft():l.toggleRight()},e.notebookClicked=function(){s.widescreen?e.chaptersClicked():(native&&C.vibrate(),a.updateNotebookArray({},function(){overflowScroll||o.resize(),n.show({mode:"notebook",dynamic:!0,scope:e,animation:"slide-in-up",cb:function(){overflowScroll?document.getElementById("notebookContent").scrollTop=0:f.$getByHandle("notebookScroll").scrollTop()}})}))},e.pdfClicked=function(){g.pdfPrint()},e.printClicked=function(){g.print()},e.settingsClicked=function(){if(w.data.settings.rtl){if(l.isOpenLeft()&&"bookSettings"!=e.sideMenuMode)return l.toggleLeft(),void y(e.settingsClicked,300)}else if(l.isOpenRight()&&"bookSettings"!=e.sideMenuMode)return l.toggleRight(),void y(e.settingsClicked,300);native&&C.vibrate(),e.setSideMenuMode("bookSettings"),mobile&&o.resize(),w.data.settings.rtl?l.toggleLeft():l.toggleRight()},e.searchClicked=function(){native&&C.vibrate(),mobile&&o.resize(),n.show({mode:"search",dynamic:!0,animation:"slide-in-up",scope:e,cb:function(){e.searchContent.notEmpty||y(function(){C.showKeyboard()},200)}})},e.settingsClose=function(){n.hide(),w.writeSlot("settings"+w.getBookId(!0),e.data.settings)};var I=[];e.customTabClicked=function(e,t){var n=document.createElement("div");if(e.relToRoot=!0,"audio"==e.type){var o=ph.join(bookPath,e.audio);e.id||(e.id=Math.round(1e4*Math.random()));for(var r,i=0;i<I.length;i++)if(I[i].getAttribute("id")=="audio-"+e.id&&!(r=I[i]).paused)return r.pause(),void(r.src="");if(!r){(r=document.createElement("audio")).setAttribute("data-dontclose",!0),r.setAttribute("id","audio-"+e.id),r.setAttribute("controls","true"),r.setAttribute("autoplay","true"),r.setAttribute("data-tap-disabled","false");var a=document.createElement("source");a.src=o,r.appendChild(a),r.appendChild(document.createTextNode("Your browser does not support the audio element")),r.className="ki-noHighlight",r.oncanplay=function(){kInteractive.tinCan({verb:"played",activity:"Audio: "+o})}}if(r.setAttribute("src",o),r.play(),I.push(r),kInteractive.scorm){var l={};l.id=kInteractive.getScormId(e.title,o),l.description="Played audio link: "+o,l.type="other",l.learnerResponses="Played",l.objective=e.options?e.options.objective:null,l.timestamp=new Date,kInteractive.scorm.setInteractions([l])}}else{kInteractive.writeData(n,e);var c=e.url;if(e.hash&&(c+=e.hash),n.className="kInteractive link",!c)return kInteractive.action(n,t),void t.stopPropagation();n.setAttribute("href",c),e.target&&"_blank"==e.target.toLowerCase()&&n.setAttribute("target","_BLANK"),c.match(/http[s]?:/g)?s.renderScope.externalLink(n):0==c.indexOf("/")?window.open(c):0==c.indexOf("mailto:")?window.location.href=c:(0!=c.indexOf("#")&&(c=ph.join(w.data.book.chapter.url,c)),g.applyChapterStateFromURL(c))}}}]),app.controller("TextSizeCtrl",["$scope","$location","cssParser","stg","settings","markers","$injector",function(e,t,n,o,r,i,a){function s(){"rfl"==o.data.book.chapter.layout&&("double"!=o.data.book.chapter.view&&o.data.settings.pageScroll||a.get("chapters").regenerateSpreads(null,function(){}))}e.backClicked=function(){e.applyHeader("default")},e.plus=function(){var t=r.getTextSize();t>30||(t=Math.round(10*(t+.1))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize(),s())},e.minus=function(){var t=r.getTextSize();t<=.2||(t=Math.round(10*(t-.1))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize(),s())}}]),app.controller("ThumbCtrl",["$scope","$filter","$rootScope","np","$element","stg","$ionicModal","modals","chapters","backend","book","$location","$timeout","$ionicLoading","$ionicPopup","crdv",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h){e.init=function(){if(e.book.coverImg=d.getCoverImgPath(e.book),chromeApp)if(i.data.chromeAssets[e.book.coverImg])e.book.coverImg=i.data.chromeAssets[e.book.coverImg];else{var t=e.book.coverImg;delete e.book.coverImg,getImgDataSrc(t,function(n){e.book.coverImg=n,i.data.chromeAssets[t]=n,e.$apply()})}}}]),app.filter("bookSetup",["$rootScope","stg","selection","media","chapters","cache","$ionicScrollDelegate",function(e,t,n,o,r,i,a){return function(){function a(e){n.active()&&n.reset();var t=e.target;if("sections"!=t.nodeName.toLowerCase()&&!hasClass(t,"k-section")&&"video"!=t.nodeName.toLowerCase()&&"audio"!=t.nodeName.toLowerCase())for(var o=t.childNodes.length;o--;)if("#text"==t.childNodes[o].nodeName&&""!=t.childNodes[o].nodeValue.replace(/\s+/g," ").trim())return void n.elementDown(t,e)}var s=document.getElementById("chaptersContent"),l=document.getElementById("epubContainer");i.setOb("epubContainer",l),i.setOb("chaptersContent",s),document.getElementById("chapters").addEventListener("click",function(t){function n(e){for(var t=e.parentNode;t&&t!=document.body;){if(hasClass(t,"menu")&&(hasClass(t,"menu-left")||hasClass(t,"menu-right")))return!0;t=t.parentNode}}var o=t.target;if("a"==o.nodeName.toLowerCase()){if(!n(o))return;var r=o.getAttribute("href");if(!r)return;if(r.match(/http[s]?:/g))return;if(0==r.indexOf("/"))return;e.renderScope.chapterLink(o)}else if("i"==o.nodeName.toLowerCase()){if(!n(o))return;if(o.parentElement.getElementsByTagName("ol").length>0)o.offsetHeight,o.parentElement.classList.toggle("expanded")}}),l.addEventListener("touchstart",a),l.addEventListener("mousedown",a),l.addEventListener("click",function(n){var i=n.target;if(i){for(var a=i;a&&a!=l;){if("a"==a.nodeName.toLowerCase()){if(hasClass(a,"ki-btn"))kInteractive.action(a,n);else{var s=a.getAttribute("href");if(!s)return kInteractive.action(a,n),void n.stopPropagation();s.match(/http[s]?:/g)?e.renderScope.externalLink(a):0==s.indexOf("/")?window.open(s):0==s.indexOf("mailto:")?window.location.href=s:(0!=s.indexOf("#")&&(s=ph.join(t.data.book.chapter.url,s)),r.applyChapterStateFromURL(s))}return void n.stopPropagation()}a=a.parentNode}if("video"!=i.nodeName.toLowerCase()&&"audio"!=i.nodeName.toLowerCase()){if("img"==i.nodeName.toLowerCase()){if(hasClass(i,"kInteractive")&&"none"!=kInteractive.readData(i).behavior)return kInteractive.action(i,n),void n.stopPropagation();var c=i.parentNode;if(hasClass(c,"kInteractive")){if(hasClass(c,"widget"))return kInteractive.action(i,n),void n.stopPropagation();if(hasClass(c,"questions"))return kInteractive.action(i,n),void n.stopPropagation()}var d=!0,u=kInteractive.readData(i);if(u?u.popup||(d=!1):d=!1,i.hasAttribute("static")&&(d=!1),i.hasAttribute("data-static")&&(d=!1),d){var p={thumbnail:i.getAttribute("src"),title:i.getAttribute("alt")};return o.show(p),void n.stopPropagation()}}return hasClass(i,"ki-btn")?(kInteractive.action(i,n),void n.stopPropagation()):hasClass(i,"kInteractive")?(kInteractive.action(i,n),void n.stopPropagation()):void("input"!=i.nodeName.toLowerCase()||n.stopPropagation())}}})}}]),app.filter("chapterHtml",function(){return function(e){if(e){for(var t=e.getElementsByTagName("li"),n=t.length;n--;){addClass(t[n],"item");var o=t[n].getElementsByTagName("ol").length?" parent":"";t[n].innerHTML='<i class="icon'+o+'"> </i> '+t[n].innerHTML}e.innerHTML=e.innerHTML.replace(/(<a .*?)(>)/g,'$1 onclick="return false;" $2')}}}),app.filter("contentHtml",["$rootScope","$filter","selection","stg",function(e,t,n,o){return function(e,t){var n=document.createElement("div");n.setAttribute("id","epubContent"),t||(t=o.data.book.chapter.absoluteURL);for(var r=e.getElementsByTagName("body")[0],i=[],a=0;a<r.childNodes.length;a++)3==r.childNodes[a].nodeType&&i.push(r.childNodes[a]);for(a=0;a<i.length;a++){var s=i[a],l=document.createElement("span");l.textContent=s.textContent,s.nextSibling?r.insertBefore(l,s.nextSibling):r.appendChild(l),r.removeChild(s)}kInteractive&&kInteractive.preRender(e,{chapterUrl:t});for(var c=getElementsByAttribute(e,"*","src"),a=0;a<c.length;a++)if(shouldParse(g=c[a].getAttribute("src"))&&c[a].setAttribute("src",ph.join(t,g)),"img"==c[a].nodeName.toLowerCase()&&(hasClass(c[a],"kInteractive")||hasClass(c[a].parentNode,"kInteractive")||c[a].style.height||c[a].getAttribute("height")||(c[a].style.maxWidth="100%"),chromeApp&&c[a].getAttribute("src"))){var d=c[a],u=d.getAttribute("src");if(isAbsoluteURLAndNotDataPath(u)){var p=d.getAttribute("chrome");o.data.chromeAssets[u]?d.setAttribute("src",o.data.chromeAssets[u]):p&&o.data.chromeAssets[p]?d.setAttribute("src",o.data.chromeAssets[p]):(p=Math.round(1e5*Math.random()),d.setAttribute("src",""),d.setAttribute("chrome",p),getImgDataSrc(u,function(e){setTimeout(function(){o.data.chromeAssets[p]=e;var t=getElementsByAttribute(document,"img","chrome",p);t.length&&t[0].setAttribute("src",e)},300)}))}}for(var f=getElementsByAttribute(e,"*","poster"),a=0;a<f.length;a++){var g=f[a].getAttribute("poster");shouldParse(g)&&f[a].setAttribute("poster",ph.join(t,g))}var h=document.createElement("sections"),m=e.getElementsByTagName("body")[0];if(partitionEnabled){for(var v=new Array,b=0;;){var y=!0,k=!1,w=0;v[b]=document.createElement("section"),v[b].setAttribute("sec",b),addClass(v[b],"k-section");for(a=m.childNodes.length;a--;)if(!m.childNodes[a].style||"absolute"!=m.childNodes[a].style.position){if(!((w+=(null!=m.childNodes[a].textContent?m.childNodes[a].textContent:m.childNodes[a].data).length)<4e3||y)){k=!0;break}y=!1,v[b].insertBefore(m.childNodes[a],v[b].firstChild)}if(!k)break;b++}for(a=0;a<v.length;a++)h.insertBefore(v[a],h.firstChild)}else{var C=document.createElement("section");C.setAttribute("sec","0"),addClass(C,"k-section");for(a=m.childNodes.length;a--;)C.insertBefore(m.childNodes[a],C.firstChild);h.appendChild(C)}if(m.appendChild(h),parseSecsSeparate)n.innerHTML=e.getElementsByTagName("body")[0].innerHTML;else{var x,I=[],E=-1!=(x=e.getElementsByTagName("body")[0].innerHTML).indexOf("<pre"),T=-1!=x.indexOf("<code"),O=-1!=x.indexOf("<script");E||T||O?(I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),I.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])):(I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),I.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])),I.push([/<([^\/][^\s>]*)([^<]*?>)(\s*[^<\s]+\s*)(<(?!\/\1))/g,"<$1$2<span>$3</span>$4"]),I.push([/(<[\/]+?[^\s>]*[^<]*?>)(\s*[^<\s]+\s*)(<)/g,"$1<span>$2</span>$3"]);for(a=0;a<I.length;a++)for(var S=I[a][0],A=I[a][1];S.test(x);)x=x.replace(S,A);n.innerHTML=x}return pauseVideoAndAudio(n),n}}]),app.filter("contentJs",["$rootScope","cache","cssParser","$filter","selection","stg","$q","settings","chapters","bookmarks","hlights","notes",function(e,t,n,o,r,i,a,s,l,c,d,u){return function(e){function n(){function e(){if(r++,"#e7e3d9"==rgb2hex(window.getComputedStyle(t.getOb("epubContent")).getPropertyValue("background-color"))){clearInterval(n),removeClass(o,"hide");for(var e=document.getElementsByTagName("style"),r=0;r<e.length;r++)if(e[r].hasAttribute("kotobee")){var i=e[r].innerHTML;i=i.replace(/[^}]*?{[^}]*?background-color:#e7e3d9 !important;.*?}/g,""),e[r].innerHTML=i}s.initialize(),l.resolve({})}}removeClass(t.getOb("epubContent"),"bgInherit");var n=setInterval(e,30);e()}var o,l=a.defer(),p=t.getOb("epubContent");return document.getElementById("epubMeta")?(document.getElementById("epubMeta").innerHTML="",o=document.getElementById("epubMeta")):((o=document.createElement("div")).setAttribute("id","epubMeta"),o.className="hide",p.parentNode.insertBefore(o,p.nextSibling)),t.setOb("epubMeta",o),r.newChapter(),!parseSecsSeparate||e?i.getBookmarks(function(e){i.getNotes(function(t){i.getHlights(function(o){for(r=0;r<e.length;r++)e[r].chapter==currentIndex&&c.addIcon(e[r]);for(r=0;r<t.length;r++)t[r].chapter==currentIndex&&u.addIcon(t[r]);for(var r=0;r<o.length;r++)o[r].chapter==currentIndex&&d.addHlight(o[r]);n()})})}):n(),l.promise}}]),app.filter("contentVirt",["stg","bookmarks","notes","workers","hlights","$timeout","$filter","cache","$ionicScrollDelegate",function(e,t,n,o,r,i,a,s,l){var c,d,u,p,f=[];return function(a,l,g){function h(e){if(e){for(var t=f.length;t--;)if(f[t]==e)return;var n=s.getOb("epubContent").className;addClass(s.getOb("epubContent"),"reveal");var o=e.offsetTop-s.getOb("epubContent").offsetTop;0!=o&&(e.style.marginTop=o+"px",f.push(e),s.getOb("epubContent").className=n)}}function m(e,t){function n(){i.html=b[0].html,o.call("htmlParser","parse",[i],function(e){var t=replaceHTML(b[0].el,e),o=b[0].options;o.includeAnnotations&&v(t),b.shift(),o.cb&&o.cb(t),b.length&&n()})}t||(t={}),t.id=Math.round(9999*Math.random());t.cb;if(null==t.includeAnnotations&&(t.includeAnnotations=!0),!parseSecsSeparate)return t.cb&&t.cb(e),e;if(hasClass(e,"parsed"))return t.cb&&t.cb(e),e;addClass(e,"parsed");var r=e.innerHTML;if(o.supported()&&t.allowWorkers){var i={};return b.push({html:r,el:e,options:t}),1==b.length&&n(),!0}var a,s=[];r.indexOf("<pre"),r.indexOf("<code"),r.indexOf("<script");s.push(/([< \/][^>]*?>)((\s*[^<\s]+\s+?)+)([^<\s]+\s*)(<)/g),a=/(>)([^<\n]*?[^<]+?)(<[^\/])/g;for(var l=0;l<s.length;l++){var c=s[l];r=r.replace(c,function(e,t){if(arguments[1].indexOf('class="parsed"')>=0)return e;if(0==arguments[1].indexOf("<pre"))return e;if(0==arguments[1].indexOf("<code"))return e;if(0==arguments[1].indexOf("<script"))return e;var n="",o=arguments[2].split(" ");""==o[o.length-1]&&o.splice(-1,1),o.push(arguments[4]);for(var r=0;r<o.length;r++){var i=r==o.length-1?"":" ";n+="<span>"+o[r]+i+"</span>"}return arguments[1]+n+"<"})}a&&(r=r.replace(a,function(e,t){if(!arguments[2].trim())return e;var n="<span>"+arguments[2]+"</span>";return arguments[1]+n+arguments[3]}));var d=replaceHTML(e,r=r.replace(/(<a [\s\S]*?)(>)/g,'$1 onclick="return false;" $2'));return t.includeAnnotations&&v(d),g&&g(),d}function v(o){for(var a=0,s=o;null!=(s=s.previousSibling);)a++;var l=[currentIndex];e.data.currentRPageOb&&l.push(e.data.currentRPageOb.index),i(function(){e.getBookmarks(function(o){e.getNotes(function(i){e.getHlights(function(e){for(var s=0;s<l.length;s++){for(c=0;c<o.length;c++)o[c].chapter==l[s]&&o[c].location.split(".")[1]==a&&t.addIcon(o[c]);for(c=0;c<i.length;c++)i[c].chapter==l[s]&&i[c].location.split(".")[1]==a&&n.addIcon(i[c]);for(var c=0;c<e.length;c++)e[c].chapter==l[s]&&e[c].location.split(".")[1]==a&&r.addHlight(e[c])}})})})},1e3)}try{var b=[];if("reset"==a)return c=d=null,u=!0,void(f=[]);var y=s.getOb("epubContent");if("reveal"==a)return void addClass(y,"reveal");if("undoReveal"==a)return void removeClass(y,"reveal");if("parse"==a)return void m(l,{includeAnnotations:!1,allowWorkers:!0,source:"parse mode",cb:g});if("parseAndAnnotations"==a)return void m(l,{allowWorkers:!0,source:"parseAndAnnotations mode"});var k,w=y.parentNode.parentNode,C=w.style.webkitTransform||w.style.mozTransform||w.style.transform;k=null==a&&null!=l?l:!overflowScroll||!config.overflowScroll&&preview&&mobile?-Number(C.split(",")[1].slice(0,-2)):s.getOb("epubContainer").scrollTop;var x=p>k?"up":"down";p=k;var I,E,T=k+w.parentNode.offsetHeight,O=y.children;if(u){for(var S=[],A=0,B=0;B<O.length;B++){for(var N=[],L=O[B],M=0;M<L.childNodes.length;M++)N[M]={},L.childNodes[M].offsetTop+L.childNodes[M].offsetHeight<k-200?N[M].add=["cNone","noMargin"]:L.childNodes[M].offsetTop>T+200?N[M].add=["cNone","noMargin"]:(0==A&&(N[M].setMargin=!0,A=1,I=M),N[M].remove=["cNone","noMargin"],N[M].setParse=!0,E=M);for(M=0;M<N.length;M++)N[M].setMargin&&h(L.childNodes[M]),N[M].setParse&&S.push([L.childNodes[M],{source:"from clean",allowWorkers:!0}]),addRemoveClass(L.childNodes[M],N[M].add,N[M].remove);for(M=0;M<N.length;M++);null!=I&&(c=L.childNodes[I]),null!=E&&(d=L.childNodes[E])}if(u=!1,S.length)for(M=0;M<S.length;M++){var $=S[M];M==S.length-1&&($[1].cb=g),m($[0],$[1])}else g&&g();return}if("fxl"==e.data.book.chapter.layout)return;if(O.length>1)return;if(1==O[0].childNodes.length)return;L=O[0];if("up"==x){if(!(c.offsetTop+c.offsetHeight)<k-0&&!(c.offsetTop>k-200))return;if(d==L.childNodes[0])return}else if("down"==x){if(!(d.offsetTop>T+0||d.offsetTop+d.offsetHeight<T+200))return;if(c==L.childNodes[L.childNodes.length-1])return}c&&(c.offsetTop+c.offsetHeight<k-0?(addClass(c,"cNone"),addClass(c,"noMargin"),c.nextSibling&&(removeClass(c=c.nextSibling,"noMargin"),h(c),c=m(c,{source:"topElem1"}))):c.offsetTop>k-200&&c.previousSibling&&(addClass(c,"noMargin"),removeClass(c=c.previousSibling,"cNone"),removeClass(c,"noMargin"),h(c),c=m(c,{source:"topElem2"}))),d&&(d.offsetTop>T+0?(addClass(d,"cNone"),d.previousSibling&&(removeClass(d=d.previousSibling,"cNone"),d=m(d,{source:"bottomElem1"}))):d.offsetTop+d.offsetHeight<T+200&&d.nextSibling&&(removeClass(d=d.nextSibling,"cNone"),d=m(d,{source:"bottomElem2"})))}catch(e){}}}]),app.filter("js",["$rootScope","$q","jsParser",function(e,t,n){return function(e,o){var r=t.defer();o||(o={});for(var i=[],a=e.getElementsByTagName("script"),s=0;s<a.length;s++)if(a[s].getAttribute("src")){var l=a[s].getAttribute("src");if(l.indexOf("/kotobeeInteractive.js")>=0)continue;l.indexOf(":/"),i.push({mode:"url",val:l})}else i.push({mode:"code",val:a[s].innerHTML});var c=e.getElementsByTagName("body")[0];return c.getAttribute("onload")&&i.push({mode:"code",val:c.getAttribute("onload")}),o.noJsParse?r.resolve():n.inject(i,function(e){r.resolve(e)}),r.promise}}]),app.filter("coverPath",["stg",function(e){return function(t,n){var o=(config.kotobee.liburl?config.kotobee.liburl:"")+"img/ui/defaultCover.png";return t?isAbsoluteURLPath(t)?t:n?(config.kotobee.liburl?config.kotobee.liburl:"../../")+"books/"+n+"/EPUB/"+t:ph.join(bookPath,e.data.packageURL,t):o}}]),app.filter("categoryStyle",["stg",function(e){return function(e){var t="";isKotobeeHosted()&&(t=publicRoot);var n="";return"image"!=e.display&&"imagetext"!=e.display||e.img&&(n+="background-image:url("+(t+"imgUser/"+e.img)+");"),"image"==e.display&&(n+="color:transparent;"),e.css&&(n+=e.css),n}}]),app.filter("catImgPath",["stg",function(e){return function(e){var t=(config.kotobee.liburl?config.kotobee.liburl:"")+"imgUser/"+e;return config.kotobee.liburl+"/"+ph.join(bookPath,t)}}]),app.filter("decodeHtmlEntities",function(){return function(e){return decodeHTMLEntities(e)}}),app.filter("nativeLinks",function(){return function(e){var t=document.createElement("div");t.innerHTML=e;for(var n=t.getElementsByTagName("a"),o=0;o<n.length;o++){var r=n[o].getAttribute("href");n[o].setAttribute("onclick","window.open('"+r+"', '_system');"),n[o].setAttribute("href","#")}return t.innerHTML}}),app.filter("moreDataExists",["stg",function(e){return function(t,n){try{if(!e.currentLibrary)return!1;if("categories"==n)return!1;if("downloaded"==n)return!1;var o;if("favorites"==n&&(o=e.favorites),"all"==n&&(o=e.currentLibrary.books),0==o.length)return!1}catch(e){return!1}return t}}]),app.filter("round",function(){return function(e){return Math.round(e)}}),app.filter("arrayEmpty",["$filter",function(e){return function(t){if(!t)return!0;for(var n=0;n<t.length;n++)if(Array.isArray(t[n])){if(!e("arrayEmpty")(t[n]))return!1}else if(t[n])return!1;return!0}}]),app.filter("langFromId",["stg",function(e){return function(t){for(var n=0;n<e.data.languages.length;n++)if(e.data.languages[n].val==t)return e.data.languages[n].label;return t}}]),app.filter("unsafe",["$sce",function(e){return e.trustAsHtml}]),app.filter("nl2br",function(){return function(e){return e?e.indexOf("</")>=0?e:e.replace(/\n/g,"<br>"):""}}),app.filter("releasePlatform",function(){return function(e){switch(e){case"win32":return"Windows 32-bit";case"win64":return"Windows 64-bit";case"win":return"Windows";case"mac":return"Macintosh"}}}),app.filter("styles",["$rootScope","$q","cssParser","$filter","selection","stg",function(e,t,n,o,r,i){return function(e,o){var r=t.defer();o||(o={});for(var i,a=[],s=e.getElementsByTagName("link"),l=0;l<s.length;l++)if("text/css"==s[l].getAttribute("type")&&s[l].getAttribute("href").length){var c=ph.join(o.path,s[l].getAttribute("href")),d=!1;if(isAbsoluteURLPath(s[l].getAttribute("href"))&&(c=s[l].getAttribute("href"),d=!0),function(e){if(e.indexOf("/css/kotobeeInteractive.css")>=0)return!0}(c))continue;c==bookPath+"EPUB/css/base.css"&&(i=!0),a.push({type:"path",val:c,dontCache:d})}i||a.unshift({type:"path",val:bookPath+"EPUB/css/base.css",dontCache:!1});for(var u=e.getElementsByTagName("style"),l=0;l<u.length;l++)a.push({type:"local",val:u[l].innerHTML,root:o.path});return o.noCssParse?r.resolve():n.inject(a,o,function(e){r.resolve(e)}),r.promise}}]),app.filter("t",["translit",function(e){return function(t,n){return e.getLang()?e.get(t,Array.prototype.slice.call(arguments,2)):""}}]),app.factory("app",["$q","backend","modals","$location","sync","$ionicHistory","book","chapters","$compile","translit",function(e,t,n,o,r,i,a,s,l,c){return{}}]),app.factory("auth",["$q","backend","modals","$location","sync","$ionicHistory","status","stg","book","view","chapters","app","$compile","translit",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f){function g(){if({}.watermarkPlaceholder){var e='<div id="watermark"><span>'+f.get("createdUsing")+'</span><a href="#" class="inlineBlock" style="vertical-align: sub" onclick="window.open(\'https://www.kotobee.com\', \'_system\');return false;"><img width="163" src="'+rootDir+'img/ui/authorLogo.png"></a></div>',t=document.createElement("div");t.innerHTML=e,document.body.insertBefore(t,document.getElementById("html5Fallback")),setTimeout(function(){addClass(document.getElementById("watermark"),"show")},4e3)}}var h={};return h.authenticate=function(r){r||(r={putTest:function(){},$$phase:!0});var i=e.defer();return r.putTest("inside"),h.getPermissions(function(e){c.generate();try{if("book"==config.kotobee.mode&&isKotobeeHosted())if(config.kotobee.public)bookPath=publicRoot+"epub/";else{var r=publicRoot.split("/books/")[1].split("/")[0];bookPath="/books/"+r+"/EPUB/epub/"}if((native||desktop)&&e&&t.cloudParam("offline")&&"offline"==e.error)return void h.startup({tab:"downloads"})}catch(e){}t.cloudParam("public")||t.cloudParam("entry")?h.startup():t.login().then(function(e){e.error?(n.hide(),o.path("/login")):h.startup()})}),i.promise},h.getPermissions=function(e){"library"==config.kotobee.mode?t.getUnauthLibrary(function(t){if(t||(t={}),"offline"!=t.error){if(t.cloud)for(var n in t.cloud)config.kotobee[n]=t.cloud[n];config.kotobee.permsLoaded=!0,e()}else e(t)}):"book"==config.kotobee.mode?(config.kotobee.public=!0,e()):u.getPermissions(e)},h.startup=function(e){if(e||(e={}),native&&g(),"library"==config.kotobee.mode){h.authenticated=!0;var t="";e.tab&&(t="/tab/"+e.tab);try{o.path("/library"+t)}catch(e){}i.clearHistory()}else"book"==config.kotobee.mode?l.loadBook().then(function(){h.authenticated=!0,o.path("/reader"),i.clearHistory(),r.initialize(),setTimeout(function(){d.initialize()},1e3)}):"app"==config.kotobee.mode&&(h.authenticated=!0,o.path("/app"),i.clearHistory())},h.redeemCode=function(e,o){var r=clone(e),i={model:{}};i.submit=function(){n.hide(),r.code=i.model.code,r.code&&(a.update(f.get("pleaseWait"),null,{dots:!0}),t.redeemCode(r,function(e){e&&!e.error?(a.update(),o()):a.showAndHide(f.get(e?e.error:"unexpectedError"),3e3)}))},n.show({mode:"redeemCode",redeemCodeInfo:i})},h}]),app.factory("autohide",["$document","$injector","cache","selection","chapters","library","stg",function(e,t,n,o,r,i,a){function s(){var t={},n=document.getElementById("libraryThumbs");if(n&&"none"!=getComputedStyle(n).display)t.mode="library",t.header=e[0].getElementById("libraryHeader"),t.footer=e[0].getElementById("libraryFooter"),t.footer&&(t.footerHeight=t.footer.offsetHeight),t.scope=angular.element(n).scope(),t.libTabs=e[0].getElementById("libraryTabs"),t.libTabs&&(t.libTabHeight=t.libTabs.offsetHeight);else{t.mode="reader",t.header=e[0].getElementById("readerHeader"),t.scope=angular.element(t.header).scope(),t.tabMenu=e[0].getElementById("tabMenu"),t.tabMenuHeight=t.tabMenu.offsetHeight;var o=e[0].body.getElementsByClassName("navControls");if(o.length){var r=(o=o[o.length-1]).getElementsByClassName("next");r.length&&(t.navNext=r[0]);var i=o.getElementsByClassName("prev");i.length&&(t.navPrev=i[0]),t.navWidth=t.navNext.offsetWidth}}return t.headerHeight=t.header.offsetHeight,ios&&(t.headerHeight-=20),t}function l(e){m=!0,o.active()?o.reset():"hidden"==h?g("buttons"):"buttons"==h?g("hidden"):"midway"==h&&g("buttons")}function c(e){function t(t,n){Math.abs(e.clientY-w.y)<15||(e.clientY<w.y?w.y>.85*document.body.clientHeight&&g(t):e.clientY>.85*document.body.clientHeight&&g(n),e.clientY>w.y?w.y<.15*document.body.clientHeight&&g(t):e.clientY<.15*document.body.clientHeight&&g(n))}k=null;var n=s();if("reader"==n.mode)"neverShow"==config.autohideReaderMode&&w&&(new Date).getTime()-C<800&&Math.abs(e.clientX-w.x)<50&&t("tab","hidden");else if("library"==n.mode){if("showOnScroll"==config.autohideLibMode){var o=document.getElementsByClassName("bookThumbsContainer")[0],r=document.getElementById("libraryThumbs"),i=Number(getElemPadding(r).top);i||(i=0),o.offsetHeight<r.offsetHeight-i&&g("buttons")}"neverShow"==config.autohideLibMode&&w&&(new Date).getTime()-C<800&&Math.abs(e.clientX-w.x)<50&&t("header","hidden")}w=null}function d(e){w={x:e.clientX,y:e.clientY},C=(new Date).getTime()}function u(e){var n=40;if(w){k||(k=s());var o=k;if("library"==o.mode&&(n=5),!("reader"==o.mode&&"showOnTap"==config.autohideReaderMode||"library"==o.mode&&"showOnTap"==config.autohideLibMode)){if(y||(y=Math.max(n,e.detail.scrollTop)),m)return m=!1,y=Math.max(n,e.detail.scrollTop),void("hidden"==h&&(y-=o.headerHeight,b=o.headerHeight));if("reader"==o.mode){if(I)return;if("default"!=o.scope.header.mode)return;if(t.get("nav").transforming)return}else if("library"==o.mode){if(o.scope.subMode)return;if(o.scope.searchOb.enabled)return}(v=o.headerHeight-(o.headerHeight-(e.detail.scrollTop-y)))>=o.headerHeight?(y=e.detail.scrollTop-o.headerHeight,v=o.headerHeight,h="hidden"):v<0?(y=Math.max(n,e.detail.scrollTop),v=0,h="buttons"):h="midway",null==b&&(b=0);var r=removeClass;if(b==o.headerHeight){if(v==o.headerHeight)return;if(v>14)return;y=Math.max(n,e.detail.scrollTop),v=0,r=addClass}v+b!=0&&(b=v,p(r,{dims:o}))}}}function p(e,t){function n(){e(o.tabMenu,"ease"),f(o.tabMenu,v*o.tabMenuHeight/o.headerHeight,o.tabMenuHeight,"down",!!ios)}t||(t={});var o=t.dims;if(o||(o=s()),e(o.header,"ease"),f(o.header,v,o.headerHeight,"up",!!ios),"reader"==o.mode){if(t.headerOnly)return;if(t.tabOnly)return void n();e(o.navNext,"ease"),e(o.navPrev,"ease"),f(o.navNext,v*o.navWidth/o.headerHeight,o.navWidth,a.data.settings.rtl?"left":"right"),f(o.navPrev,v*o.navWidth/o.headerHeight,o.navWidth,a.data.settings.rtl?"right":"left"),n()}else if("library"==o.mode){if(o.libTabs||(o=s()),o.libTabs&&(e(o.libTabs,"ease"),f(o.libTabs,v,o.libTabHeight,"up")),t.headerOnly)return;o.footer&&(e(o.footer,"ease"),f(o.footer,v*o.footerHeight/o.headerHeight,o.footerHeight,"down",!!ios))}}function f(e,t,n,o,r){var i=1-(t=Math.min(n,t))/44;ionic.requestAnimationFrame(function(){if(e){var n;if("up"==o?n="translate3d(0, -"+t+"px, 0)":"down"==o?n="translate3d(0, "+t+"px, 0)":"right"==o?n="translate3d("+t+"px, 0, 0)":"left"==o&&(n="translate3d(-"+t+"px, 0, 0)"),e.style[ionic.CSS.TRANSFORM]=n,r)for(var a=0,s=e.children.length;a<s;a++)e.children[a].style.opacity=i}})}function g(e){var t=s();"buttons"==e?(b=v=0,p(addClass)):"header"==e?(b=v=0,p(addClass,{headerOnly:!0})):"tab"==e?(b=v=0,p(addClass,{tabOnly:!0})):"hidden"==e&&(b=v=t.headerHeight,p(addClass,{dims:t})),h=e}var h,m,v,b,y,k,w,C,x={},I=!0;return x.initialize=function(){mobile&&(document.body.addEventListener(mobile&&!mobileDebug?"touchend":"mouseup",c),document.body.addEventListener(mobile&&!mobileDebug?"touchstart":"mousedown",d),config.autohideHeader&&!config.autohideReaderMode&&(config.autohideReaderMode="showOnScroll"),config.autohideHeader||(config.autohideReaderMode="alwaysShow"),config.autohideLibHeader&&!config.autohideLibMode&&(config.autohideLibMode="showOnScroll"),config.autohideLibHeader||(config.autohideLibMode="alwaysShow"))},x.setup=function(e,n,o){if(h="buttons","reader"==o.headerShrink){if("alwaysShow"==config.autohideReaderMode)return;if("neverShow"==config.autohideReaderMode)return g("hidden"),addClass(document.getElementById("chapters"),"fillSpace"),e.$watch("header.mode",function(e,t){e!=t&&g("selection"==e||"searchItems"==e||"textSize"==e?"header":"hidden")}),void addClass(document.getElementById("tabMenu"),"transparent");"showOnTap"==config.autohideReaderMode&&(g("hidden"),addClass(document.getElementById("chapters"),"transparentBtns"),addClass(document.getElementById("chapters"),"fillSpace"))}if("library"==o.headerShrink){if("alwaysShow"==config.autohideLibMode)return;if("neverShow"==config.autohideLibMode)return;config.autohideLibMode}if(t.get("nav").addListener("tap",l),"reader"==o.headerShrink){var i;e.$watch("data.settings.textSize",function(e,t){(i||(i=!0,"showOnTap"!=config.autohideReaderMode))&&g("buttons")});var a;e.$watch("header.mode",function(e,t){(a||(a=!0,"showOnTap"!=config.autohideReaderMode))&&g("buttons")}),r.addListener(function(e){"newChapter"==e&&setTimeout(function(){I=!1},1500)}),"showOnTap"==config.autohideReaderMode&&g("hidden")}else"library"==o.headerShrink&&(e.$watch("subMode",function(e,t){g("buttons")}),e.$watch("searchOb.enabled",function(e,t){g("buttons")}));n.bind("scroll",u)},x.libInitialized=function(){setTimeout(function(){"neverShow"==config.autohideLibMode&&g("hidden"),"showOnTap"==config.autohideLibMode&&g("hidden")})},x}]),app.factory("backend",["$http","error","translit","cache","$location","$injector","$ionicHistory","$rootScope","modals","$window","status","crdv","$sce","$timeout","stg","$q","sync",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m){function v(e){for(var t=0;t<C.length;t++)C[t].event==e&&C[t].func()}function b(){try{if("undefined"!=typeof lti&&lti&&email&&hash){g.data.user.email=email,g.data.user.pwd=hash,g.data.user.rememberMe=!0;var e=document.getElementsByTagName("head")[0];if(e.length){e[0];for(var t=document.getElementsByTagName("script"),n=0;n<t.length;n++)if(t[n].hasAttribute("lti")){t[n].parentNode.removeChild(t[n]);break}}}}catch(e){}}function y(e){if(g.data.currentLibrary=e,e&&e.categories){for(var t=[],n=0;n<e.categories.length;n++)t.push(e.categories[n]);for(n=0;n<e.categories.length;n++)for(var o=e.categories[n],r=0;r<t.length;r++)t[r].parent&&t[r].parent.id==o.id&&(o.children||(o.children=[]),o.children.push(t[r]),t[r].nested=!0);for(n=0;n<e.categories.length;n++)e.categories[n].nested&&(e.categories.splice(n,1),n--)}}var k,w={},C=[];w.getAuthVarsOld=function(){return{libid:config.kotobee.libid,email:g.data.user.email,pwd:g.data.user.pwd}},w.getAuthVars=function(){var e={email:g.data.user.email,pwd:g.data.user.pwd,code:g.data.user.code,env:config.kotobee.mode};return b(),e.cloudid=config.kotobee.cloudid,"library"==e.env&&g.data.book&&(e.bid=g.data.book.id),uuid&&(e.fingerprint=uuid),e},w.addListener=function(e,t){C.push({event:e,func:t})},w.initialize=function(e){e||(e={putTest:function(){},$$phase:!0});arguments.callee;e.putTest("X");var n=h.defer();return e.putTest("Y"),e.putTest("Z"),e.putTest("J"),t.detect("s_authError",w.loginErrorDetection),e.putTest("K"),g.readSlot("user"+config.kotobee.cloudid,function(t){if(config.kotobee.cloudid){var o=t;o&&(g.data.user=o)}g.data.user||(g.data.user={}),0==g.data.user.length&&(g.data.user={}),g.data.user.loggedIn=!1,e.putTest("L"),u.initialize(e,function(){preview?n.resolve():w.getFingerprint(function(e){uuid=e,n.resolve()})})}),n.promise},w.getFingerprint=function(e){function t(){var t={excludeUserAgent:!0,excludeScreenResolution:!0,excludeDoNotTrack:!0,excludeAvailableScreenResolution:!0,excludeOpenDatabase:!0,excludePlugins:!0,excludeCanvas:!0,excludeWebGL:!0,excludeJsFonts:!0};t.excludeCanvas=!1,t.excludeWebGL=!1,new Fingerprint2(t).get(function(t,n){try{t||(t=process.env.USERNAME),g.writeSlot("fingerprint",t,function(){e(t)})}catch(e){}})}native&&window.plugins.uniqueDeviceID?window.plugins.uniqueDeviceID.get(function(n){n&&(n.length?e(n):t())},t):desktop?"mac"==os?t():require("child_process").exec("wmic CPU get ProcessorId",{cwd:"."},function(n,o,r){if(o){var i=o.toUpperCase().split("PROCESSORID");if(i.length){var a=i[1].trim();a.length?e(a):t()}else t()}else t()}):t()};var x=null,I=null;w.setLibraryLoginCallback=function(e){x=e},w.setLibraryLogoutCallback=function(e){I=e},w.loginErrorDetection=function(e){g.data.user.loggedIn=!1,e&&("email"==config.kotobee.loginmode?e.loginOptions.canLoginByEmail=!0:"code"==config.kotobee.loginmode?e.loginOptions.canLoginByCode=!0:e.loginOptions.canLoginByEmail=e.loginOptions.canLoginByCode=!0,e.loginOptions.mode=e.loginOptions.canLoginByEmail?"email":"code",e.loginOptions.signIn=function(){l.hide(),setTimeout(function(){function n(){w.login({userInput:!0}).then(function(t){t.error||e.model&&(e.model.pwd=e.model.code=null)})}if("code"==e.loginOptions.mode){if(!e.model||!e.model.code)return void t.update({error:"enterYourCode"});g.data.user.code=e.model.code,g.data.user.email=g.data.user.pwd=null}else{if(!g.data.user.email)return void t.update({error:"enterYourEmail"});if(!e.model||!e.model.pwd)return void t.update({error:"enterYourPwd"});g.data.user.pwd=e.model.pwd,g.data.user.code=null}config.kotobee.permsLoaded?n():i.get("auth").getPermissions(n)},800)},e.loginOptions.register=function(){l.hide(),r.path("/register")},e.loginOptions.forgotPassword=function(){l.hide(),r.path("/forgotpwd")},e.loginOptions.redeemCode=function(){e.loginOptions.mode="code"},e.loginOptions.signInByEmail=function(){e.loginOptions.mode="email"})};var E=null;w.refreshSignatures=function(t){var n=config.kotobee.liburl+"user/signatures";e.post(n,getFormData(w.getAuthVars()),postOptions).success(function(e){e.error||(g.data.user.signatures=e.signatures,t&&t())})};var T={ping:!0};return w.login=function(o,r){o||(o={});var i={func:arguments.callee,args:arguments};document.body.focus=null;var a,s=h.defer();o.ping||(a=l.show({mode:"loading",loadingMsg:n.get("pleaseWait"),timeLimit:1e4}),g.data.user.loggedIn=!1),r&&(E=r);var c;"book"==config.kotobee.mode&&(c=config.kotobee.liburl+"library/auth"),"library"==config.kotobee.mode&&(c=config.kotobee.liburl+"library/get"),b(),preview||(w.fingerprint=uuid);var d=w.getAuthVars();return o.userInput&&(d.input=!0),d.platformdesc=navigator.userAgent,native?(d.platform="mobile",device&&(d.platformdesc=device.platform+" "+device.model+" "+device.version+" "+(device.manufacturer?device.manufacturer:""))):d.platform=desktop?"desktop":"web",d.v=readerV,o.ping&&(d.ping=!0,d.pwd=o.pwd),d.v=config.v,e.post(c,getFormData(d),postOptions).success(function(e){function n(){if(!e.cloudid&&!e.success)return o.dontShowErrorDialog||t.update({error:"s_authError"}),void s.resolve({error:"s_authError"});g.data.user.loggedIn=!0,"library"==config.kotobee.mode&&(y(e),x&&x()),s.resolve(e),E&&(E(e),E=null)}if(clearTimeout(void 0),a&&l.hide(a),e.error)return o.dontShowErrorDialog||t.update(e),g.data.user.pwd=null,g.data.user.code=null,o.ping&&w.logout(),void s.resolve(e);var r=3e5;if(void 0===r&&(r=3e5),k&&clearTimeout(k),k=setTimeout(function(){e.pwd&&(T.pwd=e.pwd),w.login(T)},r),!o.ping)if(g.data.user.pwd=e.pwd,g.data.user.id=e.userid,g.data.user.name=e.username,g.data.user.lastchap=e.lastchap,g.data.user.signatures=e.signatures,g.data.user.rememberMe){var i={rememberMe:!0};g.data.user.email&&g.data.user.pwd?(i.email=g.data.user.email,i.pwd=g.data.user.pwd):g.data.user.code&&(i.code=g.data.user.code),g.writeSlot("user"+config.kotobee.cloudid,i,n)}else g.clearSlot("user"+config.kotobee.cloudid,n)}).error(function(e){clearTimeout(void 0),l.hide(),t.update({error:"networkError",ref:i})}),s.promise},w.logout=function(){g.data.user.pwd=null,g.data.user.loggedIn=!1,g.data.user.email=null,g.data.user.code=null,g.writeSlot("user"+config.kotobee.cloudid,g.data.user,function(){"library"==config.kotobee.mode?f(function(){if(t.update({error:"s_authError"}),w.cloudParam("entry")){for(var e=0;e<g.data.currentLibrary.books.length;e++)g.data.currentLibrary.books[e].favorite=!1;u.applyExistingBooks()}else g.data.currentLibrary={};I&&I()},200):(r.path("/login"),a.clearHistory())})},w.getPermissions=function(n){var o={func:arguments.callee,args:arguments},r={};return r.env=config.kotobee.mode,r.cloudid=config.kotobee.cloudid,e.post(config.kotobee.liburl+"library/permissions",getFormData(r),postOptions).success(function(e){if(e.error)return t.update({error:"errorAndCallback",msg:e.error,cb:u.exit}),angular.element(document.getElementById("home")).scope().hideLoading=!0,void(s.$$phase||s.$apply());n&&n(e)}).error(function(e,r){(native||desktop)&&w.cloudParam("offline")?n&&n({error:"offline"}):t.update({error:"networkError",ref:o})})},w.register=function(o,r){var i={func:arguments.callee,args:arguments},a=l.show({mode:"loading",loadingMsg:n.get("registeringAccount")}),s=w.getAuthVars();s.email=o.email1,s.promocode=o.promocode,s.root=config.kotobee.liburl;var c=getFormData(s);return c.append("platform",navigator.userAgent),e.post(config.kotobee.liburl+"user/register",c,postOptions).success(function(e){l.hide(a),e.error?t.update(e):r&&r(e)}).error(function(e){t.update({error:"networkError",ref:i})})},w.forgotPwd=function(o,r){var i={func:arguments.callee,args:arguments},a=l.show({mode:"loading",loadingMsg:n.get("retrieving")}),s=w.getAuthVars();s.email=o.email,s.root=config.kotobee.liburl;var c=getFormData(s);return e.post(config.kotobee.liburl+"user/forgotpwd",c,postOptions).success(function(e){l.hide(a),e.error?t.update(e):r&&r(e)}).error(function(e){t.update({error:"networkError",ref:i})})},w.redeemCode=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(w.getAuthVars());i.append("redeemcode",n.code),i.append("platform",navigator.userAgent),e.post(config.kotobee.liburl+"user/redeemcode",i,postOptions).success(function(e){o(e)}).error(function(){t.update({error:"networkError",ref:r})})},w.downloadEbookTest=function(e,n){var o={responseType:"blob",onProgress:function(e){}},r={id:e.id,mode:e.binary};return w.sendRawPost("http://192.168.1.5/files/test.zip",r,o,function(e){if(e.error)return t.update(e),void n();n(e)})},w.downloadEbook=function(e,n,o){try{var r={responseType:"blob",onProgress:n},i={id:e.id,mode:"binary",requester:"reader"};return w.sendRawPost(config.kotobee.liburl+"library/ebook/download",i,r,function(e){if(e.error)return t.update(e),void o();o(e)})}catch(e){}return},w.tincan=function(t,n){var o=getFormData(w.getAuthVars());for(var r in t)o.append(r,t[r]);e.post(config.kotobee.liburl+"tincan",o,postOptions).success(function(e){n&&n()}).error(function(e,t){})},w.getUnauthLibrary=function(n){if("library"==config.kotobee.mode){var o={func:arguments.callee,args:arguments},r=getFormData(w.getAuthVars());e.post(config.kotobee.liburl+"library/getbasic",r,postOptions).success(function(e){y(e),n&&n(e)}).error(function(e,r){(native||desktop)&&w.cloudParam("offline")?n&&n({error:"offline"}):t.update({error:"networkError",ref:o})})}},w.addtoFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(w.getAuthVars());i.append("bid",n.id),i.append("cloudid",w.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/add",i,postOptions).success(function(e){if(e.error)return t.update(e),void o();o(e)}).error(function(){t.update({error:"networkError",ref:r})})},w.removeFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(w.getAuthVars());i.append("bid",n.id),i.append("cloudid",w.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/remove",i,postOptions).success(function(e){if(e.error)return t.update(e),void o();o(e)}).error(function(e){t.update({error:"networkError",ref:r})})},w.getServerLang=function(t,n){if(isKotobeeHosted()){var o=getFormData();return o.append("lang",t.lang),o.append("root",rootDir),o.append("v",readerV),o.append("base",publicRoot),e.post(config.kotobee.liburl+"library/getlang",o,postOptions)}return e.get(cacheBust(rootDir+"locales/"+t.lang+".js"))},w.getS3Paths=function(t){var n=getFormData();e.post(config.kotobee.liburl+"library/s3paths",n,postOptions).success(function(e){g.data.paths=e,v("pathsChanged"),t&&t(e)}).error(function(){})},w.addBookStat=function(t,n){if(t||(t={}),!preview&&config.kotobee.cloudid){window.location.href;var o=getFormData(w.getAuthVars());o.append("type",t.type),e.post(config.kotobee.liburl+"library/ebook/stat",o,postOptions).success(function(e){}).error(function(){})}},w.addStat=function(t,n){if(t||(t={}),!preview){var o=window.location.href;if(!(o.indexOf("localhost/")>=0||o.indexOf("localhost:")>=0)){var r=getFormData(w.getAuthVars());r.append("software",s.readerApp?"readerapp":"reader"),r.append("platform",navigator.userAgent),r.append("assetType",config.kotobee.mode);try{r.append("assetName","book"==config.kotobee.mode?g.data.book.meta.dc.title:g.data.currentLibrary.name)}catch(e){}r.append("assetPath",o.split("#")[0]),config.kotobee.cloudid&&r.append("assetId",config.kotobee.cloudid),g.data.user.email&&r.append("email",g.data.user.email),g.data.user.code&&r.append("code",g.data.user.code),t.action&&r.append("action",t.action),t.param&&r.append("param",t.param),e.post(config.kotobee.liburl+"stat/add",r,postOptions).success(function(e){}).error(function(){})}}},w.externalLink=function(e,t){try{if(t||(t={}),t.secure&&!native&&!desktop&&!preview)return void c.open(e);var o=function(e,t){native?u.openInNativeBrowser(e,t):desktop?require("nw.gui").Shell.openExternal(e):window.open(e,"_blank")};if(t.target&&"_blank"==t.target.toLowerCase())return void o(e,!0);if(native)return void o(e);var r={title:n.get("externalLink"),src:p.trustAsResourceUrl(e),openInNativeBrowser:o};r.status="loading";var i=setTimeout(function(){r.status="",r.error=n.get("errorLoadingPage"),s.$$phase||s.$apply()},1e4);r.loaded=function(e,t,n){r.status="loaded",clearTimeout(i),s.$$phase||s.$apply()};var a=l.show({mode:"externalSite",animation:"slide-in-up",dynamic:!0,backdropClickToClose:!1,siteOptions:r});desktop||preview||w.getXframeOptions({url:e},function(t){if(r.status="loaded",s.$$phase||s.$apply(),t&&t.success){var n=t.success.toLowerCase();"sameorigin"!=n&&"deny"!=n||(l.hide(a),setTimeout(function(){l.show({mode:"xFrameError",errorOptions:{url:e,openInNativeBrowser:o}})},500))}})}catch(e){}},w.createRequest=function(t,n,o){n||(n={});var r=getFormData(w.getAuthVars());for(var i in n)r.append(i,n[i]);e.post(t,r,postOptions).success(function(e){o(e)}).error(function(){o(!1)})},w.convertPDF=function(t,n){if(t||(t={}),!preview){var o=getFormData(w.getAuthVars());o.append("url",t.url),e.post(config.kotobee.liburl+"library/pdf",o,postOptions).success(function(e){n(e)}).error(function(){})}},w.getXframeOptions=function(t,n){arguments.callee;var o=getFormData(w.getAuthVars());o.append("url",t.url),e.post(config.kotobee.liburl+"getxframe",o,postOptions).success(function(e){e.error?n():n(e)}).error(function(e){})},w.hasAccessTo=function(t,n){if("library"==config.kotobee.mode){var o=getFormData(w.getAuthVars());t||(t={});for(var r in t)o.append(r,t[r]);o.append("v",readerV),e.post(config.kotobee.liburl+"user/access",o,postOptions).success(function(e){n&&n(e)}).error(function(e,t){n&&n({error:""})})}else n&&n({success:!0})},w.setLastChapter=function(t){var n=getFormData(w.getAuthVars());n.append("chapter",currentIndex),e.post(config.kotobee.liburl+"user/lastchap",n,postOptions).success(function(e){t&&t(e)}).error(function(e,n){t&&t({error:""})})},w.cloudParam=function(e){return config.kotobee[e]},w.getEbook=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(w.getAuthVars());for(var a in n)i.append(a,n[a]);e.post(config.kotobee.liburl+"library/ebook/get",i,postOptions).success(function(e){e.error&&t.update(e),o&&o(e)}).error(function(e){t.update({error:"networkError",ref:r}),o&&o({error:"networkError"})})},w.getEbooks=function(n,o,r){var i={func:arguments.callee,args:arguments},a=getFormData(w.getAuthVars());for(var s in n)a.append(s,n[s]);a.append("v",readerV),e.post(config.kotobee.liburl+"library/ebook/all",a,postOptions).success(function(e){e.error&&t.update(e),r&&r(e,o)}).error(function(e){t.update({error:"networkError",ref:i}),r&&r({error:"networkError"},o)})},w.sendRawPost=function(e,t,n,o,r){r||(r=0);for(var i="",a=[w.getAuthVars(),t],s=0;s<a.length;s++)for(var l in a[s]){var c=a[s][l];void 0!=c&&("object"!=typeof c&&("string"==typeof c&&(c=encodeURIComponent(c=("."+c).substr(1))),"boolean"==typeof c&&(c=c?1:0),i+="&"+l+"="+c))}var d=new XMLHttpRequest;d.open(n.method?n.method:"POST",e,!0),"GET"!=n.method&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onProgress&&(d.onprogress=function(e){e.lengthComputable&&n.onProgress(e.loaded/e.total)}),n.responseType&&(d.responseType=n.responseType);var u;return d.addEventListener("error",function(e){o({error:"networkError"}),u=!0},!1),d.onreadystatechange=function(e){d.aborted||4==d.readyState&&(200==d.status?f(function(){o(d.response)}):d.onerror())},d.onerror=function(i){if(!u){if(!(r>=3))return w.sendRawPost(e,t,n,o,++r);f(function(){o({error:"d_connectionTimedOut"})})}},"GET"!=n.method?d.send(i):d.send(),d},w.abort=function(e){e&&4!=e.readyState&&(e.aborted=!0,e.abort())},w}]),app.factory("book",["$http","error","$timeout","$rootScope","crdv","translit","modals","design","$location","library","np","sync","cssInjector","jsParser","chapters","cssParser","$q","status","backend","tinCan","stg","$sce","$filter",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C){function x(t,n){!t.dver||t.dver<2?n():e.get(cacheBust(ph.join(bookPath,"_kmeta/config.js"))).success(function(e){if(-1!=e.indexOf("var config")){e=e.replace("var config","var bookConfig");var t=document.createElement("script");t.setAttribute("bookconfig",!0);var o=document.getElementsByTagName("head");o.length&&o[0].appendChild(t),t.innerHTML=e,T||(T=clone(config));for(var r in bookConfig)"kotobee"!=r&&(config[r]=bookConfig[r]);s.injectUserCSS(config),s.convertTabs(),n&&n()}else n()}).error(function(){n&&n()})}function I(e){for(var t=document.createElement("ol"),n=0;n<e.childNodes.length;n++)if(e.childNodes[n]){var o=e.childNodes[n];if(8!=o.nodeType&&"#text"!=o.nodeName&&"navpoint"==o.nodeName.toLowerCase()){for(var r,i,a,s=0;s<o.childNodes.length;s++)if(o.childNodes[s]){var l=o.childNodes[s].nodeName.toLowerCase();"content"==l?i=o.childNodes[s].getAttribute("src"):"navlabel"==l?r=o.childNodes[s].textContent.trim():"navpoint"==l&&(a||(a=I(o)))}var c=document.createElement("li"),d=document.createElement("a");d.innerHTML=r||"",d.setAttribute("href",i?ph.join(k.data.tocPath,i):""),c.appendChild(d),a&&c.appendChild(a),t.appendChild(c)}}return t}var E={};E.root="",E.initialize=function(){},E.getCoverImgPath=function(e,t){if(t||(t=e.path),!e.cover)return"";var n="";return n=k.data.currentLibrary.cloud.public?k.getPublicRoot("book")+e.path+"/EPUB/"+e.cover:C("coverPath")(e.cover,t),e.exists&&(native?n=r.libEbooksDirectory.nativeURL+t+"/EPUB/"+e.cover.replace("_thumb",""):desktop&&(n=ph.normalize(d.getBooksPath()+t+"/"+e.cover.replace("_thumb","")))),n},E.getBgImgPath=function(e,t){if(t||(t=e.path),!e.cover)return"";var n=k.getPublicRoot("book");return n+=e.path+"/"+e.bgimg},E.open=function(e){if(preview)return a.hide(),void setTimeout(function(){a.show({mode:"generalError",errorOptions:{msg:i.get("cantPreviewLibBook")}})},500);native?(r.vibrate(),bookPath=r.libEbooksDirectory.nativeURL+e.path+"/EPUB/"):desktop?(bookPath=d.getBooksPath()+e.path+"/","mac"==os&&(bookPath="file://"+bookPath)):(bookPath=k.data.currentLibrary.cloud.public?k.getPublicRoot("book"):config.kotobee.liburl+"books/",bookPath+=e.path+"/EPUB/"),a.hide(),setTimeout(function(){v.update(i.get("pleaseWait"),null,{dots:!0}),function(t){(native||desktop)&&e.exists?t({success:!0}):b.hasAccessTo({testagainst:e.id,open:!0},t)}(function(t){t.success?E.loadBook().then(function(){x(e,function(){if(k.data.book.id=e.id,k.data.epub.bookThumb=E.getCoverImgPath(e,k.data.book.path),chromeApp)if(k.data.chromeAssets[k.data.book.bookThumb])k.data.epub.bookThumb=k.data.chromeAssets[k.data.book.bookThumb];else{var t=k.data.epub.bookThumb;delete k.data.epub.bookThumb,getImgDataSrc(t,function(e){k.data.epub.bookThumb=e,k.data.chromeAssets[t]=e})}v.update(),E.root="/book/"+k.data.book.id,l.path(E.root+"/reader"),u.initialize(),setTimeout(function(){g.initialize()},1e3)})}):v.update()})},200)},E.removeBookConfigElem=function(){for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++)if(e[t].hasAttribute("bookconfig")){e[t].parentNode.removeChild(e[t]);break}if(T){for(var n in config)"kotobee"!=n&&delete config[n];for(var n in T)config[n]=T[n];s.injectUserCSS(config)}};var T;return E.loadBook=function(){function n(){b.addStat({action:"open"}),C("chapterHtml")(k.data.toc),k.data.book.chapters=k.data.toc.innerHTML,l.resolve()}var s={func:arguments.callee,args:arguments},l=m.defer();return k.resetBook(),h.clearCache(),f.clearCache(),g.clearCache(),e.get(cacheBust(ph.join(bookPath,"META-INF/container.xml?v="+readerV))).success(function(l){config.kotobee.encodekey&&(l=config.v>=1.1?CryptoJS.AES.decrypt(l,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,l));var c=parser.parseFromString(l,"text/xml");k.data.epub={};try{k.data.packageURL=c.getElementsByTagName("rootfile")[0].getAttribute("full-path")}catch(e){return v.update(),void t.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit})}var d=config.v,u=native||isKotobeeHosted();!function(n){window.location.origin;var r=Math.round(9999*Math.random());"book"==config.kotobee.mode&&!o.readerApp&&d>=1.3&&!u?e.get("js/templates.js?c="+r).success(n).error(function(){t.update({error:"networkError",ref:s})}):n()}(function(r){e.get(cacheBust(ph.join(bookPath,k.data.packageURL))).success(function(t){function s(){var e=angular.element(document.getElementById("home"));e&&(e.scope().hideLoading=!0,o.$$phase||o.$apply()),v.update(),a.show({mode:"generalError",errorOptions:{msg:i.get("errorLoadingPage")}})}if("book"==config.kotobee.mode&&!o.readerApp)if(d>=1.3){if(u){if(0!=config.checksum.indexOf(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()))return void s()}else if(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()+CryptoJS.MD5(r).toString()!=config.checksum)return void s()}else if(d>=1.2&&CryptoJS.MD5(t).toString()!=config.checksum)return void s();config.kotobee.encodekey&&(t=config.v>=1.1?CryptoJS.AES.decrypt(t,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,t)),t=t.replace(/href="([^"]*?&[^"]*?)"/g,function(e,t){return'href="'+t.replace(/&/g,"")+'"'});var l=parser.parseFromString(t,"text/xml");k.data.epub.metadata=l.getElementsByTagName("metadata")[0],k.data.epub.manifest=l.getElementsByTagName("manifest")[0],k.data.epub.spine=l.getElementsByTagName("spine")[0];k.data.mediaList=[],k.data.book.meta={},k.data.book.version=3;try{for(w=0;w<k.data.epub.metadata.childNodes.length;w++){var c=k.data.epub.metadata.childNodes[w];if(8!=c.nodeType&&"#text"!=c.nodeName)if(c.hasAttribute("name")&&"meta"==c.nodeName.toLowerCase())k.data.book.meta[c.getAttribute("name")]=c.getAttribute("content");else for(var p,f=(p=c.hasAttribute("property")?c.getAttribute("property"):c.nodeName).split(":"),g=k.data.book.meta,h=0;h<f.length;h++)h==f.length-1?g[f[h].toLowerCase()]=c.innerHTML?c.innerHTML:c.textContent:(g[f[h].toLowerCase()]||(g[f[h].toLowerCase()]={}),g=g[f[h].toLowerCase()])}}catch(e){}k.initializeSettings();for(var m="image/.*",b=getElementsByAttribute(k.data.epub.manifest,"item","media-type",m),w=0;w<b.length;w++){var x=b[w].getAttribute("href");if(0!=x.indexOf("js/widgets/")&&(0!=x.indexOf("xhtml/pdf")||-1==x.indexOf("/page"))){(g={}).thumbnail=ph.join(bookPath,k.data.packageURL,b[w].getAttribute("href")),g.title=ph.removeExtension(ph.basename(g.thumbnail));m=b[w].getAttribute("media-type");g.type=m.split("image/")[1],k.data.mediaList.push(g),chromeApp&&isAbsoluteURLAndNotDataPath(g.thumbnail)&&(k.data.chromeAssets[g.thumbnail]?g.thumbnail=k.data.chromeAssets[g.thumbnail]:function(e,t){getImgDataSrc(e.thumbnail,function(n){k.data.chromeAssets[e.thumbnail]=n,e.thumbnail=n,t&&t()})}(g))}}var E=getElementsByAttribute(k.data.epub.manifest,"item","properties","cover-image");E.length>0?k.data.epub.bookThumb=C("coverPath")(E[0].getAttribute("href")):k.data.book.meta.cover&&(E=getElementsByAttribute(k.data.epub.manifest,"item","id",k.data.book.meta.cover)).length>0&&(k.data.epub.bookThumb=C("coverPath")(E[0].getAttribute("href"))),chromeApp&&k.data.epub.bookThumb&&(k.data.chromeAssets[k.data.epub.bookThumb]?k.data.epub.bookThumb=k.data.chromeAssets[k.data.epub.bookThumb]:getImgDataSrc(k.data.epub.bookThumb,function(e){k.data.chromeAssets[k.data.epub.bookThumb]=e,k.data.epub.bookThumb=e}));try{k.data.tocPath=getElementsByAttribute(k.data.epub.manifest,"item","properties","[s]*nav[s]*")[0].getAttribute("href")}catch(e){var T=k.data.epub.spine.getAttribute("toc");if(!T)return void n();try{k.data.book.version=2,k.data.tocPath=getElementsByAttribute(k.data.epub.manifest,"item","id",T)[0].getAttribute("href")}catch(e){return void n()}}e.get(cacheBust(ph.join(bookPath,k.data.packageURL,k.data.tocPath))).success(function(e){if(config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e)),2==k.data.book.version){var t=(o=parser.parseFromString(e,"text/xml")).getElementsByTagName("navMap");t.length&&(k.data.toc=I(t[0]))}else for(var o=parser.parseFromString(e,"text/html"),r=o.getElementsByTagName("ol"),i=0,a=0;a<r.length;a++){var s=r[a].getElementsByTagName("a");if(!(s.length<i)){i=s.length,k.data.toc=r[a];for(var l=s.length;l--;)s[l].getAttribute("href")?s[l].setAttribute("href",ph.join(k.data.tocPath,s[l].getAttribute("href"))):s[l].setAttribute("href","")}}n()}),y.send({verb:"opened",activity:"Book: "+k.data.book.meta.dc.title})}).error(function(){t.update({error:"networkError",ref:s})})})}).error(function(e){v.update(),native||desktop||"file://"!=window.location.origin?t.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit}):t.update({error:"This browser failed to run the ebook app locally. Please try a different browser, or upload the web files to your server and run the web app online"})}),l.promise},E.getTitleByIndex=function(e){if(k.data.toc)try{for(var t=k.data.toc.getElementsByTagName("li"),n=[],o=0;o<t.length;o++)if(t[o]){var r=t[o].getElementsByTagName("a");r.length&&"true"!=r[0].getAttribute("data-dontshow")&&n.push(t[o])}return n[e].getElementsByTagName("a")[0].textContent}catch(e){}},E}]),app.factory("bookinfo",["$http","error","$timeout","auth","$rootScope","crdv","np","library","book","sync","$location","translit","modals","cssInjector","jsParser","chapters","cssParser","$q","status","backend","tinCan","stg","$sce","$filter",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C,x){function I(e){var t={};return t.background="url('"+e+"')",t["background-size"]="cover",t["background-position"]="center center",t.opacity="1",t}function E(){A(),(native||desktop)&&"download"==H&&(H="loading"),native||desktop||"open"!=H||(H="loading"),"login"==H&&(R.unauthredirect&&(R.redirect=w.data.currentLibrary.unauthredirect),R.overrideunauthredirect&&(R.redirect=R.unauthredirect)),B()}function T(){"loading"==H&&(R.redirect=null,y.hasAccessTo({testagainst:R.id},function(e){e.success?A():(H="denied",R.redirect=w.data.currentLibrary.unauthredirect,R.overrideunauthredirect&&(R.redirect=R.unauthredirect)),B(),r.$$phase||r.$apply()}))}function O(e,t,n,o){native?i.writeEbook(e,t,n,o):desktop&&a.writeEbook(e,t,n,o)}function S(e){return w.data.info||(w.data.info={}),w.data.info["book"+e.id]||(w.data.info["book"+e.id]={}),w.data.info["book"+e.id]}function A(){R&&(native||desktop?H=R.exists?"open":S(R).loading?"downloading":S(R).extracting?"extracting":y.cloudParam("public")?"download":w.data.user.loggedIn?"download":y.cloudParam("entry")?"login":"download":y.cloudParam("public")?H="open":w.data.user.loggedIn?H="open":y.cloudParam("entry")&&(H="login"))}function B(){D&&D.ui&&(D.ui.actionBtnIcon=L(),D.ui.actionBtnSpinnerIcon=M(),D.ui.actionBtnLabel=$(),D.ui.actionBtnStyle=N())}function N(){return"open"==H?"openBtn":"login"==H?"openBtn":"downloading"==H?"downloadingBtn":"extracting"==H?"downloadingBtn":"loading"==H?"loadingBtn":"denied"==H?"deniedBtn":"downloadBtn"}function L(){return"open"==H?"ion-eye size18":"login"==H?"ion-person":"download"==H?"ion-code-download":"downloading"==H?null:"loading"==H?null:void 0}function M(){return"downloading"==H?"dots":"loading"==H?"dots":void 0}function $(){return"open"==H?"openBook":"login"==H?"loginToRead":"download"==H?"download":"downloading"==H?"downloading":"extracting"==H?"extracting":"loading"==H?"pleaseWait":"denied"==H?"bookAccessDenied":void 0}function P(e,t){native?i.deleteEbook(e,t):desktop&&a.deleteEbook(e,t)}var H,R,D,F,z={};return z.redeemCode=function(){p.hide(),o.redeemCode({source:"bookinfo"},function(){z.show(F)})},z.show=function(e,t){t||(t={}),F=e,R=e.book,native&&i.vibrate(),e.book.coverImg=l.getCoverImgPath(e.book),e.book.coverStyle=e.book.bannerStyle={"background-image":"url('"+e.book.coverImg+"')"},e.book.bgimg&&(e.book.bannerStyle=I(l.getBgImgPath(e.book))),chromeApp&&(w.data.chromeAssets[e.book.coverImg]?e.book.coverStyle=e.book.bannerStyle={"background-image":"url('"+w.data.chromeAssets[e.book.coverImg]+"')"}:getImgDataSrc(e.book.coverImg,function(t){w.data.chromeAssets[e.book.coverImg]=t,e.book.coverStyle={"background-image":"url('"+t+"')"},e.book.bgimg||(e.book.bannerStyle=e.book.coverStyle)}),e.book.bgimg&&(w.data.chromeAssets[e.book.bgImg]?e.book.bannerStyle=I(w.data.chromeAssets[e.book.bgImg]):getImgDataSrc(l.getBgImgPath(e.book),function(t){w.data.chromeAssets[e.book.bgImg]=t,e.book.bannerStyle=I(t)})));var n={};e.book.meta||(e.book.meta={});for(var o in e.book.meta)n[o]=e.book.meta[o];e.book.meta.dc=n;var r={};r.book=e.book,r.categoryClicked=e.categoryClicked,r.ui={},D=r;var a="slide-in-up";"none"==t.animation&&(a="none"),p.show({mode:"bookInfo",dynamic:!0,animation:a,bookInfoOptions:r}),E(),setTimeout(T,mobile?1e3:500)},z.download=function(e){function t(t){S(e).progress=Math.ceil(100*t),r.$$phase||r.$apply()}S(e).loading||(i.vibrate(),i.toast(u.get("bookIsDownloading")),S(e).loading=!0,A(),B(),S(e).progress=0,setTimeout(function(){y.downloadEbook(e,t,function(t){S(e).loading=null,t&&(S(e).extracting=!0,A(),B(),n(function(){O("src.zip",e,t,function(t){S(e).extracting=null,A(),B(),p.hide(),n(function(){p.show({mode:"bookDownloaded",downloadedOptions:{book:e,open:l.open},apply:!0}),i.applyExistingBooks(w.data.currentLibrary.books),y.addBookStat({type:"download"})},1e3)})}))})},500))},z.action=function(e){"loading"!=H&&"denied"!=H&&("open"==H?l.open(e):"login"==H?(p.hide(),setTimeout(y.login,1e3)):"download"==H&&z.download(e),A(),B())},z.delete=function(e){i.toast(u.get("deletingBook")),i.vibrate(),P(e,function(){A(),B(),r.$$phase||r.$apply()})},z.toggleFav=function(e){e.favorite?z.removeFav(e,!0):z.addToFav(e,!0)},z.addToFav=function(e,t){t?e.favorite=!0:b.update(u.get("addingToFavorites"),null,{dots:!0}),y.addtoFav(e,function(){e.favorite=!0,t||b.update()})},z.removeFav=function(e,t){t?e.favorite=!1:b.update(u.get("removingFromFavorites"),null,{dots:!0}),y.removeFav(e,function(){e.favorite=!1,t||b.update(),angular.element(document.getElementById("library")).scope().loadFavorites()})},z}]),app.factory("cache",function(){var e={},t={};return e.initialize=function(){e.setOb("body",document.getElementsByTagName("body")[0]);var t=document.getElementsByTagName("title"),n=null;t.length?n=t[0]:(n=document.createElement("title"),document.head.appendChild(n)),e.setOb("title",n)},e.setOb=function(e,n){return t[e]=n,n},e.getOb=function(e){return t[e]},e}),app.factory("chapters",["$http","tinCan","backend","context","library","error","crdv","skeleton","$stateParams","sync","$ionicSideMenuDelegate","scorm","cache","modals","status","$injector","$timeout","virt","$ionicPopup","translit","selection","$ionicScrollDelegate","$filter","$rootScope","cssInjector","cssParser","jsParser","$location","$sce","$q","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w,C,x,I,E,T,O,S,A,B){function N(e,t){var n={leftOb:{}};ee.getPageOb({page:e.index,source:"getNextIndex"},function(o){if(!o)return t();o.pages?e.vIndex<o.pages.length-1?(n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex+1):(n.leftOb.index=e.index+1,n.leftOb.vIndex=0):n.leftOb.index=e.index+1,t(n)})}function L(e,t){var n={leftOb:{}};if(ee.shouldBePaged(e)){if(!e.vIndex||0==e.vIndex)return void ee.getPageOb({page:e.index-1,source:"stepBack"},function(o){n.leftOb.index=e.index-1,o.pages&&o.pages.length&&(n.leftOb.vIndex=o.pages.length-1),t(n)});n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex-1}else n.leftOb.index=e.index-1;t(n)}function M(e){var t=B.data.epub.spine.getElementsByTagName("itemref")[e];if(t)return"no"==t.getAttribute("linear")}function $(e){if(!(e<0||e>=B.data.epub.spine.getElementsByTagName("itemref").length-1)){var t=B.data.epub.spine.getElementsByTagName("itemref")[e];if(t){var n=t.getAttribute("properties");if(n)for(var o=n.split(" "),r=0;r<o.length;r++)if(o[r].indexOf("-spread-")>0)return o[r].split("-spread-")[1]}}}function P(e,t,n){var o=ee.cacheLookup(e);o?n(o):ee.preloadChapter(e,t,n)}function H(e){for(var t=0;t<te.length;t++)te[t](e)}function R(){s.isFirstChapter({first:Y},function(e){s.isLastChapter({last:W},function(t){B.data.book.chapter.notLastChapter=!t,B.data.book.chapter.notFirstChapter=!e,x.$$phase||x.$apply()})})}function D(){timeOut(function(){g.update(null)},1e3)}function F(t,n,o){e.get(cacheBust(t)).success(function(e){config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e)),e=(e=e.replace(/<br\s*?\/>/g,"<br>")).replace(/(<)([^ >]+)([^>]*?)(\/>)/g,"$1$2$3></$2>"),n&&n(e)}).error(function(){o&&o()})}function z(e,t){e||(e={});var n=e.first,o=e.page,r=e.vIndex;null==o&&(o=currentIndex),null==r&&(r=currentVIndex),t("single"==ee.getCurrentView(o,{vIndex:r}).view?ee.shouldBePaged(e.page?e:B.data.currentPageOb)?o<=n?0==currentVIndex:!1:o<=n:B.data.currentPageOb.pages?o<=n?0==currentVIndex:!1:o<=n)}function j(e,t){function n(e){return t&&t(e),e}e||(e={});var o=e.max,r=e.page,i=e.vIndex,a=e.view;return null==r&&(r=currentIndex,i=currentVIndex,a=ee.getCurrentView(r,{returnType:"view"})),"single"==a?(null==e.index&&(e.index=e.page),ee.shouldBePaged(null!=e.page?e:B.data.currentPageOb),n(a?r>=o-1:r>=o-1?i>=_-1:!1)):n(r>=o-1?_?i>=_-2:!0:r>=o-2?_&&i>=K-1?_<=1:!0:!1)}function V(){var e=ph.removeHash(window.location.href),t=document.getElementsByTagName("base");if(t.length)for(var n=0;n<t.length;n++)if(t[n].getAttribute("href")){e=window.location.origin+"/"+t[n].getAttribute("href");break}return isAbsoluteURLPath(B.data.book.chapter.absoluteURL)?B.data.book.chapter.absoluteURL:"/"==B.data.book.chapter.absoluteURL[0]?getDomainFromURL(e)+B.data.book.chapter.absoluteURL:ph.join(e,B.data.book.chapter.absoluteURL)}function U(){return"library"==config.kotobee.mode?B.data.paths.private+"books/"+B.data.book.chapter.absoluteURL.split("/books/")[1]:B.data.paths.private+B.data.book.chapter.absoluteURL.substr(1)}var q,W,_,K,Y,J,Z,G,X,Q,ee={},te=[],ne=[];ee.busy=!0,ee.initialize=function(){if(document.getElementById("chaptersInner")){config.firstDoublePage||(config.firstDoublePage=0),null==B.data.settings.pageScroll&&(B.data.settings.pageScroll=!0),o.initialize(),currentIndex=null,B.data.currentPageOb=null,q=B.data.epub.spine.getElementsByTagName("itemref").length,W=q;for(var e=B.data.epub.spine.getElementsByTagName("itemref"),t=e.length;t--;)if(!e[t].hasAttribute("linear")||"no"!=e[t].getAttribute("linear")){W=t+1;break}Y=0;for(t=0;t<e.length;t++)if(!e[t].hasAttribute("linear")||"no"!=e[t].getAttribute("linear")){Y=t;break}var r=B.data.book.chapters?B.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+y.get("noTOC")+"</h5>";replaceHTML(document.getElementById("chaptersInner"),r),p.setOb("title",replaceHTML(p.getOb("title"),B.data.book.meta.dc.title)),n.addBookStat({type:"view"}),J||(y.addListener(function(){var e=document.getElementById("chaptersInner");e&&replaceHTML(e,B.data.book.chapters?B.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+y.get("noTOC")+"</h5>")}),J=!0),C("bookSetup")(),ee.showLoader(),ee.resetPages(),ee.preloadEdgeChapters(function(){var e=0,t=0;if(null!=ee.startChapter&&"book"==config.kotobee.mode){var n=h.get("book").root+"/reader/chapter/"+ee.startChapter;return ee.startHash&&(n+="/"+ee.startHash),O.path(n),ee.hideLoader(),c.trigger(),void x.$apply()}B.readSlot("lastLoc"+B.getBookId(),function(n){B.readSlot("lastLocY"+B.getBookId(),function(o){config.preserveLoc&&"app"!=config.kotobee.mode&&(e=n?Number(n):0,t=o?Number(o):0),B.data.user&&null!=B.data.user.lastchap&&(e=Number(B.data.user.lastchap));var r=u.getBookmark();r&&(e=Number(r));var i={};t&&(i.scroll=t),ee.loadChapterByIndex(e,i).then(function(){ee.hideLoader(),c.trigger()})})})})}else setTimeout(ee.initialize,50)},ee.preloadEdgeChapters=function(e){ee.getPageOb({page:Y,source:"preloadEdgeChapters"},function(t){ee.getPageOb({page:W-1,source:"preloadEdgeChapters"},function(t){_=null,K=null,e()})})},ee.displayChapters=function(){if(!x.widescreen||config.notebookTab){var e=d.$getByHandle("menus");e._instances[0].left.width=e._instances[0].right.width=330,e._instances[0].left.el.style.width=e._instances[0].right.el.style.width="330px",x.widescreen&&(B.data.settings.rtl?(e._instances[0].right.width=480,e._instances[0].right.el.style.width="480px"):(e._instances[0].left.width=480,e._instances[0].left.el.style.width="480px"),h.get("notes").updateNotebookArray({},function(){x.$$phase||x.$apply()})),mobile&&h.get("nav").resize(),B.data.settings.rtl?d.toggleRight():d.toggleLeft(),native&&a.vibrate()}},ee.clearCache=function(){ne=[]},ee.hideLoader=function(){var e=document.getElementById("ebookLoaderAnim");e&&addClass(e,"hide")},ee.showLoader=function(){var e=document.getElementById("ebookLoaderAnim");e&&removeClass(e,"hide")},ee.addListener=function(e){te.push(e)},ee.removeListener=function(e){for(var t=te.length;t--;)te[t]==e&&te.splice(t,1)},ee.redirectToHashPage=function(e,t){var n=t.leftOb;if(n.pages&&n.pages.length){var o=parser.parseFromString(n.raw?n.raw:n.content,"text/html");C("contentVirt")("parse",o.getElementById("epubContent"),function(){var t=o.getElementById(e);if(!t){var r=o.getElementsByName(e);r.length&&(t=r[0])}if(t){var i=k.convertElemsToLocation([t],o.getElementById("epubContent")).left,a=k.getPageByLocation(n,i);ee.loadChapterByIndex(n.index,{hash:e,vIndex:a})}})}},ee.redirect=function(e,t){t||(t={});var n=h.get("book").root+"/reader/chapter/"+e;t.hash&&(n+="/"+t.hash);var o=ee.getCurrentHash();if(t.hash?O.search("vi"):O.search({vi:t.vIndex}),O.path(n),currentIndex==e){if(!o)return ee.loadChapterByIndex(e,t);if(o==t.hash)return ee.loadChapterByIndex(e,t)}x.$$phase||x.$apply()},ee.getCurrentHash=function(){var e=O.path(),t=(e=e.replace(/\?.*/g,"")).split("/"+currentIndex+"/");if(!(t.length<2))return t[1]},ee.loadLocation=function(e,t){var n=A.defer();t||(t={});var o=!e.match(/[^0-9.]/g);return ee.showLoader(),ee.getPageOb({page:t.index},function(t){if(!t.pages||!t.pages.length){if(o){var r=k.getElemsByLocation(e);if(!r[0])return n.resolve();v.safeScrollToElem("content",r[0],!0)}else v.safeAnchorScroll("content",e,!0);return ee.hideLoader(),n.resolve()}if(o){var i=k.getPageByLocation(t,e);return ee.loadChapterByIndex(t.index,{vIndex:i}),n.resolve()}var a=parser.parseFromString(t.raw?t.raw:t.content,"text/html");C("contentVirt")("parse",a.getElementById("epubContent"),function(){var o,r;if(!(o=a.getElementById(e))){var i=a.getElementsByName(e);i.length&&(o=i[0])}o&&(r=k.convertElemsToLocation([o],a.getElementById("epubContent")).left);var s=0;return r&&(s=k.getPageByLocation(t,r)),ee.loadChapterByIndex(t.index,{vIndex:s}),n.resolve()})}),n.promise},ee.indexFromUrl=function(e,t){t||(t={});var n,o=ph.getHash(e);t.hash&&(o=t.hash),e=ph.removeHash(ph.normalize(e));for(var r=B.data.epub.manifest.getElementsByTagName("item"),i=0;i<r.length;i++)if(ph.removeHash(ph.normalize(r[i].getAttribute("href")))==e){n=r[i].getAttribute("id");break}r=B.data.epub.spine.getElementsByTagName("itemref");var a;for(i=0;i<r.length;i++)if(r[i].getAttribute("idref")==n&&(a=i,r[i].getAttribute("id")==o))return i;return a},ee.arePagesAppearingTogether=function(e,t,n){var o=ee.getCurrentView(t.index),r=e.vIndex;r<0&&e.pages&&e.pages.length&&(r+=e.pages.length),isNaN(r)&&(r=null);var i=t.vIndex;if(i<0&&t.pages&&t.pages.length&&(i+=t.pages.length),isNaN(i)&&(i=null),e.index==t.index&&r==i)return n(!0);if("double"==o.view){if("rfl"==e.layout){if(e.index==t.index&&r==i+1)return n(!0);if(t.pages&&1==t.pages.length&&e.index==t.index+1&&0==r)return n(!0)}return"fxl"==e.layout&&e.index==t.index+1?n(!0):n()}return n()},ee.getNextIndexOld=function(e,t){var n={},o=ee.getCurrentView(e.index);if(n.leftOb={index:e.index+1,vIndex:0},e.vIndex||(e.vIndex=0),"double"==o.view)if(n.double=!0,"rfl"==e.layout)if(e.pages.length-1-e.vIndex>=2)n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex+2;else{if(e.pages.length-1-e.vIndex!=1)return void ee.getPageOb({page:e.index+1,source:"getNextIndex"},function(o){1==o.pages.length?(n.leftOb.vIndex=0,n.leftOb.index=e.index+2):(n.leftOb.vIndex=1,n.leftOb.index=e.index+1),t(n)});n.leftOb.index=e.index+1,n.leftOb.vIndex=0}else n.leftOb.index++;else"rfl"!=e.layout||B.data.settings.pageScroll||(e.pages.length-1-e.vIndex>=1?(n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex+1):(n.leftOb.index=e.index+1,n.leftOb.vIndex=0));return t(n),n},ee.getElemChapterIndex=function(e){return"single"==B.data.currentView?currentIndex:traverseToTop(e,"spreadL")?currentIndex:traverseToTop(e,"spreadR")?B.data.currentRPageOb.index:currentIndex},ee.getNextIndex=function(e,t){var n=ee.getCurrentView(e.index,{vIndex:e.vIndex});N(e,function(e){if(!e)return t();"double"==n.view?e.leftOb.index>=W-1?t(e):N(e.leftOb,t):t(e)})},ee.getPrevIndexOld=function(e,t){var n={};n.leftOb={index:e.index-1,vIndex:0},e.vIndex||(e.vIndex=0);var o={};if("double"==ee.getCurrentView(e.index-1,o).view)if(n.double=!0,config.firstDoublePage||(config.firstDoublePage=0),"rfl"==e.layout)if(e.vIndex>1)n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex-2,n.leftOb.index<config.firstDoublePage&&n.leftOb.vIndex++;else{if(1!=e.vIndex)return void ee.getPageOb({page:e.index-1,source:"getPrevIndex"},function(o){1==o.pages.length?(n.leftOb.index=e.index-2,n.leftOb.vIndex=-1,n.leftOb.index<config.firstDoublePage&&(n.leftOb.index=e.index-1,n.leftOb.vIndex=0)):(n.leftOb.index=e.index-1,n.leftOb.vIndex=e.vIndex-2,n.leftOb.index<config.firstDoublePage&&(n.leftOb.vIndex=e.vIndex-1)),t(n)});n.leftOb.index=e.index-1,n.leftOb.vIndex=-1,n.leftOb.index<config.firstDoublePage&&(n.leftOb.index=e.index,n.leftOb.vIndex=0)}else n.leftOb.index=e.index-2,n.leftOb.index<config.firstDoublePage&&(n.leftOb.index=e.index-1);else"rfl"!=e.layout||B.data.settings.pageScroll||(e.vIndex>0?(n.leftOb.index=e.index,n.leftOb.vIndex=e.vIndex-1):(n.leftOb.index=e.index-1,n.leftOb.vIndex=-1));return t(n),n},ee.getPrevIndex=function(e,t){L(e,function(e){"double"==ee.getCurrentView(e.leftOb.index,{vIndex:e.leftOb.vIndex}).view?e.leftOb.index<=Y?t(e):L(e.leftOb,t):t(e)})};ee.nextChapter=function(e){s.isLastChapter(null,function(e){e?a.toast(y.get("inLastChapter")):(o.interruptAnimation(),s.getNextIndex({index:currentIndex,vIndex:currentVIndex},function(e){if(e){for(var t=B.data.epub.spine.getElementsByTagName("itemref")[e.leftOb.index];t&&t.hasAttribute("linear")&&"no"==t.getAttribute("linear");){if(++e.leftOb.index>=t.length-1)return void a.toast(y.get("inLastChapter"));t=B.data.epub.spine.getElementsByTagName("itemref")[e.leftOb.index]}var n=t.getAttribute("id");x.renderScope.applyHeader("default"),null!=e.leftOb.vIndex&&(n=null),ee.redirect(e.leftOb.index,{hash:n,vIndex:e.leftOb.vIndex}),x.$$phase||x.$apply()}}))})},ee.prevChapter=function(e){s.isFirstChapter(null,function(e){e?a.toast(y.get("inFirstChapter")):(o.interruptAnimation(),s.getPrevIndex({index:currentIndex,vIndex:currentVIndex},function(e){e.vIndex;e.leftOb.index<0&&(e.leftOb.index=0);for(var t=B.data.epub.spine.getElementsByTagName("itemref")[e.leftOb.index];t&&t.hasAttribute("linear")&&"no"==t.getAttribute("linear");){if(--e.leftOb.index<0)return e.leftOb.index=0,void a.toast(y.get("inFirstChapter"));t=B.data.epub.spine.getElementsByTagName("itemref")[e.leftOb.index]}x.renderScope.applyHeader("default");var n=t.getAttribute("id");null!=e.leftOb.vIndex&&(n=null),ee.redirect(e.leftOb.index,{hash:n,vIndex:e.leftOb.vIndex}),x.$$phase||x.$apply()}))})},ee.getCurrentView=function(e,t){function n(e){return e.view||(e.view="single"),"view"==o?(t.cb&&t.cb(e.view),e.view):"page"==o?(t.cb&&t.cb(e.page),e.page):(t.cb&&t.cb(e),e)}t||(t={});var o=t.returnType;if(void 0!=e){var r=s.getCurrentView(e,t);if(r)return n(r);if(e<config.firstDoublePage)return n({view:null,index:e});var i=B.data.settings.viewMode;return n("single"==i?{view:null,index:e,scroll:B.data.settings.pageScroll}:"double"==i?config.singleViewOnPortrait&&1.3*window.innerWidth<window.innerHeight?{view:null,index:e}:s.isSingle(e,t.vIndex)?{view:null,index:e}:{view:"double",index:e}:"auto"==i?"left"==$(e)&&"right"==$(e+1)?{view:"double",index:e}:"right"==$(e)&&"left"==$(e-1)?{view:"double",index:e-1}:{view:null,index:e,scroll:B.data.settings.pageScroll}:{view:null,index:e,scroll:B.data.settings.pageScroll})}},ee.loadChapterByIndex=function(e,t){t||(t={});var n=t.deferred;return n||(n=A.defer()),void 0==e&&(e=currentIndex),e<0?(n.resolve(),n.promise):(e>q&&(e=0),ee.getPageOb({page:e,source:"loadChapterByIndex"},function(r){ee.getSurroundingPages({index:r.index,vIndex:t.vIndex},function(){var i={index:e,vIndex:t.vIndex};if(s.normalize(i),!t.hash&&(i.index!=e||null!=i.vIndex&&i.vIndex!=t.vIndex))return ee.loadChapterByIndex(i.index,{hash:t.hash,vIndex:i.vIndex,reload:t.reload,deferred:n}),n.promise;var a=ee.getChapterURL(e),l=!1;if(0==a.indexOf("#")&&(l=!0),t.hash&&r.pages&&r.pages.length&&(l=!0),l)return ee.loadLocation(t.hash,{index:e,source:"from loadChapterByIndex"}).then(function(e){});t.leftOb=r,t.leftOb.index=e,t.leftOb.currentVIndex=t.leftOb.vIndex,t.leftOb.vIndex=t.vIndex,asyncCheck(!(r.pages&&t.leftOb.vIndex>=r.pages.length-1),ee.getPageOb,[{page:e+1,source:"loadChapterByIndex"}],function(){ee.planPageMapping(t,function(r){if(r||(r={}),r.redirect)return ee.redirect(r.redirect.index,{hash:t.hash,vIndex:t.vIndex,reload:t.reload,deferred:n}),n.promise;if(t.deferred=null,ee.urlMatchesIndex(a,currentIndex)&&!t.reload&&currentVIndex==t.vIndex){currentIndex=e,R();var i=t.hash;return i||(i=ph.getHash(t.leftOb.url)),i?ee.loadLocation(i,{index:currentIndex,source:"from loadChapterByIndex2"}).then(function(){H("renderedChapter")}):(w.$getByHandle("content").scrollTop(!0),H("renderedChapter")),B.data.book.chapter.url=a,B.data.book.chapter.absoluteURL=ph.join(bookPath,B.data.packageURL,B.data.book.chapter.url),n.resolve(),n.promise}o.startTransition(t,n)})})})}),n.promise)},ee.getSurroundingPages=function(e,t){if("single"==B.data.settings.viewMode)return t();if(!e)return t();var n=s.getJoint(e.index,e.vIndex);if(n&&n.length>1)return ee.getPageOb({page:e.index-1},t);asyncCheck(n,ee.getPageOb,[{page:e.index}],function(){ee.getPageOb({page:e.index+1},function(){ee.getPageOb({page:e.index-1},t)})})},ee.planPageMapping=function(e,t){function n(){t&&t({url:e.leftOb.url})}var o=ee.getCurrentView(e.leftOb.index,{vIndex:e.leftOb.vIndex});if(o.index==e.leftOb.index)if(ee.shouldBePaged(e.leftOb)||"double"==o.view)if(e.view="double",e.rightOb||(e.rightOb={}),"fxl"==e.leftOb.layout)ee.getChapterURL(e.leftOb.index+1)?(e.rightOb.index=e.leftOb.index+1,e.rightOb.url=ph.join(bookPath,B.data.packageURL,ee.getChapterURL(e.leftOb.index+1))):e.rightOb=null,n();else{if(e.rightOb.url=e.leftOb.url,e.leftOb.viewport=h.get("spread").getViewport(e.leftOb),e.vIndex=Number(e.vIndex),isNaN(e.vIndex)&&(e.vIndex=0),e.leftOb.vIndex=e.vIndex,e.vIndex<0||e.vIndex>=e.leftOb.pages.length){var r=0;return e.vIndex<0&&(r=e.vIndex),e.vIndex=e.leftOb.pages.length+r,e.leftOb.vIndex=e.leftOb.pages.length+r,e.rightOb.vIndex=e.leftOb.vIndex+1,e.rightOb.index=e.leftOb.index,void t({redirect:{index:o.index}})}if(e.leftOb.content=e.leftOb.pages[e.vIndex].content,"single"==o.view)return e.rightOb=null,void n();if(e.vIndex+1<e.leftOb.pages.length)e.rightOb=clone(e.leftOb),e.rightOb.vIndex=e.vIndex+1,e.rightOb.index=e.leftOb.index,e.rightOb.content=e.leftOb.pages[e.rightOb.vIndex].content,n();else{if(e.leftOb.index>=q-1)return e.rightOb=null,void n();e.rightOb.index=e.leftOb.index+1;var i=ee.getChapterURL(e.rightOb.index);ee.getPageOb({page:e.rightOb.index},function(t){e.rightOb=t,e.rightOb.vIndex=0,e.rightOb.url=ph.join(bookPath,B.data.packageURL,i),e.rightOb.pages&&e.rightOb.pages.length&&(e.rightOb.content=e.rightOb.pages[0].content),e.rightOb.viewport=h.get("spread").getViewport(e.rightOb),n()})}}else e.view="single",e.leftOb.viewport=null,e.leftOb.raw&&(e.leftOb.content=e.leftOb.raw),n();else t({redirect:{index:o.index}})},ee.getCacheOrPreload=P,ee.currentUrlMatchesVIndex=function(e){return getQueryStringValue("vi")==e},ee.urlMatchesIndex=function(e,t){if(null!=t){e=ph.normalize(e);ph.getHash(e);var n,o=ph.removeHash(e),r=B.data.epub.spine.getElementsByTagName("itemref")[t];if(r){for(var i=B.data.epub.manifest.getElementsByTagName("item"),a=0;a<i.length;a++)i[a].getAttribute("id")==r.getAttribute("idref")&&(n=i[a].getAttribute("href"));return!!n&&ph.removeHash(ph.normalize(n))==ph.removeHash(ph.normalize(o))}}},ee.applyChapterStateFromURL=function(e,t){if(t||(t={}),0!=e.indexOf("#")){var n=ph.getHash(e),o=t.index?t.index:ee.indexFromUrl(e);null!=o&&(x.renderScope.applyHeader("default"),ee.redirect(o,{hash:n,vIndex:t.vIndex}),x.$$phase||x.$apply())}else ee.redirect(currentIndex,{hash:e.substr(1)})},ee.loadChapterByURL=function(e,t){var o=ph.relative(ph.join(bookPath,B.data.packageURL),e.leftOb.url);e||(e={});var r=A.defer(),i=e.hash?e.hash:ph.getHash(o),a=e.leftOb.index;if(0==o.indexOf("#")&&(i=o.substr(1)),null!=a){if(!e.reload&&ee.urlMatchesIndex(o,currentIndex)&&currentVIndex==e.vIndex)return currentIndex=a,R(),i?(t&&t(),ee.loadLocation(i,{index:currentIndex,source:"from loadChapterByUrl"})):(l.hash?(w.$getByHandle("content").scrollTop(!0),r.resolve()):r.resolve(),t&&t(),r.promise);desktop&&require("nw.gui").App.clearCache(),kInteractive.clearAudioVideo(document),currentVIndex=e.vIndex;var s=ee.getCurrentView(a,{vIndex:currentVIndex});return B.data.currentView=s.view,currentIndex=a=s.index,R(),B.data.currentPageOb=e.leftOb,B.data.currentRPageOb=e.rightOb,delete e.leftOb.currentVIndex,mobile&&w.$getByHandle("content").resize(),ee.busy=!0,ee.loadChapterByURLRaw(e).then(function(o){ee.busy=!1,e.scroll&&w.$getByHandle("content").scrollTo(0,e.scroll,!1),config.kotobee.cloudid&&(config.kotobee.public||n.setLastChapter()),setTimeout(function(){v.reset(e.scroll?e.scroll:0,function(){i?ee.loadLocation(i,{index:currentIndex,source:"loadChapterByURLRaw"}).then(function(){H("renderedChapter"),D(),t&&t()}):(T.replaceScript(o||[]),H("renderedChapter"),D(),t&&t())},30)})})}t&&t()},ee.cacheLookup=function(e,t){for(var n=0;n<ne.length;n++)if(ne[n].url==ph.removeHash(e)){var o=ne[n];return ne.splice(n,1),ne.push(o),o}},ee.removeFromCache=function(e,t){for(var n=0;n<ne.length;n++)if(ne[n].url==ph.removeHash(e)&&ne[n].view==t)return void ne.splice(n,1)},ee.addToCache=function(e,t){t||(t={}),e.url=ph.removeHash(e.url);var n=ee.cacheLookup(e.url,e.view);n?t.update&&(n.url=e.url,n.title=e.title,n.viewport=e.viewport,n.content=e.content,n.layout=e.layout,n.styles=e.styles,e.script&&(n.script=e.script)):(ne.length>20&&ne.shift(),t.lowPriority?ne=[e].concat():ne.push(e))},ee.loadChapterByURLRaw=function(e){function r(r,i){r||(r={});var l=r.leftOb.title,c=(r.leftOb.content,r.leftOb.viewport),d=(r.leftOb.styles,r.leftOb.script,r.leftOb.layout),f=r.isCached,g=r.leftOb,h=r.rightOb;g&&(s=s.concat(g.script)),h&&(s=s.concat(h.script)),makeArrayUnique(s),l||(l=g.title),B.data.book.chapter.title=l,t.send({verb:"navigated",activity:(currentIndex?"Chapter "+currentIndex+": ":"")+l}),n.addStat({action:"chapter",param:l});var m=document.getElementById("epubInner");r.source="from chapters",pauseVideoAndAudio(m=o.populateSpreads(m,r)),p.setOb("epubContent",document.getElementById("epubContent")),p.getOb("epubContainer").focus(),f||o.setContentSize(p.getOb("epubContent"),e),B.data.book.chapter.viewport=c,B.data.book.chapter.layout=d,B.data.book.chapter.view=r.view,B.data.book.chapter.paged=ee.shouldBePaged(g),R();var b=document.getElementById("chapters");removeClass(b,["rfl","fxl","double","single"]),addClass(b,B.data.book.chapter.viewport?"fxl":"rfl"),addClass(b,r.view),B.data.book.chapter.paged?addClass(b,"paged"):removeClass(b,"paged"),kInteractive.postRender(document);f||(E.replaceStyles(""),E.replaceStyles(g.styles.replace(/#spreadR/g,"#spreadL"),{append:!0}),h&&h.viewport&&E.replaceStyles(h.styles.replace(/#spreadL/g,"#spreadR"),{append:!0})),E.replaceStyles("#epubContainer div#epubContent, #epubContainer.stylesEnabled div#epubContent { background-color:#e7e3d9 !important;}",{append:!0}),config.preserveLoc&&"app"!=config.kotobee.mode&&B.writeSlot("lastLoc"+B.getBookId(),currentIndex),B.writeSlot("lastLocY"+B.getBookId(),0);for(var y=0;y<te.length;y++)te[y]("newChapter");C("contentJs")(f).then(function(){k.reset(),v.unlock(),u.setBookmark(currentIndex);var e={};e.id="chapter-"+currentIndex,e.description="View chapter: "+l,e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,u.setInteractions([e]),a.resolve(s)})}e||(e={});var i=ph.relative(ph.join(bookPath,B.data.packageURL),e.leftOb.url),a=(arguments.callee,A.defer());B.data.book.chapter.url=i,B.data.book.chapter.absoluteURL=ph.join(bookPath,B.data.packageURL,B.data.book.chapter.url);ph.getHash(B.data.book.chapter.url);v.disable(),v.lock(),g.update(null);var s=[];return function(e,t){function n(){if("single"!=e.view&&e.rightOb){var t=e.rightOb.url;(o=ee.cacheLookup(t,"single"))?(copyObjToObj(o,e.rightOb,{onlyIfNotExists:!0}),e.rightOb.cached=!0,r(e)):ee.preloadChapter(t,i,function(t){copyObjToObj(t,e.rightOb,{onlyIfNotExists:!0}),r(e)})}else r(e)}var o;if("double"==B.data.currentView&&(o=ee.cacheLookup(B.data.book.chapter.absoluteURL,"single")),o)return copyObjToObj(o,e.leftOb,{onlyIfNotExists:!0}),e.leftOb.cached=!0,void n();var i={showError:!0,deferred:a,view:e.view,id:e.id,view:null};ee.preloadChapter(B.data.book.chapter.absoluteURL,i,function(t){copyObjToObj(t,e.leftOb,{onlyIfNotExists:!0}),n()})}(e),a.promise},ee.preloadChapter=function(e,t,n){var o={func:arguments.callee,args:arguments};t||(t={}),F(e,function(o){for(var r=parser.parseFromString(o,"text/html"),i=C("contentHtml")(r,e),a=r.getElementsByTagName("meta"),s=null,l=0;l<a.length;l++){var c=a[l].getAttribute("name");if(c&&"viewport"==c.toLowerCase()){s={};var d=a[l].getAttribute("content");if(!d)break;for(var u=d.split(","),p=0;p<u.length;p++){var f=u[p].split("=");f[1]&&(f[1]=f[1].replace("px",""),s[f[0].trim()]=Number(f[1].trim()))}}}var g=s?"fxl":"rfl";C("js")(r).then(function(o){C("styles")(r,{path:e,id:t.id}).then(function(a){var l,c=r.getElementsByTagName("title");if(c.length)l=c[0].textContent.trim();else{var d=r.getElementsByTagName("h1");d.length&&(l=d[0].textContent.trim())}l||(l=B.data.book.meta.dc.title);var u={url:e,title:l,viewport:s,layout:g,content:i.outerHTML,styles:a,script:o};t.dontCache||ee.addToCache(u,t),n&&n(u)})})},function(){t.showError&&(i.update({error:"networkError",ref:o}),t.deferred&&t.deferred.reject({}),D())})},ee.clearContent=function(){replaceHTML("epubInner","")},ee.getChapterURL=function(e){void 0==e&&(e=currentIndex),e<0&&(e=0);var t;try{var n=B.data.epub.spine.getElementsByTagName("itemref");if(e>=n.length)return;t=n[e]}catch(e){}var o=getElementsByAttribute(B.data.epub.manifest,"item","id",t.getAttribute("idref"))[0].getAttribute("href"),r=t.getAttribute("id");return r&&(o+="#"+r),o},ee.isFirstChapter=function(e){z({first:0},e)},ee.isFirstVisibleChapter=function(e){z({first:Y},e)},ee.isLastChapter=function(e){return j({max:q},e)},ee.isLastVisibleChapter=function(e){return j({max:W},e)},ee.isLastVisibleSingleChapter=function(e,t,n){return j({max:W,page:e,vIndex:t,view:"single"},n)},ee.getPageOb=function(e,t){e||(e={});var n=e.page;null==n&&(n=currentIndex);var o=ee.getChapterURL(n);if(!o)return t?t():null;P(ph.join(bookPath,B.data.packageURL,o),{},function(o){if(o.index=n,"fxl"==o.layout&&(o.spread=$(o.index)),o.nonlinear=M(o.index),o.pages||"fxl"==o.layout||!ee.shouldBePaged(o)||e.dontParse)return s.add(o),t?t(o):null;h.get("spread").parseReflowableChapter(o,function(e){return o.pages=e.pages,o.raw=e.raw,s.add(o),t?t(o):null})})},ee.shouldBePaged=function(e,t){return(!e||"fxl"!=e.layout)&&("double"==B.data.settings.viewMode||("single"==B.data.settings.viewMode?!B.data.settings.pageScroll:(!t&&e&&(t=ee.getCurrentView(e.index).view),"single"!=t||!B.data.settings.pageScroll)))},ee.pdfPrint=function(){function e(e){e||(e={}),e.scale||(e.scale=100);var o=V();isKotobeeHosted()&&config.kotobee.cloudid&&!config.kotobee.public&&(o=U());var r=B.data.book.chapter.title,a={url:o,filename:r};g.update(y.get("pleaseWait"),null,{dots:!0}),n.createRequest(config.kotobee.liburl+"link/pdfgenerate/url",a,function(n){if(!n)return g.update(),void i.update({error:"networkError",ref:t});var r=n;r=0==window.location.href.indexOf("http://")?r.replace("https://","http://"):r.replace("http://","https://"),Z&&Z.parentNode&&Z.parentNode.removeChild(Z),(Z=document.createElement("iframe")).setAttribute("style","display:none"),Z.setAttribute("name","pdfFrame"),document.body.appendChild(Z),G&&G.parentNode&&G.parentNode.removeChild(G),(G=document.createElement("form")).setAttribute("style","visibility:hidden:position:absolute"),G.setAttribute("method","post"),G.setAttribute("action",r),G.setAttribute("target","pdfFrame"),addFormHiddenInput("url",o,G),addFormHiddenInput("filename",B.data.book.chapter.title,G),addFormHiddenInput("fileext","pdf",G),addFormHiddenInput("scale",e.scale,G),addFormHiddenInput("format",config.pdfMode?config.pdfMode:"imgpdf",G),asyncCheck(!config.kotobee.encodekey,F,[B.data.book.chapter.absoluteURL],function(e){function t(){Z&&Z.parentNode&&Z.parentNode.removeChild(Z),G&&G.parentNode&&G.parentNode.removeChild(G),g.update()}config.kotobee.encodekey&&addFormHiddenInput("data",e,G),document.body.appendChild(G),G.submit(),setTimeout(function(){Z.addEventListener?Z.addEventListener("load",t,!0):Z.attachEvent&&Z.attachEvent("onload",t)}),setTimeout(function(){g.update()},4e3)})})}var t={func:arguments.callee,args:arguments};if(preview)i.update({error:"savePdfUnsupportedInPreview"});else if(!desktop&&!native)if(config.pdfsavingOptions){var o={scale:100};o.submit=function(){f.hide(),e({scale:o.scale})},f.show({mode:"pdfSave",pdfSaveOptions:o})}else e()},ee.pdfPrintOld=function(){preview?i.update({error:"savePdfUnsupportedInPreview"}):desktop||native||(g.update(y.get("pleaseWait"),null,{dots:!0}),window.location.href="https://www.kotobee.com/link/pdfgenerate?url="+V(),setTimeout(function(){g.update()},4e3))},ee.printAsBitmap=function(){var e={func:arguments.callee,args:arguments};if(!native&&!mobile){var t=V();isKotobeeHosted()&&config.kotobee.cloudid&&!config.kotobee.public&&(t=U());var o=B.data.book.chapter.title,r={url:t,filename:o};g.update(y.get("pleaseWait"),null,{dots:!0}),n.createRequest(config.kotobee.liburl+"link/pdfgenerate/url",r,function(n){function o(){try{var e=this.contentWindow;setTimeout(function(){e.__container__=this,e.focus(),e.print(),g.update()},2500)}catch(e){g.update()}}if(!n)return g.update(),void i.update({error:"networkError",ref:e});var r=n;X&&X.parentNode&&X.parentNode.removeChild(X),(X=document.createElement("iframe")).setAttribute("style","display:none"),X.setAttribute("name","printFrame"),X.id="printContainer",X.style.visibility="hidden",X.style.position="fixed",X.style.right="0",X.style.bottom="0",document.body.appendChild(X),Q&&Q.parentNode&&Q.parentNode.removeChild(Q),(Q=document.createElement("form")).setAttribute("style","visibility:hidden:position:absolute"),Q.setAttribute("method","post"),Q.setAttribute("action",r),Q.setAttribute("target","printFrame"),addFormHiddenInput("url",t,Q),addFormHiddenInput("filename",B.data.book.chapter.title,Q),addFormHiddenInput("fileext","pdf",Q),addFormHiddenInput("print",!0,Q),addFormHiddenInput("format","imghtml",Q),asyncCheck(!config.kotobee.encodekey,F,[B.data.book.chapter.absoluteURL],function(e){config.kotobee.encodekey&&addFormHiddenInput("data",e,Q),document.body.appendChild(Q),Q.submit(),X.onload=o,setTimeout(function(){g.update()},8e3)})})}},ee.print=function(){native||mobile||("fxl"==B.data.book.chapter.layout?ee.printAsBitmap():(g.update(y.get("pleaseWait"),null,{dots:!0}),F(V(),function(e){return e=(e=e.replace("</head>","<script> window.onload = function() { window.print(); parent.closePrintIframe(); }<\/script></head>")).replace("</head>","<base href='"+ph.removeFilename(V())+"/'/></head>"),(t=document.createElement("iframe")).id="printContainer",t.style.visibility="hidden",t.style.position="fixed",t.style.right="0",t.style.bottom="0",t.setAttribute("srcdoc",e),document.body.appendChild(t),void g.update();var t})))};var oe,re,ie;return ee.regenerateSpreads=function(e,t){if(e||(e={}),ee.shouldBePaged(B.data.currentPageOb))if(ee.regeneratingSpreads)re=!0;else{re=!1,p.getOb("epubContainer").style.opacity=0,ee.showLoader();var n;B.data.currentPageOb.pages&&B.data.currentPageOb.pages.length&&(n=currentVIndex/B.data.currentPageOb.pages.length),oe&&clearTimeout(oe),oe=setTimeout(function(){ee.regeneratingSpreads=!0,ie&&clearTimeout(ie),ie=setTimeout(function(){ee.regeneratingSpreads=!1,ee.regenerateSpreads(e,t)},2e4),ee.resetPages(),ee.preloadEdgeChapters(function(){ee.getPageOb({page:currentIndex},function(e){var o={};o.viewMode=B.data.settings.viewMode,o.vIndex=currentVIndex,n&&e.pages&&(o.vIndex=Math.floor(e.pages.length*n),o.vIndex!=currentVIndex&&O.search({vi:o.vIndex})),o.reload=!0,ee.loadChapterByIndex(currentIndex,o).then(function(){ee.regeneratingSpreads=!1,clearTimeout(ie),re?setTimeout(function(){re=!1,ee.regenerateSpreads(o,t)},100):(t&&t(),p.getOb("epubContainer").style.opacity=1,ee.hideLoader())})})})},e.resize?600:30)}},ee.resetPages=function(e){e||(e={});for(var t=0;t<ne.length;t++)ne[t].pages=null;return s.reset(),e.buildChapterMode?s.initialize({first:Y,last:W}):B.data.book.meta.rendition&&"pre-paginated"==B.data.book.meta.rendition.layout?s.initialize({first:Y,last:W}):"single"==B.data.settings.viewMode&&B.data.settings.pageScroll?s.initialize({first:Y,last:W}):void 0},ee}]),app.factory("context",["$interpolate","skeleton","cssParser","cache","$rootScope","stg","$injector","$http",function(e,t,n,o,r,i,a,s){function l(e,n){var o;null!=i.data.currentPageOb.currentVIndex&&(isNaN(i.data.currentPageOb.currentVIndex)||(o=i.data.currentPageOb.vIndex,i.data.currentPageOb.vIndex=currentVIndex)),t.getNextIndex(i.data.currentPageOb,function(r){null!=o&&(i.data.currentPageOb.vIndex=o);var a;r&&(a=[e,r.leftOb]),asyncCheck(!r,m.arePagesAppearingTogether,a,function(a){if(a&&r)return n("next");null!=currentVIndex&&(i.data.currentPageOb.vIndex=currentVIndex),t.getPrevIndex(i.data.currentPageOb,function(t){null!=o&&(i.data.currentPageOb.vIndex=o);m.getCurrentView(t.leftOb.index,{vIndex:t.leftOb.vIndex});m.arePagesAppearingTogether(e,t.leftOb,function(e){return n(e?"prev":null)})})})})}function c(e,t){if(e||(e={}),e.reload)t&&t();else{var n=o.getOb("epubContainer");if(null==currentIndex)return n.style.opacity=0,m.showLoader(),void(t&&t());l(e.pageOb,function(o){if(!o)return n.style.opacity=0,e.pageOb.index!=currentIndex&&m.showLoader(),void(t&&t());var r=document.getElementById(o+"Page"),s=r.getElementsByTagName("iframe");if(s.length){var l=s[0].contentDocument.getElementById("epubContent");if(l){s[0].style.visibility="visible";var d=a.get("nav").viewFromElem(l);"fxl"==d.layout&&h(s[0],d)}else if(requestAnimationFrame)return void requestAnimationFrame(function(){c(e,t)})}if("navSlide"==i.data.settings.navAnim)i.data.settings.rtl?r.style.transform="translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)":r.style.transform="translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)",setTimeout(function(){e.animID==y&&(i.data.settings.rtl?autoprefixTransform(n,"translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)"):autoprefixTransform(n,"translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)"),r.style.transform="translate3d(0,0,0)",addClass(n,"anim"),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==y&&(autoprefixTransform(n,null),removeClass(n,"anim"),t&&t())},330))},30);else if("navFade"==i.data.settings.navAnim)r.style.left=0,r.style.opacity=1,addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==y&&t&&t()},330);else if("navFlip"==i.data.settings.navAnim)addClass(n,"anim"),i.data.settings.rtl?(autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"),autoprefixTransform(r,"next"==o?"rotateY(-90deg)":"rotateY(90deg)")):(autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)"),autoprefixTransform(r,"next"==o?"rotateY(90deg)":"rotateY(-90deg)")),n.style.opacity=0,setTimeout(function(){e.animID==y&&(autoprefixTransform(r,null),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==y&&(removeClass(n,"anim"),autoprefixTransform(n,null),t&&t())},630))},30);else if("navBookBlock"==i.data.settings.navAnim){var u=document.createElement("div");u.className="shadow",u.style.opacity=0,u.appendChild(document.createElement("div")),n.appendChild(u),addClass(n,"anim"),i.data.settings.rtl?autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"):autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)");var p=n.style.transform||n.style.webkitTransform||n.style.mozTransform;autoprefixTransformOrigin(n,"rotateY(90deg)"==p?"right top":"left top"),n.style.opacity=0,addClass(r,"anim"),addClass(r,"activeSlidePage");var f=document.createElement("div");f.className="shadow",f.style.opacity=.7,r.appendChild(f),u.style.opacity=0,u.style.height=n.scrollHeight+"px",f.style.marginLeft=n.style.marginLeft,f.style.marginRight=n.style.marginRight,f.style.marginBottom=n.style.marginBottom;var g=getElemMargin(n);g.top||(g.top=0);var v=getComputedStyle(n).paddingTop.split("px");f.style.marginTop=Number(g.top)+Number(v[0])+"px";var b=getComputedStyle(n).backgroundColor,k="rgba(0,0,0,0)"==(b=b.replace(/ /g,""));k&&(n.style.backgroundColor="#fff"),setTimeout(function(){e.animID==y&&(f.style.opacity=null,setTimeout(function(){u.style.opacity=.4,setTimeout(function(){autoprefixTransformOrigin(n,null),f.parentNode&&f.parentNode.removeChild(f),u.parentNode&&u.parentNode.removeChild(u),e.animID==y&&(removeClass(n,"anim"),n.style.opacity=null,k&&(n.style.backgroundColor=null),autoprefixTransform(n,null),t&&t())},430)},200))},30)}})}}function d(e){if(e||(e={}),!e.reload){var t=o.getOb("epubContainer");null!=t.style.opacity&&(t.style.opacity=null,m.hideLoader()),native&&(t.scrollTop=0);var n=document.getElementsByClassName("activeSlidePage");if(n.length){var r=n[0];"navSlide"==i.data.settings.navAnim?r.style.transform=null:"navFade"==i.data.settings.navAnim?r.style.opacity=null:"navFlip"==i.data.settings.navAnim?autoprefixTransform(r,null):"navBookBlock"==i.data.settings.navAnim&&(deleteTransform(r),deleteTransform(t),t.style.opacity=null);for(var a=0;a<t.children.length;a++)if("shadow"==t.children[a].className){t.removeChild(t.children[a]);break}removeClass(r,"anim"),removeClass(r,"activeSlidePage");var s='<h3 id="ebookLoaderAnim"><div class="splashSpinner large"><div class="dot1"></div><div class="dot2"></div></div></h3>';document.getElementById("nextPage").innerHTML=s,document.getElementById("prevPage").innerHTML=s}}}function u(e){function n(e,t,n){e&&m.getPageOb({page:e.leftOb.index},function(o){if(o){var r={};r.leftOb=clone(o),r.vIndex=e.leftOb.vIndex,r.vIndex<0&&o.pages&&o.pages.length&&(r.vIndex+=o.pages.length),m.planPageMapping(r,function(e){p(r.leftOb.url,function(e){r.styles=e,r.container=document.getElementById(t),r.view=m.getCurrentView(r.leftOb.index,r.leftOb).view,r.source="from preloadchapters",f(r,n)})})}})}m.isFirstChapter(function(o){m.isLastChapter(function(r){r||t.getNextIndex(e.leftOb,function(e){m.getSurroundingPages(e?e.leftOb:null,function(){n(e,"nextPage")})}),o||t.getPrevIndex(e.leftOb,function(e){m.getSurroundingPages(e?e.leftOb:null,function(){n(e,"prevPage")})})})})}function p(e,t){function o(){t(b)}if(b)t(n.applyRoot(e,b));else{var r=isKotobeeHosted(),i="lib/ionic/release/css/ionic.min.css";r&&(i="/bundles/vijualib/templates/reader/cloud/lib/ionic/release/css/ionic.min.css"),s.get(i).success(function(i){if(v=i,r)s.get("/bundles/vijualib/templates/reader/cloud/css/styles.min.css").success(function(e){b=e,o()}).error(function(){t(n.applyRoot(e,b))});else{var a="css/styles.min.css",l="http://localhost:8080"==window.location.origin;l&&(a="css/style.css"),s.get(a).success(function(e){b=e,l?s.get("css/base.css").success(function(e){b=e+" "+b,s.get("css/kotobeeInteractive.css").success(function(e){b+=e,o()}).error(function(){o()})}).error(function(){o()}):o()}).error(function(){t(n.applyRoot(e,b))})}}).error(function(){t(n.applyRoot(e,b))})}}function f(e,t){e||(e={});var n=e.styles;e.container&&(n||(n=""),m.shouldBePaged(e.leftOb)&&(e.leftOb&&(e.leftOb.viewport=a.get("spread").getViewport(e.leftOb)),e.rightOb&&(e.rightOb.viewport=a.get("spread").getViewport(e.rightOb))),e.simulate?g(e,t):m.getPageOb({page:e.leftOb.index},function(n){copyObjToObj(n,e.leftOb,{onlyIfNotExists:!0}),e.leftOb.pages&&e.leftOb.vIndex<0&&(e.leftOb.vIndex+=e.leftOb.pages.length),e.rightOb?m.getPageOb({page:e.rightOb.index},function(n){copyObjToObj(n,e.rightOb,{onlyIfNotExists:!0}),e.rightOb.pages&&e.rightOb.vIndex<0&&(e.rightOb.vIndex+=e.rightOb.pages.length),g(e,t)}):g(e,t)}))}function g(e,t){function n(e){var t="";v&&(t+=v);var n=" body{margin:0; padding-top:0px;} #epubContainer{padding-top:0px;position:absolute;top:0;left:0;right:0;bottom:0 !important}";return mobile||(n+="body, #epubContainer{padding-top:1px;}"),t+=n,t+="html,#epubContainer{overflow-y:"+(mobile?"hidden":"auto")+"}",t+="#epubScroller{position: static;height: 100%;width: 100%;box-sizing: border-box;}",!mobile&&i.data.settings.rtl&&(t+="#epubContainer{overflow:auto !important}"),mobile&&(t+=" #epubContent ::-webkit-scrollbar {display: none;} #epubContent {-ms-overflow-style: none;overflow: -moz-scrollbars-none;}"),t+="#epubScroller{padding:"+getElemPadding(o.getOb("epubContainer").getElementsByClassName("scroll")[0],{computed:!0}).left+"px}",c.viewport&&c.viewport.width&&(t+="#epubContent{width:"+c.viewport.width+"px;height:"+c.viewport.height+"px; overflow:hidden}",t+="html{overflow-x:"+(mobile?"hidden":"auto")+"}",t+=" #epubInner{height:0;} ",t+=" #spreadL,#spreadR{position:absolute !important; top:0 !important;font-size: 1em !important;overflow:hidden;}"),c.viewport||mobile||(t+="#epubScroller{overflow:auto}"),t+=" #epubContent{padding:0px; line-height: 1.6;} ",t+=" #epubContent{box-sizing:border-box; font-size:"+i.data.settings.textSize+" !important;}",t+=" #epubContent.hide{display:block !important}",t+=" #epubContent section{margin-top:0 !important}",i.data.settings.textSize&&(t+=" #epubContent{font-size: "+i.data.settings.textSize+"}"),t+=b,e||(e=""),t+=e,t=t.replace("background-color:#e7e3d9 !important;","")}function a(){var e=arguments[2];return 0==e.indexOf('"')&&(e=e.split('"')[1]),0==e.indexOf("'")&&(e=e.split("'")[1]),0==e.indexOf("&quot;")&&(e=e.split("&quot;")[1]),-1!=e.indexOf("http://")?arguments[0]:-1!=e.indexOf("https://")?arguments[0]:0==e.indexOf("data:")?arguments[0]:(e=ph.relative(ph.removeFilename(u),e),arguments[1]+e+arguments[3])}function s(t){t||(t=""),t=(t=(t=t.replace(/<div class="answer correct">/g,'<div class="answer">')).replace(/<div class="correct">/g,"<div>")).replace(/<p class="explanation">.*?<\/p>/g,""),e.simulate||(t=t.replace(/(style=".*?url\()(.+?)(\).*?")/g,a));isKotobeeHosted();r.readerApp||e.simulate||(t=t.replace(/src="(?!http[s]?\:\/\/)([^"]*)?"/g,function(e,t){return'src="'+ph.relative(u,t)+'"'}));c.title;return t}e.id=Math.round(999*Math.random());var l=e.container,c=e.leftOb,d=e.rightOb,u=c.url,p=ph.removeHash(window.location.href),f=document.createElement("html"),g=document.createElement("head");ios&&(g.innerHTML="<meta http-equiv=\"Content-Security-Policy\" content=\"default-src * filesystem: data:; style-src 'self' 'unsafe-inline' filesystem: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.youtube.com http://*.youtube.com https://*.ytimg.com http://*.ytimg.com;img-src * filesystem: data: file:\">"),f.appendChild(g);var m=document.createElement("base"),y=document.getElementsByTagName("base");if(y.length)for(S=0;S<y.length;S++){var w=y[S].getAttribute("href");if(w){p=0==w.indexOf("/")||isAbsoluteURLPath(w)?w:ph.join(window.location.origin,w);break}}m.setAttribute("href",ph.join(p,ph.removeFilename(u))+"/"),g.appendChild(m);var C=document.createElement("div");C.className="stylesEnabled",C.id="epubContainer";var x=document.createElement("div");x.id="epubScroller",x.className="scroll",C.appendChild(x);var I=document.createElement("div");I.id="epubInner",x.appendChild(I);var E=document.createElement("style");E.setAttribute("type","text/css"),c.pages&&null!=c.vIndex?c.content=c.pages[c.vIndex].content:!c.content&&c.raw&&(c.content=c.raw),c.content=s(c.content),d&&(d.pages&&null!=d.vIndex?d.content=d.pages[d.vIndex].content:!d.content&&d.raw&&(d.content=d.raw),d.content=s(d.content)),e.cached=!1,I=k.populateSpreads(I,e),e.cached||(c.styles=c.styles.replace(/#spreadR/g,"#spreadL"),e.simulate||(c.styles=c.styles.replace(/(url\()(.*?)(\))/g,a)),d&&(d.styles=d.styles.replace(/#spreadL/g,"#spreadR"),e.simulate||(d.styles=d.styles.replace(/(url\()(.*?)(\))/g,a))));c.styles;var T=n(c.styles);!e.cached&&d&&(T+=" "+n(d.styles),d.styles),E.innerHTML=T,g.appendChild(E);for(var O=I.getElementsByTagName("audio"),S=O.length;S--;){try{O[S].pause(),O[S].children.length||(O[S].src="")}catch(e){}var A=O[S].parentNode;A.previousSibling&&hasClass(A.previousSibling,"playBtn")&&removeClass(A.previousSibling,"hide"),A.removeChild(O[S])}for(var B=I.getElementsByTagName("video"),S=B.length;S--;){try{B[S].pause(),B[S].children.length||(B[S].src="")}catch(e){}var N=B[S].parentNode;N.previousSibling&&hasClass(N.previousSibling,"playBtn")&&removeClass(N.previousSibling,"hide"),N.removeChild(B[S])}var L=document.createElement("body");i.data.settings.rtl&&addClass(L,"rtl"),addClass(L,c.layout),addClass(L,e.view),L.appendChild(C),f.appendChild(L);var M=document.createElement("iframe");if(M.setAttribute("srcdoc",f.outerHTML),M.style.visibility="hidden",detectIE()||native&&ios){var $="javascript: window.frameElement.getAttribute('srcdoc');";M.setAttribute("src",$),M.contentWindow&&(M.contentWindow.location=$)}M.onload=function(){M.style.visibility="visible",h(M,e)},l&&(l.innerHTML="",l.appendChild(M),t&&t(M))}function h(e,t){t||(t={});var n=t.leftOb,o={},r=!!t.rightOb,i=e.contentDocument,s=i.getElementById("epubContent"),l=i.getElementById("epubContainer");if(k.setContentSize(s,t),n.viewport){o.epubContainer=l,o.epubContent=s,o.viewport=n.viewport,o.view=r?"double":"single",o.stylesFromEpubContent=!0;var c=a.get("nav").getFxlFit(o,"FROM CONTEXT"),d=c.scrollContainer;autoprefixTransform(d,"scale("+c.bestFit+")"),autoprefixTransformOrigin(d,"top left;"),d.style.height="100%",a.get("nav").fxlAdjustAlignment(o)}else{deleteTransform(s);var u=i.getElementById("spreadL");u.style.width=u.style.height=null;var p=i.getElementById("spreadR");p&&p.parentNode.removeChild(p)}}var m,v,b,y,k={};return k.initialize=function(){m=a.get("chapters")},k.startTransition=function(e,t){d(e),setTimeout(function(){var n={animID:y=Math.round(1e4*Math.random()),reload:e.reload,pageOb:e.leftOb};c(n,function(){m.loadChapterByURL(e,function(){setTimeout(function(){n.animID==y&&(d(e),u(e),t&&t.resolve())},mobile?500:0)})})})},k.interruptAnimation=function(){d()},k.simulateChapter=function(e,t){p(e.url,function(n){var o=document.createElement("div"),r={};r.styles=n,r.styles+="#spreadL{left:0 !important;width:auto !important;height:auto !important;position:static !important;}",r.styles+="#epubContent{width:auto !important;height: auto !important;}",r.container=o,r.leftOb=clone(e),"double"==m.getCurrentView(r.leftOb.index).view&&(r.rightOb={},r.rightOb.content="<div><sections class='blankForSimulation'></sections></div>",r.rightOb.styles="",r.rightOb.layout="rfl"),r.simulate=!0,f(r,t)})},k.populateSpreads=function(e,t){t||(t={});var n=0;"rfl"==t.leftOb.layout&&"double"==t.view&&(n=config.spreadSpacing?config.spreadSpacing:0);var o=t.leftContent?t.leftContent:t.leftOb.content;if(!t.cached){(d=document.createElement("div")).innerHTML=t.leftContent?t.leftContent:t.leftOb.content;var r=d.children[0],a=r.children[0];copyAttributes(r,a),removeClass(a,"adjustedLineHeight"),a.id="spreadL",a.style.transform=a.style.transformOrigin=a.style.height=null,t.leftOb.viewport?(a.style.left="0px",a.style.width=t.leftOb.viewport.width+"px",a.style.height=t.leftOb.viewport.height+"px",i.data.settings.rtl&&(a.style.left="auto",a.style.right="0px")):(a.style.left=null,a.style.width=null,a.style.height=null),addClass(a,t.leftOb.layout),o=d.innerHTML}var s=replaceHTML(e,o);if(t.rightOb){var l;if(s.children[0].children.length>1)for(var c=0;c<s.children[0].children.length;c++)if("spreadR"==s.children[0].children[c].id){l=s.children[0].children[c];break}if(!l){var d=document.createElement("div");d.innerHTML=t.rightContent?t.rightContent:t.rightOb.content;var u=d.children[0];copyAttributes(u,l=u.children[0]),removeClass(l,"adjustedLineHeight"),l.id="spreadR",l.style.transform=l.style.transformOrigin=l.style.height=null,s.children[0].appendChild(l)}t.rightOb.viewport&&(t.leftOb.viewport&&(l.style.left=t.leftOb.viewport.width+n+"px",i.data.settings.rtl&&(l.style.right=l.style.left,l.style.left="auto")),l.style.width=t.rightOb.viewport.width+"px",l.style.height=t.rightOb.viewport.height+"px",addClass(l,t.rightOb.layout))}return s},k.test=function(e){},k.setContentSize=function(e,t){t||(t={});var n=t.leftOb,o=t.rightOb;e.style.width=e.style.height=null;var r=0;"rfl"==t.leftOb.layout&&"double"==t.view&&(r=config.spreadSpacing?config.spreadSpacing:0);var i=n.viewport;if(i){if(i.width){var a=i.width;o&&o.viewport&&(a+=o.viewport.width+r),e.style.width=a+0+"px"}if(i.height){var s=i.height;o&&o.viewport&&(s=Math.max(s,o.viewport.height)),e.style.height=s+0+0+"px"}}},k}]),app.factory("crdv",["stg","status","error","translit","$rootScope","$http","$ionicSideMenuDelegate",function(e,t,n,o,r,i,a){function s(t){e.data.settings.rtl?a.toggleLeft():a.toggleRight()}function l(){try{return cordova,!0}catch(e){return!1}}function c(e,n,o,r){try{t.updateProgress(0),e.getEntries(function(i){function a(){if(s>=i.length)e.close(function(){o&&o()});else{t.updateProgress(s/i.length);var l=i[s];s++,l.getData(new zip.BlobWriter,function(e){try{if("/"==l.filename.substr(-1))return void a();u.writeFile(e,ph.join(n,l.filename),u.libEbooksDirectory,function(){a()})}catch(e){r&&r()}},function(e,t){})}}var s=0;a()})}catch(e){r&&r()}}function d(e){switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:"QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:"NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:"SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:"INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:"INVALID_STATE_ERR";break;default:"Unknown Error"}}var u={};return u.initialize=function(t,o){t.putTest("in1"),l()?(t.putTest("in3"),e.data.cordova=!0,t.putTest("in4"),t.putTest("in5"),t.$$phase||t.$apply(),e.copyLocalToNativeStorage(),u.initAds(),u.initDirectories(function(){i.get("permit.json").success(function(e){function t(){var e={error:"errorAndCallback",msg:"noAppPermit",cb:u.exit};n.update(e),r.$$phase||r.$apply()}("udid"==e.type?window.plugins.uniqueDeviceID.get:"mac"==e.type?window.MacAddress.getMacAddress:window.plugins.imeiplugin.getImei)(function(n){n||t();try{for(var r,i=e.list.split("\n"),a=0;a<i.length;a++){var s=i[a].trim().split(" ")[0].trim(),l=i[a].trim().split("/")[0].trim();if(s==n||l==n){r=!0;break}}}catch(e){return void t()}r?o():t()},t)}).error(function(){o()})}),document.addEventListener("menubutton",s,!1),t.$$phase||t.$apply()):o()},u.showKeyboard=function(){try{if(!l())return;cordova.plugins.Keyboard.show()}catch(e){}},u.hideKeyboard=function(){try{cordova.plugins.Keyboard.close()}catch(e){}},u.tts=function(e,t){var n={text:e,rate:1};try{"iOS"==window.device.platform&&("9"==window.device.version.charAt(0)?n.rate=1.5:"10"==window.device.version.substr(0,2)?n.rate=1.5:"11"==window.device.version.substr(0,2)&&(n.rate=1.5))}catch(e){}TTS.speak(n,function(){t(!0)},function(e){u.toast(o.get("ttsUnavailableMsg")),t(!1)})},u.toast=function(e){l()&&window.plugins.toast.showShortBottom(e)},u.copyToClipboard=function(e){if(l())try{cordova.plugins.clipboard?cordova.plugins.clipboard.copy(e):window.plugins.clipboard.copy(e),u.toast(o.get("copiedToClipboard"))}catch(e){}},u.share=function(e){if(l())try{window.plugins.socialsharing.share(e)}catch(e){}},u.createPDF=function(e,t,n){try{var r=new jsPDF;margins={top:10,bottom:0,left:10,width:180},r.fromHTML(e,margins.left,margins.top,{width:margins.width},function(e){try{cordova,u.docDirectory.getFile(t,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){},e.onerror=function(e){},e.write(r.output()),u.toast(o.get("pdfSaved"))},d)},d)}catch(e){try{setTimeout(function(){r.save(t)},1e3)}catch(e){}}},margins)}catch(e){}},u.initDirectories=function(e){function t(e){}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(window.TEMPORARY,10485760,function(n){u.cacheDirectory=n.root,window.requestFileSystem(window.PERSISTENT,0,function(n){u.docDirectory=n.root;var o="kotobeeReader";r.readerApp?o="kotobeeReaderApp":config.kotobee.cloudid&&(o+=config.kotobee.cloudid),u.docDirectory.getDirectory(o,{create:!0},function(n){u.appDirectory=n,u.appDirectory.getDirectory("library",{create:!0},function(n){u.libEbooksDirectory=n,u.appDirectory.getDirectory("local",{create:!0},function(n){u.localDirectory=n,u.localDirectory.getDirectory("books",{create:!0},function(n){u.localBooksDirectory=n,u.localDirectory.getDirectory("thumbs",{create:!0},function(n){u.localThumbsDirectory=n,u.libEbooksDirectory.getFile(".nomedia",{create:!0},function(){u.localDirectory.getFile(".nomedia",{create:!0},function(){e()},t)},t)},t)},t)},t)},t)},t)},t)},t)},u.exit=function(){l()&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},u.applyExistingBooksOld=function(e,t){function n(e){return Array.prototype.slice.call(e||[],0)}if(l()){var o=u.libEbooksDirectory.createReader(),r=[],i=function(){o.readEntries(function(o){if(o.length)r=r.concat(n(o)),i();else{for(var a=0;a<r.length;a++)for(var s=r[a].name,l=0;l<e.length;l++)e[l].path==s&&(e[l].exists=!0);t()}},function(e){})};i()}else t()},u.applyExistingBooks=function(t){if((native||desktop)&&(t||e.data.currentLibrary&&(t=e.data.currentLibrary.books),t)){for(i=0;i<t.length;i++)t[i].exists=!1;for(n=0;n<e.data.downloaded.length;n++)e.data.downloaded[n].favorite=!1;for(var n=0;n<e.data.downloaded.length;n++){var o=e.data.downloaded[n].path;e.data.downloaded[n].favorite=null;for(var i=0;i<t.length;i++)if(t[i].path==o){t[i].exists=!0,e.data.downloaded[n].favorite=t[i].favorite;break}}r.$$phase||r.$apply()}},u.vibrate=function(e){l()&&(e||(e=40),ios||(ios&&(e/=4),navigator&&navigator.notification&&navigator.notification.vibrate&&navigator.notification.vibrate(e)))},u.deleteEbook=function(t,n){u.libEbooksDirectory.getDirectory(t.path,{},function(o){o.removeRecursively(function(){for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].path==t.path&&(t.exists=!1,e.data.downloaded.splice(o,1),o--);e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){n()})},function(e){})},d)},u.writeEbook=function(t,n,o,r){var i=o;u.libEbooksDirectory.getDirectory(n.path,{create:!0},function(o){var a=ph.join(n.path,t);u.writeFile(i,a,u.libEbooksDirectory,function(){u.unzipViaPlugin(ph.join(u.libEbooksDirectory.nativeURL,a),ph.join(u.libEbooksDirectory.nativeURL,n.path,"EPUB"),function(t){n.exists=!0,e.data.downloaded.push(n),u.applyExistingBooks(e.data.currentLibrary.books),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){r()})})})})},u.unzip=function(e,t,n,o){u.unzipBlob(e,t,n,o)},u.unzipBlob=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.BlobReader(e),function(e){c(e,t,n,o)})},u.unzipViaPlugin=function(e,t,n,o){zip.unzip(e,t,n,o)},u.unzipURLOld=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.HttpReader(e),function(e){c(e,t,n,o)})},u.unzipData64=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",setTimeout(function(){zip.createReader(new zip.Data64URIReader(e),function(e){setTimeout(function(){c(e,t,n,o)},100)})},100)},u.writeFile=function(e,t,n,o){var r=ph.basename(t);try{u.getDirectoryRelativeToBooks(ph.normalize(t),n,function(t){try{t.getFile(r,{create:!0},function(t){t.createWriter(function(t){function n(){var a=Math.min(i,e.size-r),s=e.slice(r,r+a);t.write(s),r+=a,t.onwrite=function(t){r<e.size?n():o&&o(!0)},t.onerror=function(e){o&&o(!1)}}var r=0,i=4194304;n()},d)},function(e,t){})}catch(e){}})}catch(e){}},u.getDirectoryRelativeToBooks=function(e,t,n){t||(t=u.libEbooksDirectory);var o=e.split("/");if(1!=o.length){var r=o[0];t.getDirectory(r,{create:!0},function(e){o.shift();var t=o.join("/");u.getDirectoryRelativeToBooks(t,e,n)},function(e){})}else n(t)},u.openInNativeBrowser=function(e,t){e=e.toString();try{if(t)return void window.open(e,"_system");try{if(cordova.InAppBrowser){window.plugins.toast.show("  "+o.get("loadingExternalPage")+"  ",4e4,"bottom");var n=ios?"yes":"no",r=cordova.InAppBrowser.open(e,"_blank","location=no,hidden=no,clearcache=yes,closebuttoncaption=Go back to App,toolbar="+n+",presentationstyle=formsheet");return r.addEventListener("loadstart",function(){}),r.addEventListener("loadstop",function(){ios||window.plugins.toast.hide()}),void r.addEventListener("loaderror",function(){if(!ios){try{r&&r.close()}catch(e){}window.plugins.toast.hide(),window.plugins.toast.showLongBottom("  "+o.get("errorLoadingPage")+"  ")}})}}catch(e){}try{if(window.inAppBrowserXwalk){var i={toolbarColor:"#FFFFFF",toolbarHeight:"40",closeButtonText:"< Close",closeButtonSize:"25",closeButtonColor:"#000000",openHidden:!1};return void window.inAppBrowserXwalk.open(e,i)}}catch(e){}return void window.open(e,"_system")}catch(e){}},u.initAds=function(){try{if(!admob)return}catch(e){return}config.kotobee.admobId&&(admob.setOptions({publisherId:config.kotobee.admobId}),admob.createBannerView())},u}]),app.factory("cssParser",["$http","cache","stg","workers",function(e,t,n,o){function r(e){function t(e){return e||(e=1),i[i.length-e]}e=e.replace(/\r?\n|\r/g," ");for(var n,o=[],r="key",i=[0],a=o,s=[a],l=0;l<e.length;l++)n||(n={}),"}"==e[l]?("properties"==r&&(n.properties=e.substring(t(),l).trim(),n.keys&&n.keys.length&&(n.keys[n.keys.length-1]=n.keys[n.keys.length-1].trim()),a.push(n)),"key"==r&&s.length>1&&(s.pop(),a=s[s.length-1]),n=null,r="key",i.push(l+1)):"{"==e[l]?("properties"==r&&(n.children||(n.children=[]),n.keys&&n.keys.length&&(n.keys[n.keys.length-1]=n.keys[n.keys.length-1].trim()),o.push(n),a=n.children,s.push(a),(n={keys:[]}).keys.push(e.substring(t(),l).trim())),i.push(l+1),r="properties"):"key"==r&&(n.keys||(n.keys=[""]),","==e[l]?n.keys.push(""):n.keys[n.keys.length-1]+=e[l]);return o}var i,a,s={},l=[];return s.clearCache=function(){l=[]},s.inject=function(t,n,a){function c(e,t){for(var n=0;n<l.length;n++)if(l[n].url==e&&l[n].id==t)return l.push(l[n]),l[n]}function d(e){l.length>7&&l.shift(),l.push(e)}function u(a,l){function g(e,t,i){function l(e){if(e){for(var t=e.split(";"),n="",o=0;o<t.length;o++)t[o]&&-1!=t[o].trim().indexOf("background")&&(n=t[o].trim().replace(/url\(.*?\)/g,"")+";");return n}}function c(e){for(var t={},n=0;n<e.length;n++)if(e[n]){var o=e[n].trim();0!=o.indexOf("body")?0!=o.indexOf("html")?0!=o.indexOf("@media")&&0!=o.indexOf("@")&&isNaN(o[0])&&"from"!=o&&"to"!=o&&(e[n]=g+" "+o):e[n]=o.replace("html",g):(e[n]=o.replace("body",g),0==e[n].indexOf("html")&&(e[n]=e[n].replace("html",g)),t.hasBody=!0)}return t.joined=e.join(","),t}if(o.supported()){var u={};return u.data=e,u.rootPath=t,u.cssOb=a,u.desktop=desktop,void o.call("cssParser","parse",[u],function(e){"url"==i&&d({url:m,val:e,id:n.id}),h(e)})}e=(e=(e=(e=s.applyRoot(t,e)).replace(/\/\*[\s\S]*?\*\//g,"")).replace(/<!--/g,"")).replace(/-->/g,"");var f="spreadL";n.id&&(f=n.id);for(var g=(a.parentClass?a.parentClass:"#epubContainer.stylesEnabled")+" #"+f,v=r(e),b="",y=0;y<v.length;y++){var k=c(v[y].keys);if(b+=k.joined,b+="{",v[y].children&&v[y].children.length)for(var w=0;w<v[y].children.length;w++){var C=c(v[y].children[w].keys);b+=C.joined,b+="{"+v[y].children[w].properties+"}",C.hasBody&&(x=l(v[y].properties))&&(b+="#epubContainer{"+x+"}")}if(v[y].properties&&(b+=v[y].properties),b+="}",k.hasBody){var x=l(v[y].properties);x&&(b+="#epubContainer{"+x+"}")}}e=p(e=b),"url"==i&&d({url:m,val:e,id:n.id}),h(e)}function h(e){e&&(f+=e),++i<t.length?u(t[i],l):l&&l(f)}if(!a)return a={},void h();if("path"==a.type){var m=a.val;if(!m||m.indexOf("EPUB/css/kotobeeInteractive.css")>=0)return void h();var v=c(m,n.id);v?h(v.val):e.get(a.dontCache?m:cacheBust(m)).success(function(e){g(e,m,"url")}).error(function(){h()})}else g(a.val,a.root)}function p(e){var t=e;return t=t.replace(/\/\*(?:(?!\*\/)[\s\S])*\*\/|[\r\n\t]+/g,""),t=t.replace(/ {2,}/g," "),t=t.replace(/ ([{:}]) /g,"$1"),t=t.replace(/([;,]) /g,"$1"),t=t.replace(/ !/g,"!")}n||(n={});var f="";u(t[i=0],a)},s.applyRoot=function(e,t){var n=/url\((.*?)\)/g;return t.replace(n,function(t,n){var o="";return 0==n.indexOf('"')?(n=n.substr(1,n.length-2),o='"'):0==n.indexOf("'")&&(n=n.substr(1,n.length-2),o="'"),-1!=n.indexOf("http://")?arguments[0]:-1!=n.indexOf("https://")?arguments[0]:0==n.indexOf("data:")?arguments[0]:(n=ph.join(e,n),"url("+o+n+o+")")})},s.getStyles=function(){return a},s.replaceStyles=function(e,t){t||(t={});for(var n,o=document.getElementsByTagName("style"),r=0;r<o.length;r++)if(void 0!=o[r].getAttribute("kotobee")){n=o[r];break}a=e,t.append&&(a=n.innerHTML+" "+e),n=replaceHTML(n,a)},s.hideStyles=function(){removeClass(t.getOb("epubContainer"),"stylesEnabled")},s.showStyles=function(){addClass(t.getOb("epubContainer"),"stylesEnabled")},s.stylize=function(e,t){for(var n=document.getElementById(e),o=n.getAttribute("style"),r=Object.keys(t),i=o?o+";":"",a=0;a<r.length;a++)i+=r[a]+":"+t[r[a]]+";";n.setAttribute("style",i)},s}]),app.factory("design",["cssParser","$interpolate","stg","$http",function(e,t,n,o){var r,i,a={};return a.getBgStyle=function(){if(!r){var e="";isKotobeeHosted()&&(e=publicRoot),"stretch"==(r={"background-image":'url("'+(config.splashBg?e+"imgUser/"+config.splashBg:rootDir+"img/ui/defaultWelcomeBG.jpg")+'")',"background-color":config.splashBgColor?config.splashBgColor:"white",color:(config.splashColor?config.splashColor:"#000")+" !important","background-size":config.splashBgSize?config.splashBgSize:"cover"})["background-size"]&&(r["background-size"]="100% 100%")}return r},a.convertTabs=function(){if(config.tabs)for(var e=0;e<config.tabs.length;e++){var t=document.createElement("div");t.setAttribute("data-kotobee",config.tabs[e]),config.tabs[e]=kInteractive.readData(t)}},a.injectUserCSS=function(e){function n(){for(var n=document.getElementsByTagName("style"),o=0;o<n.length;o++)if(n[o].hasAttribute("user")){n[o].innerHTML=t(i)(e);break}}i?n():o.get(cacheBust(rootDir+"css/user.css")).success(function(e){i=e,n()})},a.stylize=function(t,n){e.stylize(t,n)},a}]),app.factory("error",["modals","translit","$injector","$location","$ionicHistory",function(e,t,n,o,r){var i={},a=[];return i.modal=null,i.update=function(s){var l,c=n.get("backend");if(s)switch(s.error){case"s_authError":"library"==config.kotobee.mode&&c.cloudParam("entry")?l={mode:"login",dynamic:!0,animation:"slide-in-up",loginOptions:{}}:(o.path("/login"),r.clearHistory());break;case"networkError":l={mode:"networkError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"localonlyError":l={mode:"localOnlyError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"errorAndCallback":l={mode:"generalError",errorOptions:{msg:t.get(s.msg),cb:s.cb}};break;default:l={mode:"generalError",errorOptions:{msg:t.get(s.error)}}}for(var d=0;d<a.length;d++)a[d].error==s.error&&a[d].func(l);l&&e.show(l)},i.retry=function(t){e.hide(),timeOut(function(){t.func.apply(null,t.args)},100)},i.detect=function(e,t){a.push({error:e,func:t})},i.removeDetection=function(e,t){for(var n=0;n<a.length;n++)if(t==a[n].func&&e==a[n].error)return void a.splice(n,1)},i}]),app.factory("initializer",["$rootScope","$injector","translit","autohide","scorm","workers","cssParser","tinCan","book","$location","chapters","error","modals","$ionicHistory","$ionicPlatform","crdv","cache","auth","design","stg","backend","settings",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m,v,b,y,k,w){function C(){document.onkeydown=function(t){"app"!=config.kotobee.mode&&document.activeElement&&"epubContainer"==document.activeElement.id&&(p.shown()||("37"==(t=t||window.event).keyCode?(y.data.settings.rtl?d.nextChapter():d.prevChapter(),e.$$phase||e.$apply()):"39"==t.keyCode&&(y.data.settings.rtl?d.prevChapter():d.nextChapter(),e.$$phase||e.$apply())))}}function x(){setTimeout(function(){ionic.tap.requiresNativeClick=function(e){return!(!ionic.Platform.isWindowsPhone()||"A"!=e.tagName&&"BUTTON"!=e.tagName&&!e.hasAttribute("ng-click")&&("INPUT"!=e.tagName||"button"!=e.type&&"submit"!=e.type))||(!!(!e||e.disabled||/^(file|range)$/i.test(e.type)||/^(object|video|audio)$/i.test(e.tagName)||ionic.tap.isLabelContainingFileInput(e))||ionic.tap.isElementTapDisabled(e))}},1e3)}function I(){window.addEventListener("message",function(e){var n=e.data.split(":");if("next"==n[0])d.nextChapter();else if("prev"==n[0])d.prevChapter();else if("notebook"==n[0])angular.element(document.getElementById("tabMenu")).scope().notebookClicked();else if("goto"==n[0])c.path(t.get("library").root+"/reader/chapter/"+Number(n[1]));else if("zoom"==n[0])for(var o=document.getElementsByTagName("meta"),r=0;r<o.length;r++)"viewport"==o[r].getAttribute("name")&&o[r].setAttribute("content","initial-scale="+n[1])},!1),window.kbOpenChapterURL=function(e){e&&(-1==e.indexOf(":/")&&(e=ph.join(y.data.book.chapter.url,e)),d.applyChapterStateFromURL(e))}}function E(){for(var e=0;e<M.length;e++)M[e].apply(this,arguments)}function T(e){var t=document.getElementById("iconDetector");if(preview&&-1!=window.location.href.indexOf("&screenshot"))return t.style.opacity=1,void(-1==window.location.href.indexOf("&startup")&&e&&e());O(t,function(){$||($=setTimeout(function(){t.style.opacity=1,e&&e()},8e3)),t.offsetWidth<10?setTimeout(function(){T(e)},1e3):(clearTimeout($),t.style.opacity=1,setTimeout(function(){e&&e()},1e3))})}function O(e,t){e.className="",setTimeout(function(){e.className="icon fa fa-cog fa-spin size16",setTimeout(t,400)},500)}function S(){if(B)for(;B.items.length;)B.removeAt(0);A()}function A(){function t(e){this.label.toLowerCase()==n.get("exit").toLowerCase()&&r.App.quit()}function o(e,t,n){return t&&(e.click=t),n&&(e.submenu=n),new r.MenuItem(e)}var r=require("nw.gui");B||(B=new r.Menu({type:"menubar"}));var i=new r.Menu;i.append(o({label:n.get("exit")},t)),B.append(o({label:n.get("file")},t,i));for(var a=new r.Menu,s=new r.Menu,l=y.data.languages,c=0;c<l.length;c++)s.append(o({label:l[c].label},function(t){var n=this.label;setTimeout(function(){for(var t=0;t<y.data.languages.length;t++)if(y.data.languages[t].label==n)return y.data.settings.language=y.data.languages[t].val,w.langChanged(),void(e.$$phase||e.$apply())},300)}));a.append(o({label:n.get("language")},t,s)),B.append(o({label:n.get("settings")},t,a)),r.Window.get().menu=B}var B,N,L={},M=[];L.preInitialize=function(e){e.putTest("preInitialize"),b.injectUserCSS(config);var t=L.getLogo();L.playAudio(),L.displayBg(),k.addListener("pathsChanged",L.playAudio),k.addListener("pathsChanged",L.displayBg);for(var a=document.getElementsByTagName("link"),l=0;l<a.length;l++)if("shortcut icon"==a[l].getAttribute("rel")){a[l].getAttribute("href")||a[l].setAttribute("href",config.icon?config.icon:t.logo);break}b.convertTabs(),e.putTest("preInitialize2"),m.initialize(),s.initialize(),i.initialize(),y.initialize(),r.initialize(),o.initialize(),y.initializeSettings(function(){w.langChanged(),e.putTest("preInitialize3"),I(),x(),desktop&&A(),native||C(),e.putTest("preInitialize4"),m.setOb("title",replaceHTML(m.getOb("title"),n.get("loading")+"..")),n.addListener(function(){desktop&&S(),N||y.data.book||y.data.book.meta||m.setOb("title",replaceHTML(m.getOb("title"),n.get("loading")+"..")),e.putTest("translit.addListener2"),N=!0}),e.putTest("preInitialize5"),config.kotobee.cloudid&&k.getS3Paths()})},L.displayBg=function(){b.stylize("home",b.getBgStyle())},L.playAudio=function(){if(config.audio&&!document.bgAudio){var e="";isKotobeeHosted()&&(e=publicRoot);var t=e+"imgUser/"+config.audio,n=document.createElement("audio");n.setAttribute("data-dontclose",!0),n.setAttribute("controls","true"),n.setAttribute("autoplay","true"),n.setAttribute("src",t),config.audioLoop&&n.setAttribute("loop","true"),n.setAttribute("data-tap-disabled","false");var o=document.createElement("source");o.src=t,n.appendChild(o),n.appendChild(document.createTextNode("Your browser does not support the audio element")),n.oncanplay=function(){kInteractive.tinCan({verb:"played",activity:"Audio: "+t})},n.play(),document.bgAudio=n}},L.getLogo=function(){var e="";return isKotobeeHosted()&&(e=publicRoot),{logo:config.logo?e+"imgUser/"+config.logo:rootDir+"img/ui/defaultWelcomeLogo.png",slogan:config.slogan?config.slogan:""}},L.addListener=function(e){M.push(e)},L.postInitialize=function(t){t.putTest("postInitialize start"),T(function(){t.putTest("postInitialize start2"),k.initialize(t).then(function(){if(t.putTest("MM"),t.$$phase||t.$apply(),"library"==config.kotobee.mode||e.readerApp){try{y.readSlot("downloaded"+y.getBookId(!0),function(e){y.data.downloaded=e,t.putTest("MMMM")})}catch(e){y.data.downloaded=[]}y.data.downloaded||(y.data.downloaded=[])}else"book"==config.kotobee.mode?(bookPath="epub/",preview&&(bookPath=config.kotobee.bookPath),bookPath||(bookPath="epub/")):"app"==config.kotobee.mode||(status.update(),u.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:h.exit}));v.authenticate(t)}),g.registerBackButtonAction(function(t){var n=f.currentView();"forgotPwd"==n.stateId?c.path("/login"):"register"==n.stateId?c.path("/login"):"library"==n.stateId&&e.readerApp?c.path("/app"):p.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){h.exit()}}}),e.$apply()},101),L.initialized=!0,E()})};var $;return L}]),app.factory("jsParser",["$http","cache",function(e,t){var n,o,r,i={},a=[];return i.clearCache=function(){a=[]},i.inject=function(t,o){function r(e){for(var t=0;t<a.length;t++)if(a[t].url==e)return a.push(a[t]),a[t]}function i(e){a.length>5&&a.shift(),a.push(e)}function s(o,a){function d(e){e&&c.push(e),u()}function u(){++n<t.length?s(t[n],a):(l(),a&&a(c))}if(o)if("code"==o.mode)c.push(o.val),u();else{var p=r(o.val);p?d(p.val):e.get(cacheBust(o.val)).success(function(e){i({url:o.val,val:e}),d(e)}).error(function(){d()})}else u()}function l(){for(var e=0;e<c.length;e++)if(c[e]){var t;c[e].indexOf("window.location.href")>=0&&(t=/window\.location\.href[\s]*?=(.*?)[;\n]/g,c[e]=c[e].replace(t,"try { kbOpenChapterURL($1); } catch(er){};")),c[e].indexOf("event.stopPropagation()")>=0&&(t=/event\.stopPropagation\(\)/g,c[e]=c[e].replace(t,"void(0)")),c[e].indexOf("<![CDATA[")>=0&&(t=/<!\[CDATA\[/g,c[e]=c[e].replace(t,"//<![CDATA["),t=/\]\]>/g,c[e]=c[e].replace(t,"//]]>"))}}var c=[];s(t[n=0],o)},i.getScript=function(){return o},i.replaceScript=function(e){if(o=e,r&&r.length)for(t=0;t<r.length;t++)r[t].parentNode&&r[t].parentNode.removeChild(r[t]);r=[];for(var t=0;t<e.length;t++){var n=document.createElement("script");n.setAttribute("kotobee",""),n.setAttribute("type","text/javascript"),n.innerHTML=e[t],r.push(n);try{document.head.appendChild(n)}catch(e){}try{document.dispatchEvent(new Event("DOMContentLoaded"))}catch(e){}}},i}]),app.factory("library",["stg","translit","cache","$rootScope","backend","crdv",function(e,t,n,o,r,i){function a(e){e||(e={}),d.maxResults=e.large?40:20}function s(e){e||(e={}),d.maxResults+=e.large?20:6}function l(){for(var e=0;e<u.length;e++)u[e].apply(this,arguments)}var c,d={},u=[];return d.sortMethod={},d.root="",d.initialize=function(){d.setBrowserTitle(),a(),u=[],l("initialized")},d.setMax=function(e){d.maxResults=e},d.setBrowserTitle=function(){n.setOb("title",replaceHTML(n.getOb("title"),e.data.currentLibrary.name?e.data.currentLibrary.name:t.get("library")))},d.addListener=function(e){u.push(e)},d.getEbooks=function(t,n){function o(n){try{t.favs?e.data.favorites=n:e.data.currentLibrary.books=n}catch(e){}}t||(t={}),c=Math.round(1e5*Math.random()),l("preload",t),t.accumulated||addClass(document.getElementById("libraryThumbs"),"dim"),t.more?s(t.contentkey?{large:!0}:{}):a(t.contentkey?{large:!0}:{}),t.sort=d.sortMethod.data,t.sortDir=d.sortMethod.dir,t.max=d.maxResults,r.getEbooks(t,c,function(r,a){if(a==c){removeClass(document.getElementById("libraryThumbs"),"dim"),r.error||(i.applyExistingBooks(r),o(r));var s=t.favs?e.data.favorites:e.data.currentLibrary.books;s&&s.length||(r.empty=!0),l("postload",t,r),n&&n(r)}})},d}]),app.factory("markers",["$rootScope","error","cache","stg","$location","$injector","$ionicScrollDelegate",function(e,t,n,o,r,i,a){function s(){return!(r.path()&&r.path().indexOf("/reader")>=0)}var l={},c=new Array,d={};return l.addMarker=function(e){c.push(e),l.refreshMarker(e)},l.deleteMarker=function(e){for(var t=0;t<c.length;t++)c[t].id==e&&c.splice(t,1)},l.windowResize=function(){s()||d.width==window.innerWidth&&d.height==window.innerHeight||(l.refreshMarkers(),d.width=window.innerWidth,d.height=window.innerHeight)},l.refreshMarkers=function(){for(var e=0;e<c.length;e++)l.refreshMarker(c[e])},l.refreshMarkerById=function(e){for(var t=0;t<c.length;t++)if(c[t].id==e)return void l.refreshMarker(c[t])},l.getMarker=function(e){for(var t=0;t<c.length;t++)if(c[t].id==e)return c[t]},l.refreshMarker=function(e){var t=e.target();if(t&&e.elem){var r="",a="page";(hasClass(e.elem,"contentSideNoteMarker")||hasClass(e.elem,"contentBookMarker"))&&(a="side");var s=n.getOb("epubContainer").getElementsByClassName("scroll")[0],l=n.getOb("epubContent");if(s){var c=t.getBoundingClientRect(),d=s.getBoundingClientRect(),u=l.getBoundingClientRect(),p=getElemPadding(n.getOb("epubContainer")),f=0,g=0,h=1;f=s.scrollTop,g=s.scrollLeft;var m=i.get("nav");o.data.book.chapter.viewport&&(h=m.getFxlScale());var v,b,y,k=(c.top+f-(d.top+0))/h;if("side"==a){v=0;var w=Number(p.left)+(u.left-d.left+g),C=d.right-u.right+g;(y=o.data.book.chapter.viewport?w:w<C?w:C)<30&&(y=30),o.data.settings.rtl&&(b=0,v=null),v-=w}else{if(0==e.elem.offsetWidth)return;v=(c.left+g-d.left)/h}null!=k&&(r+="top: "+(k+e.offsetTop)+"px; "),null!=v&&(r+="left: "+(v+e.offsetLeft)+"px; "),null!=b&&(r+="right: "+(b-e.offsetLeft)+"px; "),null!=y&&(r+="width: "+y+"px; ");var x=1/h;""!=(r+="transform:scale("+x+");-webkit-transform:scale("+x+");-moz-transform:scale("+x+");")&&(e.elem.style.cssText=r),e.callback&&e.callback()}}},l.show=function(){for(var e=0;e<c.length;e++)c[e].elem.style.visibility="shown"},l.hide=function(){for(var e=0;e<c.length;e++)c[e].elem.style.visibility="hidden"},window.addEventListener("resize",l.windowResize,!0),l}]),app.factory("media",["$ionicModal","tinCan","$rootScope","modals",function(e,t,n,o){var r={};return r.show=function(e){t.send({verb:"viewed image",activity:e.title?e.title:e.thumbnail}),o.show({mode:"image",dynamic:!0,animation:"slide-in-up",image:e})},r.hide=function(){o.hide()},r}]),app.factory("modals",["$ionicModal","$q","$injector","$ionicPlatform","$rootScope",function(e,t,n,o,r){function i(){if(l=null,u.length){var e=u[0];e&&((l=e).hidden?i():(p.backdropClickToClose=!!e.backdropClickToClose&&e.backdropClickToClose,p.animation=e.animation?e.animation:"zoom-in",f().then(function(){s.modal=e,a&&(a.show(),s.$$phase||s.$apply(),l.timeLimit&&(c=setTimeout(function(){var e=l;d.hide(l);var t={wait:function(){d.hide(),d.show(e)}};d.show({mode:"waitTimeout",timeoutOptions:t})},l.timeLimit)),setTimeout(function(){e.cb&&e.cb(a)},750))})))}}var a,s,l,c,d={},u=[],p={animation:"zoom-in",focusFirstInput:!1,backdropClickToClose:!1};d.setScope=function(e){function t(){for(var e=document.getElementsByClassName("modal-backdrop"),t=e.length;t--;)hasClass(e[t],"hide")&&e[t].parentNode.removeChild(e[t])}(s=e).hideModal=d.hide,a||f(),s.$on("modal.hidden",function(e){c&&clearTimeout(c),setTimeout(function(){u.shift(),i(),t()},500)})};var f=function(){var n=t.defer(),o=clone(p);return o.scope=s,e.fromTemplateUrl(kTemplate("modals/modals.html"),o).then(function(e){a=e,n.resolve()}),n.promise};return d.show=function(e){if(a)return u.push(e),q=u,1==u.length&&i(),e;f().then(function(){d.show(e)})},d.obShown=function(e){return l==e},d.shown=function(){return!!a&&a.isShown()},d.hide=function(e,t){a&&(e?l==e?(a.hide(),native&&n.get("crdv").hideKeyboard()):e.hidden=!0:(a.hide(),native&&n.get("crdv").hideKeyboard()),t&&t())},d}]),app.factory("nav",["cache","crdv","$ionicGesture","$location","$rootScope","$ionicSideMenuDelegate","selection","markers","settings","$timeout","chapters","$ionicScrollDelegate","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p){function f(e,t){for(var n=0;n<M.length;n++)M[n].event==e&&M[n].func(t)}function g(t){if("newChapter"==t){var n=e.getOb("epubContainer"),o=e.getOb("epubContent");if($=u.$getByHandle("content"),mobile){var r=$.getScrollView().options;if(r.scrollbarFadeDelay=0,r.scrollingY=!0,r.minZoom=.2,r.maxZoom=3.5,r.zooming=!0,p.data.book.chapter.viewport){r.deceleration=.85,r.scrollingX=!0,r.scrollbarY=!1,$.scrollTo(0,0,!1);try{A.getFxlFit(null,"from setChapterLayout").bestFit}catch(e){}A.fxlZoomFit({noAnim:!0,immediateScrollRefresh:!0})}else n.style.marginLeft=null,n.style.paddingLeft=null,n.style.paddingTop=null,$.scrollTo(0,0,!1),r.zooming&&$.zoomTo(1,!1,0,0),r.deceleration=.95,r.scrollbarY=!0,config.textSizeControls||(r.zooming=!1),setTimeout(function(){r.scrollingX=!1,config.textSizeControls||(r.zooming=!1)},500);setTimeout(s.refreshMarkers,1e3)}else{$.scrollTop(!1);if(p.data.book.chapter.viewport)$.scrollTo(0,0,!1),A.fxlZoomFit({noAnim:!0,immediateScrollRefresh:!0});else{n.style.marginLeft=null,n.style.paddingLeft=null,n.style.paddingTop=null,$.scrollTo(0,0,!1),w(1,{noAnim:!0}),deleteTransform(o),deleteTransformOrigin(o);var i=document.getElementById("spreadR");i&&i.parentNode.removeChild(i)}}var a=n.getElementsByClassName("scroll");a.length&&(removeClass(a[0],"afterDelay"),setTimeout(function(){addClass(a[0],"afterDelay")},2e3))}}function h(){var e=L.width>=1300;r.widescreen!=e&&(f("widescreenChanged"),r.widescreen=e),e?addClass(document.body,"widescreen"):removeClass(document.body,"widescreen"),r.$$phase||r.$apply()}function m(t){if(mobile){var n=e.getOb("epubContainer");"margin"==t?(n.style.paddingLeft&&(n.style.setProperty("margin-left",n.style.paddingLeft,"important"),n.style.paddingLeft=null),n.style.paddingTop&&(n.style.setProperty("margin-top",n.style.paddingTop,"important"),n.style.paddingTop=null)):(n.style.marginLeft&&(n.style.setProperty("padding-left",n.style.marginLeft,"important"),n.style.marginLeft=null),n.style.marginTop&&(n.style.setProperty("padding-top",n.style.marginTop,"important"),n.style.marginTop=null))}}function v(e,t){if(mobile){e||(e=A.getFxlScale());var n=A.getFxlFit(null,"from fxlRefreshHorizontalVerticalScrolling"),o=$.getScrollView().options;e*n.widthFit<=n.widthFit?o.scrollingX=!1:o.scrollingX=!0,e*n.widthFit<=n.heightFit?o.scrollingY=!1:o.scrollingY=!0}}function b(e){if(!(O()||mobile&&x())){var t=p.data.book.chapter.viewport?1:.8,n=p.data.book.chapter.viewport?100:70;if(!(Math.abs(e.gesture.velocityX)<t||Math.abs(e.gesture.distance)<n||e.gesture.touches.length>1))return!0}}function y(){return!(o.path()&&o.path().indexOf("/reader")>=0)}function k(t){t||(t=e.getOb("epubContainer").getElementsByClassName("scroll")).length&&(t=t[0]),t&&deleteTransformOrigin(t)}function w(t,n){n||(n={});n.noAnim;var o=e.getOb("epubContainer").children[0];I(o)!="scale("+t+")"&&(E(o,"scale("+t+")"),T(o,t>1?"none":null),n.noAnim&&(o.style.transition="initial"),setTimeout(function(){n.noAnim&&(o.style.transition=null),redrawForChrome(document.body)},500),setTimeout(s.refreshMarkers,1e3),t>1.1?addClass(e.getOb("epubContainer"),"zoomed"):removeClass(e.getOb("epubContainer"),"zoomed"))}function C(){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.msFullscreenElement)return document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozExitFullscreen?document.mozExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),!0}function x(){var e=document.getElementById("readerBody").style.transform||document.getElementById("readerBody").style.webkitTransform;if(e&&"translate3d(0px, 0px, 0px)"!=e&&"translate3d(0px, 0, 0)"!=e)return!0}function I(e){return e.style.webkitTransform||e.style.mozTransform||e.style.transform}function E(e,t){autoprefixTransform(e,t)}function T(e,t){e.style.perspective=e.style.msPerspective=e.style.webkitPerspective=e.style.mozPerspective=t}function O(){return N>B}var S,A={},B=15,N=0,L={},M=[];A.init=function(e){mobile&&(n.on("swipeleft",A.swipeLeft,e),n.on("swiperight",A.swipeRight,e)),n.on("dragstart",A.dragStart,e),n.on("drag",A.drag,e),n.on("tap",A.tap,e),n.on("doubletap",A.fxlToggleTapZoom,e),n.on("transformstart",A.transformstart,e),n.on("transformend",A.transformend,e),S||(window.addEventListener("resize",A.windowResize,!0),L.width=window.innerWidth,L.height=window.innerHeight,mobile||h(),d.addListener(g),S=!0,A.addListener("widescreenChanged",function(){setTimeout(A.fxlZoomFit,400)}),document.body.addEventListener("keyup",function(e){27==e.keyCode&&C()}))},A.addListener=function(e,t){M.push({event:e,func:t})};var $;A.windowResize=function(){y()||L.width==window.innerWidth&&L.height==window.innerHeight||(A.fxlZoomFit(),L.width=window.innerWidth,L.height=window.innerHeight,mobile||h(),d.regenerateSpreads({resize:!0}))},A.getScroller=function(){return $};var P,H;return A.transformstart=function(){A.transforming=!0,p.data.book.chapter.viewport&&(k(),P=(new Date).getTime(),H=A.getFxlScale(),m("margin"))},A.transformend=function(){if(A.transforming=!1,!y())if(p.data.book.chapter.viewport){var t=(new Date).getTime(),n=A.getFxlScale();if(mobile&&n<H&&t-P<800)return void A.fxlZoomFit();var o=A.getFxlFit(null,"from transformend").bestFit;n<o?(u.$getByHandle("content").zoomTo(o,!0),n=o):n>3&&(u.$getByHandle("content").zoomTo(3,!0),n=o),v(3),setTimeout(s.refreshMarkers,1e3),A.repaint()}else{if(!config.textSizeControls)return;var r=$.getScrollPosition().zoom,i=l.getTextSize(),a=Math.round(r*i*10)/10;a<.2&&(a=.2),p.data.settings.textSize=a+"em",l.updateTextSize(),l.writeTextSize(),$.zoomTo(1,!0);var c=angular.element(e.getOb("epubContent")).scope();c.header.mode="textSize",c.$$phase||c.$apply(),setTimeout(s.refreshMarkers,1e3)}},A.repaint=function(){redrawForChrome(e.getOb("epubContent"))},A.resize=function(){$.resize()},A.swipeRight=function(n){if(!y()&&b(n))if($.resize(),native&&t.vibrate(),"chapter"!=swipeMode){var o=u.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)d.prevChapter();else if(o.getScrollPosition().top<=10)d.prevChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),c(function(){o.scrollBy(0,-o.getScrollView().__clientHeight)},200),c(function(){removeClass(r,"fadeOut")},300)}}else p.data.settings.rtl?d.nextChapter():d.prevChapter()},A.swipeLeft=function(n){if(!y()&&b(n))if($.resize(),native&&t.vibrate(),"chapter"!=swipeMode){var o=u.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)d.nextChapter();else if(o.getScrollPosition().top>=o.getScrollView().__contentHeight-o.getScrollView().__clientHeight-30)d.nextChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),c(function(){o.scrollBy(0,o.getScrollView().__clientHeight)},200),c(function(){removeClass(r,"fadeOut")},300)}}else p.data.settings.rtl?d.prevChapter():d.nextChapter()},A.dragStart=function(){y()||(p.data.book.chapter.viewport||$.zoomTo(1,!1),N=0,$.freezeScroll(!1))},A.drag=function(e){N++},A.tap=function(e){f("tap",e)},A.fxlToggleTapZoom=function(t){if(e.getOb("epubContent")&&p.data.book.chapter.viewport&&p.data.book.chapter.viewport.width){var n=A.getFxlScale(),o=A.getFxlFit(null,"from fxlToggleTapZoom").bestFit,r=$.getScrollView().options.minZoom;if(null==r&&(r=n-1),Math.round(100*n)!=Math.round(100*o)&&n>r)A.fxlZoomFit(t);else{var i=2*A.getFxlFit(null,"from fxlToggleTapZoom").bestFit;mobile?u.$getByHandle("content").zoomTo(i,!0,t.gesture.center.pageX,t.gesture.center.pageY):w(i),a.reset(),m("margin"),v(i)}setTimeout(s.refreshMarkers,1e3),setTimeout(A.repaint,1e3)}},A.fxlZoomIn=function(t){a.reset();var n=1.2*A.getFxlScale(),o=A.getFxlFit(null,"from fxlZoomIn");o.bestFit;n>3&&(n=3);var r=u.$getByHandle("content");mobile?r.zoomTo(n,!0):w(n),m("margin");var i=e.getOb("epubContent"),l=document.getElementById("readerBody");if(n>=1);else if("vertical"==o.bestFitType){var c=getElemMargin(i).x,d=getElemPadding(i).x;"auto"==c&&(c=0),"auto"==d&&(d=0),c||(c=0),d||(d=0);c=(l.getBoundingClientRect().width-d-p.data.book.chapter.viewport*n)/2;i.style.setProperty("margin-left",Math.round(c/n)+"px","important"),i.style.setProperty("margin-right",Math.round(c/n)+"px","important")}else i.style.marginLeft&&(i.style.marginLeft=i.style.marginRight=null);v(n),setTimeout(s.refreshMarkers,1e3)},A.fxlZoomOut=function(e){a.reset();var t=.8*A.getFxlScale(),n=A.getFxlFit(null,"from fxlZoomOut").bestFit;t<n&&(t=n),mobile?u.$getByHandle("content").zoomTo(t,!0):w(t),m("margin"),v(t),setTimeout(s.refreshMarkers,1e3)},A.fxlZoomFit=function(t){if(t||(t={}),e.getOb("epubContent")&&p.data.book.chapter.viewport&&p.data.book.chapter.viewport.width){a.reset();var n=A.getFxlFit(null,"from fxlZoomFit"),o=t.noAnim;mobile?$.zoomTo(n.bestFit,!o):w(n.bestFit,{noAnim:o}),A.fxlAdjustAlignment(),m("padding"),v(n.bestFit),setTimeout(s.refreshMarkers,1e3)}},A.fxlAdjustAlignment=function(t){t||(t={}),t.epubContent||(t.epubContent=e.getOb("epubContent")),t.epubContainer||(t.epubContainer=e.getOb("epubContainer"));var n=A.getFxlFit(t,"from fxlAdjustAlignment"),o=getElemMargin(t.epubContent,{computed:!0});"auto"==o.left&&(o.left=0),"auto"==o.top&&(o.top=0),autoprefixTransform(t.epubContent,"scale("+n.widthFit+")"),autoprefixTransformOrigin(t.epubContent,-o.left+"px "+-o.top+"px"),t.epubContainer.style.marginLeft=t.epubContainer.style.marginRight=null,t.epubContainer.style.paddingLeft=t.epubContainer.style.paddingRight=null,t.epubContainer.style.setProperty(p.data.settings.rtl?"padding-right":"padding-left",n.marginLeft+"px","important"),t.epubContainer.style.setProperty("padding-top",n.marginTop+"px","important")},A.getSpreadHeight=function(e){for(var t=0,n=0;n<e.children.length;n++){var o=e.children[n];o.id&&0==o.id.indexOf("spread")&&(t=Math.max(t,Number(o.style.height.split("px")[0])))}return t},A.getSpreadWidth=function(e){for(var t=0,n=0;n<e.children.length;n++){var o=e.children[n];o.id&&0==o.id.indexOf("spread")&&(t+=Number(o.style.width.split("px")[0]))}return t},A.viewFromElem=function(e){var t={};t.maxHeight=0,t.totalWidth=0;for(var n=0;n<e.children.length;n++){var o=e.children[n];if(o.id&&0==o.id.indexOf("spread")){var r=Number(o.style.height.split("px")[0]),i=Number(o.style.width.split("px")[0]),a={width:i,height:r};"spreadL"==o.id?(t.leftOb||(t.leftOb={}),t.leftOb.viewport=a,t.leftOb.layout=hasClass(o,"fxl")?"fxl":"rfl",t.layout=t.leftOb.layout):"spreadR"==o.id&&(t.view="double",t.rightOb||(t.rightOb={}),t.rightOb.left=Number(o.style.left.split("px")[0]),t.rightOb.viewport=a,t.rightOb.layout=hasClass(o,"fxl")?"fxl":"rfl"),t.maxHeight=Math.max(r,t.maxHeight),t.totalWidth+=i}}return t.leftOb&&t.rightOb&&t.rightOb.left&&(t.totalWidth+=t.rightOb.left-t.leftOb.viewport.width),t},A.getFxlFit=function(t,n){t||(t={}),t.viewport||(t.viewport=p.data.book.chapter.viewport);var o={};t.epubContent||(t.epubContent=e.getOb("epubContent"));var r=t.view;r||(r=p.data.currentView);var i={x:0};t.epubContainer||(t.epubContainer=e.getOb("epubContainer"));var a=t.epubContainer.getElementsByClassName("scroll");a.length&&(i=getElemPadding(a[0],{computed:!0}),o.scrollContainer=a[0]),"auto"==i.x&&(i.x=0),"auto"==i.y&&(i.y=0);var s=getElemMargin(t.epubContent,{computed:!0}),l=getElemPadding(t.epubContent,{computed:!0}),c=s.x,d=s.y;"auto"==c&&(c=0),"auto"==d&&(d=0);var u=l.x,f=l.y;"auto"==u&&(u=0),"auto"==f&&(f=0);var g=t.viewport.width+c,h=t.viewport.height+d;if("double"==r){var m=A.viewFromElem(t.epubContent);g=m.totalWidth,h=m.maxHeight}var v=document.getElementById("readerBody"),b=document.getElementById("readerHeader"),y=document.getElementById("tabMenu"),k=v.getBoundingClientRect().width,w=v.getBoundingClientRect().height;mobile&&"alwaysShow"!=config.autohideReaderMode&&"showOnScroll"!=config.autohideReaderMode&&"showOnTap"!=config.autohideReaderMode||(w-=b.getBoundingClientRect().height+y.getBoundingClientRect().height),t.includeScrollPadding||(k-=i.x,w-=i.y);var C=k/g,x=w/h;if(o.readerWidth=k,o.readerHeight=w,o.widthFit=C,o.heightFit=x,config.fitToScreen)o.bestFit=x<C?x:C,o.bestFitType=x<C?"vertical":"horizontal";else{var I=C;I>=1&&(I=1);var E=x/I;o.bestFitType="vertical",E<1&&E>=.7&&(I=x,o.bestFitType="vertical"),o.bestFit=I}return o.bestFit=o.bestFit/o.widthFit,o.innerWidth=g,o.innerHeight=h,o.outerWidth=k,o.outerHeight=w,o.marginLeft=Math.round((o.outerWidth-o.widthFit*o.bestFit*o.innerWidth)/2),o.marginTop=Math.round((o.outerHeight-o.widthFit*o.bestFit*o.innerHeight)/2),o.marginTop<0&&(o.marginTop=0),o},A.getFxlScale=function(){if(mobile)return u.$getByHandle("content").getScrollPosition().zoom;var t=I(e.getOb("epubContainer").children[0]);if(!t)return 1;if(""==t)return 1;var n=t.split("scale");if(n.length<=1)return 1;var o=n[1].split("(");if(o.length<=1)return 1;var r=o[1].split(")");return Number(r[0])},A.fullscreen=function(){var e=document.body;C()||(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen())},A}]),app.factory("np",["stg","status","error","translit","$rootScope","crdv","modals","$http","$ionicSideMenuDelegate",function(e,t,n,o,r,i,a,s,l){var c,d,u,p,f,g,h,m,v,b,y,k,w,C={};return C.init=function(e){desktop?(p=require("nw.gui"),f=require("child_process").exec,g=p.Window.get(),h=process.cwd(),v=(process.env.HOME||process.env.USERPROFILE)+"/Desktop",m=require("path").dirname(process.execPath),w=m+"/node_modules/","mac"==os&&(w=""),r.readerApp&&(w=""),w="",c=require(w+"fs.extra"),d=require(w+"async"),u=require(w+"buckle"),b=p.App.dataPath,y=b+"/temp",k=b+"/Books",C.createIfNotExists(k),C.createIfNotExists(y),g.removeAllListeners(),g.on("close",function(){C.exit()}),e&&e()):e()},C.createIfNotExists=function(e,t){desktop&&c.exists(e,function(n){n?t&&t():C.createIfNotExists(ph.parent(e),function(){c.mkdirSync(e),t&&t()})})},C.createIfNoParentsExists=function(e,t){desktop&&c.exists(e,function(n){n?t&&t():C.createIfNoParentsExists(ph.parent(e),function(){c.mkdirSync(e),t&&t()})})},C.writeEbook=function(t,n,o,r){desktop&&C.createTempDir(function(t){var a=new FileReader;a.onload=function(){var o=ph.join(t,"book.zip");"mac"==os&&(o=t+"/book.zip"),c.writeFileSync(o,Buffer.from(new Uint8Array(a.result)));var s=ph.join(k,n.path);"mac"==os&&(s=k+"/"+n.path),C.extractZip(o,s,function(){n.exists=!0,e.data.downloaded.push(n),i.applyExistingBooks(e.data.currentLibrary.books),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){C.removeDirectory(t,function(){r&&r()})})})},a.readAsArrayBuffer(o)})},C.deleteEbook=function(t,n){C.removeDirectory(ph.join(k,t.path),function(){for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].path==t.path&&(t.exists=!1,e.data.downloaded.splice(o,1),o--);e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){n&&n()})})},C.fileExists=function(e,t){c.exists(e,function(e){t(e)})},C.removeFile=function(e,t){C.removeDirectory(e,t)},C.removeDirectory=function(e,t){c.rmrf(e,function(e){t&&t(e)})},C.extractZip=function(e,t,n){u.open(e,t,function(){c.readdir(t,n)})},C.createTempDir=function(e){var t=y+"/f"+randStr(5);C.fileExists(t,function(n){n?C.createTempDir(e):c.mkdir(t,function(){e(t)})})},C.openLink=function(e){p.Shell.openExternal(e)},C.getBooksPath=function(){return k+"/"},C.writeArrayBuffer=function(e,t,n,o){var r=arrayBufferToBuffer(e);c.open(t,"w",function(e,t){if(e)throw"error opening file: "+e;c.write(t,r,0,r.length,null,function(e){e?o&&o(!1):c.close(t,function(){o&&o(!0)})})})},C.copy=function(e,t,n,o){if(n||(n={}),n.replace)for(var r=0;r<n.replace.length;r++)e=e.replace(n.replace[r].key,n.replace[r].val);n.header&&(e=n.header+e),n.footer&&(e+=n.footer),n.encoding||(n.encoding="ascii"),e=(e+="").replace(/\xA0/g," "),e=utf8Encode(e),c.writeFile(t,e,n.encoding,function(t,n){o&&o(e)})},C.exit=function(){e.getActions(function(e){if(e&&e.length){a.hide();var t={title:"confirmation",msg:"annotationsSyncExitWarning",barStyle:"bar-dark"},n={label:"delete",style:"button-assertive"};n.func=function(){p.App.quit()};var o={label:"cancel"};o.func=function(){a.hide()},t.btns=[n,o],a.show({mode:"confirm",confirmOptions:t})}else p.App.quit()})},C}]),app.factory("popovers",["$ionicPopover","$q","$rootScope",function(e,t,n){function o(){if(0!=s.length){var e=s.shift();e.apply?i.$apply(function(){i.popover=e}):i.popover=e,r&&(r.isShown()||r.show(e.event))}}var r,i,a={},s=[];a.setScope=function(e){i=e,r||l()};var l=function(){var o=t.defer();return i||(i=n),e.fromTemplateUrl(kTemplate("modals/popovers.html"),{scope:i}).then(function(e){r=e,o.resolve()}),o.promise};return a.show=function(e){r?(s.push(e),1==s.length&&o()):l().then(function(){a.show(e)})},a.shown=function(){return!!r&&r.isShown()},a.hide=function(){r&&(i.popover=null,r&&r.hide(),o())},a}]),app.factory("scorm",["scormWrapper",function(e){function t(e){var t=e.getSeconds();t<10&&(t="0"+t);var n=e.getMinutes();n<10&&(n="0"+n);var o=e.getHours();return o<10&&(o="0"+o),o+":"+n+":"+t}function n(e){var t=e.toISOString().split(".");return t.splice(t.length-1,1),t.join(".")}function o(e){var t=Math.floor(e/3600);e-=60*t*60;var n=Math.floor(e/60);return(e-=60*n)<10&&(e="0"+e),t<10&&(t="0"+t),n<10&&(n="0"+n),t+":"+n+":"+e}function r(e){var t=e,n=Math.floor(t/31104e3);t=e-31104e3*n;var o=Math.floor(t/2592e3);t=e-2592e3*o;var r=Math.floor(t/86400);t=e-86400*r;var i=Math.floor(t/3600);t=e-3600*i;var a=Math.floor(t/60);return"P"+n+"Y"+o+"M"+r+"DT"+i+"H"+a+"M"+(t=e-60*a)+"S"}function i(){if(p.length){for(var e=Number(l("cmi.objectives._count")),t={},n=0;n<p.length;n++)t[p[n].qid]=p[n];for(n=0;n<e;n++){var o=l("cmi.objectives."+n+".id");if(o){i=0;for(var r in t)t[r].objective==o&&(i+=t[r].scoreMax);g.setObjective({id:o,scoreMax:i},!0),g.setObjective({id:o,scoreRaw:0},!0)}}var i=0;for(var r in t)i+=t[r].scoreMax;c(1.2==f?"cmi.core.score.max":"cmi.score.max",i),c(1.2==f?"cmi.core.score.min":"cmi.score.min",0),c(1.2==f?"cmi.core.score.raw":"cmi.score.raw",0);for(var a=0;a<p.length;a++){for(var d=p[a],u=null,h=null,n=0;n<e;n++)d.objective==s("cmi.objectives",n,"id")&&(u=d.objective,h=n);if(u){var m=Number(l("cmi.objectives."+h+".score.raw"));m||(m=0);var v={};v.id=u,v.scoreRaw=d.result*d.weighting+m,v.scoreMin=0,v.scoreScaled=v.scoreRaw/v.scoreMax,v.completionStatus="unknown",v.successStatus="unknown",g.setObjective(v,!0)}var b=Number(l(1.2==f?"cmi.core.score.raw":"cmi.score.raw"));b||(b=0),c(1.2==f?"cmi.core.score.raw":"cmi.score.raw",d.result*d.weighting+b)}}}function a(){e.doLMSCommit("")}function s(e,t,n){var o=l(e+"."+t+"."+n);return o&&""!=o||(o=l(e+"_"+t+"."+n)),o}function l(t){return e.doLMSGetValue(t)}function c(t,n){return e.doLMSSetValue(t,n)}function d(){try{var e=l("cmi.suspend_data");return JSON.parse(e)}catch(e){return[]}}function u(e){try{c("cmi.suspend_data",JSON.stringify(e))}catch(e){}}var p,f,g={};return g.initialize=function(){if(!(config.v<1.2)){kInteractive.scorm=this;try{if(!scormEnabled)return}catch(e){return}e.doLMSInitialize(""),1.2==(f=e.getAPIVersion())?"not attempted"==l("cmi.core.lesson_status")&&(c("cmi.core.lesson_status","browsed"),a()):"not attempted"==l("cmi.completion_status")&&(c("cmi.completion_status","unknown"),a()),p=d();try{for(var t=0;t<config.scorm.objectives.length;t++){var n=Number(l("cmi.objectives._count"));n||(n=0);for(var o=n,r=config.scorm.objectives[t],i=0;i<n;i++)s("cmi.objectives",i,"id")==r.id&&(o=i);c("cmi.objectives."+o+".id",r.id),1.2!=f&&c("cmi.objectives."+o+".description",r.name)}}catch(e){}a()}},g.setBookmark=function(e,t){try{if(!scormEnabled)return}catch(e){return}c(1.2==f?"cmi.core.lesson_location":"cmi.location",e),t||a()},g.getBookmark=function(){try{if(!scormEnabled)return}catch(e){return}return l(1.2==f?"cmi.core.lesson_location":"cmi.location")},g.setInteractions=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=0;t<e.length;t++){for(var n=p.length,o=0;o<p.length;o++)p[o].id==e[t].id&&(n=o);p[n]=e[t],g.setInteraction(n,e[t],!0)}i(),u(p),a()},g.setInteraction=function(e,i,s){try{if(!scormEnabled)return}catch(e){return}i.id&&c("cmi.interactions."+e+".id",i.id),i.result&&c("cmi.interactions."+e+".result",i.result),i.correctResponses&&c("cmi.interactions."+e+".correct_responses.0.pattern",i.correctResponses),i.type&&c("cmi.interactions."+e+".type",i.type),i.weighting&&c("cmi.interactions."+e+".weighting",i.weighting),i.objective&&c("cmi.interactions."+e+".objectives.0.id",i.objective),1.2==f?(i.timestamp&&c("cmi.interactions."+e+".time",t(i.timestamp)),i.latency&&c("cmi.interactions."+e+".latency",o(i.latency)),i.learnerResponses&&c("cmi.interactions."+e+".student_response",i.learnerResponses)):(i.timestamp&&c("cmi.interactions."+e+".timestamp",n(i.timestamp)),i.latency&&c("cmi.interactions."+e+".latency",r(i.latency)),i.learnerResponses&&c("cmi.interactions."+e+".learner_responses",i.learnerResponses),i.description&&c("cmi.interactions."+e+".description",i.description)),s||a()},g.setObjective=function(e,t){try{if(!scormEnabled)return}catch(e){return}for(var n=Number(l("cmi.objectives._count")),o=n,r=0;r<n;r++)s("cmi.objectives",r,"id")==e.id&&(o=r);null!=e.id&&c("cmi.objectives."+o+".id",e.id),null!=e.scoreRaw&&c("cmi.objectives."+o+".score.raw",e.scoreRaw),null!=e.scoreMin&&c("cmi.objectives."+o+".score.min",e.scoreMin),null!=e.scoreMax&&c("cmi.objectives."+o+".score.max",e.scoreMax),1.2==f?null!=e.successStatus&&c("cmi.objectives."+o+".status",e.successStatus):(null!=e.description&&c("cmi.objectives."+o+".description",e.description),null!=e.successStatus&&c("cmi.objectives."+o+".success_status",e.successStatus),null!=e.completionStatus&&c("cmi.objectives."+o+".completion_status",e.completionStatus),null!=e.scoreScaled&&c("cmi.objectives."+o+".score.scaled",e.scoreScaled)),t||a()},g.interactionExistsOld=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=Number(l("cmi.interactions._count")),n=0;n<t;n++)if(s("cmi.interactions",n,"id")==e)return!0},g.interactionExists=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=0;t<p.length;t++)if(p[t].id==e)return!0},g.objectiveExists=function(e){try{if(!scormEnabled)return}catch(e){return}for(var t=Number(l("cmi.objectives._count")),n=0;n<t;n++)if(s("cmi.objectives",n,"id")==e)return!0},g}]),app.factory("search",["$http","error","book","$rootScope","modals","status","$location","chapters","cache","$timeout","$filter","translit","virt","selection","stg",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){function h(e,t,n,o){function r(e){for(var o=e,r=f.convertElemsToLocation([o],t).left,i='<span class="searchItem">'+o.textContent+"</span>",a=(i.toLowerCase().indexOf(y.key.toLowerCase()),i.length+Math.round((70-i.length)/2));;){if(!o.previousSibling)break;if(i.length>=a)break;o.previousSibling.textContent&&(i=o.previousSibling.textContent+i),o=o.previousSibling}i.length;for(o=e;;){if(!o.nextSibling)break;if(i.length>=70)break;o.nextSibling.textContent&&(i+=o.nextSibling.textContent),o=o.nextSibling}y.result[n].matches.push({chapter:n,elem:e,hint:i.trim(),location:r})}function i(e){return(e.textContent.toLowerCase().match(new RegExp(y.key.toLowerCase(),"g"))||[]).length}if(0!=e.children.length){for(var a=0;a<e.children.length;a++)0!=i(e.children[a])&&(o=!1,hasClass(e.children[a],"k-section")&&p.checkIfRequiresParse(e.children[a]),h(e.children[a],t,n,!0));o&&r(e)}else i(e)>0&&r(e)}function m(e,t){var n=0;e.start&&(n=e.start);var o=v(),r=function(i){e.limit&&v()-o>=e.limit?t({results:y.result,more:!0,key:y.key}):i?b(n++,r):t({results:y.result,key:y.key})};b(n,r)}function v(){for(var e=0,t=y.result.length;t--;)if(y.result[t])for(var n=y.result[t].matches.length;n--;)e++;return e}function b(e,t){var n=g.data.epub.spine.getElementsByTagName("itemref");{if(!(e>n.length-1))return s.getPageOb({page:e,dontParse:!0},function(n){var o=document.createElement("div"),r=parser.parseFromString(n.raw?n.raw:n.content,"text/html"),i=r.getElementById("epubContent");o.appendChild(i);r.getElementsByTagName("title");y.result[e]=[],y.result[e].title=n.title,y.result[e].matches=[],d("contentVirt")("parse",i,function(n){h(n,n,e),t(!0)})});t(!1)}}var y={};return y.start=function(e,t){if(y.key=e.key,e.array?y.result=e.array:y.result=new Array,"all"==e.mode)m(e,t);else if("chapter"==e.mode){var n=l.getOb("epubContent");y.result[currentIndex]=[],y.result[currentIndex].matches=[],h(n,n,currentIndex),t({results:y.result,key:y.key})}},y.removeHighlights=function(){for(var e=document.getElementsByClassName("searchItemHighlight"),t=e.length;t--;)removeClass(e[t],"searchItemHighlight")},y.searchItemClicked=function(e,t,n){function a(){i.update(u.get("pleaseWait"),null,{dots:!0}),s.addListener(l);var e=c.chapter,t=c.location;s.getPageOb({page:e},function(n){if(y.removeHighlights(),n.pages&&n.pages.length);s.redirect(e,{hash:t}),o.$$phase||o.$apply()})}function l(e){"renderedChapter"==e&&(i.update(),s.removeListener(l),p.index=d,o.renderScope.applyHeader("searchItems"),n&&n())}t||(t={});var c=e.item,d=e.index,p=e.matches;r.hide(),t.timer?timeOut(a,300):a()},y}]),app.factory("selection",["markers","cache","error","stg","virt","$rootScope","$injector","$ionicScrollDelegate",function(e,t,n,o,r,a,s,l){function c(e){return!!hasClass(e,"ki-noHighlight")||(!!hasClass(e.parentNode,"ki-noHighlight")||(!!hasClass(e.parentNode.parentNode,"ki-noHighlight")||void 0))}function d(e,t){for(t||(t=e);!e.nextSibling;)if((e=e.parentNode)==t)return;for(e=e.nextSibling;e.childNodes[0];)e=e.childNodes[0];return"#text"==e.nodeName&&e.textContent.trim()?e:d(e,t)}function u(e,t){for(t||(t=e);!e.previousSibling;)if((e=e.parentNode)==t)return;for(e=e.previousSibling;e.childNodes.length;)e=e.childNodes[e.childNodes.length-1];return"#text"==e.nodeName&&e.textContent.trim()?e:u(e,t)}function p(e){return 8==e.nodeType||"#text"==e.nodeName||"br"==e.nodeName.toLowerCase()||(0==e.offsetWidth||void 0)}function f(e,t){var n=e.split("."),o=t.split(".");if(e==t)return 0;for(var r=0;r<n.length;r++){if(Number(n[r])>Number(o[r]))return 1;if(Number(n[r])<Number(o[r]))return-1}return n.length>o.length?1:-1}function g(e){var t=1;return o.data.book.chapter.viewport&&(t=s.get("nav").getFxlScale()),e.getBoundingClientRect().width/t}var h,m,v,b,y,k,w,C,x,I,E,T,O,S,A,B,N,L,M,$,P={};P.getLocation=function(){return A};var H;P.elementDown=function(e,t){I=e;var n=!0;mobile||("a"==e.nodeName.toLowerCase()&&(n=!1),c(e)&&(n=!1),e.parentNode&&"a"==e.parentNode.nodeName.toLowerCase()&&(n=!1),n&&addClass(e,"highlightOver")),redrawForChrome(I.parentElement);var o=mobile&&!mobileDebug?400:100;if(n||(o*=4),T=setTimeout(P.elementHeld,o),mobile&&!mobileDebug){if(!t.touches||!t.touches.length)return;S=t.touches[0],M=S.clientX,$=S.clientY}else M=t.clientX,$=t.clientY,S=t;document.body.addEventListener(mobile&&!mobileDebug?"touchend":"mouseup",P.elementUp),document.body.addEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",R)};var R=function(e){S=mobile&&!mobileDebug?e.touches[0]:e,"activated"==B&&e.stopPropagation()};P.elementUp=function(e){I&&(mobile||removeClass(I,"highlightOver"),I=null,clearTimeout(T)),H&&removeClass(t.getOb("epubContent"),"disableEvents"),H=!1,document.body.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",P.elementUp),document.body.removeEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",R),a.$$phase||a.$apply()},P.elementHeld=function(){s.get("nav").transforming||S&&(Math.abs(S.clientX-M)>(mobile?30:10)||Math.abs(S.clientY-$)>(mobile?30:10)||c(I)||(addClass(I,"highlightSelected"),G(I),P.elementUp()))},P.getSelectedText=function(e){e||(e=document.getElementsByClassName("highlightSelected"));for(var t="",n=0;n<e.length;n++)t+=e[n].textContent;return t},P.getElemsByLocation=function(e,n){n||(n=t.getOb("epubContent"));var i=new Array;if(!e)return i;var a=e.split(",");if("double"==o.data.currentView){for(var s=[],l=0;l<a.length;l++){var c=a[l];c="1"+c.substr(1),s.push(c)}a=a.concat(s)}for(l=0;l<a.length;l++)if(a[l]){for(var d=a[l].split("."),u=n,p=0;p<d.length;p++)if(u){1==p&&r.checkIfRequiresParseAndAnnotations(u.children[Number(d[p])]);var f=0;u.hasAttribute("kb-offset")&&(f=Number(u.getAttribute("kb-offset"))),u=u.children[Number(d[p])-f]}u&&i.push(u)}return i},P.expand=function(){v=v.parentNode,U(),v=b=x,q(),mobile&&D(),V()},P.extendRight=function(e){if(e||"rtl"!=getComputedStyle(v).direction){if(O){n=d(v,t.getOb("epubContent"));if(v=n.parentNode,p(v))return void P.extendRight(e)}else{var n=d(b,t.getOb("epubContent"));if(b=n.parentNode,p(b))return void P.extendRight(e)}U(),q(),mobile&&D(),V()}else P.extendLeft(!0)},P.extendLeft=function(e){if(e||"rtl"!=getComputedStyle(v).direction){if(O){n=u(v,t.getOb("epubContent"));if(b=n.parentNode,p(b))return void P.extendLeft(e)}else{var n=u(v,t.getOb("epubContent"));if(v=n.parentNode,p(v))return void P.extendLeft(e)}U(),q(),mobile&&D(),V()}else P.extendRight(!0)},P.newChapter=function(){mobile&&(e.deleteMarker("anchor1Marker"),e.deleteMarker("anchor2Marker"),h=P.createAnchorMarker("anchor1"),m=P.createAnchorMarker("anchor2"),addClass(h,"disable"),addClass(m,"disable"))},P.getPageByLocation=function(e,t){var n=e.pages;if(n&&n.length){for(var o=0;o<n.length-1;o++)if(f(t,n[o].lastLocation)<=0)return o;return n.length-1}},P.getTopCornerLocation=function(){var e=P.getTopCornerElement();return P.convertElemsToLocation([e]).left},P.getTopCornerElement=function(){for(var e=t.getOb("epubContent"),n=t.getOb("epubContainer"),o=e.children[0],r=l.$getByHandle("content").getScrollPosition().top+25,i=new Array,a=o.getElementsByClassName("k-section"),s=0;s<a.length;s++)hasClass(a[s],"cNone")||i.push(a[s]);for(var c,d=document.getElementById("readerHeader").offsetHeight+10,s=0;s<i.length;s++)for(var u=i[s].getElementsByTagName("*"),p=0;p<u.length;p++){var f=u[p].getBoundingClientRect();if(f.bottom>d){if(f.top>d&&f.top<d+10)return u[p];var g=f.top-d;c?g<c.distance&&f.bottom<d+n.offsetHeight&&(c={elem:u[p],bounds:f,distance:g}):c={elem:u[p],bounds:f,distance:g}}}if(c)return c.elem;for(s=0;s<i.length;s++)if(i[s].offsetTop-r>0)return i[s];return i[0]},P.getIdArray=function(e){for(var n=P.getTopCornerElement(),o=[];;){if(!n)break;if(n==t.getOb("epubContent"))break;n.getAttribute&&n.getAttribute("id")&&o.push(n.getAttribute("id")),n=n.previousSibling?n.previousSibling:n.parentNode}return o};var D=function(){e.refreshMarkerById("anchor1Marker"),e.refreshMarkerById("anchor2Marker")},F=function(e){var t=0;for(e&&e.parentNode&&e.parentNode.hasAttribute("kb-offset")&&(t=Number(e.parentNode.getAttribute("kb-offset")));e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t},z=function(e,n){n||(n=t.getOb("epubContent"));for(var o="";e!=n;)o=F(e)+"."+o,e=e.parentNode;var r="left";return""==o?{index:"",side:r}:("1"==o[0]&&(o="0"+o.substr(1),r="right"),{index:o.substr(0,o.length-1),side:r})},V=function(){return A=P.convertElemsToLocation(document.getElementsByClassName("highlightSelected"))};P.convertElemsToLocation=function(e,n){n||(n=t.getOb("epubContent"));for(var o="",r="",i=0;i<e.length;i++){var a=z(e[i],n);"left"==a.side?o+=(o?",":"")+a.index:r+=(r?",":"")+a.index}return{left:o,right:r}};var U=function(){y=new Array,k=new Array;for(var e=t.getOb("epubContent").parentNode,n=v;;)if(y.push(n),(n=n.parentNode)==e)break;for(n=b;;)if(k.push(n),(n=n.parentNode)==e)break;var o=function(){for(i=0;i<y.length;i++)for(j=0;j<k.length;j++)if(k[j]==y[i])return[k[j],i,j]}();for(x=o[0],w=o[1],C=o[2],i=0;i<x.childNodes.length;i++){if(x.childNodes[i]==y[w-1]){O=!1;break}if(x.childNodes[i]==k[C-1]){O=!0;break}}},q=function(){try{if(K(),addClass(v,"highlightSelected"),addClass(b,"highlightSelected"),v==b)return void(A={left:z(v)});if(v==x)return void(A={left:z(v)});if(b==x)return void(A={left:z(b)});W(O?b:v,O?v:b)}catch(e){}},W=function(e,t,n){var o;if(n||(n="first"),"first"==n){if(e.parentNode==x)return void W(e,t,"second");for(o=e;(o=o.nextSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");W(e.parentNode,t,"first")}else if("second"==n){if(t.parentNode==x)return void W(e,t,"third");for(o=t;(o=o.previousSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");W(e,t.parentNode,n)}else if("third"==n){var r,a=O?k[C-1]:y[w-1],s=O?y[w-1]:k[C-1];for(i=0;i<x.childNodes.length;i++)if(a!=x.childNodes[i]){if(s==x.childNodes[i])break;r&&"#text"!=x.childNodes[i].nodeName&&8!=x.childNodes[i].nodeType&&addClass(x.childNodes[i],"highlightSelected")}else r=!0}},_=function(){K(),mobile&&(h&&(addClass(h,"disable"),addClass(m,"disable")),m&&(removeClass(h,"tween"),removeClass(m,"tween"))),B=null,O=null,P.listener&&P.listener("deactivated")},K=function(){try{var e=document.getElementsByClassName("highlightSelected");if(!e)return;for(var t=e.length;t--;)removeClass(e[t],"highlightSelected");mobile&&r.forceRepaint()}catch(e){}};P.listener=null,P.addSpanAtCloseTag=function(){var e=document.createElement("span"),t=O?v:b;return t.parentNode.insertBefore(e,t.nextSibling),e},P.getSelectedNodes=function(){return document.getElementsByClassName("highlightSelected")},P.reset=function(){_()},P.deleteNoteMarker=function(t){var n=document.getElementById("note"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("noteMarker"+t)},P.getNoteMarker=function(t){return e.getMarker("noteMarker"+t)},P.createAnchorMarker=function(n){var o=document.createElement("span");return o.setAttribute("id",n+"Marker"),o.setAttribute("anchor",n),addClass(o,"anchorMarker"),t.getOb("epubMeta").appendChild(o),o.addEventListener(mobileDebug?"mousedown":"touchstart",function(e){addClass(E=o,"selected"),L=null,document.addEventListener(mobileDebug?"mousemove":"touchmove",Y),N&&clearInterval(N),N=setInterval(J,60),document.addEventListener(mobileDebug?"mouseup":"touchend",Z),addClass(t.getOb("epubContent"),"defaultCursor"),B="anchorDragged",e.stopPropagation()}),e.addMarker({id:n+"Marker",elem:o,offsetTop:-45,offsetLeft:-10,target:function(){var e,t=0;if("anchor1"==n){if(!(e=v))return void(this.offsetLeft=-10);try{o="rtl"==getComputedStyle(e).direction}catch(e){}t=O?o?0:g(e):o?g(e):0}else{if(!(e=b))return void(this.offsetLeft=-10);var o;try{o="rtl"==getComputedStyle(e).direction}catch(e){}t=O?o?g(e):0:o?0:g(e)}return this.offsetLeft=-10+t,e}}),o},P.createNoteMarker=function(n,o,r){if(r||(r={}),!document.getElementById("note"+n.nid)){var i=document.createElement("span");return i.setAttribute("id","note"+n.nid),addClass(i,r.class?r.class:"contentNoteMarker"),t.getOb("epubMeta").appendChild(i),e.addMarker({id:"noteMarker"+n.nid,elem:i,offsetTop:-17,target:function(){return hasClass(this.elem,"contentNoteMarker")?this.offsetLeft=g(o)-13:this.offsetLeft=0,o},callback:n.callback}),i}},P.deleteBookMarker=function(t){var n=document.getElementById("bookmark"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("bookMarker"+t)},P.createBookMarker=function(n,o){var r=document.createElement("span");return r.setAttribute("id","bookmark"+n.bmid),addClass(r,"contentBookMarker"),t.getOb("epubMeta").appendChild(r),e.addMarker({id:"bookMarker"+n.bmid,elem:r,offsetLeft:0,offsetTop:-10,target:function(){return o},callback:n.callback}),r},P.embedAnchorMarker=function(e){};var Y=function(e){L=e,e.stopPropagation()},J=function(e){try{if(e&&e.stopPropagation(),mobile){if("anchorDragged"!=B)return;if(!L)return}var n;if(mobile){var o=mobileDebug?L:L.targetTouches[0];n=document.elementFromPoint(o.clientX,Math.round(o.clientY+h.offsetHeight/2))}else n=e.target;if(t.getOb("epubContent")==n)return;if(!t.getOb("epubContent").contains(n))return;if((n.textContent.match(new RegExp(" ","g"))||[]).length>1)return;if(mobile)if("anchor1"==E.getAttribute("anchor")){if(v==n)return;v=n}else{if(b==n)return;b=n}else b=n;U(),q(),redrawForChrome(v.parentElement),redrawForChrome(b.parentElement),mobile&&D()}catch(e){}},Z=function(e){try{var n=t.getOb("epubContainer");document.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",Z),mobile?(document.removeEventListener(mobileDebug?"mousemove":"touchmove",Y),removeClass(E,"selected"),clearInterval(N)):n.removeEventListener("mousemove",J),removeClass(t.getOb("epubContent"),"defaultCursor"),E=null,A=V(),B="selectionFixed",P.listener&&P.listener(B),e.stopPropagation()}catch(e){}},G=function(e){try{var n=t.getOb("epubContainer");v=b=e,mobile?(removeClass(h,"disable"),removeClass(m,"disable"),timeOut(function(){addClass(h,"tween"),addClass(m,"tween")},100),D()):(n.addEventListener("mousemove",J),document.addEventListener("mouseup",Z)),V(),B="activated",P.listener&&P.listener(B)}catch(e){}};return P.active=function(){return"selectionFixed"==B||"activated"==B},P}]),app.factory("settings",["$http","error","spread","book","cache","modals","$ionicScrollDelegate","translit","$timeout","virt","selection","$injector","stg","markers","sync","crdv","cssParser",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g,h,m){var v={};return v.pinchActive=!1,v.stylesInitialize=function(){},v.initialize=function(){v.stylingChanged(),v.lineAdjustChanged(),v.updateTextSize(),f.refreshMarkers()},v.getTextSize=function(){return Number(p.data.settings.textSize.slice(0,-2))},v.viewModeChanged=function(){n.applyMode(p.data.settings.viewMode)},v.updateTextSize=function(){try{var e=r.getOb("epubContent"),t=r.getOb("epubContent").style;if(t.fontSize==p.data.settings.textSize)return;t.fontSize=p.data.settings.textSize;for(var n=0;n<e.children.length;n++)try{e.children[n].style.fontSize="1em"}catch(e){}var o,i=r.getOb("epubContainer"),s=e.parentNode.parentNode,l=s.style.webkitTransform||s.style.mozTransform||s.style.transform;o=overflowScroll?r.getOb("epubContainer").scrollTop:Number(l.split(",")[1].slice(0,-2));var d=e.offsetHeight,u=i.offsetTop,f=i.offsetHeight;d+o<f+u?c.safeScroll("content",0,u+d-f,!0):d<f&&a.$getByHandle("content").scrollTop(!1),c.reset()}catch(e){}},v.writeTextSize=function(){p.writeSlot("settings"+p.getBookId(!0),p.data.settings,function(){f.refreshMarkers()})},v.stylingChanged=function(){p.data.settings.styling?m.showStyles():m.hideStyles(),f.refreshMarkers()},v.saveSettings=function(){p.writeSlot("settings"+p.getBookId(!0),p.data.settings)},v.langChanged=function(){"ar"==p.data.settings.language?p.data.settings.rtl=!0:p.data.settings.rtl=!1,u.get("nav").fxlZoomFit(),p.writeSlot("settings"+p.getBookId(!0),p.data.settings,function(){s.setLang(p.data.settings.language),f.refreshMarkers()})},v.lineAdjustChanged=function(){p.data.settings.lineAdjust?addClass(r.getOb("epubContent"),"adjustedLineHeight"):removeClass(r.getOb("epubContent"),"adjustedLineHeight"),f.refreshMarkers()},v.sync=function(){g.onOnline(function(){native?h.toast(s.get("syncComplete")):i.show({mode:"success",successOptions:{msg:s.get("syncComplete")}})})},v}]),app.factory("skeleton",["stg",function(e){function t(e,t){var r=u.getBone(e.index-1);if(r){var i=r;r.total>1&&(i=u.getBone(e.index-1,r.total-1)),i.next=e,e.prev=i}var a=u.getBone(t.index+1);a&&(a.prev=t,t.next=a);var s;if("double"==n()){var l=u.getJoint(e.index-1),c=u.getJoint(t.index+1);if(l)return void o();var d=t.total?t.total:1;if(c&&1==c.length&&c[0].index>=config.firstDoublePage&&(s=!0),c){var p;if(s||d%2==0&&(p=!0),s&&d%2==1&&(p=!0),p)return void o();e.alone=!0}}o()}function n(){var t=e.data.settings.viewMode;return"double"==t&&config.singleViewOnPortrait&&mobile&&1.3*window.innerWidth<window.innerHeight&&(t="single"),t}function o(e){e||(e={}),p=[],e.firstBone||(e.firstBone=r());for(var t=e.firstBone,o=n(),i=e.lastJoint;t;){var s=[];if(t.joint=s,"single"==o?s.push(t):"double"==o?(s.push(t),i&&delete t.alone,t.alone||t.index>=config.firstDoublePage&&t.next&&(s.push(t=t.next),t.joint=s)):"auto"==o&&s.push(t),i&&(s.prev=i,i.next=s),p.push(s),i=null,t.next&&(i=s),e.lastBone==t)break;t=a(t,e)}return p[p.length-1]}function r(e){var t;e||(e=0);for(var n=0;n<f.length;n++)f[n].index<e||(t?f[n].index<t.index?t=f[n]:f[n].index==t.index&&f[n].vIndex<t.vIndex&&(t=f[n]):t=f[n]);return t}function i(e){for(var t,n=0;n<f.length;n++)f[n].index>e||(t?f[n].index>t.index?t=f[n]:f[n].index==t.index&&f[n].vIndex>t.vIndex&&(t=f[n]):t=f[n]);return t}function a(e,t){return t||(t={}),e.next?e.next:t.connectedOnly?void 0:s(e.index+1)}function s(e){var t,n,o=i();if(o)for(;e<=o.index;){if(t&&(e=t.index+1),n=u.getBone(e))return n;t=null,e++}}function l(e){var t=s(e);if(t)return t.joint}function c(e,t){t||(t="");for(var n;e;)t+=e.index+"."+e.vIndex,n=e,(e=e.next)&&(t+="->");return n}function d(e,t){t||(t="");for(var n;e;){t+=" [";for(var o=0;o<e.length;o++)t+=e[o].index+"."+e[o].vIndex+",";t=t.substr(0,t.length-1)+"]",n=e,(e=e.next)&&(t+="->")}return n}var u={},p=[],f=[];return u.reset=function(){f=[],p=[]},u.initialize=function(e){u.reset(),e||(e={});for(var t=e.first;t<e.last;t++)u.add({index:t})},u.trace=function(){for(var e=-1;;){var t=s(e+1);if(!t)break;e=c(t).index}for(var n=-1;;){var o=l(n+1);if(!o)break;var r=d(o);n=r[r.length-1].index}},u.add=function(e){var n,o,r,i,a=u.getBone(e.index);if(a){var s=e.pages&&e.pages.length;if(a.total&&s)return;if(!a.total&&!s)return;u.remove(a)}if(e.pages&&e.pages.length)for(var l=0;l<e.pages.length;l++)(i={}).index=e.index,i.vIndex=l,i.total=e.pages.length,n&&(i.prev=n,n.next=i),f.push(i),n=i,0==l&&(o=i),l==e.pages.length-1&&(r=i);else(i={}).index=e.index,i.vIndex=null,f.push(i),o=r=i;t(o,r)},u.remove=function(e){e.prev&&e.prev.next&&(e.prev.next=null),e.next&&e.next.prev&&(e.next.prev=null);for(var t=0;t<f.length;t++)if(f[t]==e)return void f.splice(t,1)},u.getBone=function(e,t){for(var n=0;n<f.length;n++)if(f[n].index==e){if(null==t)return f[n];if(f[n].vIndex==t)return f[n]}},u.normalize=function(e){if(null!=e.vIndex){var t=u.getJoint(e.index,e.vIndex);if(t){var n=t[0].index,o=t[0].vIndex;(n!=e.index||null!=o&&o!=e.vIndex)&&(e.index=n,null!=o&&(e.vIndex=o))}}},u.getJoint=function(e,t){for(var n=0;n<p.length;n++)for(var o=0;o<p[n].length;o++)if(p[n][o].index==e){if(t<=-1&&p[n][o].total&&(t+=p[n][o].total),null==t)return p[n];if(null==p[n][o].vIndex)return p[n];if(p[n][o].vIndex==t)return p[n]}},u.nextJoint=function(e,t){var n=u.getBone(e,t);if(n){var o=n.joint.next;if(o)return{index:o.index,vIndex:o.vIndex}}},u.prevJoint=function(e,t){var n=u.getBone(e,t);if(n){var o=n.joint.prev;if(o)return{index:o.index,vIndex:o.vIndex}}},u.getNextIndex=function(e,t){var n={},o=u.getJoint(e.index,e.vIndex);return o&&o.next?n.leftOb={index:o.next[0].index,vIndex:o.next[0].vIndex}:n.leftOb={index:o[o.length-1].index+1,vIndex:0},t&&t(n),n},u.getPrevIndex=function(e,t){var n={},o=u.getJoint(e.index,e.vIndex);return o&&o.prev?n.leftOb={index:o.prev[0].index,vIndex:o.prev[0].vIndex}:n.leftOb={index:o[0].index-1,vIndex:-1},t&&t(n),n},u.isSingle=function(e,t){var n=u.getJoint(e,t);if(n)return 1==n.length},u.getCurrentView=function(e,t){var n=u.getJoint(e,t.vIndex);if(n){var o={};return o.view=1==n.length?"single":"double",o.index=e,o}},u.isLastChapter=function(e,t){e||(e={});var n=null==e.index?currentIndex:e.index,o=null==e.vIndex?currentVIndex:e.vIndex;return t(u.getJoint(n,o)==i(e.last).joint)},u.isFirstChapter=function(e,t){return e||(e={}),t(u.getJoint(currentIndex,currentVIndex)==r(e.first).joint)},u.isNeighbor=function(e,t){for(var n=u.getJoint(currentIndex,currentVIndex),o=n.next,r=n.prev,i=0;i<2;i++){var a=[o,r][i],s=["next","prev"][i];if(a)for(var l=0;l<a.length;l++)if(a[l].index==e.index){if(null==a[l].vIndex)return t(s);if(a[l].vIndex==e.vIndex)return t(s)}}t()},u}]),app.factory("spread",["$document","$injector","cache","selection","skeleton","chapters","stg","$filter",function(e,t,n,o,r,i,a,s){function l(e,t){function n(e){if(!e)return"";for(var n=t.url,o=getElementsByAttribute(e,"*","src"),r=0;r<o.length;r++){var i=o[r].getAttribute("src");shouldParse(i)&&o[r].setAttribute("src",ph.join(n,i))}return e.outerHTML}function r(e,r){r||(r={}),f=x.top+t.pageHeight-k-w,a&&(s.length,s.push({content:n(traverseToTop(a,"epubContent")),lastLocation:o.convertElemsToLocation([e],C).left})),(a=u(e,{markOffset:!0})).appendChild(e.cloneNode(!0))}function i(e){return l.nextSibling?(l=l.nextSibling,"sibling"):l.parentNode&&"body"!=l.nodeName.toLowerCase()?(l=l.parentNode,a=a.parentNode?a.parentNode:traverseToBottom(a,"epubContent"),i()):(a&&s.push({content:n(traverseToTop(a,"epubContent"))}),"break")}t.pages||(t.pages=[]),t.index||(t.index=0),t.lastStop||(t.lastStop=document.createElement("div"));var a=t.lastStop,s=[];e.style.width=t.pageWidth+"px";var l=e,f=t.pageHeight-0,g=getElemMargin(e,{computed:!0}),h=getElemPadding(e,{computed:!0}),m=g.top,v=g.bottom,b=h.top,y=h.bottom;"auto"==m&&(m=0),"auto"==v&&(v=0),"auto"==b&&(b=0),"auto"==y&&(y=0),m||(m=0),v||(v=0),b||(b=0),y||(y=0),g=Number(g),h=Number(h);for(var k=m+b,w=v+y,C=traverseToBottom(e,"epubContent");;){if(!l||8==l.nodeType){if("continue"==i())continue;break}var x=getBoundingBox(l);if(x.bottom<f-w){if(t.supportsPageBreakStyles&&d(l)){if(r(l,{src:"breakStyle"}),"break"==i())break;continue}I=l.cloneNode(!0);if(a.appendChild(I),s.length&&p(I,l,"less"),"break"==i())break}else if(c(l)){var I=cloneNodeAttributes(l);a.appendChild(I),s.length&&p(I,l,"canDigInside"),a=a.childNodes[a.childNodes.length-1],l=l.childNodes[0]}else if(r(l,{src:"end"}),"break"==i())break}if(1==s.length){l=traverseToBottom(e,"epubContent");s[0].content=n(l)}return s}function c(e){if(!e.childNodes.length)return!1;if(e.className.indexOf("kInteractive")>=0){if(hasClass(e,"video"))return!1;if(hasClass(e,"gallery"))return!1;if(hasClass(e,"audio"))return!1;if(hasClass(e,"widget"))return!1;if(hasClass(e,"widget"))return!1;if(hasClass(e,"threed"))return!1}return!0}function d(e){return(!e.nodeName||"span"!=e.nodeName.toLowerCase())&&(!(!e.style||"always"!=e.style.pageBreakBefore&&"always"!=getComputedStyle(e).pageBreakBefore)||!(!e.previousSibling||!e.previousSibling.style||"always"!=e.previousSibling.style.pageBreakAfter&&"always"!=getComputedStyle(e.previousSibling).pageBreakAfter))}function u(e,t){t||(t={});for(var n,o=parents(e),r=0;r<o.length-1;r++)if("#document"!=o[r].nodeName.toLowerCase()&&"html"!=o[r].nodeName.toLowerCase()){var i=cloneNodeAttributes(o[r]);n?(n.appendChild(i),p(i,o[r],"duplicate"),n=n.childNodes[0]):n=i}return n}function p(e,t,n){var o=getFilteredChildIndex(t);if(o>0){var r=e.parentNode,i=getFilteredChildIndex(e);o!=i&&(r.getAttribute("kb-offset")||r.setAttribute("kb-offset",o-i))}}var f={};return f.initialize=function(){},f.applyMode=function(e){"double"==e?f.activateDblPage():"single"==e?f.activateSinglePage():"auto"==e&&f.activateAutoPage()},f.activateSinglePage=function(){if(i.shouldBePaged(a.data.currentPageOb))i.regenerateSpreads();else{i.resetPages({buildChapterMode:!0});var e={};e.viewMode="single",e.reload=!0,i.loadChapterByIndex(currentIndex,e,function(){})}},f.activateDblPage=function(){if(i.shouldBePaged(a.data.currentPageOb))i.regenerateSpreads();else{i.resetPages({buildChapterMode:!0});var e={};e.viewMode="double",e.reload=!0,i.loadChapterByIndex(currentIndex,e,function(){})}},f.activateAutoPage=function(){"double"==i.getCurrentView(currentIndex,{vIndex:currentVIndex}).view?f.activateDblPage():f.activateSinglePage()},f.getViewport=function(e){e||(e={});var t=document.getElementById("readerBody"),n=document.getElementById("readerHeader"),o=document.getElementById("tabMenu"),r=t.getBoundingClientRect().width,s=t.getBoundingClientRect().height;mobile&&"alwaysShow"!=config.autohideReaderMode&&"showOnScroll"!=config.autohideReaderMode&&"showOnTap"!=config.autohideReaderMode||(s-=n.getBoundingClientRect().height+o.getBoundingClientRect().height);var l=i.getCurrentView(e.index,{vIndex:e.vIndex});l||(l={view:"double"});var c={},d=config.spreadSpacing?config.spreadSpacing:0;return"double"==l.view?c.width=Math.round((r-d)/2):(c.width=r,"double"==a.data.settings.viewMode&&(c.width=r/2),1.3*window.innerWidth<window.innerHeight&&(c.width=r)),c.height=s,c},f.parseReflowableChapter=function(e,n){e.raw&&!e.pages&&(e.content=e.raw),t.get("context").simulateChapter(e,function(t){var o=f.getViewport(e),r={};r.pages=[],r.pageWidth=o.width,r.pageHeight=o.height,r.url=e.url,r.index=e.index,t.style.width="100%",t.style.height="100%",t.style.position="absolute",t.style.zIndex=-1,t.style.visibility="hidden",t.setAttribute("data-index",r.index),document.body.appendChild(t),t.addEventListener("error",function(e){}),t.addEventListener("load",function(){var e=t.contentDocument.documentElement,i=e.getElementsByTagName("body")[0];i.style.width=o.width+"px",i.style.height=2*o.height+"px";var a=e.getElementsByTagName("style")[0].innerHTML;r.supportsPageBreakStyles=a.indexOf("page-break-after")>=0||a.indexOf("page-break-before")>=0;var c=t.contentDocument.getElementById("spreadR");c&&c.parentNode.removeChild(c),t.contentDocument.getElementById("epubScroller").style.overflowY="hidden";var d=t.contentDocument.getElementById("epubContent"),u=d.outerHTML;s("contentVirt")("parse",d,function(){var e=l(i,r);t.parentNode.removeChild(t);var a={};a.pages=e,a.raw=u,a.viewport=o,n(a)})})})},f}]),app.factory("status",["$ionicLoading","translit","$q",function(e,t,n){function o(){i&&(clearTimeout(i),i=null)}function r(){o(),s&&(i=setTimeout(function(){a.update().then(function(){a.showAndHide(t.get("statusTimeoutError"),3e3)})},s))}var i,a={},s=1e4;return a.update=function(t,i,l){var c=n.defer();if(l||(l={}),l.dots&&(t+=' <ion-spinner icon="dots" class="loadingSpinner"></ion-spinner>'),l.progress&&(t+='<div class="loadingProgress"></div>'),s=l.timeoutDuration?l.timeoutDuration:1e4,o(),t){r();var d={template:t};for(var u in l)d[u]=l[u];e.show(d),a.updateProgress()}else e.hide();return timeOut(function(){c.resolve()},i||250),c.promise},a.updateProgress=function(e){e||(e=0),e>1&&(e=1);var t=document.getElementsByClassName("loadingProgress");t.length&&(t[0].style.width=Math.round(100*e)+"%"),e>0&&r()},a.showAndHide=function(e,t){a.update(e,t).then(function(){a.update()})},a}]),app.factory("stg",["sync","$rootScope",function(e,t){var n={};n.data={},n.view={};return n.initialize=function(){t.data=n.data,t.view=n.view,n.reset(),n.setLanguages(),preview&&n.clearSlots()},n.initializeSettings=function(e){function t(){n.applyDefaultSettings();try{if(config.defaultLanguage&&(n.data.settings.language=config.defaultLanguage),n.data.settings.navAnim=config.defaultNavAnim?config.defaultNavAnim:"navBookBlock",n.data.settings.viewMode=config.defaultViewMode?config.defaultViewMode:"auto",n.data.settings.pageScroll=null==config.defaultPageScroll||config.defaultPageScroll,!preview)return void n.readSlot("settings"+n.getBookId(!0),function(t){t&&(t.language&&(n.data.settings.language=t.language),t.navAnim&&(n.data.settings.navAnim=t.navAnim),t.viewMode&&(n.data.settings.viewMode=t.viewMode)),e&&e()})}catch(e){}e&&e()}try{n.readSlot("settings"+n.getBookId(!0),function(e){n.data.settings=e,0==n.data.settings.length&&(n.data.settings={}),t()})}catch(e){n.data.settings={},t()}},n.reset=function(){n.resetBook(),n.resetLibrary()},n.setLanguages=function(){n.data.languages=[{label:"English",val:"en"},{label:"Franais",val:"fr"},{label:"Espaol",val:"es"},{label:"Portugus",val:"pt"},{label:"Nederlands",val:"nl"},{label:"Deutsch",val:"de"},{label:"Magyar",val:"hu"},{label:"Italiano",val:"it"},{label:"Svenska",val:"sw"},{label:"Melayu",val:"ms"},{label:"Norsk",val:"no"},{label:"Polski",val:"pl"},{label:"Romn",val:"ro"},{label:"P",val:"ru"},{label:"Trke",val:"tr"},{label:"",val:"ar"},{label:"",val:"zh"},{label:"",val:"jp"},{label:"",val:"ko"}]},n.resetBook=function(){n.data.epub={},n.data.toc="",n.data.mediaList=[],n.data.packageURL="",n.data.book={},n.data.book.chapter={},n.data.chromeAssets=[]},n.resetLibrary=function(){n.data.downloaded=[],n.data.favorites=[],n.data.currentLibrary={}},n.applyDefaultSettings=function(){n.data.settings&&(n.data.settings.styling||(n.data.settings.styling=!0),n.data.settings.textSize||(n.data.settings.textSize="1em"),n.data.settings.lineAdjust||(n.data.settings.lineAdjust=!0),n.data.settings.language||(n.data.settings.language="en"),null==config.viewModeOptional&&(config.viewModeOptional=!0),null==config.pageScrollOptional&&(config.pageScrollOptional=!0),null==config.navAnimOptional&&(config.navAnimOptional=!0),null==config.languageOptional&&(config.languageOptional=!0))},n.getBookId=function(e){if(!config.kotobee.cloudid){var t,o="",r="";try{t=n.data.book.meta.dc.identifier}catch(e){}if(desktop){var i=require("nw.gui");r=t||i.App.manifest.name+(i.App.manifest.rand?i.App.manifest.rand:"")}else if(native)r=t||(cordova.rand?cordova.rand:"");else{r=(r=(r=(r=location.href.split("#")[0]).replace("https://","http://")).replace("http://www.","http://")).replace("http://","");try{o=e?"":t||n.data.book.meta.dc.title}catch(e){}}return"_"+(r+o).replace(/[\/\s:#]/g,"")}return"book"==config.kotobee.mode?"_"+config.kotobee.cloudid:"library"==config.kotobee.mode?"_"+config.kotobee.cloudid+"_"+(e?"":n.data.book.id):void 0},n.addBookmark=function(t,o){n.readSlot("bookmark"+n.getBookId(),function(r){function i(r){r&&(a=r),t.chapter=currentIndex,t.cloudid=config.kotobee.cloudid,a.push(t),n.writeSlot("bookmark"+n.getBookId(),a,function(){return e.queue("bookmark/add",t),o&&o(!0),!0})}var a=r;null!=t.bmid?n.deleteBookmark(t.bmid,null,i):n.uniqueId(a,"bmid",function(e){t.bmid=e,i()})})},n.getBookmarks=function(e){n.readSlot("bookmark"+n.getBookId(),function(t){e&&e(t)})},n.deleteBookmark=function(t,o,r){n.readSlot("bookmark"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].bmid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("bookmark"+n.getBookId(),i,function(){o||e.queue("bookmark/delete",s),r&&r(i)})}})},n.deleteNote=function(t,o,r){n.readSlot("note"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].nid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("note"+n.getBookId(),i,function(){o||e.queue("note/delete",s),r&&r(i)})}})},n.addNote=function(t,o){try{n.readSlot("note"+n.getBookId(),function(r){function i(i){i&&(r=i),null==t.chapter&&(t.chapter=currentIndex),t.cloudid=config.kotobee.cloudid;var a={};for(var s in t)"event"!=s&&(a[s]=t[s]);r.push(a),n.writeSlot("note"+n.getBookId(),r,function(){return e.queue("note/add",a),o&&o(!0),!0})}null!=t.nid?n.deleteNote(t.nid,null,i):n.uniqueId(r,"nid",function(e){t.nid=e,i()})})}catch(e){}return!0},n.getNotes=function(e){n.readSlot("note"+n.getBookId(),e)},n.deleteHlight=function(t,o,r){n.readSlot("hlight"+n.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].hid==t){var s=i[a];return i.splice(a,1),void n.writeSlot("hlight"+n.getBookId(),i,function(){o||e.queue("hlight/delete",s),r&&r(i)})}})},n.addHlight=function(t,o){n.readSlot("hlight"+n.getBookId(),function(r){function i(i){i&&(r=i),null==t.chapter&&(t.chapter=currentIndex),t.cloudid=config.kotobee.cloudid,r.push(t),n.writeSlot("hlight"+n.getBookId(),r,function(){return e.queue("hlight/add",t),o&&o(!0),!0})}null!=t.hid?n.deleteHlight(t.hid,null,i):n.uniqueId(r,"hid",function(e){t.hid=e,i()})})},n.getHlightById=function(e,t){n.getHlights(function(n){for(var o=0;o<n.length;o++)if(n[o].hid==e)return t&&t(n[o]),n[o]})},n.getHlights=function(e){n.readSlot("hlight"+n.getBookId(),e)},n.addAction=function(e,t){n.readSlot("actions"+n.getBookId(),function(o){o.push(e),n.writeSlot("actions"+n.getBookId(),o,function(){return t&&t(!0),!0})})},n.deleteAction=function(e,t){n.readSlot("actions"+n.getBookId(),function(o){for(var r=0;r<o.length;r++)if(JSON.stringify(e)==JSON.stringify(o[r]))return o.splice(r,1),void n.writeSlot("actions"+n.getBookId(),o,function(){return t&&t(o),o});t&&t()})},n.getActions=function(e){n.readSlot("actions"+n.getBookId(),e)},n.readSlot=function(e,t){function n(){if(!(o=localStorage[e]))return t&&t([]),[];var n=JSON.parse(o);return t&&t(n),n}var o;if(chromeApp)chrome.storage.local.get(e,function(n){n=n?isEmpty(n)?[]:n[e]:[],t&&t(n)});else if(native)try{NativeStorage.getItem(e,function(e){e||t([]);var n=JSON.parse(e);t&&t(n)},function(){t&&t([])})}catch(e){n()}else n()},n.writeSlot=function(e,t,n){function o(){localStorage[e]=JSON.stringify(t),n&&n()}if(chromeApp){var r={};r[e]=t,chrome.storage.local.set(r,function(){n&&n()})}else if(native)try{NativeStorage.setItem(e,JSON.stringify(t),function(){n&&n()},function(e){o()})}catch(e){o()}else o()},n.clearSlot=function(e,t){function n(){delete localStorage[e],t&&t()}if(chromeApp)chrome.storage.local.remove(e,function(){t&&t()});else if(native)try{NativeStorage.remove(e,function(){t&&t()},function(){n()})}catch(e){}else n()},n.clearSlots=function(e){function t(){function t(){if(++i>=o.length)e&&e();else{var r=o[i];0==r.indexOf("note_")?n.clearSlot(r,t):0==r.indexOf("bookmark_")?n.clearSlot(r,t):0==r.indexOf("hlight_")?n.clearSlot(r,t):0==r.indexOf("settings_")&&n.clearSlot(r,t)}}var o=[];for(var r in localStorage)o.push(r);var i=-1;t()}if(chromeApp)chrome.storage.local.clear(e);else if(native)try{NativeStorage.clear(e,function(){t()})}catch(e){}else t()},n.copyLocalToNativeStorage=function(){if(native)try{for(var e in localStorage)NativeStorage.setItem(e,localStorage[e]),delete localStorage[e]}catch(e){}},n.uniqueId=function(e,t,o){var r=0;t||(t="id");for(var i=0;i<e.length;i++)Number(e[i][t])>r&&(r=Number(e[i][t]));n.readSlot("actions"+n.getBookId(),function(e){for(var n=0;n<e.length;n++)Number(e[n].data[t])>r&&(r=Number(e[n].data[t]));return o&&o(r+1),r+1})},n.getPublicRoot=function(e){var t="";return n.data.paths&&("book"==config.kotobee.mode||"book"==e?t=n.data.paths.books:"library"!=config.kotobee.mode&&"library"!=e||(t=n.data.paths.libraries)),t||(t=""),t},n}]),app.factory("sync",["$injector","translit","$rootScope","$http","error",function(e,t,n,o,r){function i(){n.data.syncing||(n.data.syncing=!0,n.$$phase||n.$apply())}function a(){n.data.syncing&&(n.data.syncing=!1,n.$$phase||n.$apply())}var s,l,c,d,u,p,f,g={};return g.initialize=function(){config.kotobee.cloudid&&(l||(l=e.get("stg")),c||(c=e.get("bookmarks")),d||(d=e.get("notes")),u||(u=e.get("hlights")),p||(p=e.get("chapters")),l.getActions(function(e){s=e,window.addEventListener?(window.addEventListener("offline",g.onOffline,!1),window.addEventListener("online",g.onOnline,!1)):(document.addEventListener("offline",g.onOffline,!1),document.addEventListener("online",g.onOnline,!1))}))},g.trigger=function(){g.offline()?g.onOffline():g.onOnline()},g.offline=function(){if(e.get("backend").cloudParam("sync"))try{return"NONE"==navigator.network.connection.type.toUpperCase()&&"UNKNOWN"==navigator.network.connection.type.toUpperCase()}catch(e){return!1}},g.onOffline=function(){e.get("backend").cloudParam("sync")},g.onOnline=function(t){e.get("backend").cloudParam("sync")&&(f||g.applyChanges(function(){i();arguments.callee;var s=getFormData(e.get("backend").getAuthVars());o.post(config.kotobee.liburl+"library/notebook/all",s,postOptions).success(function(e){if(a(),e.error)return r.update(e),void(t&&t());var n=e.notes?e.notes:[],o=e.bookmarks?e.bookmarks:[],i=e.hlights?e.hlights:[];d.deleteAll(!0,function(){d.addNotesFromSync(n,function(){c.deleteAll(!0,function(){c.addBookmarksFromSync(o,function(){u.deleteAll(!0,function(){u.addHlightsFromSync(i,function(){t&&t()})})})})})})}).error(function(e){n.data.syncing=!1,r.update({error:"cantLoadNodes"}),t&&t()})}))},g.queue=function(e,t){if(l&&config.kotobee.cloudid&&!config.kotobee.public){var n={type:e,data:clone(t)};s.push(n),l.addAction(n,function(){g.offline()||f||g.applyChanges()})}},g.applyChanges=function(t){if(a(),e.get("backend").cloudParam("sync")&&l&&l.data.user&&(l.data.user.email||l.data.user.code))try{var n={func:arguments.callee,args:arguments};if(0==s.length)return f=!1,void(t&&t());i(),f=!0;var c=s[0],d=getFormData(e.get("backend").getAuthVars());for(var u in c.data)d.append(u,c.data[u]);o.post(config.kotobee.liburl+"library/"+c.type,d,postOptions).success(function(e){s.splice(0,1),l.deleteAction(c,function(){g.applyChanges()})}).error(function(e){f=!1,setTimeout(a,300),r.update({error:"syncOnConnectionMsg",ref:n})})}catch(e){}},g}]),app.factory("tinCan",["stg","backend",function(e,t){function n(t){try{if(!config.gAnalyticsID)return;if(!ga)return}catch(e){return}ga("send","event",t.activity,t.verb,e.data.book.meta.dc.title)}var o={};return o.initialize=function(){},o.send=function(o){n(o),t.cloudParam("tincan")&&(o.name=e.data.user.name?e.data.user.name:"User",e.data.user.email?o.email=e.data.user.email:e.data.user.code&&(o.email=e.data.user.code+"@promocode"),o.lrs=t.cloudParam("tincanlrs"),o.lrsver=t.cloudParam("tincanlrsver"),o.lrsuser=t.cloudParam("tincanlrsuser"),o.lrspwd=t.cloudParam("tincanlrspwd"),t.tincan(o))},o}]),app.factory("translit",["$interpolate","$http","$injector","$rootScope","cache",function(e,t,n,o,r){function i(){for(var e=0;e<d.length;e++)d[e](a)}var a,s,l={},c={},d=[];return l.addListener=function(e){d.push(e)},l.setLangOld=function(e){a=e},l.setLang=function(e,t){n.get("backend").getServerLang({lang:e}).success(function(n){s=n,a=e,o.data&&(o.data.lc||(o.data.lc=0),o.data.lc=Number(o.data.lc)+1),i(),r.getOb("viewContainer")||r.setOb("viewContainer",document.getElementsByClassName("view-container")[0]),"ar"==e?(r.getOb("body")&&addClass(r.getOb("body"),"rtl"),r.getOb("viewContainer")&&r.getOb("viewContainer").setAttribute("dir","rtl")):(r.getOb("body")&&removeClass(r.getOb("body"),"rtl"),r.getOb("viewContainer")&&r.getOb("viewContainer").setAttribute("dir","ltr")),t&&t()}).error(function(e,t){})},l.getLang=function(){return a},l.get=function(t,n){if(!s)return t;if(!a)return t;if(s[t]&&(t=s[t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},l.getOld=function(t,n){if(c[a][t]&&(t=c[a][t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},l}]),app.factory("view",["stg",function(e){var t={};return t.generate=function(){var t=e.data.currentLibrary,n=e.data.currentLibrary.cloud,o=e.view;o.registration={},o.registration.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.inregistration,o.topmenu={},o.topmenu.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.intopmenu,o.topmenu={},o.topmenu.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.intopmenu,o.bookinfo={},o.bookinfo.promocode=n&&!n.public&&t&&!t.cloud.promocodesdisabled&&t.promocodesettings.inbookinfo},t}]),app.factory("virt",["$ionicScrollDelegate","$filter","$location","cache","$q",function(e,t,n,o,r){var i,a,s,l,c={};c.lock=function(){a=!0},c.unlock=function(){a=!1},c.enable=function(){i||a||(i=!0,l&&clearInterval(l),s=setInterval(d,60),d())},c.disableAfter=function(e){l&&clearInterval(l),l=setInterval(function(){c.disable(),clearInterval(l)},e)},c.disable=function(){i&&(a||(i=!1,clearInterval(s)))};var d=function(){a||t("contentVirt")()};return c.reset=function(e,n){a||(c.reveal(!0),t("contentVirt")("reset"),t("contentVirt")(null,e,function(){c.reveal(!1),n&&n()}))},c.checkIfRequiresParse=function(e){parseSecsSeparate&&(hasClass(e,"parsed")||t("contentVirt")("parse",e))},c.checkIfRequiresParseAndAnnotations=function(e){hasClass(e,"parsed")||t("contentVirt")("parseAndAnnotations",e)},c.reveal=function(e){a||t("contentVirt")(e?"reveal":"undoReveal")},c.safeAnchorScroll=function(e,t,n){if(!a){var o=r.defer();c.reveal(!0);var i=document.getElementById(t);return c.safeScrollToElem(e,i,n),timeOut(function(){c.reset(),o.resolve()},1300),o.promise}},c.safeScroll=function(t,n,o,i){if(!a){var s=r.defer();return i||(i=!0),c.reveal(!0),e.$getByHandle(t).scrollTo(Math.round(n),Math.round(o),i),timeOut(function(){c.reset(),s.resolve()},1300),s.promise}},c.safeScrollToElem=function(t,n,r){if(n&&!a){c.reveal(!0);var i=o.getOb("epubContainer"),s=0,l=getComputedStyle(i).paddingTop;l&&(s=Number(l.split("px")[0]));var d=e.$getByHandle(t).getScrollPosition().top-(i.getBoundingClientRect().top+s)-25;return c.safeScroll(t,0,n.getBoundingClientRect().top+d,r)}},c.forceRepaint=function(){try{var e=document.createTextNode(" ");document.body.appendChild(e),setTimeout(function(){},0)}catch(e){}},c}]),app.factory("workers",["stg",function(e){function t(e){p=!0}function n(e){if(e.length){var t=e[0].args,n=e[0].id;s(t[0]).postMessage({func:t[1],params:t[2],id:n})}}function o(e){var t=i(e.target);r(t);var o=t[0].args[3];o&&o(e.data.data),t.shift(),n.apply(this,[t])}function r(e){for(var t=0;t<e.length;t++);}function i(e){return e==c?g:e==d?h:e==u?m:void 0}function a(e){return"cssParser"==e?g:"htmlParser"==e?h:"search"==e?m:void 0}function s(e){return"cssParser"==e?c:"htmlParser"==e?d:"search"==e?u:void 0}function l(){return!p&&"undefined"!=typeof Worker}var c,d,u,p,f={},g=[],h=[],m=[];f.initialize=function(){if(l())try{c=new Worker(rootDir+"js/workers/cssParser.js"),d=new Worker(rootDir+"js/workers/htmlParser.js"),u=new Worker(rootDir+"js/workers/search.js"),c.addEventListener("error",t,!1),d.addEventListener("error",t,!1),u.addEventListener("error",t,!1),c.addEventListener("message",o,!1),d.addEventListener("message",o,!1),u.addEventListener("message",o,!1)}catch(e){p=!0}};var v=0;return f.call=function(e,t,o,r){if(++v,s(e)){var i=a(e),l=[e,t,o,r];i.push({args:l,id:v}),1==i.length&&n(i)}},f.supported=function(){return l()},f}]),app.factory("bookmarks",["selection","translit","crdv","popovers","stg","cache","modals","virt","chapters",function(e,t,n,o,r,i,a,s,l){function c(e,t){r.readSlot("bookmark"+r.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(l.busy||arrayContainsProperty(n,"bmid",e.bmid)||d.addIcon(e)),n.push(e),r.writeSlot("bookmark"+r.getBookId(),n,t)})}var d={};return d.addBookmark=function(){var o={};o.chapter=currentIndex,o.location=e.getTopCornerLocation(),r.addBookmark(o,function(){d.addIcon(o),n.toast(t.get("bookmarked"))})},d.addBookmarksFromSync=function(e,t){function n(){++o>=e.length?t&&t():c(e[o],n)}var o=-1;n()},d.addIconIfNotShown=function(e){d.addIcon(e)},d.addIcon=function(n){var r=e.getElemsByLocation(n.location);if(r[0]){var i=e.createBookMarker(n,r[0]);if(i.className="contentBookMarker",i.setAttribute("bmid",n.bmid),i.setAttribute("bloc",r[0].offsetTop),i.addEventListener("tap",function(e){e.stopImmediatePropagation()}),i.addEventListener("click",function(e){s.safeScrollToElem("content",i,!0);var t={};t.bmid=this.getAttribute("bmid"),t.location=this.getAttribute("bloc")}),i.addEventListener("hold",function(e){var r=[{name:t.get("delete"),func:function(){d.delete(n.bmid),o.hide()}},{name:t.get("cancel"),func:function(){o.hide()}}];o.show({mode:"list",listOb:r,backdropClickToClose:!1})}),!mobile){var l=document.createElement("span");l.className="editIcon icon ion-ios-close",l.addEventListener("click",function(e){var t={title:"confirmation",msg:"bookmarkDeleteConfirm",barStyle:"bar-dark"},o={label:"delete",style:"button-assertive"};o.func=function(){d.delete(n.bmid),a.hide()};var r={label:"cancel"};r.func=function(){a.hide()},t.btns=[o,r],a.show({mode:"confirm",confirmOptions:t})}),l.addEventListener("tap",function(e){e.stopImmediatePropagation()}),i.appendChild(l),i.addEventListener("mouseover",function(e){addClass(i,"edit"),i.addEventListener("mouseout",function(e){removeClass(i,"edit")})})}}},d.delete=function(t,n,o){e.deleteBookMarker(t),r.deleteBookmark(t,n,o)},d.deleteAll=function(e,t){r.getBookmarks(function(n){function o(){++r>=n.length?t&&t():d.delete(n[r].bmid,e,o)}var r=-1;o()})},d}]),app.factory("hlights",["selection","crdv","backend","stg","$rootScope","modals","chapters",function(e,t,n,o,r,i,a){function s(e,t){o.readSlot("hlight"+o.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(a.busy||arrayContainsProperty(n,"hid",e.hid)||l.addHlight(e)),n.push(e),o.writeSlot("hlight"+o.getBookId(),n,t)})}var l={};return l.addHlightsFromSync=function(e,t){function n(){++o>=e.length?t&&t():s(e[o],n)}var o=-1;n()},l.addHlight=function(t){for(var n=document.getElementsByClassName("hlight"+t.hid),o=n.length;o--;)n[o].style.backgroundColor=null,removeClass(n[o],"contentHlightBG"),removeClass(n[o],"hlight"+t.hid);for(o=(n=e.getElemsByLocation(t.location)).length;o--;)n[o]&&(addClass(n[o],"contentHlightBG"),addClass(n[o],"hlight"+t.hid),n[o].style.backgroundColor=t.color);return l},l.showPopup=function(t,n){r.$new(!0).hlightOb={},t||(t=[]);var s={};s.save=function(r){for(var s=0;s<t.length;s++){var c=t[s];null==c.chapter&&(c.chapter=a.getElemChapterIndex(e.getSelectedNodes()[0])),c.color=r,null==c.src&&(c.src=e.getSelectedText()),o.addHlight(c,function(){l.addHlight(c),s==t.length-1&&timeOut(function(){i.hide(),n&&n(!0)},300)})}},s.color=t[0].color?t[0].color:"#fffb85",t[0].hid&&(s.delete=function(){for(var e=0;e<t.length;e++)l.delete(t[0].hid,null,function(){e==t.length-1&&timeOut(function(){i.hide(),n&&n()},300)})}),i.show({mode:"hlight",hlightOptions:s})},l.delete=function(e,t,n){for(var r=document.getElementsByClassName("hlight"+e),i=r.length;i--;)i==r.length-1&&removeClass(r[i],"last"),removeClass(r[i],"contentHlightBG"),r[i].style.backgroundColor=null,removeClass(r[i],"hlight"+e);o.deleteHlight(e,t,n)},l.deleteAll=function(e,t){o.getHlights(function(n){function o(){++r>=n.length?t&&t():l.delete(n[r].hid,e,o)}var r=-1;o()})},l}]),app.factory("notes",["selection","translit","crdv","$ionicGesture","stg","$rootScope","cache","modals","popovers","$injector","virt","$timeout","chapters","book","$sce",function(e,t,n,o,r,i,a,s,l,c,d,u,p,f,g){function h(e){for(var t=e.split(" "),n=0;n<t.length;n++)if(t[n]&&0==t[n].trim().indexOf("note"))return t[n].trim().substr(4)}function m(e,t){r.readSlot("note"+r.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(p.busy||arrayContainsProperty(n,"nid",e.nid)||v.addIcon(e)),n.push(e),r.writeSlot("note"+r.getBookId(),n,t)})}var v={};return v.addNotesFromSync=function(e,t){function n(){++o>=e.length?t&&t():m(e[o],n)}var o=-1;n()},v.addNotesFromQuestions=function(t,n){function o(e){e>=s.length?i(0):r.addNote(s[e].ob,function(){addClass(s[e].elem,"note"+s[e].ob.nid),o(++e)})}function i(e){e>=l.length?n&&n():r.deleteNote(l[e].nid,null,function(){removeClass(l[e].elem,"note"+l[e].nid),i(++e)})}for(var a=t.elem.getElementsByClassName("ques"),s=[],l=[],c=0;c<a.length;c++)for(var d=a[c],u=d.getElementsByTagName("p")[0].textContent,f=d.getElementsByClassName("ans"),g=0;g<f.length;g++){var m=f[g],v=m.className;v=v.split(" ");var b;"radio"==m.type?b="mcq":"checkbox"==m.type?b="mmcq":"text"==m.type?b="sa":"textarea"==m.type&&(b="sa");var y=h(m.className),k="";if("mcq"==b||"mmcq"==b){if(!m.checked){y&&l.push({nid:y,elem:m});continue}k=m.nextElementSibling.textContent}if("sa"==b){if(""==m.value){y&&l.push({nid:y,elem:m});continue}k=m.value}var w={};w.chapter||(w.chapter=p.getElemChapterIndex(m)),w.location||(w.location=e.convertElemsToLocation([m],t.root).left,t.rootIndex&&(w.location=t.rootIndex+"."+w.location)),w.type||(w.type="content"),w.src||(w.src=u),w.note=k,y&&(w.nid=y),s.push({ob:w,elem:m})}o(0)},v.addIcon=function(n,o){if("page"==n.type){if(!(c=e.getElemsByLocation(n.location))[0])return;var i=e.createNoteMarker(n,c[0],{class:"contentSideNoteMarker"});if(i.setAttribute("nid",n.nid),i.setAttribute("ncontent",n.note?n.note:""),i.setAttribute("nloc",n.location),i.addEventListener("click",function(e){d.safeScrollToElem("content",i,!0);var t={};t.note=this.getAttribute("ncontent"),t.nid=this.getAttribute("nid"),t.location=this.getAttribute("nloc"),t.type="page",v.noteClicked([t]),e.stopImmediatePropagation()}),i.addEventListener("tap",function(e){e.stopImmediatePropagation()}),i.addEventListener("hold",function(o){var i=[{name:t.get("edit"),func:function(){l.hide(),v.noteClicked([n])}},{name:t.get("delete"),func:function(){r.deleteNote(n.nid,null,function(){e.deleteNoteMarker(n.nid),l.hide()})}},{name:t.get("cancel"),func:function(){l.hide()}}];l.show({mode:"list",listOb:i,backdropClickToClose:!1})}),!mobile){var a=document.createElement("span");a.className="editIcon icon ion-ios-close",a.addEventListener("click",function(t){var o={title:"confirmation",msg:"noteDeleteConfirm",barStyle:"bar-dark"},i={label:"delete",style:"button-assertive"};i.func=function(){r.deleteNote(n.nid,null,function(){e.deleteNoteMarker(n.nid)}),s.hide()};var a={label:"cancel"};a.func=function(){s.hide()},o.btns=[i,a],s.show({mode:"confirm",confirmOptions:o}),t.stopImmediatePropagation()}),a.addEventListener("tap",function(e){e.stopImmediatePropagation()}),i.appendChild(a),i.addEventListener("mouseover",function(e){addClass(i,"edit"),i.addEventListener("mouseout",function(e){removeClass(i,"edit")})})}}if("content"==n.type){for(var c=e.getElemsByLocation(n.location,o),p=0;p<c.length;p++)c[p]&&addClass(c[p],"note"+n.nid);if(1==c.length&&c[0]){var f=c[0].type;if("radio"==f||"checkbox"==f)return void(c[0].checked=!0);if("text"==f||"textarea"==f)return void(c[0].value=n.note)}for(p=0;p<c.length;p++)c[p]&&addClass(c[p],"contentNoteBG");var g=c[c.length-1];if(!g)return;g.setAttribute("ncontent",n.note?n.note:""),g.setAttribute("nloc",n.location),addClass(g,"last"),u(function(){try{var t=e.createNoteMarker(n,g);t&&(t.onclick=function(e){var t=this.getAttribute("id"),n=document.getElementsByClassName(t),o=n[n.length-1],r=(o.getAttribute("ncontent"),{});r.note=o.getAttribute("ncontent"),r.location=o.getAttribute("nloc"),r.nid=t.substr(4),r.type="content",r.src=o.textContent,v.noteClicked([r]),e.stopImmediatePropagation(),e.preventDefault()},t.addEventListener("tap",function(e){e.stopImmediatePropagation()}))}catch(e){}})}},v.noteClicked=function(t,n){try{t||(t=[]);var o={};o.save=function(i){for(var a=0;a<t.length;a++){var l=t[a];l.chapter||(l.chapter=p.getElemChapterIndex(e.getSelectedNodes()[0])),l.location||(l.location=e.getTopCornerLocation()),l.type||(l.type="page"),l.src||(l.src="content"==l.type?e.getSelectedText():"");var c=null==l.nid;l.note=i,r.addNote(l,function(){if(c)v.addIcon(l);else{e.getNoteMarker(l.nid).elem.setAttribute("ncontent",l.note);var o=e.getElemsByLocation(l.location),r=o[o.length-1];r&&r.setAttribute("ncontent",l.note)}a==t.length-1&&u(function(){s.hide(),n&&n(!0)},300)})}t[0].nid&&(o.delete=function(){for(var e=0;e<t.length;e++)v.delete(t[0].nid,null,function(){e==t.length-1&&u(function(){s.hide(),n&&n()},300)})})},t[0].note&&(o.note=t[0].note),s.show({mode:"note",dynamic:!0,animation:"slide-in-up",noteOptions:o,event:t[0].event})}catch(e){}},v.delete=function(t,n,o){e.deleteNoteMarker(t);for(var i=document.getElementsByClassName("note"+t),a=i.length;a--;)a==i.length-1&&(removeClass(i[a],"last"),i[a].removeAttribute("nloc"),i[a].removeAttribute("ncontent")),removeClass(i[a],"contentNoteBG"),removeClass(i[a],"note"+t);r.deleteNote(t,n,o)},v.deleteAll=function(e,t){r.getNotes(function(n){function o(){++r>=n.length?t&&t():v.delete(n[r].nid,e,o)}var r=-1;o()})},v.updateNotebookArray=function(e,t){var n=new Array;r.getBookmarks(function(o){for(var i=0;i<o.length;i++){var a=o[i];n[a.chapter]||(n[a.chapter]=new Array),n[a.chapter].push(a)}r.getNotes(function(o){for(var i=0;i<o.length;i++){var a=o[i];n[a.chapter]||(n[a.chapter]=new Array),a.noteTrusted=g.trustAsHtml(a.note.replace(new RegExp("\r?\n","g"),"<br />")),n[a.chapter].push(a)}r.getHlights(function(o){for(a=0;a<o.length;a++){i=o[a];n[i.chapter]||(n[i.chapter]=new Array),n[i.chapter].push(i)}for(var i in n)n[i].title=f.getTitleByIndex(i);for(var a=0;a<n.length;a++)if(n[a])for(var s=0;s<n[a].length;s++){var l=n[a][s].location.split(",");n[a][s].locationDec=Number("0."+l[0].split(".").join(""))}r.data.notebookContent={results:n,showDelete:e.showDelete},t&&t()})})})},v}]);